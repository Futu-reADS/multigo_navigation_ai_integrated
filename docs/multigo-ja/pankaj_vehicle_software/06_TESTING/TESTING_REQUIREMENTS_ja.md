# テスト要件

**プロジェクト:** 屋外車椅子輸送ロボット - マルチチームシステム
**ドキュメントタイプ:** システム全体のテスト要件
**チーム責任:** 全チーム（協調テスト）
**ステータス:** 第6週 - アクティブ開発
**日付:** 2025年12月16日
**バージョン:** 1.0

---

## ドキュメント管理

| バージョン | 日付 | 作成者 | 変更内容 |
|---------|------|--------|---------|
| 1.0 | 2025-12-16 | マルチチーム | 初版包括的テスト要件 |

**関連ドキュメント:**
- すべての要件ドキュメント（機能、ハードウェア、ソフトウェア、フリート管理）
- SAFETY_REQUIREMENTS.md（安全テストがクリティカル）
- INTEGRATION_REQUIREMENTS.md（第7週 - 統合テスト戦略）

---

## 1. 目的と範囲

本ドキュメントは、すべての開発フェーズにわたる車椅子輸送ロボットシステムの**包括的なテスト要件**を規定します：
- **ユニットテスト**（個別コンポーネント）
- **統合テスト**（コンポーネント間の相互作用）
- **システムテスト**（エンドツーエンドシナリオ）
- **フィールドテスト**（実環境検証）
- **リグレッションテスト**（継続的検証）
- **パフォーマンステスト**（負荷、ストレス、耐久）
- **安全テスト**（フェイルセーフ検証）

**テスト哲学:**
- 早期に、頻繁にテスト（シフトレフトアプローチ）
- 可能な限り自動化テスト（CI/CD統合）
- 展開前の実環境検証が必須
- 安全テストは失敗許容度ゼロ

---

## 2. ユニットテスト要件

### 2.1 ソフトウェアユニットテスト

| ID | 要件 | 優先度 | 受入基準 |
|----|-------------|----------|---------------------|
| TEST-UNIT-SW-001 | すべてのROS 2ノードにはユニットテストが必要（gtest/pytestを使用） | クリティカル | ノードごとにコードカバレッジ≥80% |
| TEST-UNIT-SW-002 | ユニットテストは外部依存関係をモック化する必要がある（センサー、ネットワーク、ファイルシステム） | クリティカル | ハードウェアなしでテスト実行 |
| TEST-UNIT-SW-003 | ユニットテストは合計<5分で実行される必要がある（高速フィードバック） | 高 | 実行時間を測定 |
| TEST-UNIT-SW-004 | ユニットテストはすべてのgitコミットで自動実行される必要がある（プレコミットフック） | 高 | CI/CD統合を検証 |
| TEST-UNIT-SW-005 | 失敗したユニットテストはプルリクエストのマージをブロックする必要がある | クリティカル | CI強制が機能的 |
| TEST-UNIT-SW-006 | ユニットテストのカバレッジは測定およびレポートされる必要がある（coverage.py、gcov） | 高 | カバレッジレポート生成 |

**ユニットテストが必要な主要モジュール:**
- スワーブドライブ運動学計算
- 経路計画アルゴリズム
- センサーデータ処理（LiDARフィルタリング、カメラキャリブレーション）
- ステートマシンロジック（ミッション状態、ドッキング状態）
- 安全モニター（衝突検出、ジオフェンシング）
- TVM APIクライアント（REST、WebSocket）

### 2.2 ハードウェアユニットテスト

| ID | 要件 | 優先度 | 受入基準 |
|----|-------------|----------|---------------------|
| TEST-UNIT-HW-001 | 各モーターコントローラーは独立してテストされる必要がある（トルク、速度、応答時間） | クリティカル | すべての8コントローラーがテスト合格 |
| TEST-UNIT-HW-002 | バッテリーBMSはテストされる必要がある（電圧精度、電流測定、SOC推定） | クリティカル | BMS読み取り値を検証 |
| TEST-UNIT-HW-003 | CANバス通信はテストされる必要がある（メッセージ完全性、タイミング、エラー処理） | クリティカル | 100%メッセージ配信を検証 |
| TEST-UNIT-HW-004 | センサーは個別にテストされる必要がある（LiDAR範囲精度、カメラキャリブレーション、IMUドリフト） | 高 | センサー仕様を検証 |
| TEST-UNIT-HW-005 | 電力分配はテストされる必要がある（電圧調整、負荷共有、リップル） | 高 | 電圧が±5%許容範囲内 |

---

## 3. 統合テスト要件

### 3.1 車両サブシステム統合

| ID | 要件 | 優先度 | 受入基準 |
|----|-------------|----------|---------------------|
| TEST-INT-VEH-001 | ナビゲーション + スワーブドライブ統合はテストされる必要がある（コマンド → モーション遅延<100ms） | クリティカル | 遅延を検証 |
| TEST-INT-VEH-002 | 知覚 + ナビゲーション統合はテストされる必要がある（障害物検出 → 経路再計画<2秒） | クリティカル | 応答時間を検証 |
| TEST-INT-VEH-003 | ドッキング + ArUcoビジョン統合はテストされる必要がある（マーカー検出 → ドッキング精度±5mm） | クリティカル | ドッキング精度を検証 |
| TEST-INT-VEH-004 | 安全 + 全サブシステム統合はテストされる必要がある（緊急停止がすべてのシステムに<100msで伝播） | クリティカル | 緊急停止遅延を検証 |
| TEST-INT-VEH-005 | バッテリー + 電力管理統合はテストされる必要がある（SOC → 自動充電トリガー） | 高 | 自動充電が機能的 |

### 3.2 フリート管理統合

| ID | 要件 | 優先度 | 受入基準 |
|----|-------------|----------|---------------------|
| TEST-INT-FLEET-001 | 車両 + TVMサーバー統合はテストされる必要がある（テレメトリーアップロード、ミッション割り当て） | クリティカル | 双方向通信を検証 |
| TEST-INT-FLEET-002 | 予約システム + 車両スケジューリング統合はテストされる必要がある（予約 → ミッション作成） | 高 | エンドツーエンド予約が機能的 |
| TEST-INT-FLEET-003 | ユーザー認証 + フリートUI統合はテストされる必要がある（RBAC強制） | 高 | ロールベースアクセスを検証 |
| TEST-INT-FLEET-004 | テレオペレーション + 車両制御統合はテストされる必要がある（オペレーター入力 → 車両応答） | 高 | テレオペレーションが機能的 |

### 3.3 ハードウェア-ソフトウェア統合

| ID | 要件 | 優先度 | 受入基準 |
|----|-------------|----------|---------------------|
| TEST-INT-HWSW-001 | ROS 2 + CANバス統合はテストされる必要がある（モーターコマンド → CANメッセージ → モーター応答） | クリティカル | エンドツーエンド制御を検証 |
| TEST-INT-HWSW-002 | 充電システム + 車両ソフトウェア統合はテストされる必要がある（自動ドッキング、充電モニタリング） | クリティカル | 自動充電が機能的 |
| TEST-INT-HWSW-003 | 車両UI + ROS 2統合はテストされる必要がある（タッチスクリーン入力 → ROSコマンド） | 高 | UIコマンドが実行される |

---

## 4. システムテスト要件

### 4.1 エンドツーエンドミッションテスト

| ID | 要件 | 優先度 | 受入基準 |
|----|-------------|----------|---------------------|
| TEST-SYS-MISSION-001 | 完全な歩行支援ミッションはテストされる必要がある: アイドル → ナビゲーション → ドッキング → 輸送 → 目的地 → 戻る | クリティカル | 100回連続成功ミッション |
| TEST-SYS-MISSION-002 | 医薬品配達ミッションはテストされる必要がある: ピックアップ → 輸送 → 配達確認 → 戻る | クリティカル | 50回連続成功ミッション |
| TEST-SYS-MISSION-003 | マルチウェイポイントミッションはテストされる必要がある（3+停止、順次ナビゲーション） | 高 | マルチストップルーティングが機能的 |
| TEST-SYS-MISSION-004 | ミッション失敗回復はテストされる必要がある（ナビゲーションブロック → オペレーター警告 → テレオペレーション回復） | 高 | 回復手順を検証 |

### 4.2 フリート調整テスト

| ID | 要件 | 優先度 | 受入基準 |
|----|-------------|----------|---------------------|
| TEST-SYS-FLEET-001 | マルチ車両運用はテストされる必要がある（5+車両同時、競合なし） | 高 | 同時運用を検証 |
| TEST-SYS-FLEET-002 | 充電キュー管理はテストされる必要がある（複数車両が充電待ち、優先度キューが機能的） | 高 | キュー管理を検証 |
| TEST-SYS-FLEET-003 | 予約競合解決はテストされる必要がある（重複予約、優先度処理） | 中 | 競合解決を検証 |

### 4.3 安全システムテスト

| ID | 要件 | 優先度 | 受入基準 |
|----|-------------|----------|---------------------|
| TEST-SYS-SAFE-001 | 緊急停止はテストされる必要がある（物理ボタン、UIボタン、リモート緊急停止、すべてのソース） | クリティカル | すべてのソースから緊急停止<100ms |
| TEST-SYS-SAFE-002 | 障害物回避はテストされる必要がある（歩行者、車両、さまざまな速度での静的障害物） | クリティカル | 1000kmテストでゼロ衝突 |
| TEST-SYS-SAFE-003 | ジオフェンシングはテストされる必要がある（車両が境界で停止、ジオフェンス違反なし） | クリティカル | ジオフェンス強制100% |
| TEST-SYS-SAFE-004 | センサー故障処理はテストされる必要がある（LiDAR故障、カメラ故障、IMU故障 → 安全停止） | クリティカル | フェイルセーフ動作を検証 |
| TEST-SYS-SAFE-005 | ネットワーク故障処理はテストされる必要がある（WiFi/LTE喪失 → 自律運用、テレメトリーバッファ） | 高 | オフライン運用を検証 |
| TEST-SYS-SAFE-006 | 傾斜安全性はテストされる必要がある（傾斜>10°で停止、傾斜>5°でドッキング拒否） | クリティカル | 傾斜制限を強制 |

---

## 5. フィールドテスト要件

### 5.1 環境テスト

| ID | 要件 | 優先度 | 受入基準 |
|----|-------------|----------|---------------------|
| TEST-FIELD-ENV-001 | 屋外運用は雨中にテストされる必要がある（軽い雨5mm/時、2時間継続） | クリティカル | 浸水なし、運用継続 |
| TEST-FIELD-ENV-002 | 屋外運用は極端な温度でテストされる必要がある（-5°C、+40°C） | 高 | 極端な温度で運用を検証 |
| TEST-FIELD-ENV-003 | 屋外運用は強風でテストされる必要がある（風速15 m/s） | 中 | 安定性を維持 |
| TEST-FIELD-ENV-004 | 夜間運用はテストされる必要がある（低照度<10ルクス、照明システムが機能的） | 高 | 夜間運用を検証 |
| TEST-FIELD-ENV-005 | 屋内/屋外遷移はテストされる必要がある（照明変化、表面変化） | 高 | シームレスな遷移を検証 |

### 5.2 地形テスト

| ID | 要件 | 優先度 | 受入基準 |
|----|-------------|----------|---------------------|
| TEST-FIELD-TERRAIN-001 | 傾斜ナビゲーションはテストされる必要がある（5°、8°、10°傾斜、上下） | クリティカル | 傾斜処理を検証 |
| TEST-FIELD-TERRAIN-002 | 荒れた地形はテストされる必要がある（砂利、石畳、草） | 高 | 地形処理を検証 |
| TEST-FIELD-TERRAIN-003 | 縁石検出はテストされる必要がある（高さ>50mmの縁石を検出して回避） | クリティカル | 縁石回避を検証 |
| TEST-FIELD-TERRAIN-004 | 狭い経路ナビゲーションはテストされる必要がある（幅1.5mの経路、タイトなクリアランス） | 高 | 狭い経路ナビゲーションが機能的 |

### 5.3 実環境シナリオテスト

| ID | 要件 | 優先度 | 受入基準 |
|----|-------------|----------|---------------------|
| TEST-FIELD-REAL-001 | 混雑した環境はテストされる必要がある（歩行者が経路を横断、動的障害物） | クリティカル | 群衆での安全なナビゲーション |
| TEST-FIELD-REAL-002 | 長距離ナビゲーションはテストされる必要がある（1km連続ミッション、介入なし） | 高 | 長距離自律性を検証 |
| TEST-FIELD-REAL-003 | 終日運用はテストされる必要がある（8時間連続運用、複数ミッション） | 高 | 耐久性を検証 |
| TEST-FIELD-REAL-004 | ユーザー受入テストは実施される必要がある（実際の介護者、患者がシステムを使用） | 高 | ユーザーフィードバックを収集 |

---

## 6. パフォーマンステスト要件

### 6.1 遅延テスト

| ID | 要件 | 優先度 | 受入基準 |
|----|-------------|----------|---------------------|
| TEST-PERF-LAT-001 | 制御ループ遅延は測定される必要がある（センサー入力 → 制御出力<50ms） | クリティカル | 遅延<50msを検証 |
| TEST-PERF-LAT-002 | ナビゲーション再計画遅延は測定される必要がある（障害物検出 → 新規経路<2秒） | 高 | 再計画<2秒を検証 |
| TEST-PERF-LAT-003 | TVMテレメトリー遅延は測定される必要がある（車両ステータス → フリートUI更新<5秒） | 中 | テレメトリー遅延<5秒 |
| TEST-PERF-LAT-004 | テレオペレーション遅延は測定される必要がある（オペレーター入力 → 車両応答<100ms WiFi、<500ms LTE） | 高 | テレオペ遅延を検証 |

### 6.2 スループットテスト

| ID | 要件 | 優先度 | 受入基準 |
|----|-------------|----------|---------------------|
| TEST-PERF-THRU-001 | CANバススループットは測定される必要がある（メッセージレート、利用率<70%） | 高 | CAN利用率が許容範囲内 |
| TEST-PERF-THRU-002 | ネットワークスループットは測定される必要がある（テレメトリーデータレート、ビデオストリーミングビットレート） | 中 | 帯域幅使用が制限内 |
| TEST-PERF-THRU-003 | ROS 2トピックスループットは測定される必要がある（すべてのトピックのメッセージレート） | 中 | トピックレートが許容範囲内 |

### 6.3 耐久テスト

| ID | 要件 | 優先度 | 受入基準 |
|----|-------------|----------|---------------------|
| TEST-PERF-END-001 | 24時間連続運用はテストされる必要がある（クラッシュなし、メモリリークなし、劣化なし） | 高 | 24時間運用成功 |
| TEST-PERF-END-002 | 1000km自律ナビゲーションはテストされる必要がある（累積距離、安全インシデントゼロ） | クリティカル | 1000kmマイルストーン達成 |
| TEST-PERF-END-003 | 10,000充電サイクルはテストされる必要がある（バッテリー健全性、接点摩耗） | 中 | バッテリー寿命を検証 |

### 6.4 ストレステスト

| ID | 要件 | 優先度 | 受入基準 |
|----|-------------|----------|---------------------|
| TEST-PERF-STRESS-001 | 高負荷シナリオはテストされる必要がある（50+車両が同時にTVMサーバーに報告） | 中 | サーバーが負荷を処理 |
| TEST-PERF-STRESS-002 | 迅速なミッション割り当てはテストされる必要がある（1分間に100ミッション作成） | 中 | システムが応答性を維持 |
| TEST-PERF-STRESS-003 | ネットワーク劣化はテストされる必要がある（パケットロス10%、20%、30% → グレースフル劣化） | 高 | グレースフル劣化を検証 |

---

## 7. リグレッションテスト要件

| ID | 要件 | 優先度 | 受入基準 |
|----|-------------|----------|---------------------|
| TEST-REGR-001 | 自動リグレッションテストスイートはすべてのソフトウェアリリースで実行される必要がある | クリティカル | すべてのリグレッションテストが合格 |
| TEST-REGR-002 | リグレッションテストはすべてのクリティカル機能をカバーする必要がある（ナビゲーション、ドッキング、安全） | クリティカル | クリティカルパスカバレッジ100% |
| TEST-REGR-003 | リグレッションテスト実行時間は<30分である必要がある | 高 | 高速リグレッションフィードバック |
| TEST-REGR-004 | リグレッションテスト失敗はリリース展開をブロックする必要がある | クリティカル | 失敗したテストでのリリースなし |

---

## 8. 受入テスト要件

### 8.1 工場受入テスト（FAT）

| ID | 要件 | 優先度 | 受入基準 |
|----|-------------|----------|---------------------|
| TEST-ACCEPT-FAT-001 | 各車両は出荷前にFATに合格する必要がある: ハードウェア検査、ソフトウェアテスト、キャリブレーション | クリティカル | 100% FAT合格率 |
| TEST-ACCEPT-FAT-002 | FATには以下を含める必要がある: モーターコントローラーテスト、センサー検証、ナビゲーションデモ、安全システムチェック | クリティカル | すべてのFAT項目完了 |
| TEST-ACCEPT-FAT-003 | FATチェックリストは文書化され、QAエンジニアによって署名される必要がある | 高 | FATドキュメント完成 |

### 8.2 サイト受入テスト（SAT）

| ID | 要件 | 優先度 | 受入基準 |
|----|-------------|----------|---------------------|
| TEST-ACCEPT-SAT-001 | 車両は展開サイトでSATに合格する必要がある: マップ検証、接続テスト、ミッションシミュレーション | クリティカル | 稼働前のSAT合格 |
| TEST-ACCEPT-SAT-002 | SATには顧客サインオフを含める必要がある（顧客が成功したテストミッションを目撃） | クリティカル | 顧客承認を文書化 |
| TEST-ACCEPT-SAT-003 | SATはサイト固有の構成を検証する必要がある（ジオフェンス、充電ステーション、WiFi） | 高 | サイト固有セットアップを検証 |

---

## 9. 安全テスト要件

### 9.1 安全認証テスト

| ID | 要件 | 優先度 | 受入基準 |
|----|-------------|----------|---------------------|
| TEST-SAFE-CERT-001 | システムはサードパーティ安全評価を受ける必要がある（ISO 13849 PLd、SIL 2機能安全） | クリティカル | 安全認証取得 |
| TEST-SAFE-CERT-002 | 緊急停止システムは認証される必要がある（IEC 60204-1カテゴリ0停止） | クリティカル | 緊急停止認証取得 |
| TEST-SAFE-CERT-003 | リスク評価はすべての運用モードで実施される必要がある（HAZOP、FMEA） | クリティカル | リスク評価を文書化 |

### 9.2 フェイルセーフテスト

| ID | 要件 | 優先度 | 受入基準 |
|----|-------------|----------|---------------------|
| TEST-SAFE-FAIL-001 | すべての単一点故障はテストされる必要がある（フェイルセーフ動作を検証） | クリティカル | すべての故障が安全停止に |
| TEST-SAFE-FAIL-002 | センサーフュージョン劣化はテストされる必要がある（LiDARのみ、カメラのみ運用） | 高 | 劣化運用が安全 |
| TEST-SAFE-FAIL-003 | ソフトウェアクラッシュ回復はテストされる必要がある（ナビゲーションノードクラッシュ → ウォッチドッグ再起動） | 高 | 5秒以内に回復 |

---

## 10. テスト自動化要件

| ID | 要件 | 優先度 | 受入基準 |
|----|-------------|----------|---------------------|
| TEST-AUTO-001 | CI/CDパイプラインはすべてのコミットで自動テストを実行する必要がある（ユニット、統合、リグレッション） | クリティカル | CI/CDが機能的 |
| TEST-AUTO-002 | 夜間自動テストは包括的テストスイートを実行する必要がある（8時間フルシステムテスト） | 高 | 夜間テストをスケジュール |
| TEST-AUTO-003 | テスト結果はダッシュボードに公開される必要がある（テスト合格率、カバレッジ、トレンド） | 高 | ダッシュボードがアクセス可能 |
| TEST-AUTO-004 | 自動テストはシミュレーション環境で実行される必要がある（Gazebo、モックセンサー） | 高 | シミュレーションテストが機能的 |

---

## 11. テストドキュメント要件

| ID | 要件 | 優先度 | 受入基準 |
|----|-------------|----------|---------------------|
| TEST-DOC-001 | テスト計画は各テストフェーズで文書化される必要がある（ユニット、統合、システム、フィールド） | クリティカル | テスト計画が利用可能 |
| TEST-DOC-002 | テストケースは次の内容で文書化される必要がある: ID、説明、前提条件、ステップ、期待結果 | 高 | テストケースを文書化 |
| TEST-DOC-003 | テスト結果は次の内容でログされる必要がある: タイムスタンプ、テスター、合格/不合格、欠陥ID | 高 | テストログを維持 |
| TEST-DOC-004 | トレーサビリティマトリクスは要件 → テストケースをマップする必要がある（すべての要件がテストされていることを検証） | クリティカル | トレーサビリティマトリクス完成 |

---

## 12. テストメトリクスとKPI

| メトリクス | 目標 | 測定方法 |
|--------|--------|-------------------|
| ユニットテストカバレッジ | ≥80% | コードカバレッジツール（coverage.py、gcov） |
| 統合テスト合格率 | 100% | CI/CDテスト結果 |
| システムテスト成功率 | ≥95% | フィールドテストミッションログ |
| 安全テスト合格率 | 100% | 安全認証レポート |
| 欠陥密度 | <5欠陥/KLOC | 欠陥追跡システム |
| テスト自動化カバレッジ | ≥70% | 自動対手動テスト比率 |
| 欠陥検出平均時間 | <24時間 | CI/CDパイプライン監視 |
| 欠陥修正平均時間 | <7日 | 欠陥追跡ライフサイクル |

---

## 13. 要件サマリー

| カテゴリ | 数 | 優先度内訳 |
|----------|-------|-------------------|
| ユニットテスト | 11 | クリティカル: 7、高: 4 |
| 統合テスト | 12 | クリティカル: 9、高: 3 |
| システムテスト | 17 | クリティカル: 10、高: 6、中: 1 |
| フィールドテスト | 14 | クリティカル: 6、高: 7、中: 1 |
| パフォーマンステスト | 13 | クリティカル: 2、高: 7、中: 4 |
| リグレッションテスト | 4 | クリティカル: 3、高: 1 |
| 受入テスト | 6 | クリティカル: 5、高: 1 |
| 安全テスト | 7 | クリティカル: 6、高: 1 |
| テスト自動化 | 4 | クリティカル: 1、高: 3 |
| テストドキュメント | 4 | クリティカル: 2、高: 2 |
| **合計** | **92** | **クリティカル: 51、高: 35、中: 6** |

---

## 14. テストタイムラインとフェーズ

```
開発フェーズ                  テスト活動
────────────────────────────────────────────────────────
第1-10週: コンポーネント開発  → ユニットテスト（継続的）
第11-15週: 統合              → 統合テスト
第16-20週: システム構築      → システムテスト + 安全テスト
第21-25週: フィールドトライアル → フィールドテスト + パフォーマンステスト
第26-28週: 受入              → FAT + SAT + 認証
第29週+: 展開                → リグレッションテスト（継続中）
```

---

## 15. テスト環境要件

| 環境 | 目的 | コンポーネント |
|-------------|---------|-----------|
| **シミュレーション** | 初期テスト、CI/CD | Gazeboシミュレーター、モックセンサー、仮想TVMサーバー |
| **ラボ** | ハードウェアインループテスト | テスト車両、センサーリグ、制御環境 |
| **テストトラック** | フィールドテスト | 障害物、傾斜、充電ステーションを備えた屋外コース |
| **パイロットサイト** | 実環境検証 | 実際の展開サイト、実際のユーザー、本番条件 |

---

## 16. 改訂履歴

| バージョン | 日付 | 作成者 | 変更内容 |
|---------|------|--------|---------|
| 1.0 | 2025-12-16 | マルチチーム | 初版包括的テスト要件（92要件） |

---

**ドキュメント終了**

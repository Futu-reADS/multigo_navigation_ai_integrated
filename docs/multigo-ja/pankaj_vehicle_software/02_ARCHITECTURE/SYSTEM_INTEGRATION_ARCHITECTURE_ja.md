# システム統合アーキテクチャ

**プロジェクト:** 屋外車椅子輸送ロボット - マルチチームシステム
**文書タイプ:** 統合アーキテクチャ仕様
**チーム責任:** システムアーキテクト（全チーム調整）
**日付:** 2025年12月16日
**バージョン:** 1.0

---

## 統合ポイント

### 1. 車両 ↔ フリート管理統合

| ID | アーキテクチャ決定 | 理由 | 代替案 |
|----|-------------|----------|---------------------|
| INT-ARCH-001 | 車両はREST API + WebSocket経由でTVMサーバーと通信する | HTTP/WSS標準プロトコル、ファイアウォール透過 | MQTT（より複雑）、gRPC（ブラウザサポート限定的） |
| INT-ARCH-002 | 車両は5秒ごとにテレメトリバッチを送信する（個別イベントではない） | 帯域幅削減、サーバー負荷削減 | イベントごとの送信（帯域幅浪費） |
| INT-ARCH-003 | ミッションコマンドはWebSocket経由で受信する（REST APIではなく） | 低レイテンシ（ポーリング不要） | HTTPロングポーリング（レイテンシ増加） |
| INT-ARCH-004 | 車両はネットワーク障害時にテレメトリをローカルにバッファリングする | オフライン耐性、データ損失なし | バッファリングなし（サービス外時のデータ損失） |

### 2. 車両ソフトウェア ↔ ハードウェア統合

| ID | アーキテクチャ決定 | 理由 | 代替案 |
|----|-------------|----------|------------------------|
| INT-ARCH-005 | ROS 2ノードはCANバス経由でモーターコントローラーと通信する | 車両で標準的、高信頼性、低レイテンシ | イーサネット（オーバーヘッド大）、シリアル（帯域幅限定的） |
| INT-ARCH-006 | センサーデータはROS 2トピック経由でパブリッシュする | ROS 2標準、ツールとの互換性 | カスタムプロトコル（車輪の再発明） |
| INT-ARCH-007 | 緊急停止はハードウェアリレーとソフトウェアトピックの両方を使用する | 多重化安全性、ハードウェアフェイルセーフ | ソフトウェアのみ（単一障害点） |

### 3. マルチチーム開発統合

| ID | アーキテクチャ決定 | 理由 | 代替案 |
|----|-------------|----------|------------------------|
| INT-ARCH-008 | チームは定義されたインターフェース経由で統合する（TVM API、ハードウェア-ソフトウェア、ROS 2トピック） | 明確な責任分離、並行開発 | 密結合統合（並行開発不可） |
| INT-ARCH-009 | インターフェース変更はすべて影響を受けるチームに事前通知する | 破壊的変更の回避、統合リスク削減 | 通知なし（統合破損リスク） |
| INT-ARCH-010 | 統合テストは全チーム出席で毎週実施する | 早期問題検出、統合同期 | テストなし（後期統合問題） |

---

## 統合アーキテクチャ図

```
┌──────────────────────────────────────────────────────────────┐
│                      マルチチームシステム                         │
│                                                              │
│  ┌───────────────────────────────────────────────────────┐  │
│  │            Unnoチーム（フリート管理）                      │  │
│  │                                                          │  │
│  │  ┌─────────────────────────────────────────────┐       │  │
│  │  │  TVMサーバー（Node.js + PostgreSQL）         │       │  │
│  │  │  - REST API（車両コマンド、ミッション）      │       │  │
│  │  │  - WebSocket（リアルタイムテレメトリ）       │       │  │
│  │  │  - データベース（フリートデータ、ミッション） │       │  │
│  │  └──────────────────────┬──────────────────────┘       │  │
│  └────────────────────────┼──────────────────────────────┘  │
│                           │                                  │
│                           │ HTTPS/WSS (TVM API)              │
│                           ↓                                  │
│  ┌────────────────────────────────────────────────────────┐ │
│  │            Pankajチーム（車両ソフトウェア）              │ │
│  │                                                          │ │
│  │  ┌─────────────────────────────────────────────┐       │ │
│  │  │  車両ソフトウェア（ROS 2 Humble）             │       │ │
│  │  │  - ナビゲーション（Nav2、NDT）               │       │ │
│  │  │  - ドッキング（ArUco）                       │       │ │
│  │  │  - 知覚（LiDAR処理）                        │       │ │
│  │  │  - 制御（Swerveドライブ）                   │       │ │
│  │  │  - TVMクライアント（REST + WebSocket）      │       │ │
│  │  └──────────────────────┬──────────────────────┘       │ │
│  └────────────────────────┼──────────────────────────────┘ │
│                           │                                  │
│                           │ CAN バス                         │
│                           ↓                                  │
│  ┌────────────────────────────────────────────────────────┐ │
│  │            土屋チーム（ハードウェア）                      │ │
│  │                                                          │ │
│  │  ┌─────────────────────────────────────────────┐       │ │
│  │  │  ハードウェアプラットフォーム                  │       │ │
│  │  │  - 4× Swerveモジュール（モーター + エンコーダ）│       │ │
│  │  │  - 3D LiDAR（360° スキャン）                │       │ │
│  │  │  - カメラ（2× RGB）                          │       │ │
│  │  │  - IMU、エンコーダー、バッテリーBMS           │       │ │
│  │  │  - 計算プラットフォーム（GMKtec Nucbox K6）   │       │ │
│  │  └─────────────────────────────────────────────┘       │ │
│  └──────────────────────────────────────────────────────────┘ │
│                                                              │
│  ┌────────────────────────────────────────────────────────┐ │
│  │            Kirilチーム（eHMI）                           │ │
│  │                                                          │ │
│  │  ┌─────────────────────────────────────────────┐       │ │
│  │  │  eHMIサブシステム（ESP32-S3）                │       │ │
│  │  │  - LEDストリップ（WS2812B、状態インジケーター）│       │ │
│  │  │  - LEDマトリックス（HUB75、方向アイコン）     │       │ │
│  │  │  - オーディオ（I2S、アナウンス）             │       │ │
│  │  │  - シリアル通信（ROS 2ノードへ）             │       │ │
│  │  └──────────────────────┬──────────────────────┘       │ │
│  └────────────────────────┼──────────────────────────────┘ │
└──────────────────────────────────────────────────────────────┘
```

---

## 統合契約（チーム間インターフェース）

### TVM API（Unno ↔ Pankaj）
- **インターフェース:** REST API + WebSocket
- **オーナー:** Unno（サーバー）、Pankaj（クライアント）
- **ドキュメント:** `../shared/INTERFACES/TVM_API_SPECIFICATION.md`
- **バージョニング:** API v1（セマンティックバージョニング、破壊的変更はメジャー++）

### ハードウェア-ソフトウェアインターフェース（土屋 ↔ Pankaj）
- **インターフェース:** CANバス、ROS 2トピック
- **オーナー:** 土屋（ハードウェア）、Pankaj（ソフトウェアドライバー）
- **ドキュメント:** `../shared/INTERFACES/HARDWARE_SOFTWARE_INTERFACES.md`
- **電気仕様:** CANピン配置、電圧レベル、コネクタ

### ROS 2トピック/サービス（Pankaj ↔ Kiril）
- **インターフェース:** ROS 2トピック、シリアルコマンド
- **オーナー:** Pankaj（パブリッシャー）、Kiril（サブスクライバー）
- **ドキュメント:** `../shared/INTERFACES/ROS_TOPICS_AND_SERVICES.md`
- **メッセージ定義:** カスタム`_msgs`パッケージ

---

## 統合スケジュール

**統合マイルストーン:**

| 週 | 統合マイルストーン | 関与チーム | 成果物 |
|------|----------------------|----------------|----------------|
| 1-10 | コンポーネント開発 | 全チーム（独立） | 単体テスト済みコンポーネント |
| 11-15 | ハードウェア-ソフトウェア統合 | Pankaj + 土屋 | ROS 2 ↔ CANバス検証済み |
| 16-18 | フリート統合 | Pankaj + Unno | 車両 ↔ TVM検証済み |
| 19-20 | システム統合 | 全チーム | 完全システム動作可能 |
| 21-25 | フィールド統合テスト | 全チーム | 実世界検証 |
| 26-28 | FAT + SAT | 全チーム + 顧客 | 受入テスト |

---

**文書ステータス:** ドラフト
**承認必要:** システムアーキテクト、チームリード（Pankaj、Unno、土屋、Kiril）

# 安全要件

**文書ID:** REQ-SAFE-001
**バージョン:** 1.0
**日付:** 2025-12-15
**ステータス:** ドラフト
**分類:** 内部

---

## 文書管理

| バージョン | 日付 | 著者 | 変更内容 |
|---------|------|--------|---------|
| 1.0 | 2025-12-15 | 安全エンジニア | 初期安全要件仕様 |

---

## 1. 導入

### 1.1 目的

この文書は、屋外優先車椅子搬送ロボットの**安全要件**を規定します。安全性は最優先サブシステムであり、すべての動作モード中に乗客の安全、運用の安全、環境の安全を確保します。

### 1.2 範囲

この仕様は以下をカバー:
- **乗客の安全** - 搬送中の車椅子乗客の保護
- **運用の安全** - 安全な自律運転（衝突回避、緊急停止）
- **環境の安全** - 様々な天候、傾斜、照明条件での安全運用
- **システムの安全** - 冗長性、故障検出、フェールセーフモード
- **ソフトウェアの安全** - 安全監視、速度ガバナー、衝突予測
- **ハードウェアの安全** - 緊急停止回路、センサー、ブレーキ

**範囲外:**
- 車椅子取り付けの機械設計（機械仕様でカバー）
- 物理的ドッキング機構の安全（DOCKING_SYSTEM_REQUIREMENTS.mdでカバー）
- バッテリー化学と電気安全（HARDWARE_REQUIREMENTS.mdでカバー）

### 1.3 関連文書

- **SYSTEM_REQUIREMENTS.md** - セクション1.3（SAFE-REQ-001～014）
- **OVERALL_SYSTEM_ARCHITECTURE.md** - セクション4（安全アーキテクチャ）
- **question_answers.md** - 安全性の明確化
- **EHMI_SYSTEM_REFERENCE.md** - 安全関連eHMI状態

### 1.4 安全哲学

システムは4層の**多層防御**安全戦略に従います:

**レイヤー1: 緊急停止（ハードウェア）**
- 物理的緊急停止ボタン（乗客+遠隔オペレーター）
- ハードウェアベースのモーターカットオフ（<100ms応答）
- ソフトウェア制御から独立

**レイヤー2: システム監視（ソフトウェアウォッチドッグ）**
- すべての重要サブシステムのリアルタイム監視
- センサー故障時の自動劣化モード
- 通信タイムアウト時の安全状態

**レイヤー3: 衝突回避（認識+計画）**
- 3D LiDAR障害物検出
- 動的障害物追跡
- 予測的衝突回避
- 安全ゾーン（停止<0.5m、減速<1.5m、注意<3m）

**レイヤー4: 運用安全（制約）**
- 速度制限（乗客あり1.0 m/s、なし1.5 m/s）
- 加速度制限（0.5 m/s²）
- 傾斜制限（最大10°）
- 天候制限（小雨のみ）

---

## 2. 乗客安全要件

### 2.1 速度制限（SAFE-PASS-SPEED）

| 要件ID | 要件 | 優先度 | 検証 |
|----------------|-------------|----------|------------|
| SAFE-PASS-SPEED-001 | システムは乗客搭乗時に1.0 m/sを超えてはならない | 重要 | 安全テスト |
| SAFE-PASS-SPEED-002 | システムはドッキング操作中に速度を0.5 m/sに制限すること | 重要 | 安全テスト |
| SAFE-PASS-SPEED-003 | システムは5°以上の傾斜で速度を0.3 m/sに制限すること | 重要 | 傾斜テスト |
| SAFE-PASS-SPEED-004 | システムは低視認性（<10m）で速度を0.7 m/sに削減すること | 高 | フィールドテスト |
| SAFE-PASS-SPEED-005 | システムはハードウェア速度ガバナー経由で速度制限を強制すること | 重要 | ハードウェア検査 |

**合計要件: 5**

---

### 2.2 加速度制限（SAFE-PASS-ACCEL）

| 要件ID | 要件 | 優先度 | 検証 |
|----------------|-------------|----------|------------|
| SAFE-PASS-ACCEL-001 | システムは乗客搭乗時に線形加速度を0.5 m/s²に制限すること | 重要 | 安全テスト |
| SAFE-PASS-ACCEL-002 | システムは乗客搭乗時に角加速度を0.3 rad/s²に制限すること | 重要 | 安全テスト |
| SAFE-PASS-ACCEL-003 | システムは乗客搭乗時にジャークを2.0 m/s³に制限すること | 高 | 安全テスト |
| SAFE-PASS-ACCEL-004 | システムは速度変更を≥1秒かけてランプすること | 高 | 安全テスト |
| SAFE-PASS-ACCEL-005 | システムはSカーブ加速プロファイルを使用すること（滑らかな開始/停止） | 中 | 統合テスト |

**合計要件: 5**

---

### 2.3 乗客検出（SAFE-PASS-DETECT）

| 要件ID | 要件 | 優先度 | 検証 |
|----------------|-------------|----------|------------|
| SAFE-PASS-DETECT-001 | システムは重量センサー経由で乗客の存在を検出すること（>20kg） | 重要 | ハードウェアテスト |
| SAFE-PASS-DETECT-002 | システムは搬送開始前に乗客検出を確認すること | 重要 | 安全テスト |
| SAFE-PASS-DETECT-003 | システムは搬送中に乗客重量がしきい値を下回った場合停止すること | 重要 | 故障注入テスト |
| SAFE-PASS-DETECT-004 | システムは乗客検出後にオペレーター確認を要求すること | 高 | 統合テスト |
| SAFE-PASS-DETECT-005 | システムはタイムスタンプ付きで乗客検出イベントを記録すること | 中 | ログ検査 |

**合計要件: 5**

---

### 2.4 傾斜検出と安定性（SAFE-PASS-TILT）

| 要件ID | 要件 | 優先度 | 検証 |
|----------------|-------------|----------|------------|
| SAFE-PASS-TILT-001 | システムは傾斜角度（ロール、ピッチ）を最小50 Hzで監視すること | 重要 | パフォーマンステスト |
| SAFE-PASS-TILT-002 | システムは傾斜が±15°を超えた場合警告を発すること（オーディオ+eHMI） | 重要 | 傾斜テスト |
| SAFE-PASS-TILT-003 | システムは傾斜が±20°を超えた場合即座に停止すること | 重要 | 安全テスト |
| SAFE-PASS-TILT-004 | システムは10°以上の傾斜での運用を防止すること | 重要 | 傾斜テスト |
| SAFE-PASS-TILT-005 | システムは動的安定性マージンを計算すること（リアルタイム） | 高 | 単体テスト |
| SAFE-PASS-TILT-006 | システムは初期傾斜が5°以上の場合ミッションを拒否すること | 高 | 統合テスト |

**合計要件: 6**

---

### 2.5 緊急停止（乗客主導）（SAFE-PASS-ESTOP）

| 要件ID | 要件 | 優先度 | 検証 |
|----------------|-------------|----------|------------|
| SAFE-PASS-ESTOP-001 | システムは乗客がアクセス可能な物理的緊急停止ボタンを持つこと | 重要 | ハードウェア検査 |
| SAFE-PASS-ESTOP-002 | システムは緊急停止作動時に1.0 m/sから0.5m以内で停止すること | 重要 | 制動テスト |
| SAFE-PASS-ESTOP-003 | システムは緊急停止後100ms以内にモーター電源を切断すること | 重要 | ハードウェアテスト |
| SAFE-PASS-ESTOP-004 | システムはeHMI緊急状態を作動すること（赤点滅、サイレン） | 重要 | 統合テスト |
| SAFE-PASS-ESTOP-005 | システムは緊急停止後に手動リセットを要求すること | 重要 | 安全テスト |
| SAFE-PASS-ESTOP-006 | システムは位置、タイムスタンプ、理由付きで緊急停止イベントを記録すること | 高 | ログ検査 |

**合計要件: 6**

---

### 2.6 シートベルトと拘束具（SAFE-PASS-RESTRAINT）

| 要件ID | 要件 | 優先度 | 検証 |
|----------------|-------------|----------|------------|
| SAFE-PASS-RESTRAINT-001 | システムは磁気センサー経由でシートベルト装着を検出すること | 重要 | ハードウェアテスト |
| SAFE-PASS-RESTRAINT-002 | システムはシートベルト未装着時に搬送開始を拒否すること | 重要 | 安全テスト |
| SAFE-PASS-RESTRAINT-003 | システムは搬送中にシートベルトが外れた場合オペレーターに警告すること | 重要 | 故障注入テスト |
| SAFE-PASS-RESTRAINT-004 | システムは搬送中にシートベルトが外れた場合即座に停止すること | 重要 | 安全テスト |

**合計要件: 4**

---

## 3. 運用安全要件

### 3.1 障害物検出（SAFE-OPS-OBS）

| 要件ID | 要件 | 優先度 | 検証 |
|----------------|-------------|----------|------------|
| SAFE-OPS-OBS-001 | システムは360°視野で障害物を検出すること | 重要 | フィールドテスト |
| SAFE-OPS-OBS-002 | システムは最小50 Hzで障害物を検出すること（3D LiDAR） | 重要 | パフォーマンステスト |
| SAFE-OPS-OBS-003 | システムは≥0.1m高さ、≥0.05m直径の障害物を検出すること | 重要 | 障害物テスト |
| SAFE-OPS-OBS-004 | システムは最大15m範囲で障害物を検出すること | 高 | フィールドテスト |
| SAFE-OPS-OBS-005 | システムは距離別に障害物を分類すること（停止、減速、注意ゾーン） | 重要 | 統合テスト |
| SAFE-OPS-OBS-006 | システムは動的障害物を追跡すること（歩行者、車両） | 高 | 追跡テスト |
| SAFE-OPS-OBS-007 | システムは障害物の軌道を予測すること（1-3秒） | 高 | 統合テスト |

**合計要件: 7**

---

### 3.2 安全ゾーン（SAFE-OPS-ZONE）

| 要件ID | 要件 | 優先度 | 検証 |
|----------------|-------------|----------|------------|
| SAFE-OPS-ZONE-001 | システムは停止ゾーンを定義すること（障害物から<0.5m） | 重要 | 統合テスト |
| SAFE-OPS-ZONE-002 | システムは障害物が停止ゾーンに入った場合即座に停止すること | 重要 | 安全テスト |
| SAFE-OPS-ZONE-003 | システムは減速ゾーンを定義すること（障害物から0.5-1.5m） | 重要 | 統合テスト |
| SAFE-OPS-ZONE-004 | システムは減速ゾーンで速度を0.3 m/sに削減すること | 重要 | 安全テスト |
| SAFE-OPS-ZONE-005 | システムは注意ゾーンを定義すること（障害物から1.5-3m） | 高 | 統合テスト |
| SAFE-OPS-ZONE-006 | システムは注意ゾーンで速度を0.7 m/sに削減すること | 高 | 安全テスト |
| SAFE-OPS-ZONE-007 | システムはロボット速度に基づいてゾーンサイズを適応すること | 高 | 統合テスト |

**合計要件: 7**

---

### 3.3 衝突回避（SAFE-OPS-COLL）

| 要件ID | 要件 | 優先度 | 検証 |
|----------------|-------------|----------|------------|
| SAFE-OPS-COLL-001 | システムはすべての障害物の衝突時間（TTC）を計算すること | 重要 | 単体テスト |
| SAFE-OPS-COLL-002 | システムはTTC<2秒の場合制動を開始すること | 重要 | 安全テスト |
| SAFE-OPS-COLL-003 | システムは5秒以内に衝突が予測される場合経路を再計画すること | 高 | 統合テスト |
| SAFE-OPS-COLL-004 | システムは回避よりも減速を優先すること（乗客の快適性） | 高 | 安全テスト |
| SAFE-OPS-COLL-005 | システムは障害物から≥1.0mの安全距離を維持すること | 重要 | フィールドテスト |
| SAFE-OPS-COLL-006 | システムは保守的なバウンディングボックスを使用すること（ロボット+0.2mマージン） | 重要 | 設定 |

**合計要件: 6**

---

### 3.4 緊急停止（自動）（SAFE-OPS-ESTOP）

| 要件ID | 要件 | 優先度 | 検証 |
|----------------|-------------|----------|------------|
| SAFE-OPS-ESTOP-001 | システムは障害物<0.3mの場合緊急停止を開始すること | 重要 | 安全テスト |
| SAFE-OPS-ESTOP-002 | システムは傾斜>20°の場合緊急停止を開始すること | 重要 | 傾斜テスト |
| SAFE-OPS-ESTOP-003 | システムはセンサー故障検出時に緊急停止を開始すること | 重要 | 故障注入テスト |
| SAFE-OPS-ESTOP-004 | システムは通信タイムアウト（>1秒）時に緊急停止を開始すること | 重要 | タイムアウトテスト |
| SAFE-OPS-ESTOP-005 | システムはソフトウェアクラッシュ検出時に緊急停止を開始すること | 重要 | 故障注入テスト |
| SAFE-OPS-ESTOP-006 | システムは完全なセンサースナップショット付きで緊急停止理由を記録すること | 高 | ログ検査 |

**合計要件: 6**

---

### 3.5 遠隔緊急停止（SAFE-OPS-REMOTE）

| 要件ID | 要件 | 優先度 | 検証 |
|----------------|-------------|----------|------------|
| SAFE-OPS-REMOTE-001 | システムはUI経由の遠隔緊急停止をサポートすること | 重要 | 統合テスト |
| SAFE-OPS-REMOTE-002 | システムは専用ワイヤレスボタン経由の遠隔緊急停止をサポートすること | 高 | ハードウェアテスト |
| SAFE-OPS-REMOTE-003 | システムは500ms以内に遠隔緊急停止を実行すること | 重要 | レイテンシーテスト |
| SAFE-OPS-REMOTE-004 | システムは10 Hzハートビートで遠隔緊急停止接続を維持すること | 重要 | パフォーマンステスト |
| SAFE-OPS-REMOTE-005 | システムはハートビート喪失時に自動緊急停止を開始すること | 重要 | 故障注入テスト |

**合計要件: 5**

---

### 3.6 劣化モード運用（SAFE-OPS-DEGRADE）

| 要件ID | 要件 | 優先度 | 検証 |
|----------------|-------------|----------|------------|
| SAFE-OPS-DEGRADE-001 | システムはLiDAR故障時に劣化モードに入ること（カメラのみ） | 高 | 故障注入テスト |
| SAFE-OPS-DEGRADE-002 | システムは劣化モードで最大速度を0.5 m/sに削減すること | 重要 | 安全テスト |
| SAFE-OPS-DEGRADE-003 | システムは劣化モードをオペレーターに通知すること（eHMI + UI） | 重要 | 統合テスト |
| SAFE-OPS-DEGRADE-004 | システムは劣化モードで乗客搬送を拒否すること | 重要 | 安全テスト |
| SAFE-OPS-DEGRADE-005 | システムはナビゲーション故障時にリンプホームモードに入ること | 高 | 統合テスト |
| SAFE-OPS-DEGRADE-006 | システムは複数の重要センサーが故障した場合停止すること | 重要 | 故障注入テスト |

**合計要件: 6**

---

## 4. 環境安全要件

### 4.1 傾斜制限（SAFE-ENV-SLOPE）

| 要件ID | 要件 | 優先度 | 検証 |
|----------------|-------------|----------|------------|
| SAFE-ENV-SLOPE-001 | システムは100kg負荷で最大10°（17.6%勾配）の傾斜で動作すること | 重要 | 傾斜テスト |
| SAFE-ENV-SLOPE-002 | システムは10°以上の傾斜での運用を拒否すること | 重要 | 傾斜テスト |
| SAFE-ENV-SLOPE-003 | システムは5°以上の傾斜で速度を0.3 m/sに削減すること | 重要 | 安全テスト |
| SAFE-ENV-SLOPE-004 | システムはリアルタイムで傾斜角度を計算すること（ロール+ピッチ） | 重要 | 単体テスト |
| SAFE-ENV-SLOPE-005 | システムは7°以上の傾斜に接近している場合オペレーターに警告すること | 高 | 統合テスト |

**合計要件: 5**

---

### 4.2 天候制限（SAFE-ENV-WEATHER）

| 要件ID | 要件 | 優先度 | 検証 |
|----------------|-------------|----------|------------|
| SAFE-ENV-WEATHER-001 | システムは小雨（<2.5mm/hr）で動作すること | 高 | 降雨チャンバーテスト |
| SAFE-ENV-WEATHER-002 | システムは大雨（>7.5mm/hr）での運用を拒否すること | 重要 | 雨センサーテスト |
| SAFE-ENV-WEATHER-003 | システムは雨センサー故障時に運用を拒否すること | 高 | 故障注入テスト |
| SAFE-ENV-WEATHER-004 | システムは風速を監視し、>40 km/hの場合運用を拒否すること | 高 | 風テスト |
| SAFE-ENV-WEATHER-005 | システムは雨天時に速度を0.7 m/sに削減すること | 高 | 安全テスト |

**合計要件: 5**

---

### 4.3 温度制限（SAFE-ENV-TEMP）

| 要件ID | 要件 | 優先度 | 検証 |
|----------------|-------------|----------|------------|
| SAFE-ENV-TEMP-001 | システムは-10°C～+45°Cの周囲温度で動作すること | 高 | 気候チャンバー |
| SAFE-ENV-TEMP-002 | システムは温度<-5°Cまたは>40°Cの場合オペレーターに警告すること | 中 | 統合テスト |
| SAFE-ENV-TEMP-003 | システムはバッテリー温度を監視し、>60°Cの場合運用を拒否すること | 重要 | 温度センサーテスト |
| SAFE-ENV-TEMP-004 | システムはモーター温度を監視し、>80°Cの場合電力を削減すること | 高 | 熱テスト |

**合計要件: 4**

---

### 4.4 照明要件（SAFE-ENV-LIGHT）

| 要件ID | 要件 | 優先度 | 検証 |
|----------------|-------------|----------|------------|
| SAFE-ENV-LIGHT-001 | システムは日中（1,000-100,000 lux）で動作すること | 重要 | フィールドテスト |
| SAFE-ENV-LIGHT-002 | システムは夜間（<10 lux）にアクティブ照明で動作すること | 高 | 夜間テスト |
| SAFE-ENV-LIGHT-003 | システムは周囲<500 luxで自動的にヘッドライトを作動すること | 高 | 統合テスト |
| SAFE-ENV-LIGHT-004 | システムは運用中に安全ビーコン（赤点滅）を作動すること | 重要 | ハードウェア検査 |
| SAFE-ENV-LIGHT-005 | システムは低視認性（<10m）で速度を0.7 m/sに削減すること | 高 | 安全テスト |

**合計要件: 5**

---

## 5. システム安全要件

### 5.1 冗長性（SAFE-SYS-REDUND）

| 要件ID | 要件 | 優先度 | 検証 |
|----------------|-------------|----------|------------|
| SAFE-SYS-REDUND-001 | システムは冗長な緊急停止回路を持つこと（2×独立） | 重要 | ハードウェア検査 |
| SAFE-SYS-REDUND-002 | システムは冗長な通信リンクを持つこと（WiFi + LTE） | 高 | 統合テスト |
| SAFE-SYS-REDUND-003 | システムは傾斜検出用にデュアルIMUを持つこと | 高 | ハードウェア検査 |
| SAFE-SYS-REDUND-004 | システムは複数のセンサーからデータを融合すること（LiDAR + カメラ） | 重要 | 統合テスト |
| SAFE-SYS-REDUND-005 | システムはデュアル電源を使用すること（メイン+バックアップ） | 中 | ハードウェア検査 |

**合計要件: 5**

---

### 5.2 故障検出（SAFE-SYS-FAULT）

| 要件ID | 要件 | 優先度 | 検証 |
|----------------|-------------|----------|------------|
| SAFE-SYS-FAULT-001 | システムはLiDAR故障を検出すること（>1秒間データなし） | 重要 | 故障注入テスト |
| SAFE-SYS-FAULT-002 | システムはカメラ故障を検出すること（>1秒間フレームなし） | 重要 | 故障注入テスト |
| SAFE-SYS-FAULT-003 | システムはIMU故障を検出すること（データなしまたは凍結値） | 重要 | 故障注入テスト |
| SAFE-SYS-FAULT-004 | システムはモーターコントローラー故障を検出すること（フィードバックなし） | 重要 | 故障注入テスト |
| SAFE-SYS-FAULT-005 | システムはバッテリー故障を検出すること（電圧降下、過電流） | 重要 | バッテリー故障テスト |
| SAFE-SYS-FAULT-006 | システムは最小1 Hzで診断を公開すること | 高 | 統合テスト |

**合計要件: 6**

---

### 5.3 フェールセーフモード（SAFE-SYS-FAILSAFE）

| 要件ID | 要件 | 優先度 | 検証 |
|----------------|-------------|----------|------------|
| SAFE-SYS-FAILSAFE-001 | システムは重要センサー故障時に安全状態に入ること（停止、保持） | 重要 | 故障注入テスト |
| SAFE-SYS-FAILSAFE-002 | システムは非重要センサー故障時にリンプホームモードに入ること | 高 | 統合テスト |
| SAFE-SYS-FAILSAFE-003 | システムは安全重要故障時に乗客搬送を無効にすること | 重要 | 安全テスト |
| SAFE-SYS-FAILSAFE-004 | システムはすべての故障モードで緊急停止機能を維持すること | 重要 | 安全テスト |
| SAFE-SYS-FAILSAFE-005 | システムはフェールセーフモードへのすべての遷移を記録すること | 高 | ログ検査 |

**合計要件: 5**

---

### 5.4 ウォッチドッグタイマー（SAFE-SYS-WATCHDOG）

| 要件ID | 要件 | 優先度 | 検証 |
|----------------|-------------|----------|------------|
| SAFE-SYS-WATCHDOG-001 | システムはハードウェアウォッチドッグタイマーを実装すること（1秒タイムアウト） | 重要 | ハードウェア検査 |
| SAFE-SYS-WATCHDOG-002 | システムはウォッチドッグタイムアウト時にリセットすること | 重要 | 故障注入テスト |
| SAFE-SYS-WATCHDOG-003 | システムは重要ノード用のソフトウェアウォッチドッグを実装すること | 重要 | 統合テスト |
| SAFE-SYS-WATCHDOG-004 | システムはソフトウェアウォッチドッグ期限切れ時に安全状態に入ること | 重要 | 故障注入テスト |
| SAFE-SYS-WATCHDOG-005 | システムは10 Hzで安全監視からの明示的なハートビートを要求すること | 重要 | パフォーマンステスト |

**合計要件: 5**

---

### 5.5 通信タイムアウト（SAFE-SYS-TIMEOUT）

| 要件ID | 要件 | 優先度 | 検証 |
|----------------|-------------|----------|------------|
| SAFE-SYS-TIMEOUT-001 | システムは>1秒間cmd_velを受信しない場合タイムアウトすること | 重要 | タイムアウトテスト |
| SAFE-SYS-TIMEOUT-002 | システムは>1秒間センサーデータを受信しない場合タイムアウトすること | 重要 | タイムアウトテスト |
| SAFE-SYS-TIMEOUT-003 | システムは>5秒間UIハートビートを受信しない場合タイムアウトすること | 高 | タイムアウトテスト |
| SAFE-SYS-TIMEOUT-004 | システムは任意の重要タイムアウト時に安全停止を開始すること | 重要 | 安全テスト |

**合計要件: 4**

---

## 6. ソフトウェア安全要件

### 6.1 安全監視ノード（SAFE-SW-SUPER）

| 要件ID | 要件 | 優先度 | 検証 |
|----------------|-------------|----------|------------|
| SAFE-SW-SUPER-001 | システムは専用のsafety_supervisor_nodeを実装すること（C++） | 重要 | コード検査 |
| SAFE-SW-SUPER-002 | 安全監視は専用CPUコアで実行すること（分離） | 高 | システム設定 |
| SAFE-SW-SUPER-003 | 安全監視は10 Hzですべての重要サブシステムを監視すること | 重要 | パフォーマンステスト |
| SAFE-SW-SUPER-004 | 安全監視は速度コマンドをオーバーライドする権限を持つこと | 重要 | 統合テスト |
| SAFE-SW-SUPER-005 | 安全監視は/safety/statusトピックに診断を公開すること | 重要 | 統合テスト |
| SAFE-SW-SUPER-006 | 安全監視はすべての安全違反を記録すること | 高 | ログ検査 |

**合計要件: 6**

---

### 6.2 速度ガバナー（SAFE-SW-VGOV）

| 要件ID | 要件 | 優先度 | 検証 |
|----------------|-------------|----------|------------|
| SAFE-SW-VGOV-001 | システムはすべてのcmd_velコマンドをフィルタリングする速度ガバナーを実装すること | 重要 | 統合テスト |
| SAFE-SW-VGOV-002 | 速度ガバナーは乗客速度制限（1.0 m/s）を強制すること | 重要 | 安全テスト |
| SAFE-SW-VGOV-003 | 速度ガバナーは加速度制限（0.5 m/s²）を強制すること | 重要 | 安全テスト |
| SAFE-SW-VGOV-004 | 速度ガバナーは安全制限を超えるコマンドを拒否すること | 重要 | 単体テスト |
| SAFE-SW-VGOV-005 | 速度ガバナーはフィルタリングされたコマンドを/cmd_vel_safeトピックに公開すること | 重要 | 統合テスト |

**合計要件: 5**

---

### 6.3 衝突予測（SAFE-SW-PRED）

| 要件ID | 要件 | 優先度 | 検証 |
|----------------|-------------|----------|------------|
| SAFE-SW-PRED-001 | システムはLiDAR+速度を使用する衝突予測を実装すること | 重要 | 単体テスト |
| SAFE-SW-PRED-002 | 衝突予測はすべての障害物の衝突時間（TTC）を計算すること | 重要 | 統合テスト |
| SAFE-SW-PRED-003 | 衝突予測は1-3秒先の衝突を予測すること | 重要 | 安全テスト |
| SAFE-SW-PRED-004 | 衝突予測はTTC<1秒の場合緊急停止をトリガーすること | 重要 | 安全テスト |
| SAFE-SW-PRED-005 | 衝突予測は/safety/collisionトピックに衝突警告を公開すること | 高 | 統合テスト |

**合計要件: 5**

---

### 6.4 緊急停止ハンドラー（SAFE-SW-ESTOP）

| 要件ID | 要件 | 優先度 | 検証 |
|----------------|-------------|----------|------------|
| SAFE-SW-ESTOP-001 | システムは緊急停止ハンドラーを実装すること（ハードウェア+ソフトウェア） | 重要 | コード検査 |
| SAFE-SW-ESTOP-002 | 緊急停止は50ms以内にゼロ速度コマンドを公開すること | 重要 | レイテンシーテスト |
| SAFE-SW-ESTOP-003 | 緊急停止はすべてのモーションコントローラーを無効にすること | 重要 | 統合テスト |
| SAFE-SW-ESTOP-004 | 緊急停止はeHMI緊急状態を作動すること | 重要 | 統合テスト |
| SAFE-SW-ESTOP-005 | 緊急停止はUI経由の手動リセットを要求すること | 重要 | 安全テスト |

**合計要件: 5**

---

### 6.5 ハートビート監視（SAFE-SW-HEART）

| 要件ID | 要件 | 優先度 | 検証 |
|----------------|-------------|----------|------------|
| SAFE-SW-HEART-001 | すべての重要ノードは最小10 Hzでハートビートを公開すること | 重要 | 統合テスト |
| SAFE-SW-HEART-002 | 安全監視はすべての重要ノードからのハートビートを監視すること | 重要 | 統合テスト |
| SAFE-SW-HEART-003 | システムは任意の重要ハートビート喪失時に安全停止を開始すること | 重要 | 故障注入テスト |
| SAFE-SW-HEART-004 | ハートビートメッセージはノードステータスとタイムスタンプを含むこと | 中 | メッセージ検査 |

**合計要件: 4**

---

## 7. ハードウェア安全要件

### 7.1 緊急停止回路（SAFE-HW-ESTOP）

| 要件ID | 要件 | 優先度 | 検証 |
|----------------|-------------|----------|------------|
| SAFE-HW-ESTOP-001 | システムはハードウェア緊急停止回路を持つこと（ソフトウェアから独立） | 重要 | ハードウェア検査 |
| SAFE-HW-ESTOP-002 | 緊急停止回路は100ms以内にモーター電源を切断すること | 重要 | ハードウェアテスト |
| SAFE-HW-ESTOP-003 | 緊急停止ボタンは赤、マッシュルームヘッド、ツイストリセットであること | 重要 | ハードウェア検査 |
| SAFE-HW-ESTOP-004 | 緊急停止回路はデュアルチャネル（冗長）であること | 重要 | ハードウェア検査 |
| SAFE-HW-ESTOP-005 | 緊急停止回路はISO 13850に準拠すること | 重要 | 認証 |

**合計要件: 5**

---

### 7.2 バッテリー管理システム（SAFE-HW-BMS）

| 要件ID | 要件 | 優先度 | 検証 |
|----------------|-------------|----------|------------|
| SAFE-HW-BMS-001 | システムは電圧、電流、温度を監視するBMSを持つこと | 重要 | ハードウェア検査 |
| SAFE-HW-BMS-002 | BMSは過放電を防止すること（<20% SOC） | 重要 | バッテリーテスト |
| SAFE-HW-BMS-003 | BMSは過電流を防止すること（>50A連続） | 重要 | 電流テスト |
| SAFE-HW-BMS-004 | BMSは温度>60°Cの場合電源を切断すること | 重要 | 熱テスト |
| SAFE-HW-BMS-005 | BMSは1 HzでバッテリーステータスをROS 2に公開すること | 高 | 統合テスト |
| SAFE-HW-BMS-006 | システムはバッテリー<30% SOCの場合ホームへ戻ることを開始すること | 高 | 統合テスト |

**合計要件: 6**

---

### 7.3 モーターコントローラー（SAFE-HW-MOTOR）

| 要件ID | 要件 | 優先度 | 検証 |
|----------------|-------------|----------|------------|
| SAFE-HW-MOTOR-001 | モーターコントローラーはハードウェア電流制限を持つこと（モーター当たり10A） | 重要 | ハードウェア検査 |
| SAFE-HW-MOTOR-002 | モーターコントローラーは熱保護を持つこと（>90°Cでシャットダウン） | 重要 | 熱テスト |
| SAFE-HW-MOTOR-003 | モーターコントローラーは緊急停止信号を受け入れること（ハードウェア入力） | 重要 | ハードウェア検査 |
| SAFE-HW-MOTOR-004 | モーターコントローラーは10 HzでステータスをROS 2に報告すること | 高 | 統合テスト |
| SAFE-HW-MOTOR-005 | モーターコントローラーは通信喪失時に安全状態に入ること | 重要 | 故障注入テスト |

**合計要件: 5**

---

### 7.4 ブレーキシステム（SAFE-HW-BRAKE）

| 要件ID | 要件 | 優先度 | 検証 |
|----------------|-------------|----------|------------|
| SAFE-HW-BRAKE-001 | システムは電気機械ブレーキを持つこと（フェールセーフ係合） | 重要 | ハードウェア検査 |
| SAFE-HW-BRAKE-002 | ブレーキは電源喪失時に自動的に係合すること | 重要 | 電源喪失テスト |
| SAFE-HW-BRAKE-003 | ブレーキは緊急停止時に自動的に係合すること | 重要 | 安全テスト |
| SAFE-HW-BRAKE-004 | ブレーキは100kg負荷で10°傾斜でロボットを保持すること | 重要 | ブレーキテスト |
| SAFE-HW-BRAKE-005 | ブレーキ係合時間は<200msであること | 重要 | レイテンシーテスト |

**合計要件: 5**

---

### 7.5 安全センサー（SAFE-HW-SENSOR）

| 要件ID | 要件 | 優先度 | 検証 |
|----------------|-------------|----------|------------|
| SAFE-HW-SENSOR-001 | システムは障害物検出用の3D LiDARを持つこと | 重要 | ハードウェア検査 |
| SAFE-HW-SENSOR-002 | システムは傾斜検出用のデュアルIMU（9-DOF）を持つこと | 重要 | ハードウェア検査 |
| SAFE-HW-SENSOR-003 | システムは乗客検出用の重量センサーを持つこと | 重要 | ハードウェア検査 |
| SAFE-HW-SENSOR-004 | システムはシートベルト装着センサーを持つこと | 重要 | ハードウェア検査 |
| SAFE-HW-SENSOR-005 | システムは天候監視用の雨センサーを持つこと | 高 | ハードウェア検査 |
| SAFE-HW-SENSOR-006 | すべての安全センサーは≥10 Hzでデータを公開すること | 重要 | パフォーマンステスト |

**合計要件: 6**

---

## 8. テストと検証要件

### 8.1 安全テスト（SAFE-TEST-SAFETY）

| 要件ID | 要件 | 優先度 | 検証 |
|----------------|-------------|----------|------------|
| SAFE-TEST-SAFETY-001 | システムは100回の緊急停止テストを完了すること（0%失敗） | 重要 | テストレポート |
| SAFE-TEST-SAFETY-002 | システムは50回の衝突回避テストを完了すること | 重要 | テストレポート |
| SAFE-TEST-SAFETY-003 | システムは50回の傾斜安定性テストを完了すること（最大10°） | 重要 | テストレポート |
| SAFE-TEST-SAFETY-004 | システムは20回のセンサー故障テストを完了すること | 重要 | テストレポート |
| SAFE-TEST-SAFETY-005 | システムは20回の乗客安全テストを完了すること（フル負荷） | 重要 | テストレポート |

**合計要件: 5**

---

### 8.2 故障注入テスト（SAFE-TEST-FAULT）

| 要件ID | 要件 | 優先度 | 検証 |
|----------------|-------------|----------|------------|
| SAFE-TEST-FAULT-001 | システムはLiDAR故障注入でテストすること | 重要 | 故障注入テスト |
| SAFE-TEST-FAULT-002 | システムはカメラ故障注入でテストすること | 重要 | 故障注入テスト |
| SAFE-TEST-FAULT-003 | システムはIMU故障注入でテストすること | 重要 | 故障注入テスト |
| SAFE-TEST-FAULT-004 | システムはモーターコントローラー故障注入でテストすること | 重要 | 故障注入テスト |
| SAFE-TEST-FAULT-005 | システムは通信タイムアウト注入でテストすること | 重要 | 故障注入テスト |
| SAFE-TEST-FAULT-006 | すべての故障注入テストは安全状態への移行を検証すること | 重要 | テストレポート |

**合計要件: 6**

---

### 8.3 受入基準（SAFE-TEST-ACCEPT）

| 基準 | 目標 | MVP目標 | 検証 |
|-----------|--------|------------|------------|
| 緊急停止成功率 | 100% | 100% | 100テスト |
| 衝突回避成功率 | >99% | >95% | 500シナリオ |
| 乗客速度制限遵守 | 100% | 100% | 継続監視 |
| 傾斜検出と停止 | 100% | 100% | 50傾斜テスト |
| センサー故障安全状態移行 | 100% | 100% | 故障注入テスト |
| ブレーキ係合時間 | <200ms | <300ms | レイテンシーテスト |
| 緊急停止停止距離 | <0.5m @ 1.0 m/s | <0.7m @ 1.0 m/s | 制動テスト |

---

## 9. 要件概要

### カテゴリー別要件数

| カテゴリー | 合計要件 | 重要 | 高 | 中 | 低 |
|----------|-------------------|----------|------|--------|-----|
| **乗客安全** | **31** | 24 | 7 | 0 | 0 |
| **運用安全** | **42** | 34 | 8 | 0 | 0 |
| **環境安全** | **19** | 6 | 11 | 2 | 0 |
| **システム安全** | **25** | 20 | 5 | 0 | 0 |
| **ソフトウェア安全** | **25** | 22 | 3 | 0 | 0 |
| **ハードウェア安全** | **27** | 24 | 3 | 0 | 0 |
| **テスト** | **11** | 11 | 0 | 0 | 0 |
| **合計** | **180** | **141 (78%)** | **37 (21%)** | **2 (1%)** | **0 (0%)** |

**優先度分布:**
- **重要（141要件、78%）**: 安全重要、これらなしではシステムは安全に動作不可
- **高（37要件、21%）**: 信頼性と堅牢性に重要
- **中（2要件、1%）**: 品質改善
- **低（0要件、0%）**: 安全サブシステムには該当なし

---

## 10. 受入基準

### 10.1 最小限の実行可能製品（MVP）

**MVP定義:** すべての重要安全テストに合格した、乗客搭乗での安全な自律運転。

**MVP要件:**
- ✅ すべての重要要件（合計141）を満たすこと
- ✅ 100%緊急停止成功率（100テスト）
- ✅ >95%衝突回避成功（500シナリオ）
- ✅ 100%乗客速度制限遵守
- ✅ 100%傾斜検出と停止（<20°）
- ✅ すべてのセンサー故障テストに合格（安全状態移行）
- ✅ <300msブレーキ係合時間
- ✅ <0.7m停止距離 @ 1.0 m/s

**MVP除外:**
- 天候運用（小雨） - MVPでは乾燥条件を要求可能
- 夜間運用 - MVPでは日中を要求可能
- 高度な劣化モード - 基本的な安全停止で許容

---

### 10.2 本番準備完了

**本番定義:** すべての重要+高要件を満たす堅牢な全天候24/7運用。

**本番要件:**
- ✅ すべての重要（141）+すべての高（37）要件を満たす = 合計178
- ✅ 100%緊急停止成功率（1000テスト）
- ✅ >99%衝突回避成功（10,000シナリオ）
- ✅ 小雨運用（<2.5mm/hr）
- ✅ アクティブ照明による夜間運用
- ✅ <200msブレーキ係合時間
- ✅ <0.5m停止距離 @ 1.0 m/s
- ✅ 1000時間MTBF（平均故障間隔）
- ✅ 完全な故障注入テストスイート

---

## 11. トレーサビリティ

### 11.1 親要件トレーサビリティ

この文書は以下から要件を派生:

**SYSTEM_REQUIREMENTS.md（SAFE-REQ）:**
| システム要件 | 派生安全要件 | ステータス |
|--------------------|----------------------------|--------|
| SAFE-REQ-002（速度制限1.0 m/s） | SAFE-PASS-SPEED-001、SAFE-SW-VGOV-002 | トレース済み |
| SAFE-REQ-005（傾斜検出） | SAFE-PASS-TILT-001～006 | トレース済み |
| SAFE-REQ-006（緊急停止） | SAFE-PASS-ESTOP-001～006、SAFE-OPS-ESTOP-001～006 | トレース済み |
| SAFE-REQ-007（衝突回避） | SAFE-OPS-COLL-001～006 | トレース済み |
| SAFE-REQ-010（傾斜最大10°） | SAFE-ENV-SLOPE-001～005 | トレース済み |

**すべてのシステムレベル安全要件はサブシステム要件にトレース済み。** ✅

---

## 12. 変更履歴

| バージョン | 日付 | 著者 | 変更内容 |
|---------|------|--------|---------|
| 1.0 | 2025-12-15 | 安全エンジニア | SYSTEM_REQUIREMENTS.mdと安全ベストプラクティスに基づく初期安全要件 |

---

**文書ステータス:** ドラフト
**次回レビュー:** 予備安全分析（FMEA）後
**必要な承認:** 安全エンジニア、システムアーキテクト、ナビゲーションリード、ハードウェアリード

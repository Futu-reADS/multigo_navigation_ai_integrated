# セキュリティ要件（パイロットレベル）

**文書ID:** REQ-SEC-001
**バージョン:** 2.0（パイロット用簡易版）
**日付:** 2025年12月19日
**ステータス:** 有効
**オーナー:** Pankaj（車両ソフトウェア）
**スコープ:** 車両ソフトウェアセキュリティのみ

---

## 文書情報

**目的:** 車椅子輸送ロボット車両ソフトウェアのパイロットレベルセキュリティ要件を定義する

**スコープ:**
- 車両側ソフトウェアセキュリティ
- 車両-TVM API通信セキュリティ
- 基本的な安全クリティカルセキュリティ機能

**スコープ外:**
- TVMサーバーセキュリティ（Unnoの責任範囲）
- ハードウェア物理セキュリティ（Tsuchiyaの責任範囲）
- 高度なコンプライアンス（GDPR、HIPAA、ISO 27001）
- エンタープライズ機能（MFA、SSO、ペネトレーションテスト）

**パイロットフォーカス:**
- 安全動作に不可欠なセキュリティ
- 一般的な脆弱性の防止
- 基本的な認証と暗号化
- 安全クリティカル保護

---

## 目次

1. [認証](#1-認証)
2. [APIセキュリティ](#2-apiセキュリティ)
3. [ネットワークセキュリティ](#3-ネットワークセキュリティ)
4. [データ保護](#4-データ保護)
5. [物理的安全](#5-物理的安全)
6. [ログ記録](#6-ログ記録)
7. [セキュアな開発](#7-セキュアな開発)

---

## 1. 認証

### 1.1 車両-TVM認証

**REQ-SEC-001** [CRITICAL]
- 車両はJWT（JSON Web Tokens）を使用してTVMサーバーに認証すること
- トークン有効期限: 1時間
- リフレッシュトークン有効期限: 24時間
- **実装:** TVM_API_SPECIFICATION.mdを参照

**REQ-SEC-002** [CRITICAL]
- 車両は認証時に一意のデバイスID（UUID）を含めること
- デバイスIDは初期セットアップ時にプロビジョニング
- **実装:** `/etc/multigo/vehicle_id`に保存

**REQ-SEC-003** [HIGH]
- 車両はTVMからのコマンド受信時にJWT署名を検証すること
- 期限切れまたは無効なトークンを拒否
- **実装:** 標準JWTライブラリを使用（PyJWTまたはcpp-jwt）

**REQ-SEC-004** [HIGH]
- 車両は有効期限前にJWTを自動リフレッシュすること
- トークン期限切れ5分前にリフレッシュ
- **実装:** TVMクライアントのバックグラウンドスレッド

---

## 2. APIセキュリティ

### 2.1 TVM API通信

**REQ-SEC-005** [CRITICAL]
- すべてのTVM API通信はHTTPS（TLS 1.2以上）を使用すること
- プレーンテキストHTTPは許可しない
- **実装:** TVM APIクライアントがHTTPS URLを強制

**REQ-SEC-006** [CRITICAL]
- 車両はTVMサーバーのTLS証明書を検証すること
- 本番環境では自己署名証明書を拒否
- 開発環境では自己署名証明書を許可（警告付き）
- **実装:** Python requestsライブラリで`verify=True`

**REQ-SEC-007** [HIGH]
- 車両は指数バックオフを伴うリトライロジックを実装すること
- 失敗したリクエストによるAPI乱用を防止
- 最大リトライ回数: 3、バックオフ: 1秒、2秒、4秒
- **実装:** TVMクライアントリトライラッパー

### 2.2 入力検証

**REQ-SEC-008** [CRITICAL]
- 車両はすべての受信WebSocketコマンドを検証すること
- コマンドタイプ、パラメータ、データ型をチェック
- 不正なコマンドを拒否
- **実装:** JSONスキーマ検証

**REQ-SEC-009** [HIGH]
- 車両は実行前にミッションウェイポイントを検証すること
- 座標境界、速度制限、ステアリング角制限をチェック
- **実装:** nav_goalパッケージのウェイポイントバリデータ

---

## 3. ネットワークセキュリティ

### 3.1 ネットワーク通信

**REQ-SEC-010** [CRITICAL]
- すべてのネットワーク通信は暗号化を使用すること:
  - TVM API: HTTPS/WSS（TLS）
  - ROS 2内部: ローカルホストのみ（外部公開なし）
- **実装:** ROS 2 DDSをローカルホストにバインドするよう設定

**REQ-SEC-011** [HIGH]
- 車両WiFi接続はWPA2またはWPA3を使用すること
- 最小パスワード長: 12文字
- **実装:** ネットワーク設定（ソフトウェアスコープ外、文書化のみ）

**REQ-SEC-012** [MEDIUM]
- 車両はROS 2トピックを公開ネットワークに公開しないこと
- ROS 2 DDSドメインをローカルホストまたは車両内部ネットワークに制限
- **実装:** ROS_DOMAIN_ID環境変数、ファイアウォールルール

---

## 4. データ保護

### 4.1 転送中のデータ

**REQ-SEC-013** [CRITICAL]
- TVMに送信されるテレメトリデータは暗号化すること（HTTPS）
- 含む: 位置、バッテリー状態、エラー
- **実装:** HTTPSを使用したTVM REST API

**REQ-SEC-014** [HIGH]
- 車両はURLに機密データを送信しないこと
- すべての機密パラメータにPOSTボディを使用
- **実装:** TVMクライアントAPI設計

### 4.2 保存データ

**REQ-SEC-015** [MEDIUM]
- 車両はユーザーPIIをローカルに保存しないこと
- 保存するもの: 車両ID、ミッションデータ、マップのみ
- **実装:** 設計原則 - ユーザーデータ永続化なし

**REQ-SEC-016** [MEDIUM]
- 車両ログは機密データを含まないこと
- マスク対象: APIトークン、パスワード、ユーザー名
- **実装:** ログフィルター/サニタイザー

### 4.3 シークレット管理

**REQ-SEC-017** [CRITICAL]
- APIキーとクレデンシャルをソースコードにハードコードしないこと
- 設定ファイルまたは環境変数に保存
- **実装:** 制限されたパーミッションを持つ設定ファイル（`/etc/multigo/config.yaml`、chmod 600）

**REQ-SEC-018** [HIGH]
- シークレットを含む設定ファイルは制限されたパーミッションを持つこと
- 車両ソフトウェアユーザー（例: `multigo`ユーザー）のみが読み取り可能
- **実装:** デプロイスクリプトが`chmod 600 /etc/multigo/config.yaml`を設定

---

## 5. 物理的安全

### 5.1 緊急停止

**REQ-SEC-019** [CRITICAL]
- 車両はハードウェアE-stopに100ms以内に応答すること
- 緊急停止は最高優先度、オーバーライド不可
- **実装:** ハードウェアE-stop回路 + ソフトウェアモニター

**REQ-SEC-020** [CRITICAL]
- 車両はTVMからのソフトウェアE-stopコマンドに500ms以内に応答すること
- すべてのモーターを停止、現在のミッションをキャンセル
- **実装:** セーフティモニターのWebSocket E-stopハンドラ

**REQ-SEC-021** [HIGH]
- 車両はすべてのE-stopイベントをログすること
- 含む: タイムスタンプ、トリガー源（ハードウェア/ソフトウェア）、位置
- **実装:** セーフティモニターが`/var/log/multigo/safety.log`にログ

### 5.2 安全境界

**REQ-SEC-022** [HIGH]
- 車両はコマンドに対して安全制限を強制すること:
  - 最大速度: 1.5 m/s
  - 最大ステアリング角: ±45°
  - 最大加速度: 0.5 m/s²
- **実装:** スワーブドライブコントローラーの制限

**REQ-SEC-023** [MEDIUM]
- 車両は安全チェックに失敗した場合、TVMからのコマンドを拒否すること
- 例: マップ外への移動コマンド、制限超過
- **実装:** nav_controlのコマンドバリデータ

---

## 6. ログ記録

### 6.1 セキュリティログ

**REQ-SEC-024** [HIGH]
- 車両はセキュリティイベントをログすること:
  - 認証試行（成功/失敗）
  - E-stop起動
  - 受信した無効なコマンド
  - ネットワーク接続失敗
- **実装:** セキュリティイベントマーカー付き集中ログ

**REQ-SEC-025** [HIGH]
- セキュリティログはTVMサーバーに送信すること
- 集中監視のため
- **実装:** TVM API `/api/v1/errors`エンドポイント

**REQ-SEC-026** [MEDIUM]
- 車両はローカルに7日間ログを保持すること
- ディスク満杯を防ぐためログをローテート
- **実装:** `logrotate`設定

---

## 7. セキュアな開発

### 7.1 コードセキュリティ

**REQ-SEC-027** [HIGH]
- コードはセキュリティ脆弱性についてレビューすること
- 安全クリティカルコードにはピアレビュー必須
- **実装:** GitHubプルリクエストレビュー

**REQ-SEC-028** [MEDIUM]
- 依存関係は最新に保つこと
- 既知の脆弱性を月次でチェック
- **実装:** `pip list --outdated`、`rosdep update`

**REQ-SEC-029** [MEDIUM]
- シークレットをバージョン管理にコミットしないこと
- シークレットを含む設定ファイルには`.gitignore`を使用
- **実装:** `.gitignore`に`*.secret`、`config/*.yaml`を含める

**REQ-SEC-030** [MEDIUM]
- コードはセキュアコーディングプラクティスに従うこと
- OWASP Top 10認識（SQLインジェクション、XSS、コマンドインジェクション）
- **実装:** 開発者トレーニング、コードレビューチェックリスト

---

## サマリー

**要件総数:** 30（152から簡略化）

### 深刻度別要件

| 深刻度 | 数 | 割合 |
|----------|-------|------------|
| CRITICAL | 11 | 37% |
| HIGH | 14 | 47% |
| MEDIUM | 5 | 17% |

### カテゴリー別要件

| カテゴリー | 数 | Critical | High | Medium |
|----------|-------|----------|------|--------|
| 認証 | 4 | 2 | 2 | 0 |
| APIセキュリティ | 5 | 2 | 2 | 1 |
| ネットワークセキュリティ | 3 | 1 | 1 | 1 |
| データ保護 | 6 | 2 | 2 | 2 |
| 物理的安全 | 5 | 3 | 2 | 0 |
| ログ記録 | 3 | 0 | 2 | 1 |
| セキュアな開発 | 4 | 1 | 3 | 0 |

---

## 削除された内容（エンタープライズ → パイロット）

**削除された122要件:**

### 認証と認可
- ❌ 多要素認証（MFA）
- ❌ シングルサインオン（SSO）
- ❌ パスワード複雑性ルール（12文字、ローテーション、履歴）
- ❌ クライアント証明書（mTLS）
- ❌ 詳細なRBACロール（5ユーザーロール）
- **理由:** パイロットはシンプルなJWT認証を使用、TVMサーバーがユーザー管理を処理

### データ保護
- ❌ AES-256保存時暗号化
- ❌ キー管理サービス（AWS KMS、Vault）
- ❌ キーローテーション（90日）
- ❌ 分析用データ匿名化
- ❌ セキュアなデータ削除（GDPR削除権）
- **理由:** 車両はユーザーPIIを保存しない、転送中の暗号化はHTTPSで処理

### ネットワークセキュリティ
- ❌ ネットワークセグメンテーション（DMZ、内部、管理）
- ❌ 詳細なファイアウォールルール
- ❌ DDoS保護
- ❌ リモートアクセス用VPN
- ❌ 証明書ピンニング
- **理由:** パイロット展開、シンプルなネットワーク設定

### コンプライアンス
- ❌ GDPRコンプライアンス（9要件）
- ❌ PIPEDAコンプライアンス
- ❌ HIPAAコンプライアンス
- ❌ ISO 27001、ISO 13849、IEC 62443
- **理由:** パイロットプロジェクト、必要に応じて後でコンプライアンス追加

### インシデント対応
- ❌ インシデント対応計画
- ❌ 24/7オンコールローテーション
- ❌ フォレンジックツール
- ❌ 侵害通知（72時間）
- **理由:** パイロットにはエンタープライズインシデント管理不要

### 脆弱性管理
- ❌ 四半期ごとの脆弱性スキャン
- ❌ 年次ペネトレーションテスト
- ❌ SBOM（ソフトウェア部品表）
- ❌ 7日間クリティカルパッチSLA
- **理由:** パイロットには手動セキュリティレビューで十分

### セキュアな開発
- ❌ CI/CDでの静的解析（SAST）
- ❌ 動的解析（DAST）
- ❌ コンテナセキュリティスキャン
- ❌ イメージ署名
- **理由:** パイロットは手動コードレビューを使用、CI/CDセキュリティは後で追加

---

## 実装優先順位

**フェーズ1（週1-2）: クリティカルセキュリティ**
1. REQ-SEC-001: JWT認証
2. REQ-SEC-005: TVM API用HTTPS
3. REQ-SEC-008: コマンド検証
4. REQ-SEC-017: シークレット管理
5. REQ-SEC-019、020: E-stop実装

**フェーズ2（週3-4）: 高優先度**
1. REQ-SEC-003: JWT検証
2. REQ-SEC-006: TLS証明書検証
3. REQ-SEC-009: ウェイポイント検証
4. REQ-SEC-022: 安全制限
5. REQ-SEC-024、025: セキュリティログ

**フェーズ3（週5+）: 中優先度**
1. REQ-SEC-012: ROS 2ネットワーク分離
2. REQ-SEC-016: ログサニタイゼーション
3. REQ-SEC-028: 依存関係更新
4. REQ-SEC-029: シークレット.gitignore

---

## テスト要件

**セキュリティテストには以下を含むこと:**
1. JWT認証テスト（有効/無効/期限切れトークン）
2. HTTPS強制テスト（HTTP拒否）
3. コマンド検証テスト（不正なJSON）
4. E-stop応答時間テスト（<100msハードウェア、<500msソフトウェア）
5. 安全制限テスト（過度な速度/ステアリング拒否）
6. ログサニタイゼーションテスト（ログにシークレットなし）

**セキュリティレビューには以下を含むこと:**
1. 認証コードのピアレビュー
2. コマンド検証コードのピアレビュー
3. E-stop機能の手動テスト
4. 設定ファイルパーミッションのレビュー

---

## チーム向けメモ

**Pankaj（車両ソフトウェア）向け:**
- 車両ソフトウェアにこれら30要件を実装
- TVM APIクライアントはREQ-SEC-001からREQ-SEC-007を処理する必要あり
- セーフティモニターはREQ-SEC-019からREQ-SEC-023を処理する必要あり
- テストはすべてのCRITICAL要件を検証する必要あり

**Unno（TVMサーバー）向け:**
- サーバー側セキュリティはあなたの責任範囲（この文書に含まれない）
- TVM_API_SPECIFICATION.mdに従ってJWTトークンを提供
- サーバー側ユーザー認証を実装
- 独自のセキュリティ要件文書を参照

**Tsuchiya+Kiril（ハードウェア）向け:**
- ハードウェアE-stopはあなたの責任範囲
- 車両WiFi設定はあなたの責任範囲
- 物理セキュリティ（ロック、改ざん検出）はあなたの責任範囲
- 独自のセキュリティ要件文書を参照

---

## v1.0からの変更点

**v2.0（2025年12月19日）:**
- 152要件から30要件に削減（80%削減）
- エンタープライズ機能を削除（MFA、SSO、コンプライアンス）
- TVMサーバーセキュリティを削除（Unnoのスコープに移動）
- ハードウェアセキュリティを削除（Tsuchiyaのスコープに移動）
- パイロットレベル車両ソフトウェアセキュリティに焦点
- 実装ノートとテスト要件を追加

**v1.0（2025年12月17日）:**
- 152エンタープライズレベル要件を含む初期バージョン
- ステータス: パイロットには高度すぎる（シニアフィードバック）

---

**文書ステータス:** ✅ 有効（パイロットレベル）
**次回レビュー:** パイロット完了後（週18）
**承認者:** シニア（2025年12月19日）

---

**文書終了**

# ナビゲーション要件

**文書ID:** REQ-NAV-001
**バージョン:** 1.0
**日付:** 2025-12-15
**ステータス:** ドラフト
**分類:** 内部

---

## 文書管理

| バージョン | 日付 | 著者 | 変更内容 |
|---------|------|--------|---------|
| 1.0 | 2025-12-15 | Navigation Lead | ParcelPalの実証済みアーキテクチャに基づく初期ナビゲーション要件 |

---

## 1. はじめに

### 1.1 目的

この文書は、屋外優先車椅子搬送ロボットの**ナビゲーション要件**を規定します。ナビゲーションサブシステムは、ParcelPal配送ロボットアーキテクチャに基づく、実証済みのNDTローカライゼーションとNav2パスプランニングを使用して、自律的なポイント間移動を実現します。

### 1.2 範囲

この仕様は以下をカバーします:
- **ローカライゼーション** - 事前構築マップ上のNDTスキャンマッチング（運用中の継続的SLAMはなし）
- **パスプランニング** - Nav2によるグローバル（A*/Dijkstra）およびローカル（DWB）プランニング
- **マップ管理** - オフラインマッピング、マップ保存、マップ更新
- **マルチウェイポイントナビゲーション** - 500m～1kmミッションのための順次ウェイポイント実行
- **センサーフュージョン** - LiDAR + IMU + 車輪オドメトリ
- **ルート実行** - ゴールキュー管理、再プランニング、リカバリー動作
- **性能** - 500mで±10cm精度、GPS不要

**範囲外:**
- ドッキング精密制御（DOCKING_SYSTEM_REQUIREMENTS.mdでカバー）
- ドッキング時の障害物回避（DOCKING_SYSTEM_REQUIREMENTS.mdでカバー）
- 安全制限と緊急停止（SAFETY_REQUIREMENTS.mdでカバー）

### 1.3 関連文書

- **SYSTEM_REQUIREMENTS.md** - セクション1.2（NAV-REQ-001～012）
- **OVERALL_SYSTEM_ARCHITECTURE.md** - セクション3.1（ナビゲーションサブシステム）
- **PARCELPAL_EXPLORATION_SUMMARY.md** - 実証済みNDTローカライゼーションアーキテクチャ
- **question_answers.md** - GPS除外、500m～1km範囲の明確化

### 1.4 ナビゲーションアーキテクチャ概要

システムは**ParcelPal 2フェーズナビゲーション戦略**を実装します:

**フェーズ1: オフラインマッピング（一度、手動運転）**
```
手動テレオペレーション運転
    ↓
LiDAR + オドメトリ + IMU記録
    ↓
SLAM Toolbox（マッピングモード）ループクロージャ付き
    ↓
最終マップ保存
    ↓
ウェイポイントアノテーション（停止、充電、ドッキングゾーン）
```

**フェーズ2: オンラインローカライゼーション（日常運用）**
```
保存されたマップをロード
    ↓
保存されたマップ上のNDTスキャンマッチング
    ↓
継続的姿勢推定（ドリフト累積なし！）
    ↓
ウェイポイントへのNav2パスプランニング
    ↓
スワーブドライブコントローラー実行
```

**重要な洞察:** このアプローチは、固定の事前構築マップ上でローカライズすることでドリフト累積を排除し、GPSなしで信頼性の高い500m～1kmナビゲーションを可能にします。

---

## 2. ローカライゼーション要件

### 2.1 NDTスキャンマッチング（NAV-LOC-NDT）

| 要件ID | 要件 | 優先度 | 検証 |
|----------------|-------------|----------|------------|
| NAV-LOC-NDT-001 | システムはローカライゼーションにNDT（Normal Distributions Transform）を使用しなければならない | 重要 | 設定 |
| NAV-LOC-NDT-002 | システムは事前構築静的マップ上でローカライズしなければならない（継続的SLAMではない） | 重要 | アーキテクチャレビュー |
| NAV-LOC-NDT-003 | システムはGPSなしで500mにわたり±10cm位置精度を達成しなければならない | 重要 | フィールドテスト（100試行） |
| NAV-LOC-NDT-004 | システムは±2°方向精度を達成しなければならない | 高 | フィールドテスト |
| NAV-LOC-NDT-005 | システムは最低10 Hzで姿勢推定を配信しなければならない | 重要 | 性能テスト |
| NAV-LOC-NDT-006 | システムは姿勢共分散（不確実性推定）を計算しなければならない | 高 | ユニットテスト |
| NAV-LOC-NDT-007 | システムはボクセルグリッドサイズ0.5m～1.0m（屋外チューニング）を使用しなければならない | 高 | 設定 |
| NAV-LOC-NDT-008 | システムは最大30反復のニュートン最適化を使用しなければならない | 中 | 設定 |

**合計要件数: 8**

---

### 2.2 センサーフュージョン（NAV-LOC-FUSION）

| 要件ID | 要件 | 優先度 | 検証 |
|----------------|-------------|----------|------------|
| NAV-LOC-FUSION-001 | システムは3D LiDAR + IMU + 車輪オドメトリを融合しなければならない | 重要 | 統合テスト |
| NAV-LOC-FUSION-002 | システムは拡張カルマンフィルター（EKF）またはパーティクルフィルターを使用しなければならない | 高 | アーキテクチャレビュー |
| NAV-LOC-FUSION-003 | システムはセンサーを重み付けしなければならない: LiDAR（70%）、IMU（20%）、オドメトリ（10%） | 中 | 設定 |
| NAV-LOC-FUSION-004 | システムは姿勢推定においてIMU傾斜を補償しなければならない | 重要 | 統合テスト |
| NAV-LOC-FUSION-005 | システムは外れ値センサー読み取りを検出して拒否しなければならない | 高 | 故障注入テスト |
| NAV-LOC-FUSION-006 | システムはLiDARが5 Hzに低下してもローカライゼーションを10 Hzで維持しなければならない | 高 | 性能テスト |

**合計要件数: 6**

---

### 2.3 マップ管理（NAV-LOC-MAP）

| 要件ID | 要件 | 優先度 | 検証 |
|----------------|-------------|----------|------------|
| NAV-LOC-MAP-001 | システムは起動時に事前構築マップをロードしなければならない | 重要 | 統合テスト |
| NAV-LOC-MAP-002 | システムはPCD（Point Cloud Data）形式のマップファイルをサポートしなければならない | 重要 | ファイル形式テスト |
| NAV-LOC-MAP-003 | システムは最大500 MBのマップファイル（1km屋外マップ）をサポートしなければならない | 高 | ロードテスト |
| NAV-LOC-MAP-004 | システムは起動時30秒以内にマップをロードしなければならない | 高 | 性能テスト |
| NAV-LOC-MAP-005 | システムは複数のマップ（例: サイトA、サイトB）を保存しなければならない | 中 | 設定 |
| NAV-LOC-MAP-006 | システムは再コンパイルなしでマップ更新を許可しなければならない | 高 | 統合テスト |
| NAV-LOC-MAP-007 | システムはロード時にマップファイル整合性（チェックサム）を検証しなければならない | 中 | ユニットテスト |

**合計要件数: 7**

---

### 2.4 初期姿勢推定（NAV-LOC-INIT）

| 要件ID | 要件 | 優先度 | 検証 |
|----------------|-------------|----------|------------|
| NAV-LOC-INIT-001 | システムは起動時に初期姿勢入力（x, y, θ）を要求しなければならない | 重要 | 統合テスト |
| NAV-LOC-INIT-002 | システムはUI（マップクリック）による初期姿勢をサポートしなければならない | 高 | UIテスト |
| NAV-LOC-INIT-003 | システムは保存された「ホーム」位置による初期姿勢をサポートしなければならない | 高 | 設定 |
| NAV-LOC-INIT-004 | システムは10秒以内に初期姿勢収束を検証しなければならない | 重要 | 性能テスト |
| NAV-LOC-INIT-005 | システムはローカライゼーション信頼度が80%未満の場合、ナビゲーションを拒否しなければならない | 重要 | 安全テスト |
| NAV-LOC-INIT-006 | システムはローカライゼーション信頼度を/nav/confidenceトピックに配信しなければならない | 高 | 統合テスト |

**合計要件数: 6**

---

### 2.5 ローカライゼーション故障処理（NAV-LOC-FAIL）

| 要件ID | 要件 | 優先度 | 検証 |
|----------------|-------------|----------|------------|
| NAV-LOC-FAIL-001 | システムはローカライゼーション故障（1m超の姿勢ジャンプ）を検出しなければならない | 重要 | 故障注入テスト |
| NAV-LOC-FAIL-002 | システムはローカライゼーション故障時に即座に停止しなければならない | 重要 | 安全テスト |
| NAV-LOC-FAIL-003 | システムはローカライゼーション故障時にオペレーター介入を要求しなければならない | 重要 | 統合テスト |
| NAV-LOC-FAIL-004 | システムはセンサースナップショット付きでローカライゼーション故障をログしなければならない | 高 | ログ検査 |
| NAV-LOC-FAIL-005 | システムは自動リカバリー（最後の既知良好姿勢からの再初期化）を試行しなければならない | 中 | 統合テスト |

**合計要件数: 5**

---

## 3. パスプランニング要件

### 3.1 グローバルパスプランニング（NAV-PLAN-GLOBAL）

| 要件ID | 要件 | 優先度 | 検証 |
|----------------|-------------|----------|------------|
| NAV-PLAN-GLOBAL-001 | システムはNav2グローバルプランナー（NavFnまたはSmac Planner）を使用しなければならない | 重要 | 設定 |
| NAV-PLAN-GLOBAL-002 | システムは静的マップ上でAからBへの最短安全パスをプランしなければならない | 重要 | 統合テスト |
| NAV-PLAN-GLOBAL-003 | システムはA*またはDijkstraアルゴリズムを使用しなければならない | 高 | 設定 |
| NAV-PLAN-GLOBAL-004 | システムは500mパスに対して1秒以内にグローバルプランを計算しなければならない | 高 | 性能テスト |
| NAV-PLAN-GLOBAL-005 | システムは静的障害物によってブロックされた場合、グローバルパスを再プランしなければならない | 高 | 統合テスト |
| NAV-PLAN-GLOBAL-006 | システムはマップで定義されたno-goゾーンを尊重しなければならない | 重要 | 設定テスト |
| NAV-PLAN-GLOBAL-007 | システムは草地より舗装経路を優先しなければならない（コストマップチューニング） | 中 | フィールドテスト |

**合計要件数: 7**

---

### 3.2 ローカルパスプランニング（NAV-PLAN-LOCAL）

| 要件ID | 要件 | 優先度 | 検証 |
|----------------|-------------|----------|------------|
| NAV-PLAN-LOCAL-001 | システムはNav2ローカルプランナー（DWB - Dynamic Window Approach）を使用しなければならない | 重要 | 設定 |
| NAV-PLAN-LOCAL-002 | システムは3～5秒先の衝突回避軌道をプランしなければならない | 重要 | 統合テスト |
| NAV-PLAN-LOCAL-003 | システムは最低5 Hzでローカルプランを更新しなければならない | 重要 | 性能テスト |
| NAV-PLAN-LOCAL-004 | システムはスワーブドライブ運動学制約を使用しなければならない | 重要 | 設定 |
| NAV-PLAN-LOCAL-005 | システムは滑らかなパス（曲率最小化）を優先しなければならない | 高 | 軌道解析 |
| NAV-PLAN-LOCAL-006 | システムは振動を回避しなければならない（減衰係数≥0.8） | 高 | フィールドテスト |
| NAV-PLAN-LOCAL-007 | システムは5秒以内に実行可能なローカルプランが見つからない場合、タイムアウトしなければならない | 高 | 統合テスト |

**合計要件数: 7**

---

### 3.3 コストマップ（NAV-PLAN-COST）

| 要件ID | 要件 | 優先度 | 検証 |
|----------------|-------------|----------|------------|
| NAV-PLAN-COST-001 | システムはグローバルコストマップ（マップからの静的障害物）を維持しなければならない | 重要 | 統合テスト |
| NAV-PLAN-COST-002 | システムはローカルコストマップ（LiDARからの動的障害物）を維持しなければならない | 重要 | 統合テスト |
| NAV-PLAN-COST-003 | システムは5 Hzでローカルコストマップを更新しなければならない | 重要 | 性能テスト |
| NAV-PLAN-COST-004 | システムは0.5mの膨張半径（ロボット＋安全マージン）を使用しなければならない | 重要 | 設定 |
| NAV-PLAN-COST-005 | システムは障害物をLETHAL（コスト255）としてマークしなければならない | 重要 | 設定 |
| NAV-PLAN-COST-006 | システムは自由空間をFREE（コスト0）としてマークしなければならない | 重要 | 設定 |
| NAV-PLAN-COST-007 | システムは勾配膨張（距離とともにコスト減少）を使用しなければならない | 高 | 設定 |
| NAV-PLAN-COST-008 | システムは障害物除去時にローカルコストマップをクリアしなければならない（減衰率） | 中 | 統合テスト |

**合計要件数: 8**

---

### 3.4 動的障害物処理（NAV-PLAN-DYN）

| 要件ID | 要件 | 優先度 | 検証 |
|----------------|-------------|----------|------------|
| NAV-PLAN-DYN-001 | システムはLiDAR内の動的障害物（人、車両）を検出しなければならない | 重要 | フィールドテスト |
| NAV-PLAN-DYN-002 | システムは動的障害物を追跡しなければならない（カルマンフィルター） | 高 | 統合テスト |
| NAV-PLAN-DYN-003 | システムは1～3秒先の障害物動きを予測しなければならない | 高 | 予測テスト |
| NAV-PLAN-DYN-004 | システムは予測された障害物位置を回避しなければならない | 重要 | 衝突テスト |
| NAV-PLAN-DYN-005 | システムは動的障害物によってパスがブロックされた場合、待機しなければならない（タイムアウト30秒） | 高 | 統合テスト |
| NAV-PLAN-DYN-006 | システムは動的障害物が30秒超パスをブロックした場合、再ルーティングしなければならない | 高 | 統合テスト |

**合計要件数: 6**

---

## 4. マルチウェイポイントナビゲーション

### 4.1 ウェイポイント管理（NAV-WP-MANAGE）

| 要件ID | 要件 | 優先度 | 検証 |
|----------------|-------------|----------|------------|
| NAV-WP-MANAGE-001 | システムは順次ウェイポイントナビゲーション（A→B→C→D）をサポートしなければならない | 重要 | 統合テスト |
| NAV-WP-MANAGE-002 | システムはマップフレーム内で（x, y, θ）付きウェイポイントを保存しなければならない | 重要 | 設定 |
| NAV-WP-MANAGE-003 | システムは名前付きウェイポイント（例: 「停止1」、「充電」）をサポートしなければならない | 高 | UIテスト |
| NAV-WP-MANAGE-004 | システムはUIによるウェイポイントの挿入/削除を許可しなければならない | 高 | UIテスト |
| NAV-WP-MANAGE-005 | システムは繰り返しミッションのためにウェイポイントリストを保存しなければならない | 中 | 設定 |
| NAV-WP-MANAGE-006 | システムはウェイポイントがマップ境界内にあることを検証しなければならない | 高 | ユニットテスト |

**合計要件数: 6**

---

### 4.2 ウェイポイント実行（NAV-WP-EXEC）

| 要件ID | 要件 | 優先度 | 検証 |
|----------------|-------------|----------|------------|
| NAV-WP-EXEC-001 | システムは順次ウェイポイントにナビゲートしなければならない | 重要 | 統合テスト |
| NAV-WP-EXEC-002 | システムは0.3m以内、±10°以内でウェイポイント到達を宣言しなければならない | 重要 | 統合テスト |
| NAV-WP-EXEC-003 | システムは各ウェイポイントで設定可能な期間（0～60秒）停止しなければならない | 高 | 設定 |
| NAV-WP-EXEC-004 | システムは停止期間後に次のウェイポイントに進まなければならない | 高 | 統合テスト |
| NAV-WP-EXEC-005 | システムは3回試行後に到達不可能なウェイポイントをスキップしなければならない | 高 | 統合テスト |
| NAV-WP-EXEC-006 | システムはUIにウェイポイント進行状況を報告しなければならない | 高 | 統合テスト |
| NAV-WP-EXEC-007 | システムはウェイポイントキャンセルを処理しなければならない（即座に停止） | 高 | 統合テスト |

**合計要件数: 7**

---

### 4.3 ミッションプランニング（NAV-WP-MISSION）

| 要件ID | 要件 | 優先度 | 検証 |
|----------------|-------------|----------|------------|
| NAV-WP-MISSION-001 | システムは最大1km総距離のミッションをサポートしなければならない | 重要 | フィールドテスト |
| NAV-WP-MISSION-002 | システムは最大10ウェイポイントのミッションをサポートしなければならない | 高 | 統合テスト |
| NAV-WP-MISSION-003 | システムは総ミッション距離とETAを計算しなければならない | 高 | ユニットテスト |
| NAV-WP-MISSION-004 | システムはミッション実行可能性（バッテリー、マップカバレッジ）を検証しなければならない | 高 | ユニットテスト |
| NAV-WP-MISSION-005 | システムはバッテリー不足の場合、ミッションを拒否しなければならない | 重要 | 安全テスト |
| NAV-WP-MISSION-006 | システムはオペレーターコマンドでミッションを一時停止しなければならない | 高 | 統合テスト |
| NAV-WP-MISSION-007 | システムは現在位置からミッションを再開しなければならない | 高 | 統合テスト |

**合計要件数: 7**

---

## 5. ルート実行とリカバリー

### 5.1 ゴール処理（NAV-EXEC-GOAL）

| 要件ID | 要件 | 優先度 | 検証 |
|----------------|-------------|----------|------------|
| NAV-EXEC-GOAL-001 | システムはROS 2アクションサーバー経由でナビゲーションゴールを受け入れなければならない | 重要 | 統合テスト |
| NAV-EXEC-GOAL-002 | システムはゴールフィードバック（残距離、ETA）を提供しなければならない | 高 | 統合テスト |
| NAV-EXEC-GOAL-003 | システムは許容範囲内でゴール成功を宣言しなければならない | 重要 | 統合テスト |
| NAV-EXEC-GOAL-004 | システムは最大試行回数（3回再試行）後にゴール失敗を宣言しなければならない | 高 | 統合テスト |
| NAV-EXEC-GOAL-005 | システムはゴールキャンセルをサポートしなければならない | 重要 | 統合テスト |
| NAV-EXEC-GOAL-006 | システムはゴールプリエンプションをサポートしなければならない（新ゴールが旧ゴールをキャンセル） | 高 | 統合テスト |

**合計要件数: 6**

---

### 5.2 リカバリー動作（NAV-EXEC-RECOVERY）

| 要件ID | 要件 | 優先度 | 検証 |
|----------------|-------------|----------|------------|
| NAV-EXEC-RECOVERY-001 | システムはリカバリー動作（クリア、回転、後退）を実装しなければならない | 重要 | 統合テスト |
| NAV-EXEC-RECOVERY-002 | システムはスタック時（10秒超進行なし）にリカバリーを試行しなければならない | 重要 | スタックテスト |
| NAV-EXEC-RECOVERY-003 | システムはローカルコストマップをクリアするために360°回転しなければならない | 高 | 統合テスト |
| NAV-EXEC-RECOVERY-004 | システムは前方パスがブロックされた場合、0.5m後退しなければならない | 高 | 統合テスト |
| NAV-EXEC-RECOVERY-005 | システムは動的障害物がクリアされるまで30秒待機しなければならない | 高 | 統合テスト |
| NAV-EXEC-RECOVERY-006 | システムは3回のリカバリー試行後にオペレーターヘルプを要求しなければならない | 高 | 統合テスト |
| NAV-EXEC-RECOVERY-007 | システムは理由付きで全リカバリー試行をログしなければならない | 中 | ログ検査 |

**合計要件数: 7**

---

### 5.3 再プランニング（NAV-EXEC-REPLAN）

| 要件ID | 要件 | 優先度 | 検証 |
|----------------|-------------|----------|------------|
| NAV-EXEC-REPLAN-001 | システムはパスからの逸脱が1m超の場合、再プランしなければならない | 高 | 統合テスト |
| NAV-EXEC-REPLAN-002 | システムは障害物がパスをブロックした場合、再プランしなければならない | 重要 | 統合テスト |
| NAV-EXEC-REPLAN-003 | システムは1秒以内に再プランしなければならない | 高 | 性能テスト |
| NAV-EXEC-REPLAN-004 | システムは再プランニング頻度を1 Hzに制限しなければならない（安定性） | 高 | 統合テスト |
| NAV-EXEC-REPLAN-005 | システムは再プランニング失敗時に以前のパスを維持しなければならない | 重要 | 故障注入テスト |

**合計要件数: 5**

---

## 6. 性能要件

### 6.1 ナビゲーション精度（NAV-PERF-ACC）

| 要件ID | 要件 | 優先度 | 検証 |
|----------------|-------------|----------|------------|
| NAV-PERF-ACC-001 | システムは500mにわたり±10cm位置精度を達成しなければならない | 重要 | フィールドテスト（50ミッション） |
| NAV-PERF-ACC-002 | システムは1kmにわたり±20cm位置精度を達成しなければならない | 高 | フィールドテスト（20ミッション） |
| NAV-PERF-ACC-003 | システムは±2°方向精度を達成しなければならない | 高 | フィールドテスト |
| NAV-PERF-ACC-004 | システムは95パーセンタイル精度±15cmを達成しなければならない | 高 | 統計分析 |
| NAV-PERF-ACC-005 | システムはドリフトを累積してはならない（固定マップ上のローカライゼーション） | 重要 | ドリフト解析テスト |

**合計要件数: 5**

---

### 6.2 ナビゲーション速度と効率（NAV-PERF-SPEED）

| 要件ID | 要件 | 優先度 | 検証 |
|----------------|-------------|----------|------------|
| NAV-PERF-SPEED-001 | システムは500mミッションで平均速度0.8 m/sを維持しなければならない | 高 | フィールドテスト |
| NAV-PERF-SPEED-002 | システムは500mミッションを12分未満で完了しなければならない | 高 | ミッションテスト |
| NAV-PERF-SPEED-003 | システムは1kmミッションを25分未満で完了しなければならない | 高 | ミッションテスト |
| NAV-PERF-SPEED-004 | システムはパス長を最適化しなければならない（最短パスの10%以内） | 中 | パス解析 |
| NAV-PERF-SPEED-005 | システムは不必要な停止を最小化しなければならない（500m当たり3回未満） | 中 | フィールドテスト |

**合計要件数: 5**

---

### 6.3 計算性能（NAV-PERF-COMP）

| 要件ID | 要件 | 優先度 | 検証 |
|----------------|-------------|----------|------------|
| NAV-PERF-COMP-001 | ローカライゼーションはCPUを20%未満使用しなければならない | 高 | リソース監視 |
| NAV-PERF-COMP-002 | パスプランニングはCPUを15%未満使用しなければならない | 高 | リソース監視 |
| NAV-PERF-COMP-003 | ナビゲーションスタックはRAMを5GB未満使用しなければならない | 高 | リソース監視 |
| NAV-PERF-COMP-004 | コストマップ更新は100ms未満で完了しなければならない | 高 | レイテンシーテスト |
| NAV-PERF-COMP-005 | 姿勢推定は50ms未満のレイテンシーを持たなければならない | 重要 | レイテンシーテスト |

**合計要件数: 5**

---

## 7. 統合要件

### 7.1 ROS 2 Nav2統合（NAV-INT-NAV2）

| 要件ID | 要件 | 優先度 | 検証 |
|----------------|-------------|----------|------------|
| NAV-INT-NAV2-001 | システムはNav2 Humble（ROS 2 Humble）を使用しなければならない | 重要 | バージョンチェック |
| NAV-INT-NAV2-002 | システムはbt_navigatorを動作ツリー実行に使用しなければならない | 重要 | 設定 |
| NAV-INT-NAV2-003 | システムはcontroller_serverを軌道実行に使用しなければならない | 重要 | 設定 |
| NAV-INT-NAV2-004 | システムはplanner_serverをパスプランニングに使用しなければならない | 重要 | 設定 |
| NAV-INT-NAV2-005 | システムはrecoveries_serverをリカバリー動作に使用しなければならない | 高 | 設定 |
| NAV-INT-NAV2-006 | システムはYAMLファイルでNav2を設定しなければならない | 高 | 設定テスト |

**合計要件数: 6**

---

### 7.2 スワーブドライブ統合（NAV-INT-SWERVE）

| 要件ID | 要件 | 優先度 | 検証 |
|----------------|-------------|----------|------------|
| NAV-INT-SWERVE-001 | システムはスワーブドライブコントローラー（nav2_core::Controllerインターフェース）を使用しなければならない | 重要 | コード検査 |
| NAV-INT-SWERVE-002 | システムは全方向動作（vx、vy、ω）をサポートしなければならない | 重要 | 統合テスト |
| NAV-INT-SWERVE-003 | システムはローカルプランナーでスワーブ運動学を使用しなければならない | 重要 | 設定 |
| NAV-INT-SWERVE-004 | システムはツイスト（linear.x、linear.y、angular.z）付きcmd_velを配信しなければならない | 重要 | トピック検査 |

**合計要件数: 4**

---

### 7.3 センサー統合（NAV-INT-SENSOR）

| 要件ID | 要件 | 優先度 | 検証 |
|----------------|-------------|----------|------------|
| NAV-INT-SENSOR-001 | システムは/scan（2Dに投影された3D LiDAR）をサブスクライブしなければならない | 重要 | トピック検査 |
| NAV-INT-SENSOR-002 | システムは/imu/data（IMU方向＋角速度）をサブスクライブしなければならない | 重要 | トピック検査 |
| NAV-INT-SENSOR-003 | システムは/odom（車輪オドメトリ）をサブスクライブしなければならない | 重要 | トピック検査 |
| NAV-INT-SENSOR-004 | システムはrobot_localizationパッケージを使用してセンサーを融合しなければならない | 高 | 設定 |
| NAV-INT-SENSOR-005 | システムは融合されたオドメトリを/odometry/filteredに配信しなければならない | 高 | トピック検査 |

**合計要件数: 5**

---

## 8. テストと検証

### 8.1 ユニットテスト（NAV-TEST-UNIT）

| 要件ID | 要件 | 優先度 | 検証 |
|----------------|-------------|----------|------------|
| NAV-TEST-UNIT-001 | NDTローカライゼーションは85%超のユニットテストカバレッジを持たなければならない | 高 | コードカバレッジ |
| NAV-TEST-UNIT-002 | パスプランニングアルゴリズムは80%超のユニットテストカバレッジを持たなければならない | 高 | コードカバレッジ |
| NAV-TEST-UNIT-003 | ウェイポイントマネージャーは90%超のユニットテストカバレッジを持たなければならない | 高 | コードカバレッジ |

**合計要件数: 3**

---

### 8.2 統合テスト（NAV-TEST-INT）

| 要件ID | 要件 | 優先度 | 検証 |
|----------------|-------------|----------|------------|
| NAV-TEST-INT-001 | システムは50回の成功した500mミッションを完了しなければならない | 重要 | フィールドテスト |
| NAV-TEST-INT-002 | システムは20回の成功した1kmミッションを完了しなければならない | 重要 | フィールドテスト |
| NAV-TEST-INT-003 | システムは10回のマルチウェイポイントミッション（5ウェイポイント以上）を完了しなければならない | 高 | フィールドテスト |
| NAV-TEST-INT-004 | システムは20回の動的障害物シナリオを処理しなければならない | 高 | フィールドテスト |
| NAV-TEST-INT-005 | システムは10回のローカライゼーション再初期化シナリオを処理しなければならない | 高 | フィールドテスト |

**合計要件数: 5**

---

### 8.3 受け入れ基準（NAV-TEST-ACCEPT）

| 基準 | 目標 | MVP目標 | 検証 |
|-----------|--------|------------|------------|
| 位置精度（500m） | ±10cm | ±20cm | 50ミッション |
| 位置精度（1km） | ±20cm | ±40cm | 20ミッション |
| ミッション成功率 | >95% | >90% | 100ミッション |
| 平均ミッション速度 | 0.8 m/s | 0.6 m/s | フィールドテスト |
| ローカライゼーション信頼度 | >95% | >90% | 継続監視 |
| リカバリー成功率 | >90% | >80% | 50スタックシナリオ |
| CPU使用率 | <35%（loc+plan） | <50% | リソース監視 |

---

## 9. 要件サマリー

### カテゴリ別要件数

| カテゴリ | 合計要件数 | 重要 | 高 | 中 | 低 |
|----------|-------------------|----------|------|--------|-----|
| **ローカライゼーション** | **32** | 18 | 11 | 3 | 0 |
| - NDTスキャンマッチング | 8 | 4 | 3 | 1 | 0 |
| - センサーフュージョン | 6 | 3 | 3 | 0 | 0 |
| - マップ管理 | 7 | 3 | 3 | 1 | 0 |
| - 初期姿勢 | 6 | 4 | 2 | 0 | 0 |
| - 故障処理 | 5 | 4 | 1 | 0 | 0 |
| **パスプランニング** | **28** | 16 | 10 | 2 | 0 |
| - グローバルプランニング | 7 | 4 | 2 | 1 | 0 |
| - ローカルプランニング | 7 | 5 | 2 | 0 | 0 |
| - コストマップ | 8 | 6 | 1 | 1 | 0 |
| - 動的障害物 | 6 | 3 | 3 | 0 | 0 |
| **マルチウェイポイント** | **20** | 8 | 11 | 1 | 0 |
| - ウェイポイント管理 | 6 | 3 | 2 | 1 | 0 |
| - ウェイポイント実行 | 7 | 4 | 3 | 0 | 0 |
| - ミッションプランニング | 7 | 3 | 4 | 0 | 0 |
| **ルート実行** | **18** | 10 | 7 | 1 | 0 |
| - ゴール処理 | 6 | 4 | 2 | 0 | 0 |
| - リカバリー動作 | 7 | 3 | 4 | 0 | 0 |
| - 再プランニング | 5 | 3 | 2 | 0 | 0 |
| **性能** | **15** | 3 | 10 | 2 | 0 |
| - ナビゲーション精度 | 5 | 2 | 3 | 0 | 0 |
| - 速度と効率 | 5 | 0 | 3 | 2 | 0 |
| - 計算性能 | 5 | 1 | 4 | 0 | 0 |
| **統合** | **15** | 11 | 4 | 0 | 0 |
| - Nav2統合 | 6 | 5 | 1 | 0 | 0 |
| - スワーブドライブ | 4 | 4 | 0 | 0 | 0 |
| - センサー統合 | 5 | 3 | 2 | 0 | 0 |
| **テスト** | **8** | 2 | 6 | 0 | 0 |
| - ユニットテスト | 3 | 0 | 3 | 0 | 0 |
| - 統合テスト | 5 | 2 | 3 | 0 | 0 |
| **合計** | **136** | **68（50%）** | **59（43%）** | **9（7%）** | **0（0%）** |

**優先度分布:**
- **重要（68要件、50%）**: コアナビゲーション機能、これなしではシステムはナビゲートできない
- **高（59要件、43%）**: 信頼性と堅牢性のために重要
- **中（9要件、7%）**: あると良い最適化
- **低（0要件、0%）**: ナビゲーションサブシステムではN/A

---

## 10. 受け入れ基準

### 10.1 最小実用製品（MVP）

**MVP定義:** 事前マップルート上の信頼性の高いポイント間自律ナビゲーション、500mで±20cm精度。

**MVP要件:**
- ✅ 全重要要件（合計68）を満たす必要がある
- ✅ 事前構築マップ上でNDTローカライゼーション動作
- ✅ Nav2パスプランニング機能（グローバル＋ローカル）
- ✅ 500mで±20cm精度（ミッションの90%）
- ✅ >90%ミッション成功率（50テストミッション）
- ✅ マルチウェイポイントナビゲーション（最大5ウェイポイント）
- ✅ 基本リカバリー動作（クリア、回転、後退）
- ✅ <50% CPU使用率（ナビゲーションスタック）

**MVP除外:**
- 1kmミッション（500mに制限可能）
- 高度なリカバリー動作
- 動的障害物予測（基本回避を使用可能）

---

### 10.2 量産対応

**量産定義:** 堅牢、効率的、全天候型自律ナビゲーション、全重要＋高要件を満たす。

**量産要件:**
- ✅ 全重要（68）＋全高（59）要件を満たす = 合計127
- ✅ 500mで±10cm精度、1kmで±20cm
- ✅ >95%ミッション成功率（1000テストミッション）
- ✅ 0.8 m/s平均ミッション速度
- ✅ マルチウェイポイントミッション（最大10ウェイポイント、1km合計）
- ✅ 動的障害物予測と回避
- ✅ 高度なリカバリー動作（>90%成功）
- ✅ <35% CPU使用率（ナビゲーションスタック）
- ✅ 夜間および小雨での運用

---

## 11. トレーサビリティ

### 11.1 親要件トレーサビリティ

この文書は以下から要件を導出します:

**SYSTEM_REQUIREMENTS.md（NAV-REQ）:**
| システム要件 | 導出されたナビゲーション要件 | ステータス |
|--------------------|-------------------------------|--------|
| NAV-REQ-002（500mで±10cm） | NAV-PERF-ACC-001、NAV-LOC-NDT-003 | トレース済み |
| NAV-REQ-003（NDTローカライゼーション） | NAV-LOC-NDT-001～008 | トレース済み |
| NAV-REQ-004（マルチウェイポイント） | NAV-WP-MANAGE-001、NAV-WP-EXEC-001 | トレース済み |
| NAV-REQ-005（Nav2統合） | NAV-INT-NAV2-001～006 | トレース済み |
| NAV-REQ-006（500m～1km範囲） | NAV-WP-MISSION-001 | トレース済み |
| NAV-REQ-007（A*/Dijkstra） | NAV-PLAN-GLOBAL-003 | トレース済み |
| NAV-REQ-008（衝突回避） | NAV-PLAN-DYN-004、NAV-PLAN-COST-004 | トレース済み |
| NAV-REQ-009（リカバリー動作） | NAV-EXEC-RECOVERY-001～007 | トレース済み |

**全システムレベルナビゲーション要件がサブシステム要件にトレースされています。** ✅

---

## 12. 変更履歴

| バージョン | 日付 | 著者 | 変更内容 |
|---------|------|--------|---------|
| 1.0 | 2025-12-15 | Navigation Lead | ParcelPal NDTアーキテクチャに基づく初期ナビゲーション要件 |

---

**文書ステータス:** ドラフト
**次回レビュー:** Nav2設定と初期マッピング後
**承認要:** Navigation Lead、System Architect、Localization Engineer

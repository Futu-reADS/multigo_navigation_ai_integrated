# 車両TVMクライアント要件

**文書管理:**
- **文書ID:** VEH-TVM-REQ-001
- **バージョン:** 1.0
- **日付:** 2025年12月16日
- **ステータス:** ドラフト
- **オーナー:** Pankaj（車両ソフトウェアチーム）
- **レビュアー:** Unno（TVMサーバー統合）、システムアーキテクト

---

## 1. はじめに

### 1.1 目的

この文書は、TVM（Total Vehicle Management）サーバーと通信する車両側ソフトウェアコンポーネントである車両TVMクライアントの要件を規定します。クライアントは、車両テレメトリ（位置、ステータス、バッテリー、エラー、ドッキング更新）をTVMサーバーに公開し、REST APIとWebSocket接続を介してミッションコマンドを受信する責任があります。

### 1.2 スコープ

**スコープ内:**
- テレメトリ公開用REST APIクライアント
- リアルタイムコマンド受信用WebSocketクライアント
- メッセージキューイングによるオフライン動作
- JWT認証とトークン管理
- メッセージ検証とエラー処理
- 車両ROS 2システムとの統合
- リトライロジックと接続復旧

**スコープ外:**
- TVMサーバーバックエンド実装（TVM_SERVER_REQUIREMENTS.mdでカバー）
- フリート管理フロントエンド（FLEET_MANAGEMENT_REQUIREMENTS.mdでカバー）
- 車両ナビゲーション、ドッキング、パーセプション（他のVEHICLE要件でカバー）

### 1.3 定義と略語

| 用語 | 定義 |
|------|------------|
| TVMクライアント | TVMサーバーと通信する車両側ソフトウェア |
| TVMサーバー | フリート管理バックエンドサーバー |
| テレメトリ | 車両センサーデータ（位置、バッテリー、ステータス） |
| オフラインキュー | TVMサーバーが到達不能な場合のローカルメッセージバッファ |
| JWT | JSON Web Token（認証） |
| ハートビート | WebSocket接続を維持するための定期的なping |

### 1.4 参照

- TVM_API_SPECIFICATION.md - 完全なAPI契約（7 RESTエンドポイント、5 WebSocketコマンド）
- TVM_DATA_MODELS.md - JSONスキーマと検証ルール
- TVM_SERVER_REQUIREMENTS.md - サーバー側実装
- FLEET_MANAGEMENT_REQUIREMENTS.md - フロントエンドアプリケーション

---

## 2. システム概要

### 2.1 アーキテクチャ

TVMクライアントは以下を行うROS 2ノードです:
- 車両ROS 2トピックをサブスクライブ（位置、バッテリー、ステータス、エラー、ドッキング）
- 指定された頻度でREST API経由でTVMサーバーにテレメトリを公開
- WebSocket経由でTVMサーバーからミッションコマンドを受信し、ROS 2に公開
- オフライン時（TVMサーバー到達不能）にローカルでメッセージをキューイング
- 接続復旧時にバルクアップロード経由でキューされたメッセージをアップロード
- JWTトークンライフサイクルを管理（認証、リフレッシュ）

### 2.2 技術スタック

**実装言語:** Python 3.10以上（ROS 2 Humble互換性のため推奨）

**ライブラリ:**
- ROS 2 Humble（ROS 2ノード用rclpy）
- requests（REST APIクライアント）
- websocketsまたはpython-socketio（WebSocketクライアント）
- pyjwt（JWTトークン処理）
- pydantic（JSONスキーマに対するメッセージ検証）

---

## 3. 機能要件

### 3.1 REST APIクライアント

#### 3.1.1 位置更新公開

| 要件ID | 優先度 | 要件 | 受入基準 |
|--------|----------|-------------|---------------------|
| VEH-TVM-LOC-001 | CRITICAL | クライアントは1 HzでTVMサーバーに位置更新を公開すること | • ROS 2トピックをサブスクライブ: /tvm/location<br>• 1秒ごとに/api/v1/vehicle/{vehicle_id}/locationにPOST<br>• レート制限: 最大1 req/s |
| VEH-TVM-LOC-002 | HIGH | クライアントは送信前に位置データを検証すること | • TVM_DATA_MODELS.mdからLocationUpdateスキーマを使用<br>• Pydantic検証<br>• 無効なメッセージをスキップ（エラーをログ） |
| VEH-TVM-LOC-003 | HIGH | クライアントは位置更新に正確なタイムスタンプを含めること | • ミリ秒精度のISO 8601 UTC形式<br>• 車両システム時刻を使用（NTP同期）<br>• 送信時刻ではなく測定時のタイムスタンプ |
| VEH-TVM-LOC-004 | MEDIUM | クライアントはオフライン時に位置更新をキューイングすること | • ローカルキューに保存（最大1000メッセージ）<br>• キュー満杯時FIFO削除<br>• 接続復旧時にバルクエンドポイント経由でアップロード |

#### 3.1.2 車両ステータス公開

| 要件ID | 優先度 | 要件 | 受入基準 |
|--------|----------|-------------|---------------------|
| VEH-TVM-STATUS-001 | CRITICAL | クライアントは状態変更時に車両ステータス更新を公開すること | • ROS 2トピックをサブスクライブ: /tvm/status<br>• 状態変更時（idle、navigating、docking、charging、error、emergency_stop）に/api/v1/vehicle/{vehicle_id}/statusにPOST<br>• イベント駆動（定期的ではない） |
| VEH-TVM-STATUS-002 | HIGH | クライアントはミッション中のステータス更新にmission_idを含めること | • アクティブなミッションにステータスをリンク<br>• アイドル時は空/null<br>• UUID形式に対して検証 |

#### 3.1.3 バッテリー更新公開

| 要件ID | 優先度 | 要件 | 受入基準 |
|--------|----------|-------------|---------------------|
| VEH-TVM-BAT-001 | HIGH | クライアントは5秒ごとにバッテリー更新を公開すること | • ROS 2トピックをサブスクライブ: /power/battery_state<br>• 5秒ごとに/api/v1/vehicle/{vehicle_id}/batteryにPOST<br>• レート制限: 最大1 req/5s |
| VEH-TVM-BAT-002 | MEDIUM | クライアントはすべてのバッテリーメトリクスを含めること | • SoC（0-100%）、電圧、電流、温度、充電ステータス<br>• BatteryUpdateスキーマに従って検証<br>• 精度: SoC ±1%、電圧 ±0.1V、温度 ±0.5°C |

#### 3.1.4 エラーレポート公開

| 要件ID | 優先度 | 要件 | 受入基準 |
|--------|----------|-------------|---------------------|
| VEH-TVM-ERR-001 | CRITICAL | クライアントはエラー発生時に即座にエラーレポートを公開すること | • ROS 2トピックをサブスクライブ: /tvm/error<br>• エラー発生後1秒以内に/api/v1/vehicle/{vehicle_id}/errorにPOST<br>• イベント駆動 |
| VEH-TVM-ERR-002 | HIGH | クライアントはエラー深刻度とサブシステムを含めること | • 深刻度: INFO、WARNING、ERROR、CRITICAL<br>• サブシステム: navigation、perception、docking、power、communication<br>• ErrorReportスキーマに従って検証 |

#### 3.1.5 ドッキング更新公開

| 要件ID | 優先度 | 要件 | 受入基準 |
|--------|----------|-------------|---------------------|
| VEH-TVM-DOCK-001 | HIGH | クライアントはドッキング操作中にドッキング更新を公開すること | • ROS 2トピックをサブスクライブ: /tvm/docking<br>• フェーズ変更時（approaching、aligning、docking、docked）に/api/v1/vehicle/{vehicle_id}/dockingにPOST<br>• イベント駆動 |
| VEH-TVM-DOCK-002 | MEDIUM | クライアントはArUcoマーカー検出結果を含めること | • マーカーID、距離、アライメントエラー<br>• TVMサーバーがドッキングパフォーマンスを追跡するのに役立つ<br>• オプションフィールド（マーカー未検出の場合null） |

#### 3.1.6 バルクアップロード（オフライン復旧）

| 要件ID | 優先度 | 要件 | 受入基準 |
|--------|----------|-------------|---------------------|
| VEH-TVM-BULK-001 | HIGH | クライアントは接続復旧時にバルクエンドポイント経由でキューされたメッセージをアップロードすること | • /api/v1/vehicle/{vehicle_id}/bulkにPOST<br>• リクエストあたり最大1000メッセージ<br>• 失敗時にリトライ（3回試行） |
| VEH-TVM-BULK-002 | HIGH | クライアントはアップロード成功後にキューされたメッセージをクリアすること | • ローカルキューからメッセージを削除<br>• 成功カウントをログ<br>• 通常のテレメトリ公開を再開 |
| VEH-TVM-BULK-003 | MEDIUM | クライアントはバルクアップロード前にキューされたメッセージを重複排除すること | • 重複タイムスタンプをチェック<br>• 重複が存在する場合は最新のメッセージを保持<br>• サーバー負荷を削減 |

---

### 3.2 WebSocketクライアント

#### 3.2.1 接続管理

| 要件ID | 優先度 | 要件 | 受入基準 |
|--------|----------|-------------|---------------------|
| VEH-TVM-WS-CONN-001 | CRITICAL | クライアントは起動時にTVMサーバーへのWebSocket接続を確立すること | • wss://{server}/ws/vehicle/{vehicle_id}に接続<br>• クエリパラメータまたはヘッダーにJWTトークンを含める<br>• 接続失敗時にリトライ（指数バックオフ） |
| VEH-TVM-WS-CONN-002 | HIGH | クライアントは接続ハートビートを実装すること | • 5秒以内にサーバーpingに応答<br>• メッセージ未受信の場合30秒ごとにpingを送信<br>• pingへの応答がない場合は切断を検出 |
| VEH-TVM-WS-CONN-003 | HIGH | クライアントはWebSocket切断時に自動再接続すること | • 指数バックオフ: 1秒、2秒、4秒、8秒、... 最大60秒<br>• 切断理由をログ<br>• 再接続後に通常動作を再開 |

#### 3.2.2 コマンド受信

| 要件ID | 優先度 | 要件 | 受入基準 |
|--------|----------|-------------|---------------------|
| VEH-TVM-WS-CMD-001 | CRITICAL | クライアントはTVMサーバーから「dispatch」コマンドを受信すること | • dispatchメッセージを解析（mission_id、pickup、destination、priority）<br>• ROS 2トピックに公開: /navigation/mission/dispatch<br>• 2秒以内にコマンドを確認 |
| VEH-TVM-WS-CMD-002 | CRITICAL | クライアントはTVMサーバーから「cancel」コマンドを受信すること | • cancelメッセージを解析（mission_id）<br>• ROS 2トピックに公開: /navigation/mission/cancel<br>• 2秒以内にコマンドを確認 |
| VEH-TVM-WS-CMD-003 | CRITICAL | クライアントはTVMサーバーから「emergency_stop」コマンドを受信すること | • ROS 2トピックに公開: /safety/emergency_stop（最高優先度）<br>• 500ms以内にコマンドを確認<br>• 即座のアクション（検証遅延なし） |
| VEH-TVM-WS-CMD-004 | HIGH | クライアントはTVMサーバーから「resume」コマンドを受信すること | • ROS 2トピックに公開: /safety/resume<br>• コマンドを確認<br>• emergency_stop後のみ有効 |
| VEH-TVM-WS-CMD-005 | MEDIUM | クライアントはTVMサーバーから「configure」コマンドを受信すること | • 設定更新を解析（speed_limit、operational_hours）<br>• ROS 2トピックに公開: /config/update<br>• 更新された設定で確認 |

#### 3.2.3 メッセージ検証

| 要件ID | 優先度 | 要件 | 受入基準 |
|--------|----------|-------------|---------------------|
| VEH-TVM-WS-VAL-001 | HIGH | クライアントはすべてのWebSocketメッセージをJSONスキーマに対して検証すること | • TVM_DATA_MODELS.mdからスキーマを使用<br>• Pydantic検証<br>• 無効なメッセージを拒否（エラー応答を送信） |
| VEH-TVM-WS-VAL-002 | MEDIUM | クライアントはコマンドIDが一意であることを検証すること | • command_idが最近のコマンド（最後の100件）の重複でないことをチェック<br>• 重複コマンドを無視<br>• 警告をログ |

---

### 3.3 認証とトークン管理

#### 3.3.1 JWTトークン取得

| 要件ID | 優先度 | 要件 | 受入基準 |
|--------|----------|-------------|---------------------|
| VEH-TVM-AUTH-001 | CRITICAL | クライアントは起動時にTVMサーバーで認証すること | • client_idとclient_secretで/api/v1/auth/tokenにPOST<br>• JWTトークン（24時間有効期限） + リフレッシュトークンを受信<br>• トークンを安全に保存（メモリ内、ディスクに書き込まない） |
| VEH-TVM-AUTH-002 | HIGH | クライアントはすべてのREST APIリクエストにJWTトークンを含めること | • Authorizationヘッダー: "Bearer {token}"<br>• トークンが欠落または無効な場合、リクエストは401で失敗<br>• 401を受信した場合は自動的にトークンをリフレッシュ |

#### 3.3.2 トークンリフレッシュ

| 要件ID | 優先度 | 要件 | 受入基準 |
|--------|----------|-------------|---------------------|
| VEH-TVM-AUTH-REF-001 | HIGH | クライアントは有効期限前に自動的にJWTトークンをリフレッシュすること | • トークン寿命の80%でリフレッシュ（24時間トークンの場合19.2時間）<br>• リフレッシュトークンで/api/v1/auth/refreshにPOST<br>• 保存されたJWTトークンを更新 |
| VEH-TVM-AUTH-REF-002 | HIGH | クライアントはトークンリフレッシュ失敗時に認証をリトライすること | • 指数バックオフでリトライ（1秒、2秒、4秒）<br>• 最大5回試行<br>• すべてのリトライ失敗時にクリティカルエラーをログ |

---

### 3.4 オフライン動作

#### 3.4.1 接続検出

| 要件ID | 優先度 | 要件 | 受入基準 |
|--------|----------|-------------|---------------------|
| VEH-TVM-OFFLINE-001 | HIGH | クライアントはTVMサーバーが到達不能な場合を検出すること | • 接続タイムアウト: 10秒<br>• オフライン宣言前に3回リトライ<br>• オフライン状態をログ |
| VEH-TVM-OFFLINE-002 | MEDIUM | クライアントはオフライン時に定期的にTVMサーバーの可用性をチェックすること | • 60秒ごとに接続をリトライ<br>• 接続復旧時に通常動作を再開<br>• オンライン状態をログ |

#### 3.4.2 メッセージキューイング

| 要件ID | 優先度 | 要件 | 受入基準 |
|--------|----------|-------------|---------------------|
| VEH-TVM-QUEUE-001 | HIGH | クライアントはTVMサーバー到達不能時にテレメトリメッセージをキューイングすること | • 最大キューサイズ: 1000メッセージ<br>• キュー満杯時にFIFO削除（最も古いメッセージを削除）<br>• キューはメモリに保存（一時的、再起動時に失われる） |
| VEH-TVM-QUEUE-002 | MEDIUM | クライアントはオフラインキューでエラーレポートを優先すること | • キュー満杯でもエラーレポートをキューに保持<br>• キュー満杯時は位置/バッテリー更新を最初に削除<br>• クリティカルエラーが失われないことを保証 |

---

### 3.5 エラー処理とリトライロジック

| 要件ID | 優先度 | 要件 | 受入基準 |
|--------|----------|-------------|---------------------|
| VEH-TVM-ERR-HANDLE-001 | HIGH | クライアントは失敗したリクエストに対して指数バックオフを実装すること | • バックオフ: 1秒、2秒、4秒、8秒、16秒、... 最大60秒<br>• 最大10回リトライ試行<br>• 10回失敗後、バルクアップロード用にメッセージをキューイング |
| VEH-TVM-ERR-HANDLE-002 | HIGH | クライアントはすべての通信エラーをログすること | • ログレベル: 接続失敗時ERROR、リトライ時WARNING<br>• 含む: タイムスタンプ、エンドポイント、エラーメッセージ、リトライ回数<br>• 構造化ログ（JSON形式） |
| VEH-TVM-ERR-HANDLE-003 | MEDIUM | クライアントはTVM接続ステータスをROS 2に公開すること | • トピック: /tvm/connection_status（std_msgs/Bool）<br>• True = 接続、False = オフライン<br>• 状態変更時に更新 |

---

## 4. 非機能要件

### 4.1 パフォーマンス

| 要件ID | 優先度 | 要件 | 受入基準 |
|--------|----------|-------------|---------------------|
| VEH-TVM-PERF-001 | HIGH | クライアントは一貫して1 Hzで位置更新を公開すること | • 測定レイテンシ: ROS 2トピック受信からREST POSTまで<100ms<br>• 通常条件下でメッセージドロップなし<br>• ターゲットハードウェアでCPU使用率<5% |
| VEH-TVM-PERF-002 | MEDIUM | クライアントは<500msレイテンシでWebSocketコマンドを処理すること | • WebSocket受信からROS 2公開まで: <500ms<br>• コマンド処理はテレメトリ公開をブロックしない |

### 4.2 信頼性

| 要件ID | 優先度 | 要件 | 受入基準 |
|--------|----------|-------------|---------------------|
| VEH-TVM-REL-001 | HIGH | クライアントはネットワーク障害から自動的に復旧すること | • ネットワーク復旧後に自動再接続<br>• バルクエンドポイント経由でキューされたメッセージをアップロード<br>• 通常動作を再開（手動介入不要） |
| VEH-TVM-REL-002 | MEDIUM | クライアントはROS 2ライフサイクルノードとして実行すること（オプション） | • configure、activate、deactivate、cleanup状態をサポート<br>• SIGTERM時のグレースフルシャットダウン<br>• シャットダウン前にキューをフラッシュ |

### 4.3 セキュリティ

| 要件ID | 優先度 | 要件 | 受入基準 |
|--------|----------|-------------|---------------------|
| VEH-TVM-SEC-001 | CRITICAL | クライアントはHTTPSとWSS（セキュアWebSocket）を使用すること | • すべてのREST API呼び出しはhttps://を使用<br>• WebSocket接続はwss://を使用<br>• 暗号化されていない接続を拒否 |
| VEH-TVM-SEC-002 | HIGH | クライアントはTVMサーバーSSL証明書を検証すること | • 証明書検証を有効化（テスト以外は自己署名でない）<br>• 証明書が無効な場合は接続を拒否<br>• 設定可能な証明書バンドルパス |
| VEH-TVM-SEC-003 | HIGH | クライアントは機密データ（JWTトークン、シークレット）をログしないこと | • ログ内でトークンを編集（最初の8文字のみ表示）<br>• client_secretは決してログしない<br>• ログサニタイゼーション |

---

## 5. インターフェース要件

### 5.1 ROS 2トピック（入力 - 車両 → TVMクライアント）

| トピック | メッセージタイプ | 頻度 | 説明 |
|-------|--------------|-----------|-------------|
| /tvm/location | custom_msgs/LocationUpdate | 1 Hz | 車両位置、方位、速度 |
| /tvm/status | custom_msgs/VehicleStatus | イベント | 車両状態変更 |
| /power/battery_state | sensor_msgs/BatteryState | 0.2 Hz | バッテリーSoC、電圧、電流、温度 |
| /tvm/error | custom_msgs/ErrorReport | イベント | エラーレポート |
| /tvm/docking | custom_msgs/DockingUpdate | イベント | ドッキングフェーズ更新 |

**注:** カスタムメッセージ定義はTVM_DATA_MODELS.mdのJSONスキーマと一致すること

### 5.2 ROS 2トピック（出力 - TVMクライアント → 車両）

| トピック | メッセージタイプ | 説明 |
|-------|--------------|-------------|
| /navigation/mission/dispatch | custom_msgs/MissionDispatch | TVMサーバーからの新しいミッション |
| /navigation/mission/cancel | std_msgs/String | ミッションキャンセル（mission_id） |
| /safety/emergency_stop | std_msgs/Empty | 緊急停止コマンド |
| /safety/resume | std_msgs/Empty | 緊急停止からの再開 |
| /config/update | custom_msgs/ConfigUpdate | 設定更新 |
| /tvm/connection_status | std_msgs/Bool | TVMサーバー接続ステータス |

### 5.3 設定パラメータ（ROS 2パラメータ）

| パラメータ | タイプ | デフォルト | 説明 |
|-----------|------|---------|-------------|
| tvm_server_url | string | "https://tvm.example.com" | TVMサーバーベースURL |
| vehicle_id | string | "vehicle_001" | 一意の車両識別子 |
| client_id | string | "vehicle_001" | 認証クライアントID |
| client_secret | string | "" | 認証シークレット（環境変数からロード） |
| queue_max_size | int | 1000 | 最大オフラインキューサイズ |
| retry_max_attempts | int | 10 | 失敗したリクエストの最大リトライ試行回数 |

---

## 6. テスト要件

| テストタイプ | カバレッジ | 受入 |
|-----------|----------|------------|
| 単体テスト | ≥80%コードカバレッジ | すべてのテストがパス、クリティカルパス100% |
| 統合テスト | TVMクライアント ↔ モックTVMサーバー | すべてのAPIエンドポイントがテスト済み |
| オフラインテスト | ネットワーク切断/再接続シナリオ | キューとバルクアップロードが正しく動作 |
| 負荷テスト | 8時間1 Hzテレメトリ | メモリリークなし、安定したCPU使用率 |

---

## 7. トレーサビリティマトリックス

| 要件カテゴリー | 要件数 | 優先度分布 |
|---------------------|-------------------|----------------------|
| REST APIクライアント | 16 | CRITICAL: 3、HIGH: 10、MEDIUM: 3 |
| WebSocketクライアント | 11 | CRITICAL: 4、HIGH: 5、MEDIUM: 2 |
| 認証 | 4 | CRITICAL: 1、HIGH: 3 |
| オフライン動作 | 4 | HIGH: 2、MEDIUM: 2 |
| エラー処理 | 3 | HIGH: 2、MEDIUM: 1 |
| 非機能（パフォーマンス） | 2 | HIGH: 1、MEDIUM: 1 |
| 非機能（信頼性） | 2 | HIGH: 1、MEDIUM: 1 |
| 非機能（セキュリティ） | 3 | CRITICAL: 1、HIGH: 2 |
| **合計** | **45** | **CRITICAL: 9、HIGH: 26、MEDIUM: 10** |

---

## 8. 前提条件と依存関係

### 8.1 前提条件

1. 車両は信頼性の高いインターネット接続を持つ（Wi-Fiまたは4G/5G）
2. 車両システム時刻はNTP同期されている
3. 車両計算ユニットにROS 2 Humbleがインストールされている
4. Python 3.10以上が利用可能

### 8.2 依存関係

1. TVM_API_SPECIFICATION.md確定（週1 ✅）
2. TVM_DATA_MODELS.md確定（週1 ✅）
3. TVMサーバー展開済みでアクセス可能（TVM_SERVER_REQUIREMENTS.md）
4. 車両ROS 2システムが必要なトピックを公開（VEHICLE要件）

---

## 9. 未解決問題とリスク

### 9.1 未解決問題

| ID | 問題 | 担当 | 目標解決 |
|----|-------|-------|-------------------|
| VEH-TVM-ISSUE-001 | カスタムROS 2メッセージ定義の作成が必要 | Pankaj | 週7（実装） |
| VEH-TVM-ISSUE-002 | TVMサーバーURL設定（開発 vs 本番） | Pankaj | 週7 |

### 9.2 リスク

| リスク | 確率 | 影響 | 軽減策 |
|------|------------|--------|------------|
| ネットワークレイテンシ>1秒が1 Hz公開に影響 | MEDIUM | MEDIUM | 非同期公開を実装（非ブロッキング） |
| WebSocket接続が頻繁に切断 | LOW | HIGH | 堅牢な再接続ロジック、指数バックオフ |
| 長期オフライン期間中にキューが満杯 | LOW | MEDIUM | キューサイズを増やすか、永続キュー（ディスクストレージ）を実装 |

---

## 10. 改訂履歴

| バージョン | 日付 | 著者 | 変更内容 |
|---------|------|--------|---------|
| 1.0 | 2025年12月16日 | Pankaj | 初期ドラフト - 週2文書化 |

---

**文書終了**

**要件総数:** 45
**文書ステータス:** レビュー用ドラフト
**次回レビュー:** 週3（UnnoとTVMサーバー統合テスト用）

# TVMサーバーアーキテクチャ

**プロジェクト:** 屋外車椅子搬送ロボット - マルチチームシステム
**文書タイプ:** フリート管理アーキテクチャ仕様
**チーム:** 海野（フリート管理）
**日付:** 2025年12月16日
**バージョン:** 1.0

---

## システムアーキテクチャ概要

```
┌─────────────────────────────────────────────────────────────┐
│                    TVMサーバー（Node.js）                    │
│                                                             │
│  ┌─────────────┐  ┌──────────────┐  ┌─────────────────┐  │
│  │   REST API  │  │  WebSocket   │  │  バックグラウンド│  │
│  │   (Express) │  │  (Socket.io) │  │  ワーカー (Bull) │  │
│  └──────┬──────┘  └──────┬───────┘  └────────┬────────┘  │
│         │                 │                    │           │
│         └─────────────────┴────────────────────┘           │
│                           │                                │
│                  ┌────────▼─────────┐                      │
│                  │  ビジネスロジック│                      │
│                  │   (サービス)     │                      │
│                  └────────┬─────────┘                      │
│                           │                                │
│         ┌─────────────────┼──────────────────┐            │
│         │                 │                  │             │
│    ┌────▼─────┐    ┌─────▼──────┐    ┌─────▼──────┐     │
│    │PostgreSQL│    │   Redis    │    │  S3 (logs) │     │
│    │  (main)  │    │  (cache)   │    │  (storage) │     │
│    └──────────┘    └────────────┘    └────────────┘     │
└─────────────────────────────────────────────────────────────┘
```

## 技術スタック

- **ランタイム:** Node.js 20 LTS
- **フレームワーク:** Express.js 4.x
- **データベース:** PostgreSQL 15
- **キャッシュ:** Redis 7.x
- **キュー:** Bull（Redisベース）
- **WebSocket:** Socket.io 4.x
- **認証:** JWT（jsonwebtoken）
- **検証:** Joi
- **ORM:** Prisma

## コンポーネント詳細

### REST APIレイヤー
- 認証ミドルウェア（JWT検証）
- レート制限（express-rate-limit）
- リクエスト検証（Joiスキーマ）
- エラー処理ミドルウェア
- APIバージョニング（/api/v1/）

### WebSocketレイヤー
- リアルタイム車両テレメトリ
- ミッションステータス更新
- フリートダッシュボード更新
- JWTによる認証

### バックグラウンドワーカー
- ミッションスケジューリング
- バッテリー健全性監視
- ログ集約
- 分析計算

### データベーススキーマ
- vehicles、missions、reservations、users、roles、logs
- クエリ用最適化インデックス
- 大規模テーブル用パーティショニング

### キャッシング戦略
- 車両ステータス: 5秒TTL
- ユーザーセッション: 24時間TTL
- マップデータ: 1時間TTL

## デプロイアーキテクチャ

- AWS ECS上のDockerコンテナ
- アプリケーションロードバランサー
- オートスケーリング（2～10インスタンス）
- マルチAZデプロイ

---

**合計:** TVM_SERVER_REQUIREMENTS.mdで35～40要件をカバー

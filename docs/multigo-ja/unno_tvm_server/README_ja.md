# TVMサーバー（フリート管理） - Unnoの範囲

**チームリーダー:** Unno
**範囲:** TVMサーバー（バックエンド+ダッシュボード）のみ
**タイムライン:** 20週間（MVP 15週間 + 高度な機能 5週間）
**ステータス:** 実装準備完了

---

## 🎯 あなたが構築するもの

**フリート管理システム（サーバーサイド）:**
- ✅ **バックエンドサーバー** - REST API + WebSocketサーバー
- ✅ **データベース** - 車両データ、ミッション、ユーザー、テレメトリー
- ✅ **フリートダッシュボード** - Webアプリケーション（PC/タブレット）
- ✅ **ユーザー認証** - JWT、ロールベースアクセス制御（RBAC）
- ✅ **予約システム** - ミッションスケジューリングと派遣
- ✅ **リアルタイム監視** - 車両位置、ステータス、バッテリー
- ✅ **遠隔操作** - 手動制御インターフェース（オプション）
- ✅ **音声通信** - VoIP統合（オプション）

---

## ❌ あなたが構築しないもの

- ❌ **車両ソフトウェア**（Pankajの責任範囲）
  - ROS 2ノード、ナビゲーション、ドッキング、知覚は含まれません
  - 車両側クライアントコードは含まれません

- ❌ **ハードウェアプラットフォーム**（TsuchiyaとKirilの責任範囲）
  - 機械、電気、センサーは含まれません
  - 物理的なロボットは含まれません

**あなたの焦点:** サーバーサイドバックエンドとフリート管理ダッシュボード

---

## 🔗 あなたのインターフェース

### 車両ソフトウェアへのインターフェース（Pankaj）

**ドキュメント（重要）:**
- `04_INTERFACES/TVM_API_SPECIFICATION.md` - **これを実装する必要があります**
- `04_INTERFACES/TVM_DATA_MODELS.md` - 従うべきJSONスキーマ

**Pankajがあなたに送信するもの:**
- 車両テレメトリー（位置、ステータス、バッテリー、エラー）REST API経由
- 1秒ごとのハートビート
- ミッションステータス更新

**あなたがPankajに送信するもの:**
- ミッション派遣コマンド WebSocket経由
- 緊急停止コマンド
- 設定更新
- ミッションキャンセルコマンド

**実装ガイド:**
- `TVM_API_IMPLEMENTATION_GUIDE_FOR_UNNO.md`を参照（提供予定）
- テスト用のモック車両クライアントを使用（提供予定）

---

## 🛠️ 技術スタック（あなたの選択）

**バックエンドオプション:**
- Node.js + Express/NestJS
- Python + FastAPI/Django
- Java + Spring Boot
- **あなたの決定** - チームの専門知識に基づいて選択

**データベースオプション:**
- PostgreSQL（リレーショナル、推奨）
- MySQL（リレーショナル）
- MongoDB（ドキュメント、柔軟）
- **あなたの決定** - スキーマ参照はDATABASE_DESIGN.mdを参照

**フロントエンドオプション:**
- React（最も人気）
- Vue（軽量）
- Angular（エンタープライズ）
- **あなたの決定** - Webベースである必要があります（PC/タブレット）

**リアルタイム:**
- WebSocket / Socket.io（車両コマンドに必須）

**VoIP（オプション）:**
- Twilio（商用）
- WebRTC（オープン標準）
- Asterisk（オープンソースPBX）

---

## 📁 フォルダ構造

```
unno_tvm_server/
├── 01_REQUIREMENTS/          ← サーバーが満たすべき要件
│   ├── FLEET_MANAGEMENT_REQUIREMENTS.md
│   ├── TVM_SERVER_REQUIREMENTS.md
│   ├── RESERVATION_SYSTEM_REQUIREMENTS.md
│   ├── USER_ROLE_MANAGEMENT_REQUIREMENTS.md
│   ├── FLEET_UI_REQUIREMENTS.md
│   └── TELEOPERATION_REQUIREMENTS.md
│
├── 02_ARCHITECTURE/          ← システムの構成
│   ├── TVM_SERVER_ARCHITECTURE.md
│   ├── DATABASE_ARCHITECTURE.md
│   ├── DATABASE_DESIGN.md（PostgreSQLスキーマ参照）
│   └── FLEET_UI_ARCHITECTURE.md
│
├── 03_DESIGN/                ← 詳細設計
│   ├── TVM_SERVER_DESIGN.md
│   ├── DATABASE_SCHEMA_DESIGN.md
│   ├── AUTHENTICATION_DESIGN.md
│   └── FLEET_UI_COMPONENTS_DESIGN.md
│
├── 04_INTERFACES/            ← 車両へのインターフェース（Pankaj）
│   ├── TVM_API_SPECIFICATION.md ← これを実装（重要！）
│   └── TVM_DATA_MODELS.md ← これらのスキーマに従う
│
├── 05_DEVELOPMENT/           ← 開発方法
│   └── FLEET_SOFTWARE_DEVELOPMENT_GUIDE.md
│
└── README.md                 ← このファイル
```

---

## 🚀 クイックスタート

### 1. まずインターフェースドキュメントを読む

**重要 - コーディング前に必読:**
1. `04_INTERFACES/TVM_API_SPECIFICATION.md` - **実装する必要があるAPI**
2. `04_INTERFACES/TVM_DATA_MODELS.md` - **従う必要があるJSONスキーマ**
3. `TVM_API_IMPLEMENTATION_GUIDE_FOR_UNNO.md` - 実装ガイド（Pankajから提供予定）

### 2. 要件を確認

何を構築するかを理解するために、以下から始めてください:
1. `01_REQUIREMENTS/TVM_SERVER_REQUIREMENTS.md`
2. `01_REQUIREMENTS/FLEET_MANAGEMENT_REQUIREMENTS.md`
3. `01_REQUIREMENTS/RESERVATION_SYSTEM_REQUIREMENTS.md`

### 3. データベース設計を確認

参照: `02_ARCHITECTURE/DATABASE_DESIGN.md`（PostgreSQLスキーマ参照）

**11テーブル:**
- users、vehicles、missions、mission_waypoints
- vehicle_telemetry、vehicle_errors、reservations
- floors、routes、route_waypoints、audit_logs

### 4. 技術スタックを選択

**必要な決定:**
- バックエンドフレームワーク（Node.js/Python/Java）
- データベース（PostgreSQL推奨）
- フロントエンドフレームワーク（React/Vue/Angular）

### 5. 実装を開始

**推奨される順序（まずMVP）:**

**フェーズ1: MVP（15週間）**
1. **第1-2週:** 認証 + ユーザー管理
2. **第3-5週:** データベーススキーマ + 基本CRUD
3. **第6-8週:** 車両テレメトリー取り込み（REST API）
4. **第9-11週:** ミッション派遣（WebSocket）
5. **第12-13週:** フリートダッシュボード（基本UI）
6. **第14-15週:** Pankajとの統合テスト

**フェーズ2: 高度な機能（5週間）**
7. **第16-17週:** 予約システム
8. **第18-19週:** 高度なダッシュボード機能
9. **第20週:** 音声通信（オプション）

---

## 🔑 主要設計原則

### 1. APIファースト開発
- TVM_API_SPECIFICATION.mdを仕様通りに正確に実装
- テスト用にモック車両クライアントを使用（Pankajから提供）
- Pankajと調整せずにAPIを変更しない

### 2. パイロットレベルのシンプルさ
- シングルサーバーデプロイメント（マルチリージョンではない）
- 基本的な高可用性（エンタープライズ99.9%+稼働率ではない）
- 災害復旧なし（上級者が除外すると言った）
- スケーラビリティより機能性に焦点を当てる

### 3. リアルタイム車両通信
- WebSocketサーバーが処理する必要があること:
  - 複数の同時車両接続
  - 各車両から1秒ごとのハートビート
  - 1秒未満のレイテンシーでコマンド派遣
  - 再接続処理（車両がオフラインになる）

### 4. ユーザーロール
- **管理者:** フルアクセス、システム設定
- **オペレーター:** ミッション派遣、フリート監視
- **介護者:** 入居者の輸送リクエスト
- **看護師:** 医療輸送リクエスト（オプション）

---

## 📋 API実装チェックリスト

### REST APIエンドポイント（車両 → サーバー）

**これらを実装する必要があります:**
- [ ] `POST /api/v1/auth/login` - 車両認証
- [ ] `POST /api/v1/telemetry` - テレメトリーアップロード（位置、ステータス、バッテリー）
- [ ] `POST /api/v1/missions/{id}/status` - ミッションステータス更新
- [ ] `POST /api/v1/errors` - エラー報告
- [ ] `GET /api/v1/vehicles/{id}/config` - 車両設定取得

### WebSocket（サーバー → 車両）

**これらを実装する必要があります:**
- [ ] `mission.dispatch` - 車両に新しいミッションを送信
- [ ] `mission.cancel` - 現在のミッションをキャンセル
- [ ] `emergency.stop` - 緊急停止コマンド
- [ ] `config.update` - 設定更新

### ダッシュボードAPIエンドポイント（ダッシュボード → サーバー）

**これらを実装する必要があります:**
- [ ] ユーザー認証と認可
- [ ] 車両リストとステータス
- [ ] ミッション作成と派遣
- [ ] リアルタイム位置追跡
- [ ] 履歴テレメトリークエリ

---

## 🧪 テスト戦略

### 1. 単体テスト
- 各APIエンドポイントを個別にテスト
- データベース操作をテスト
- WebSocket接続処理をテスト

### 2. モック車両との統合テスト
- Pankajがモック車両クライアントを提供します
- 以下をテストするために使用:
  - テレメトリー取り込み
  - ミッション派遣
  - コマンド配信
  - エラー処理

### 3. 負荷テスト（オプション）
- 複数の車両をシミュレート（10-20台）
- WebSocket接続制限をテスト
- データベースクエリパフォーマンスをテスト

### 4. 実車両との統合
- 第14-15週: Pankajとの統合テスト
- 実車両テレメトリーをテスト
- 実ミッション派遣をテスト
- 再接続シナリオをテスト

---

## 📊 データベーススキーマ概要

**参照:** `02_ARCHITECTURE/DATABASE_DESIGN.md`

**主要テーブル:**

1. **users** - ユーザーアカウント（管理者、オペレーター、介護者）
2. **vehicles** - 車両登録と設定
3. **missions** - ミッションキューと履歴
4. **mission_waypoints** - 各ミッションのウェイポイント
5. **vehicle_telemetry** - リアルタイム車両データ（位置、ステータス、バッテリー）
6. **vehicle_errors** - 車両からのエラーログ
7. **reservations** - スケジュールされた輸送リクエスト
8. **floors** - 建物のフロア定義
9. **routes** - 事前定義されたルート
10. **route_waypoints** - ルートのウェイポイント
11. **audit_logs** - ユーザーアクション監査証跡

**時系列データ:**
- `vehicle_telemetry`は大きくなる可能性があります（1Hz更新）
- パーティショニングまたは時系列データベースを検討（TimescaleDB）
- データ保持ポリシーを実装（30日間保持）

---

## 🔒 セキュリティ要件

**参照:** Pankajの範囲から簡略化

**認証:**
- 車両とユーザー用のJWTトークン
- トークン有効期限: 24時間（車両）、8時間（ユーザー）
- リフレッシュトークンメカニズム

**認可:**
- ロールベースアクセス制御（RBAC）
- ユーザーロールごとの権限
- APIエンドポイントアクセス制御

**データ保護:**
- すべての通信にHTTPS/TLS
- データベース内の機密データを暗号化（パスワード、トークン）
- APIレート制限（悪用防止）

**プライバシー:**
- Li San（法的レビュー）と調整
- データ保持ポリシーを実装
- データ収集のユーザー同意

---

## 📞 連絡先

**あなたのチーム:** Unno（+ チームメンバーTBD）

**車両ソフトウェアチーム:** Pankaj
- **インターフェース:** TVM_API_SPECIFICATION.md
- **調整:** APIレビュー会議、統合テスト（第14-15週）
- **モッククライアント:** テスト用にPankajから提供されます

**ハードウェアチーム:** Tsuchiya + Kiril
- **直接インターフェースなし** - 車両ソフトウェア経由で通信
- **調整:** 不要

**法務:** Li San
- **レビュー:** プライバシー要件
- **ステータス:** レビュー保留中

**上級者:** [名前]
- **承認:** 最終アーキテクチャと範囲

---

## ✅ 成功基準

### MVP（第15週）

- [ ] すべてのREST APIエンドポイントが実装されている
- [ ] すべてのWebSocketコマンドが実装されている
- [ ] データベーススキーマが完成している
- [ ] 基本的なフリートダッシュボードが動作している
- [ ] ユーザー認証が動作している
- [ ] Pankajとの統合テストに合格

### 高度な機能（第20週）

- [ ] 予約システムが動作している
- [ ] 高度なダッシュボード機能が完成している
- [ ] 音声通信（実装されている場合）
- [ ] 負荷テストに合格（10台以上の車両）

### 品質

- [ ] APIがTVM_API_SPECIFICATION.mdに正確に従っている
- [ ] すべてのJSONスキーマがTVM_DATA_MODELS.mdに対して検証されている
- [ ] コードカバレッジ≥70%
- [ ] ドキュメントが完成している

---

## ⚠️ 重要な注意事項

### APIコントラクトは凍結されています

**Pankajと調整せずにAPIを変更しないでください:**
- RESTエンドポイントはTVM_API_SPECIFICATION.mdで定義されています
- WebSocketコマンドは定義されています
- JSONスキーマはTVM_DATA_MODELS.mdで定義されています

**API変更が必要な場合:**
1. Pankajと議論
2. TVM_API_SPECIFICATION.mdを更新（両者が同意）
3. セマンティックバージョニングを使用（v1、v2など）

### オフライン車両の処理

**車両はオフラインになる可能性があります:**
- WiFi切断
- バッテリー消耗
- ネットワーク問題

**あなたのサーバーが行う必要があること:**
- オフライン車両のコマンドをキューに入れる
- 車両が再接続したときにコマンド配信を再試行
- 車両が長時間オフラインの場合、ミッションを「失敗」としてマークする

### リアルタイムダッシュボード更新

**ユーザーはリアルタイム更新を期待しています:**
- 車両位置は1秒ごとに更新
- ミッションステータスは即座に更新
- ダッシュボードへWebSocketまたはServer-Sent Events（SSE）を使用

---

**ドキュメントバージョン:** 1.0
**最終更新日:** 2025年12月19日
**ステータス:** 実装準備完了
**次のアクション:** PankajからのTVM_API_IMPLEMENTATION_GUIDE_FOR_UNNO.mdを待つ

---

**ハッピーコーディング！ 🚀**

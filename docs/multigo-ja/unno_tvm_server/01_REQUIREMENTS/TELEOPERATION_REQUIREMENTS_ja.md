# 遠隔操作要件

**プロジェクト:** 屋外車椅子輸送ロボット - マルチチームシステム
**文書タイプ:** フリート管理 + 車両要件仕様
**チーム責任:** Pankaj（車両ソフトウェア） + Unno（遠隔操作UI）
**ステータス:** 第5週 - 活発な開発
**日付:** 2025-12-16
**バージョン:** 1.0

---

## 文書管理

| バージョン | 日付 | 作成者 | 変更内容 |
|---------|------|--------|---------|
| 1.0 | 2025-12-16 | マルチチーム | 遠隔操作要件の初版 |

**関連文書:**
- COMMUNICATION_SYSTEM_REQUIREMENTS.md（WiFi、4G LTE レイテンシ）
- FLEET_UI_REQUIREMENTS.md（Webベース遠隔操作インターフェース）
- SAFETY_REQUIREMENTS.md（遠隔操作安全制約）
- SWERVE_DRIVE_REQUIREMENTS.md（車両制御コマンド）

---

## 1. 目的と範囲

本文書は、車椅子輸送ロボットの**遠隔操作**の要件を規定する。自律動作が不可能な場合（例: エラーからの回復、マッピングされていないエリアでのナビゲーション、テスト）に、オペレーターが車両を手動制御できるようにする。

**設計原則:**
- 安全第一: 速度制限の低減、オペレーター確認
- 低帯域幅動作（4G LTE上で機能）
- マルチモーダル制御（ゲームパッド、キーボード、タッチ）
- レイテンシ耐性インターフェース（視覚フィードバック、予測インジケーター）

**ユースケース:**
- 緊急車両回復（スタック、ナビゲーション失敗）
- 新しいエリアのマッピング（手動探索 + SLAM）
- 車両テストとコミッショニング
- オペレータートレーニングとデモンストレーション

---

## 2. 遠隔操作モード

### 2.1 モード定義

| ID | 要件 | 優先度 | 受入基準 |
|----|-------------|----------|---------------------|
| TELEOP-MODE-001 | システムは3つの遠隔操作モードをサポートしなければならない: 無効、支援、手動 | CRITICAL | すべてのモードが実装されている |
| TELEOP-MODE-002 | **無効モード**: 遠隔操作が利用不可（通常の自律動作） | CRITICAL | モード遷移が機能的 |
| TELEOP-MODE-003 | **支援モード**: オペレーターが高レベル目標を送信、車両が自律的にナビゲート | HIGH | 支援モードが機能的 |
| TELEOP-MODE-004 | **手動モード**: オペレーターが車両の動きを直接制御（ジョイスティック/キーボード入力） | CRITICAL | 手動モードが機能的 |
| TELEOP-MODE-005 | システムは手動モードに入る際にオペレーター確認を要求しなければならない（誤作動防止） | CRITICAL | 確認ダイアログが必要 |

**成功基準:** モード遷移が明確でフェイルセーフ

### 2.2 モード遷移

| ID | 要件 | 優先度 | 受入基準 |
|----|-------------|----------|---------------------|
| TELEOP-TRANS-001 | 遠隔操作を有効化するには管理者またはオペレーターロールが必要でなければならない | CRITICAL | RBACが強制されている |
| TELEOP-TRANS-002 | システムはオペレーターの非アクティブ時（10秒以上入力なし）に自動的に手動モードを終了しなければならない | CRITICAL | 自動終了が機能的 |
| TELEOP-TRANS-003 | システムは緊急停止時に即座に手動モードを終了しなければならない | CRITICAL | 緊急停止が手動モードを終了 |
| TELEOP-TRANS-004 | システムは手動モードに入る際に目立つ警告を表示しなければならない（UI警告 + 車両音声） | HIGH | 警告が表示される |
| TELEOP-TRANS-005 | システムはすべての遠隔操作セッションをログ記録しなければならない: オペレーター、開始時刻、継続時間、モード | HIGH | 遠隔操作ログが機能的 |

---

## 3. 手動遠隔操作要件

### 3.1 制御インターフェース

| ID | 要件 | 優先度 | 受入基準 |
|----|-------------|----------|---------------------|
| TELEOP-CTRL-001 | システムはゲームパッド制御をサポートしなければならない（Xbox/PS4互換、USB/Bluetooth） | HIGH | ゲームパッド入力が機能的 |
| TELEOP-CTRL-002 | システムはキーボード制御をサポートしなければならない（W/A/S/Dで移動、矢印キーでカメラ） | MEDIUM | キーボード入力が機能的 |
| TELEOP-CTRL-003 | システムはタブレット/モバイルでタッチ制御をサポートしなければならない（仮想ジョイスティック） | LOW | タッチ制御が機能的 |
| TELEOP-CTRL-004 | ゲームパッドレイアウトは以下でなければならない: 左スティック = 並進（前進/後退/横移動）、右スティック = 回転 | HIGH | ゲームパッドマッピングが正しい |
| TELEOP-CTRL-005 | システムは現在の制御方法をUIに表示しなければならない（ゲームパッドアイコン、キーボードアイコン） | MEDIUM | 制御方法インジケーターが表示される |

**ゲームパッドマッピング:**
- 左スティックY軸: 前進/後退速度
- 左スティックX軸: 左/右横移動
- 右スティックX軸: 回転（ヨー）
- 右トリガー: スピードブースト（最大速度増加）
- Aボタン: クラクション/警告音
- Bボタン: 緊急停止
- Startボタン: 遠隔操作の有効化/無効化

### 3.2 速度制御

| ID | 要件 | 優先度 | 受入基準 |
|----|-------------|----------|---------------------|
| TELEOP-VEL-001 | 手動モードの最大速度は0.5 m/s（通常の自律速度の50%）でなければならない | CRITICAL | 速度制限が強制されている |
| TELEOP-VEL-002 | システムは速度平滑化を適用しなければならない（0.5 m/s²加速度制限） | HIGH | スムーズな加速 |
| TELEOP-VEL-003 | システムはスピードブーストをサポートしなければならない（右トリガー押下 = 0.8 m/s最大） | MEDIUM | スピードブーストが機能的 |
| TELEOP-VEL-004 | システムはジョイスティック入力にデッドゾーンを適用しなければならない（±10%スティック偏向 = ゼロ速度） | HIGH | デッドゾーンがドリフトを防止 |
| TELEOP-VEL-005 | システムは現在の指令速度と実速度をUIに表示しなければならない | MEDIUM | 速度表示が機能的 |

### 3.3 遠隔操作安全

| ID | 要件 | 優先度 | 受入基準 |
|----|-------------|----------|---------------------|
| TELEOP-SAFE-001 | システムは遠隔操作中に障害物検出を維持しなければならない（衝突時に緊急停止） | CRITICAL | 障害物検出がアクティブ |
| TELEOP-SAFE-002 | システムは遠隔操作中にジオフェンシングを強制しなければならない（運用エリア外への移動を防止） | CRITICAL | ジオフェンシングが強制されている |
| TELEOP-SAFE-003 | システムはビデオフィードに衝突警告オーバーレイを表示しなければならない（赤いバウンディングボックス） | HIGH | 衝突警告が可視 |
| TELEOP-SAFE-004 | システムは "デッドマンスイッチ" を保持することをオペレーターに要求しなければならない（ボタン保持 = 動作有効） | CRITICAL | デッドマンスイッチが実装されている |
| TELEOP-SAFE-005 | デッドマンスイッチが解放されると車両は即座に（0.5秒以内に）停止しなければならない | CRITICAL | 解放時に即座停止 |
| TELEOP-SAFE-006 | システムは乗客が乗車中の遠隔操作を禁止しなければならない（安全ポリシー） | CRITICAL | 乗客検出が遠隔操作をブロック |

---

## 4. ビデオストリーミング要件

### 4.1 カメラ構成

| ID | 要件 | 優先度 | 受入基準 |
|----|-------------|----------|---------------------|
| TELEOP-VIDEO-001 | システムは前方カメラからビデオをストリーミングしなければならない（主ビュー）720p、15 fps | CRITICAL | ビデオストリームが機能的 |
| TELEOP-VIDEO-002 | システムはオプションで後方カメラをストリーミングしなければならない（後退時）480p、10 fps | MEDIUM | 後方カメラストリームが機能的 |
| TELEOP-VIDEO-003 | ビデオにはステータスオーバーレイを含めなければならない: バッテリー%、接続強度、速度、モード | HIGH | ステータスオーバーレイが表示される |
| TELEOP-VIDEO-004 | システムはカメラPTZ制御をサポートしなければならない（パン-チルト-ズーム、カメラがサポートする場合） | LOW | PTZ制御が機能的 |

### 4.2 ビデオエンコーディングと伝送

| ID | 要件 | 優先度 | 受入基準 |
|----|-------------|----------|---------------------|
| TELEOP-VIDEO-ENC-001 | ビデオはH.264コーデックを使用しなければならない（Jetson Orin Nanoでハードウェアエンコード） | CRITICAL | H.264エンコーディングが機能的 |
| TELEOP-VIDEO-ENC-002 | ビデオビットレートはネットワーク帯域幅に適応しなければならない: 2 Mbps（WiFi）、500 kbps（LTE） | CRITICAL | アダプティブビットレートが機能的 |
| TELEOP-VIDEO-ENC-003 | ビデオは低レイテンシストリーミングにWebRTCを使用しなければならない（可能な場合はP2P） | HIGH | WebRTCストリーミングが実装されている |
| TELEOP-VIDEO-ENC-004 | ビデオレイテンシは<500msガラス間（WiFi）、<1000ms（LTE）でなければならない | HIGH | レイテンシが測定され許容範囲内 |
| TELEOP-VIDEO-ENC-005 | システムはビデオレイテンシインジケーターをUIに表示しなければならない（緑<500ms、黄色<1000ms、赤>1000ms） | MEDIUM | レイテンシインジケーターが機能的 |

### 4.3 ビデオ品質劣化

| ID | 要件 | 優先度 | 受入基準 |
|----|-------------|----------|---------------------|
| TELEOP-VIDEO-DEG-001 | システムはネットワーク不良時にビデオ解像度を下げなければならない（720p → 480p → 360p） | HIGH | 解像度適応が機能的 |
| TELEOP-VIDEO-DEG-002 | システムはネットワーク不良時にフレームレートを下げなければならない（15fps → 10fps → 5fps） | HIGH | フレームレート適応が機能的 |
| TELEOP-VIDEO-DEG-003 | システムはビデオ品質が劣化したときに "低帯域幅" 警告を表示しなければならない | MEDIUM | 警告が表示される |
| TELEOP-VIDEO-DEG-004 | システムはビデオなしでも遠隔操作機能を維持しなければならない（センサーオーバーレイのみ） | MEDIUM | テキストのみの遠隔操作が可能 |

---

## 5. オペレーターUI要件

### 5.1 遠隔操作ダッシュボード

| ID | 要件 | 優先度 | 受入基準 |
|----|-------------|----------|---------------------|
| TELEOP-UI-001 | 遠隔操作UIはメインビデオフィードを表示しなければならない（画面エリアの70%を占める） | CRITICAL | ビデオフィードが目立つ |
| TELEOP-UI-002 | UIは車両ステータスパネルを表示しなければならない: バッテリー、速度、モード、エラー | HIGH | ステータスパネルが可視 |
| TELEOP-UI-003 | UIはビデオにLiDARオーバーレイを表示しなければならない（トップダウン2Dスキャン、半透明） | HIGH | LiDARオーバーレイが機能的 |
| TELEOP-UI-004 | UIは車両位置と遠隔操作経路トレースを含むマップを表示しなければならない | MEDIUM | マップ表示が機能的 |
| TELEOP-UI-005 | UIは緊急停止ボタンを提供しなければならない（大きい、赤、常に可視） | CRITICAL | 緊急停止ボタンがアクセス可能 |
| TELEOP-UI-006 | UIはネットワークレイテンシを表示しなければならない: ビデオレイテンシ、制御レイテンシ、接続品質 | HIGH | レイテンシメトリクスが表示される |

### 5.2 制御フィードバック

| ID | 要件 | 優先度 | 受入基準 |
|----|-------------|----------|---------------------|
| TELEOP-FEEDBACK-001 | UIはジョイスティック入力視覚化を表示しなければならない（仮想ジョイスティックインジケーター） | MEDIUM | 入力視覚化が表示される |
| TELEOP-FEEDBACK-002 | UIはゲームパッドで触覚フィードバックを提供しなければならない（衝突警告時に振動） | LOW | 触覚フィードバックが機能的 |
| TELEOP-FEEDBACK-003 | UIは車両方位矢印を表示しなければならない（コンパス方位） | MEDIUM | 方位矢印が表示される |
| TELEOP-FEEDBACK-004 | UIはアクティブセンサーを強調表示しなければならない（緑=OK、黄色=劣化、赤=故障） | HIGH | センサーステータスインジケーター |

---

## 6. 支援遠隔操作要件

### 6.1 目標ベース制御

| ID | 要件 | 優先度 | 受入基準 |
|----|-------------|----------|---------------------|
| TELEOP-ASSIST-001 | 支援モードはオペレーターがマップをクリックしてウェイポイント目標を設定できるようにしなければならない | HIGH | ウェイポイント設定が機能的 |
| TELEOP-ASSIST-002 | 車両はNav2プランナーを使用してクリックされた目標に自律的にナビゲートしなければならない | HIGH | 目標への自律ナビゲーション |
| TELEOP-ASSIST-003 | オペレーターは現在の目標をキャンセルして新しい目標を設定できなければならない | HIGH | 目標キャンセルが機能的 |
| TELEOP-ASSIST-004 | システムは目標への計画経路をマップに表示しなければならない（破線） | MEDIUM | 経路視覚化が機能的 |

### 6.2 支援安全

| ID | 要件 | 優先度 | 受入基準 |
|----|-------------|----------|---------------------|
| TELEOP-ASSIST-SAFE-001 | 支援モードは通常の自律安全制約を使用しなければならない（障害物回避、ジオフェンシング） | CRITICAL | 安全制約がアクティブ |
| TELEOP-ASSIST-SAFE-002 | オペレーターは支援ナビゲーション中に車両を緊急停止できなければならない | CRITICAL | 支援モードで緊急停止が機能的 |

---

## 7. 複数車両遠隔操作要件

| ID | 要件 | 優先度 | 受入基準 |
|----|-------------|----------|---------------------|
| TELEOP-MULTI-001 | システムは一度に1台の車両の遠隔操作をサポートしなければならない（同時複数車両制御なし） | CRITICAL | 単一車両制御が強制されている |
| TELEOP-MULTI-002 | オペレーターは車両間で制御を切り替えられなければならない（確認ダイアログ付き） | HIGH | 車両切り替えが機能的 |
| TELEOP-MULTI-003 | システムは2人のオペレーターが同じ車両を同時に制御することを防止しなければならない | CRITICAL | 制御ロックが機能的 |
| TELEOP-MULTI-004 | UIは現在遠隔操作制御下にある車両を表示しなければならない | HIGH | アクティブ車両が強調表示される |

---

## 8. 遠隔操作セッション管理

| ID | 要件 | 優先度 | 受入基準 |
|----|-------------|----------|---------------------|
| TELEOP-SESSION-001 | システムは遠隔操作にアクセスする前にオペレーターログインを要求しなければならない（認証） | CRITICAL | ログインが強制されている |
| TELEOP-SESSION-002 | 遠隔操作セッションは30分後にタイムアウトしなければならない（再認証が必要） | HIGH | セッションタイムアウトが機能的 |
| TELEOP-SESSION-003 | システムは遠隔操作セッションをログ記録しなければならない: オペレーター、車両、開始/終了時刻、移動距離 | HIGH | セッションログが機能的 |
| TELEOP-SESSION-004 | システムはフリートUIに遠隔操作履歴を表示しなければならない（監査証跡） | MEDIUM | 履歴表示が機能的 |

---

## 9. ネットワークとレイテンシ要件

| ID | 要件 | 優先度 | 受入基準 |
|----|-------------|----------|---------------------|
| TELEOP-NET-001 | 遠隔操作はWiFi上で機能的でなければならない（優先、<100msレイテンシ） | CRITICAL | WiFi遠隔操作が機能的 |
| TELEOP-NET-002 | 遠隔操作は4G LTE上で機能的でなければならない（フォールバック、<500msレイテンシ許容） | HIGH | LTE遠隔操作が機能的 |
| TELEOP-NET-003 | システムは往復レイテンシを測定しなければならない（オペレーター入力 → 車両応答） | HIGH | レイテンシ測定が機能的 |
| TELEOP-NET-004 | システムはレイテンシ>500ms（黄色警告）または>1000ms（赤警告）時にオペレーターに警告しなければならない | HIGH | レイテンシ警告が表示される |
| TELEOP-NET-005 | システムはネットワーク切断が>5秒続く場合に自動的に手動モードを終了しなければならない | CRITICAL | 切断時に自動終了 |

---

## 10. 遠隔操作性能要件

| ID | 要件 | 優先度 | 受入基準 |
|----|-------------|----------|---------------------|
| TELEOP-PERF-001 | 制御コマンドレイテンシはWiFi上で<100ms（オペレーター入力 → 車両動作）でなければならない | HIGH | レイテンシ<100ms測定 |
| TELEOP-PERF-002 | ビデオレイテンシはWiFi上で<500ms（カメラ → オペレーター画面）でなければならない | HIGH | レイテンシ<500ms測定 |
| TELEOP-PERF-003 | システムは15 fpsビデオストリーミング最小値を維持しなければならない（許容可能なオペレーター体験） | MEDIUM | 15 fps最小値が維持されている |
| TELEOP-PERF-004 | 遠隔操作は合計<5 Mbps帯域幅を消費しなければならない（ビデオ + 制御 + テレメトリ） | MEDIUM | 帯域幅使用量が測定されている |

---

## 11. 緊急および障害処理

| ID | 要件 | 優先度 | 受入基準 |
|----|-------------|----------|---------------------|
| TELEOP-FAULT-001 | システムは車両緊急停止時に遠隔操作モードを終了しなければならない | CRITICAL | 緊急停止が遠隔操作を終了 |
| TELEOP-FAULT-002 | システムは重要センサー故障時（LiDAR、カメラ）に遠隔操作モードを終了しなければならない | CRITICAL | センサー故障が遠隔操作を終了 |
| TELEOP-FAULT-003 | システムは遠隔操作中の車両障害時にオペレーターに通知しなければならない（視覚 + 音声警告） | HIGH | 障害通知が表示される |
| TELEOP-FAULT-004 | システムはインシデント後レビューのために遠隔操作セッションビデオを記録しなければならない | LOW | セッション記録が機能的 |

---

## 12. 遠隔操作トレーニングとテスト

| ID | 要件 | 優先度 | 受入基準 |
|----|-------------|----------|---------------------|
| TELEOP-TRAIN-001 | システムは遠隔操作トレーニングモードを提供しなければならない（速度制限、安全エリアのみ） | MEDIUM | トレーニングモードが機能的 |
| TELEOP-TRAIN-002 | トレーニングモードは "訓練生" ロールのオペレーターがアクセス可能でなければならない | MEDIUM | ロールベースのトレーニングアクセス |
| TELEOP-TRAIN-003 | システムは遠隔操作チュートリアルUIを提供しなければならない（画面上の指示） | LOW | チュートリアルUIが利用可能 |

---

## 13. 要件サマリー

| カテゴリ | 数 | 優先度内訳 |
|----------|-------|-------------------|
| 遠隔操作モード | 10 | Critical: 7、High: 3 |
| 手動遠隔操作 | 16 | Critical: 8、High: 5、Medium: 2、Low: 1 |
| ビデオストリーミング | 15 | Critical: 5、High: 7、Medium: 3 |
| オペレーターUI | 10 | Critical: 2、High: 5、Medium: 2、Low: 1 |
| 支援遠隔操作 | 6 | Critical: 2、High: 4 |
| 複数車両遠隔操作 | 4 | Critical: 2、High: 2 |
| セッション管理 | 4 | Critical: 1、High: 2、Medium: 1 |
| ネットワークとレイテンシ | 5 | Critical: 2、High: 3 |
| 性能 | 4 | High: 2、Medium: 2 |
| 緊急および障害処理 | 4 | Critical: 2、High: 1、Low: 1 |
| トレーニングとテスト | 3 | Medium: 2、Low: 1 |
| **合計** | **81** | **Critical: 31、High: 34、Medium: 13、Low: 3** |

---

## 14. 遠隔操作システム図

```
┌──────────────────────────────────────────────────────────┐
│               オペレーターワークステーション              │
│                                                          │
│  ┌──────────────┐      ┌───────────────┐               │
│  │   Web UI     │      │  ゲームパッド  │               │
│  │ (ブラウザ)    │◄─────┤  (USB/BT)     │               │
│  │              │      └───────────────┘               │
│  │ • ビデオフィード                                       │
│  │ • LiDARオーバーレイ                                    │
│  │ • ステータスパネル                                      │
│  │ • マップビュー                                         │
│  └──────┬───────┘                                       │
│         │ WebRTC (video)                                │
│         │ WebSocket (control + telemetry)               │
└─────────┼──────────────────────────────────────────────┘
          │
          │ WiFi (優先、<100ms) または LTE (フォールバック、<500ms)
          │
┌─────────▼──────────────────────────────────────────────┐
│              車両 (Jetson Orin Nano)                   │
│                                                        │
│  ┌───────────────┐    ┌────────────────┐             │
│  │ 遠隔操作ノード  │───>│ スワーブドライブ│             │
│  │ (ROS 2)       │    │ コントローラー   │             │
│  └───────┬───────┘    └────────────────┘             │
│          │                                            │
│          ▼                                            │
│  ┌───────────────┐    ┌────────────────┐             │
│  │ ビデオエンコーダー│    │ 安全監視        │             │
│  │ (H.264)       │    │ (障害物、       │             │
│  │               │    │  ジオフェンシング)│             │
│  └───────────────┘    └────────────────┘             │
│                                                        │
└────────────────────────────────────────────────────────┘
```

---

## 15. トレーサビリティマトリクス

| 遠隔操作要件カテゴリ | 関連システムコンポーネント |
|-----------------------------------|---------------------------|
| 制御インターフェース | ROS 2遠隔操作ノード、スワーブドライブコントローラー、ゲームパッドドライバー |
| ビデオストリーミング | 前方/後方カメラ、H.264エンコーダー（Jetson）、WebRTCサーバー |
| オペレーターUI | フリート管理WebUI、WebSocketサーバー、ビデオプレーヤー |
| 安全 | 障害物検出、ジオフェンシング、緊急停止、デッドマンスイッチ |

---

## 16. 改訂履歴

| バージョン | 日付 | 作成者 | 変更内容 |
|---------|------|--------|---------|
| 1.0 | 2025-12-16 | マルチチーム | 遠隔操作要件の初版（81要件） |

---

**文書終了**

# フリート管理システム要件

**文書管理:**
- **文書ID:** FM-REQ-001
- **バージョン:** 1.0
- **日付:** 2025年12月16日
- **ステータス:** ドラフト
- **所有者:** Unno（フリート管理チーム）
- **レビュアー:** Pankaj（統合）、プロジェクト管理

---

## 1. はじめに

### 1.1 目的

この文書は、自律型車椅子搬送ロボットの集中監視、制御、調整を提供するフリート管理システム（TVM - Total Vehicle Management）の要件を規定します。このシステムにより、施設スタッフ（介護士、看護師、管理者）は車両を配車し、ミッションを追跡し、予約を管理し、フリートステータスをリアルタイムで監視できます。

### 1.2 範囲

**範囲内:**
- フリートダッシュボード（リアルタイム監視、マップ可視化）
- 予約システム（歩行介助、薬品配送）
- ユーザー役割管理（管理者、介護士、看護師）
- リアルタイム車両追跡とステータス
- ミッション配車とキュー管理
- 通信システム（音声、アラート、通知）
- レポートと分析
- TVM Server APIとの統合（TVM_API_SPECIFICATION.mdで定義）

**範囲外:**
- 車両側ソフトウェア（VEHICLE要件でカバー）
- TVMサーバーバックエンド実装（TVM_SERVER_REQUIREMENTS.mdでカバー）
- ハードウェアコンポーネント（HARDWARE要件でカバー）
- ログアップロードシステム（別個のtvm_uploadデーモン）

### 1.3 定義と略語

| 用語 | 定義 |
|------|------------|
| TVM | Total Vehicle Management - フリート管理システム |
| Admin | 完全なシステムアクセス権を持つ管理者 |
| Caregiver | 介護士 - 歩行介助を提供するスタッフメンバー |
| Nurse | 看護師 - 薬品/備品を配送する医療スタッフ |
| Mission | 単一の搬送タスク（ピックアップ → 目的地） |
| Reservation | 事前スケジュールされたミッションリクエスト |
| Dispatch | 車両へのリアルタイムミッション割り当て |
| Fleet | 管理対象の全車両のコレクション |
| Waypoint | 施設マップ内の名前付き位置 |

### 1.4 参照

- TVM_API_SPECIFICATION.md - 車両 ↔ TVM Server API契約
- TVM_DATA_MODELS.md - JSONスキーマとデータモデル
- TEAM_RESPONSIBILITIES.md - チーム範囲と所有権
- Excelユースケース - 介護士と看護師のワークフローシナリオ

---

## 2. システム概要

### 2.1 システムコンテキスト

フリート管理システムは、PCおよびタブレットデバイスからアクセス可能なWebベースのアプリケーションです。REST APIとWebSocketを介してTVMサーバーバックエンドに接続し、リアルタイム更新を行います。システムは3つの主要ユーザー役割にサービスを提供します:

1. **管理者** - 完全なシステムアクセス、ユーザー管理、分析
2. **介護士** - 歩行介助をリクエスト、車両ステータスを追跡
3. **看護師** - 薬品配送をリクエスト、緊急搬送

### 2.2 主要機能

- リアルタイム車両追跡（1Hz位置更新）
- 車両位置を含むインタラクティブ施設マップ
- 優先度キュー付き予約システム
- ロールベースアクセス制御（RBAC）
- スタッフと乗客間の音声通信（VoIP）
- 緊急アラートシステム
- ミッション履歴と分析
- 多言語サポート（EN、JA）

---

## 3. 機能要件

### 3.1 フリートダッシュボード

#### 3.1.1 リアルタイム車両監視

| 要件ID | 優先度 | 要件 | 受け入れ基準 |
|--------|----------|-------------|---------------------|
| FM-DASH-MON-001 | CRITICAL | システムは、フリート内の全車両のリアルタイムステータスを表示しなければならない | • ステータス変更後2秒以内に車両リストが更新される<br>• 表示: 車両ID、ステータス、バッテリー、位置、現在のミッション<br>• 色分けされたステータスインジケーター（緑=アイドル、青=ナビゲート中、黄=充電中、赤=エラー） |
| FM-DASH-MON-002 | CRITICAL | システムは、車両が移動中のとき1Hzで車両位置を更新しなければならない | • マップが1秒ごとに更新<br>• マップ上の車両アイコン位置精度±0.5m<br>• 位置更新間のスムーズなアニメーション |
| FM-DASH-MON-003 | HIGH | システムは、視覚的インジケーター付きで車両バッテリーステータスを表示しなければならない | • バッテリーパーセンテージ表示（0-100%）<br>• <30%で警告（黄色）、<15%で危険（赤）<br>• 車両がドッキング中の充電インジケーター |
| FM-DASH-MON-004 | HIGH | システムは、リアルタイムで車両状態遷移を表示しなければならない | • 状態: アイドル、ナビゲート中、ドッキング中、充電中、エラー、緊急停止<br>• 遷移タイムスタンプ表示<br>• 状態履歴ログ（最新10件の遷移） |
| FM-DASH-MON-005 | MEDIUM | システムは、車両健全性サマリーダッシュボードを提供しなければならない | • 稼働率パーセンテージ（過去24時間、7日、30日）<br>• ミッション成功率<br>• 平均ミッション時間<br>• メンテナンスアラート |
| FM-DASH-MON-006 | HIGH | システムは、車両がエラー状態に入ったときオペレーターにアラートしなければならない | • デスクトップ通知 + 音声アラート<br>• エラー詳細表示（コード、重要度、説明）<br>• アラートをクリアする確認ボタン<br>• 5分以内に確認されない場合エスカレーション |
| FM-DASH-MON-007 | CRITICAL | システムは、ダッシュボードからの緊急停止コマンドをサポートしなければならない | • 目立つE-STOPボタン（赤、確認必要）<br>• 500ms以内にWebSocket経由でコマンド送信<br>• 車両の確認応答を表示<br>• 監査証跡に記録 |
| FM-DASH-MON-008 | MEDIUM | システムは、各車両のアクティブミッション詳細を表示しなければならない | • ミッションID、ピックアップ/目的地ウェイポイント<br>• 進捗率<br>• 完了までの推定時間<br>• 乗客ステータス（該当する場合） |

#### 3.1.2 インタラクティブマップ可視化

| 要件ID | 優先度 | 要件 | 受け入れ基準 |
|--------|----------|-------------|---------------------|
| FM-DASH-MAP-001 | CRITICAL | システムは、車両位置を含むインタラクティブ施設マップを表示しなければならない | • 2Dフロアプランオーバーレイ<br>• 現在のGPS座標に車両アイコン<br>• ズーム（100-500%）、パンコントロール<br>• マルチフロアサポート |
| FM-DASH-MAP-002 | HIGH | システムは、マップ上に車両の進行方向/向きを表示しなければならない | • 進行方向を示す矢印インジケーター<br>• リアルタイムで回転更新<br>• 異なる車両状態に異なるアイコン |
| FM-DASH-MAP-003 | HIGH | システムは、マップ上にウェイポイントとナビゲーションパスを表示しなければならない | • 名前付きウェイポイント（入口、部屋、充電ステーション）<br>• アクティブミッションパスをラインで表示<br>• 情報用のクリック可能なウェイポイント |
| FM-DASH-MAP-004 | MEDIUM | システムは、車両リストから選択されたときに車両をハイライトしなければならない | • 選択された車両アイコンをハイライト（大きく、点滅する境界）<br>• マップを選択された車両に自動センタリング<br>• 情報パネルに詳細な車両ステータスを表示 |
| FM-DASH-MAP-005 | HIGH | システムは、マップ上に障害物/通行不能パスの警告を表示しなければならない | • ブロックされたエリアの赤色ゾーンオーバーレイ<br>• 車両ルート逸脱アラート<br>• 代替パス提案 |
| FM-DASH-MAP-006 | MEDIUM | システムは、カスタムマップレイヤー（オン/オフ切り替え）をサポートしなければならない | • レイヤー: ウェイポイント、充電ステーション、アクティブミッション、制限エリア<br>• マップツールバーのレイヤーコントロール<br>• レイヤー状態をユーザー設定に保存 |
| FM-DASH-MAP-007 | LOW | システムは、車両アクティビティのヒートマップビューを提供しなければならない | • 過去の経路ヒートマップ（過去24時間、7日）<br>• 色のグラデーション（青=低、赤=高アクティビティ）<br>• 高トラフィックエリアの特定に役立つ |

#### 3.1.3 ダッシュボードレイアウトとユーザビリティ

| 要件ID | 優先度 | 要件 | 受け入れ基準 |
|--------|----------|-------------|---------------------|
| FM-DASH-UI-001 | HIGH | システムは、PC（1920x1080）とタブレット（1280x800）用のレスポンシブレイアウトを提供しなければならない | • 自動レイアウト調整<br>• タッチフレンドリーなコントロール（最小48pxタップターゲット）<br>• 水平スクロールなし |
| FM-DASH-UI-002 | MEDIUM | システムは、ダッシュボードのカスタマイズをサポートしなければならない | • ドラッグ&ドロップウィジェット配置<br>• サイズ変更可能なパネル<br>• ユーザーごとにレイアウト保存 |
| FM-DASH-UI-003 | HIGH | システムは、ページ全体を再読み込みせずにダッシュボードウィジェットを更新しなければならない | • WebSocketベースのリアルタイム更新<br>• WebSocket失敗時の優雅な劣化（ポーリングにフォールバック）<br>• 更新インジケーター（点滅アイコン） |
| FM-DASH-UI-004 | MEDIUM | システムは、一般的なアクションのキーボードショートカットを提供しなければならない | • Ctrl+D: ミッション配車<br>• Ctrl+R: ダッシュボード更新<br>• Ctrl+F: 検索にフォーカス<br>• Esc: モーダルを閉じる |
| FM-DASH-UI-005 | LOW | システムは、ダークモードテーマをサポートしなければならない | • ユーザー設定でトグル<br>• 可読性のための高コントラスト<br>• 設定を保存 |

---

### 3.2 予約システム

#### 3.2.1 予約作成

| 要件ID | 優先度 | 要件 | 受け入れ基準 |
|--------|----------|-------------|---------------------|
| FM-RES-CREATE-001 | CRITICAL | システムは、介護士が歩行介助予約を作成できるようにしなければならない | • フォーム: 乗客名、ピックアップウェイポイント、目的地ウェイポイント、スケジュール時刻<br>• 検証: 全フィールド必須、時刻 ≥ 現在時刻 + 10分<br>• 確認表示 |
| FM-RES-CREATE-002 | CRITICAL | システムは、看護師が薬品配送予約を作成できるようにしなければならない | • フォーム: 品目説明、ピックアップ（薬局）、目的地（部屋）、スケジュール時刻、優先度<br>• 優先度レベル: ルーチン、緊急、非常<br>• 非常予約はキューをスキップ |
| FM-RES-CREATE-003 | HIGH | システムは、予約を受け入れる前にウェイポイントの可用性を検証しなければならない | • ウェイポイントが施設マップに存在することを確認<br>• ウェイポイントが制限エリアにないことを確認<br>• ウェイポイントがアクセス可能（ブロックされていない）ことを確認 |
| FM-RES-CREATE-004 | HIGH | システムは、予約作成時にミッション期間を推定しなければならない | • 期間 = パス距離 / 平均速度 + ドッキング時間<br>• 推定完了時刻を表示<br>• パス変更時に更新 |
| FM-RES-CREATE-005 | MEDIUM | システムは、定期的な予約をサポートしなければならない | • 日次、週次パターン<br>• 終了日または発生回数<br>• 単一または全発生の編集/削除 |
| FM-RES-CREATE-006 | HIGH | システムは、作成時に一意の予約IDを割り当てなければならない | • 形式: RES-YYYYMMDD-NNNN<br>• 連番<br>• 確認に表示 |
| FM-RES-CREATE-007 | MEDIUM | システムは、リクエスト者に確認通知を送信しなければならない | • メール/アプリ内通知<br>• 含む内容: 予約ID、時刻、ウェイポイント、推定期間<br>• 表示/キャンセルへのリンク |

#### 3.2.2 予約キュー管理

| 要件ID | 優先度 | 要件 | 受け入れ基準 |
|--------|----------|-------------|---------------------|
| FM-RES-QUEUE-001 | CRITICAL | システムは、保留中の予約の優先度キューを維持しなければならない | • 優先順序: 非常 > 緊急 > ルーチン > スケジュール時刻<br>• 同じ優先度内でFIFO<br>• キューがオペレーターに表示 |
| FM-RES-QUEUE-002 | HIGH | システムは、スケジュールされた予約に対して自動的に車両を配車しなければならない | • スケジュール時刻の5分前に車両を配車<br>• 最も近い利用可能な車両を選択<br>• 予約ステータスを「配車済み」に更新 |
| FM-RES-QUEUE-003 | HIGH | システムは、車両の利用不可を優雅に処理しなければならない | • 利用可能な車両がない場合、予約をキュー<br>• リクエスト者に遅延を通知<br>• 車両がアイドルになり次第割り当て |
| FM-RES-QUEUE-004 | MEDIUM | システムは、複数の予約に対して車両割り当てを最適化しなければならない | • 近隣の予約を同じ車両にバッチ処理<br>• 総移動距離を最小化<br>• 時間制約を尊重 |
| FM-RES-QUEUE-005 | HIGH | システムは、車両がミッションを完了したときにキューをリアルタイムで更新しなければならない | • キュー位置を再計算<br>• 待機中のリクエスト者にETA更新を送信<br>• WebSocket通知 |
| FM-RES-QUEUE-006 | MEDIUM | システムは、オペレーターがキューを手動で並び替えできるようにしなければならない | • ドラッグ&ドロップインターフェース<br>• 管理者/オペレーター役割が必要<br>• 監査証跡に記録 |

#### 3.2.3 予約追跡と履歴

| 要件ID | 優先度 | 要件 | 受け入れ基準 |
|--------|----------|-------------|---------------------|
| FM-RES-TRACK-001 | HIGH | システムは、予約ステータスをリアルタイムで表示しなければならない | • 状態: 保留中、キュー済み、配車済み、進行中、完了、キャンセル<br>• 進捗インジケーター（0-100%）<br>• 割り当てられた車両の現在位置 |
| FM-RES-TRACK-002 | MEDIUM | システムは、予約の検索とフィルタリングを提供しなければならない | • 検索条件: 予約ID、リクエスト者、日付範囲、ステータス<br>• 複数選択フィルター<br>• 結果を時刻でソート（新しい順） |
| FM-RES-TRACK-003 | HIGH | システムは、配車前の予約キャンセルを許可しなければならない | • キャンセルボタン（確認必要）<br>• リクエスト者に通知送信<br>• 車両配車後はキャンセル不可 |
| FM-RES-TRACK-004 | MEDIUM | システムは、完全な予約履歴を維持しなければならない | • 全予約を保存（最低1年間）<br>• 含む内容: created_at、updated_at、completed_at、リクエスト者、vehicle_id、status_transitions<br>• CSVにエクスポート可能 |
| FM-RES-TRACK-005 | LOW | システムは、予約統計を生成しなければならない | • 日次/週次/月次カウント<br>• 平均期間、成功率<br>• ピーク使用時間 |

---

### 3.3 ユーザー役割管理

#### 3.3.1 役割定義

| 要件ID | 優先度 | 要件 | 受け入れ基準 |
|--------|----------|-------------|---------------------|
| FM-ROLE-DEF-001 | CRITICAL | システムは、3つのユーザー役割を実装しなければならない: 管理者、介護士、看護師 | • 役割をデータベースに保存<br>• 各ユーザーに正確に1つの役割を割り当て<br>• ロールベースのUI要素（役割に基づいて表示/非表示） |
| FM-ROLE-DEF-002 | CRITICAL | 管理者役割は、完全なシステムアクセスを持たなければならない | • ユーザーの作成/編集/削除<br>• 全予約とミッションの表示<br>• 分析とレポートへのアクセス<br>• システム設定 |
| FM-ROLE-DEF-003 | HIGH | 介護士役割は、歩行介助機能にアクセスしなければならない | • 歩行介助予約の作成<br>• 自分の予約を表示<br>• 割り当てられたミッションを追跡<br>• 車両との音声通信 |
| FM-ROLE-DEF-004 | HIGH | 看護師役割は、薬品配送機能にアクセスしなければならない | • 薬品配送予約の作成<br>• 優先度設定（ルーチン、緊急、非常）<br>• 自分の予約を表示<br>• 車両位置を表示（読み取り専用） |
| FM-ROLE-DEF-005 | MEDIUM | システムは、ロールベースの権限マトリックスをサポートしなければならない | • 権限: view_dashboard、create_reservation、cancel_reservation、view_analytics、manage_users、emergency_stop<br>• マトリックスを設定ファイルに保存<br>• サーバー側で強制 |

#### 3.3.2 ユーザー管理（管理者のみ）

| 要件ID | 優先度 | 要件 | 受け入れ基準 |
|--------|----------|-------------|---------------------|
| FM-ROLE-USER-001 | HIGH | 管理者は、新規ユーザーアカウントを作成しなければならない | • フォーム: ユーザー名、メール、パスワード、役割、氏名<br>• パスワード要件: ≥8文字、大文字1つ、数字1つ、特殊文字1つ<br>• メール確認はオプション |
| FM-ROLE-USER-002 | HIGH | 管理者は、既存のユーザーアカウントを編集しなければならない | • 変更可能: メール、役割、氏名、アクティブステータス<br>• ユーザー名は変更不可（一意のID）<br>• 自分の管理者役割は編集不可 |
| FM-ROLE-USER-003 | MEDIUM | 管理者は、ユーザーアカウントを無効化/再有効化しなければならない | • 無効化されたユーザーはログイン不可<br>• データは保存される（削除されない）<br>• 監査ログエントリ |
| FM-ROLE-USER-004 | MEDIUM | 管理者は、ユーザーパスワードをリセットしなければならない | • 一時パスワードを生成<br>• ユーザーにメール送信<br>• 次回ログイン時にパスワード変更を強制 |
| FM-ROLE-USER-005 | HIGH | システムは、一意のユーザー名とメールを強制しなければならない | • 作成/編集時に検証<br>• 重複時にエラーメッセージ<br>• 大文字小文字を区別しないチェック |

#### 3.3.3 認証と認可

| 要件ID | 優先度 | 要件 | 受け入れ基準 |
|--------|----------|-------------|---------------------|
| FM-ROLE-AUTH-001 | CRITICAL | システムは、ユーザー名/パスワードでユーザーを認証しなければならない | • 検証付きログインフォーム<br>• 成功時にJWTトークン発行（24時間有効期限）<br>• トークンをhttpOnlyクッキーに保存 |
| FM-ROLE-AUTH-002 | HIGH | システムは、全APIエンドポイントでロールベースアクセス制御を強制しなければならない | • サーバーがJWTと役割を検証<br>• 権限不足の場合403 Forbidden<br>• UX用のクライアント側チェック（サーバーが信頼のソース） |
| FM-ROLE-AUTH-003 | HIGH | システムは、有効期限前にJWTトークンを自動的に更新しなければならない | • トークン有効期間の80%で更新（19.2時間）<br>• ユーザーに透過的<br>• 更新失敗時はログアウト |
| FM-ROLE-AUTH-004 | MEDIUM | システムは、全認証イベントをログに記録しなければならない | • ログイン/ログアウトタイムスタンプ<br>• 失敗したログイン試行（5回失敗後にレート制限）<br>• IPアドレス、ユーザーエージェント |
| FM-ROLE-AUTH-005 | MEDIUM | システムは、セッションタイムアウトをサポートしなければならない | • 設定可能なタイムアウト（デフォルト8時間）<br>• タイムアウト5分前に警告<br>• 「セッション延長」ボタン |

---

### 3.4 ミッション管理

#### 3.4.1 ミッション配車

| 要件ID | 優先度 | 要件 | 受け入れ基準 |
|--------|----------|-------------|---------------------|
| FM-MISSION-DISP-001 | CRITICAL | システムは、WebSocket経由で車両にミッションを配車しなければならない | • コマンドタイプ: "dispatch"<br>• ペイロード: mission_id、pickup、destination、priority<br>• 2秒以内に車両の確認応答 |
| FM-MISSION-DISP-002 | HIGH | システムは、ダッシュボードからの手動ミッション配車をサポートしなければならない | • オペレーターが選択: 車両、ピックアップ、目的地<br>• 即座に配車（キューをバイパス）<br>• 確認必要 |
| FM-MISSION-DISP-003 | HIGH | システムは、配車前にミッションを検証しなければならない | • 車両が「アイドル」状態でなければならない<br>• バッテリー ≥ 20%<br>• アクティブエラーなし<br>• ウェイポイントが有効で到達可能 |
| FM-MISSION-DISP-004 | MEDIUM | システムは、配車前に推定ミッション期間を提供しなければならない | • 基準: パス距離、平均速度、ドッキング時間<br>• オペレーターに表示<br>• 期間 > 10分の場合警告 |
| FM-MISSION-DISP-005 | HIGH | システムは、車両によるミッション拒否を処理しなければならない | • 理由: 低バッテリー、障害物ブロック、エラー状態<br>• ミッションを自動的に再キュー<br>• オペレーターに通知 |

#### 3.4.2 ミッション監視

| 要件ID | 優先度 | 要件 | 受け入れ基準 |
|--------|----------|-------------|---------------------|
| FM-MISSION-MON-001 | CRITICAL | システムは、ミッション進捗をリアルタイムで追跡しなければならない | • フェーズ: 配車済み、ピックアップへナビゲート中、ピックアップドッキング、乗客乗車中、目的地へナビゲート中、目的地ドッキング、乗客降車中、完了<br>• フェーズ遷移を記録<br>• 進捗率を表示 |
| FM-MISSION-MON-002 | HIGH | システムは、ミッションタイムラインを表示しなければならない | • 開始時刻、フェーズ遷移、完了時刻<br>• 実際 vs. 推定期間<br>• 遅延警告（実際 > 推定 + 2分） |
| FM-MISSION-MON-003 | HIGH | システムは、ナビゲーション中のミッションキャンセルを許可しなければならない | • キャンセルボタン（管理者/オペレーターのみ）<br>• WebSocket経由で「キャンセル」コマンド送信<br>• 車両がアイドル状態に戻る |
| FM-MISSION-MON-004 | MEDIUM | システムは、ミッションが予想期間を50%超過した場合にアラートしなければならない | • デスクトップ通知 + ダッシュボードアラート<br>• オペレーターの選択肢: ミッションキャンセル、タイムアウト延長、調査<br>• 解決されない場合管理者にエスカレーション |
| FM-MISSION-MON-005 | MEDIUM | システムは、全ミッションイベントをデータベースに記録しなければならない | • イベント: 配車済み、開始、ウェイポイント到達、完了、キャンセル、失敗<br>• タイムスタンプ、vehicle_id、mission_id、event_data<br>• 分析用にクエリ可能 |

#### 3.4.3 ミッション履歴と分析

| 要件ID | 優先度 | 要件 | 受け入れ基準 |
|--------|----------|-------------|---------------------|
| FM-MISSION-HIST-001 | MEDIUM | システムは、最低1年間のミッション履歴を維持しなければならない | • 全ミッションをデータベースに保存<br>• 含む内容: mission_id、vehicle_id、pickup、destination、start_time、end_time、status、requester<br>• CSV/JSONにエクスポート可能 |
| FM-MISSION-HIST-002 | MEDIUM | システムは、ミッション検索とフィルタリングを提供しなければならない | • 検索条件: ミッションID、車両ID、日付範囲、ステータス、リクエスト者<br>• ソート: 開始時刻、期間、ステータス<br>• ページネーション（ページあたり50件） |
| FM-MISSION-HIST-003 | LOW | システムは、ミッション分析ダッシュボードを生成しなければならない | • 総ミッション数（日次/週次/月次）<br>• 成功率%<br>• 平均期間<br>• ピーク時間ヒートマップ |
| FM-MISSION-HIST-004 | LOW | システムは、頻繁に使用されるルートを特定しなければならない | • トップ10のピックアップ-目的地ペア<br>• 頻度カウント<br>• ルートごとの平均期間 |

---

### 3.5 通信システム

#### 3.5.1 音声通信（VoIP）

| 要件ID | 優先度 | 要件 | 受け入れ基準 |
|--------|----------|-------------|---------------------|
| FM-COMM-VOICE-001 | HIGH | システムは、スタッフと車両乗客間の音声通信をサポートしなければならない | • VoIPプロトコル（WebRTC推奨）<br>• ダッシュボードから通話を開始<br>• 双方向オーディオ |
| FM-COMM-VOICE-002 | HIGH | システムは、ダッシュボードにアクティブな通話を表示しなければならない | • 通話ステータス: 呼び出し中、接続中、終了<br>• 通話時間タイマー<br>• ミュート/ミュート解除コントロール |
| FM-COMM-VOICE-003 | MEDIUM | システムは、通話録音をサポートしなければならない（オプション、設定可能） | • 施設ポリシーごとに録音を有効化<br>• 暗号化形式で保存<br>• 保持期間を設定可能 |
| FM-COMM-VOICE-004 | MEDIUM | システムは、通話失敗を優雅に処理しなければならない | • 再試行ロジック（3回試行、5秒間隔）<br>• テキストアラートにフォールバック<br>• 失敗をオペレーターに通知 |

#### 3.5.2 アラートと通知

| 要件ID | 優先度 | 要件 | 受け入れ基準 |
|--------|----------|-------------|---------------------|
| FM-COMM-ALERT-001 | CRITICAL | システムは、全オンラインオペレーターに緊急アラートを送信しなければならない | • アラートタイプ: 車両エラー、乗客緊急ボタン、システム障害<br>• デスクトップ通知 + 音声<br>• ダッシュボードのアラートバナー（確認されるまで消去不可） |
| FM-COMM-ALERT-002 | HIGH | システムは、カスタムアラートルーティングルールをサポートしなければならない | • 車両エラーをメンテナンスチームにルート<br>• 予約リクエストを介護士/看護師にルート<br>• 管理者がルールを設定可能 |
| FM-COMM-ALERT-003 | HIGH | システムは、全アラートを監査証跡に記録しなければならない | • タイムスタンプ、アラートタイプ、受信者、acknowledged_by、acknowledged_at<br>• CSVにエクスポート可能<br>• 保持: 1年 |
| FM-COMM-ALERT-004 | MEDIUM | システムは、アプリ内通知（非緊急）をサポートしなければならない | • 未読カウント付き通知センターアイコン<br>• 最近の通知リスト<br>• 既読/未読のマーク |
| FM-COMM-ALERT-005 | LOW | システムは、メール通知をサポートしなければならない（ユーザーごとに設定可能） | • ユーザー設定: 予約確認、ミッション完了、車両エラー時にメール<br>• ミッション詳細付きメールテンプレート<br>• 配信停止リンク |

---

### 3.6 レポートと分析

#### 3.6.1 標準レポート

| 要件ID | 優先度 | 要件 | 受け入れ基準 |
|--------|----------|-------------|---------------------|
| FM-REPORT-STD-001 | MEDIUM | システムは、日次フリート利用レポートを生成しなければならない | • レポート内容: 総ミッション数、総走行距離、平均ミッション時間、車両稼働率%<br>• 毎日23:59に自動生成<br>• 管理者にメール送信 |
| FM-REPORT-STD-002 | MEDIUM | システムは、週次メンテナンスレポートを生成しなければならない | • レポート内容: バッテリーサイクル、タイプ別エラー数、低バッテリーインシデント<br>• 日曜日23:59に自動生成<br>• メンテナンスが必要な車両をハイライト |
| FM-REPORT-STD-003 | LOW | システムは、月次使用状況サマリーを生成しなければならない | • ユーザー役割ごとのミッション数（介護士 vs 看護師）<br>• ピーク使用時間<br>• トップルート<br>• コスト見積もり（走行距離 × レート） |

#### 3.6.2 カスタム分析

| 要件ID | 優先度 | 要件 | 受け入れ基準 |
|--------|----------|-------------|---------------------|
| FM-REPORT-CUSTOM-001 | LOW | システムは、インタラクティブ分析ダッシュボードを提供しなければならない | • チャート: ライン（時系列ミッション）、バー（車両別ミッション）、パイ（ミッションステータス）<br>• 日付範囲セレクター<br>• PNG/PDFにエクスポート |
| FM-REPORT-CUSTOM-002 | LOW | システムは、カスタムレポートビルダーをサポートしなければならない | • メトリクス選択: ミッション数、平均期間、距離、バッテリー使用量<br>• グループ化: 車両、ユーザー、期間<br>• フィルター: 日付範囲、ステータス、優先度 |

---

## 4. 非機能要件

### 4.1 パフォーマンス

| 要件ID | 優先度 | 要件 | 受け入れ基準 |
|--------|----------|-------------|---------------------|
| FM-PERF-001 | HIGH | システムは、最大10台の同時車両をサポートしなければならない | • 全車両のリアルタイム追跡<br>• マップ更新 <1秒レイテンシ<br>• パフォーマンス劣化なし |
| FM-PERF-002 | HIGH | システムは、最大50の同時ユーザーセッションを処理しなければならない | • ログイン、ダッシュボードロード、API呼び出しが応答的<br>• WebSocket接続が安定<br>• メモリリークなし |
| FM-PERF-003 | MEDIUM | ダッシュボードページは、10Mbps接続で3秒以内にロードしなければならない | • 初期ページロード <3秒<br>• インタラクティブまで <5秒<br>• Lighthouseで測定 |
| FM-PERF-004 | MEDIUM | APIレスポンス時間は、95%のリクエストで <500msでなければならない | • サーバーで測定<br>• WebSocketストリーミングを除外<br>• APMツールで監視 |

### 4.2 信頼性と可用性

| 要件ID | 優先度 | 要件 | 受け入れ基準 |
|--------|----------|-------------|---------------------|
| FM-REL-001 | HIGH | システムは、稼働時間中（8:00-20:00）に99.5%の稼働率を持たなければならない | • 月あたり最大36分のダウンタイム<br>• 稼働時間外の計画的メンテナンス<br>• 稼働時間監視サービスで監視 |
| FM-REL-002 | HIGH | システムは、WebSocket切断を優雅に処理しなければならない | • 指数バックオフで自動再接続（1秒、2秒、4秒、...）<br>• 切断中の更新をキュー、再接続時に同期<br>• 切断 >10秒の場合ユーザーに通知 |
| FM-REL-003 | MEDIUM | システムは、毎日データベースをバックアップしなければならない | • 毎日02:00に自動バックアップ<br>• 保持: 30日<br>• 月次でリストア手順をテスト |

### 4.3 セキュリティ

| 要件ID | 優先度 | 要件 | 受け入れ基準 |
|--------|----------|-------------|---------------------|
| FM-SEC-001 | CRITICAL | システムは、全クライアント-サーバー通信にHTTPSを使用しなければならない | • TLS 1.2+、強力な暗号<br>• 有効なSSL証明書<br>• HTTPはHTTPSにリダイレクト |
| FM-SEC-002 | CRITICAL | システムは、bcryptを使用してパスワードを保存しなければならない（コストファクター ≥12） | • 平文パスワードを保存しない<br>• ユーザーごとに一意のソルト<br>• アルゴリズム更新のための移行計画 |
| FM-SEC-003 | HIGH | システムは、CSRF保護を実装しなければならない | • 全フォームにCSRFトークン<br>• SameSiteクッキー属性<br>• 有効なトークンなしのリクエストを拒否 |
| FM-SEC-004 | HIGH | システムは、XSSを防ぐために全ユーザー入力をサニタイズしなければならない | • サーバー側での入力検証<br>• 出力エンコーディング（HTMLエンティティ）<br>• Content Security Policyヘッダー |
| FM-SEC-005 | MEDIUM | システムは、セキュリティイベントをログに記録しなければならない（ログイン失敗、権限拒否など） | • タイムスタンプ、ユーザー、IP、アクションでイベントを記録<br>• 異常を監視<br>• 疑わしいパターンでアラート |

### 4.4 ユーザビリティ

| 要件ID | 優先度 | 要件 | 受け入れ基準 |
|--------|----------|-------------|---------------------|
| FM-UX-001 | HIGH | システムは、日本語と英語をサポートしなければならない | • ユーザー設定に言語セレクター<br>• 全UIテキストを翻訳（ハードコーディングされた文字列なし）<br>• ロケールごとの日付/時刻フォーマット |
| FM-UX-002 | MEDIUM | システムは、全ダッシュボードコントロールにツールチップを提供しなければならない | • ボタン、アイコンにホバーツールチップ<br>• キーボードアクセス可能（フォーカス → ツールチップ）<br>• 両言語で翻訳 |
| FM-UX-003 | MEDIUM | システムは、セッション間でUI状態を維持しなければならない | • ダッシュボードレイアウト、選択されたフィルター、言語設定<br>• ブラウザのlocalStorageに保存<br>• クロスデバイスのためにサーバーに同期 |
| FM-UX-004 | LOW | システムは、アクセシビリティ標準（WCAG 2.1 Level AA）をサポートしなければならない | • キーボードナビゲーション（全機能）<br>• スクリーンリーダー互換（ARIAラベル）<br>• 十分な色のコントラスト（4.5:1） |

### 4.5 互換性

| 要件ID | 優先度 | 要件 | 受け入れ基準 |
|--------|----------|-------------|---------------------|
| FM-COMPAT-001 | HIGH | システムは、モダンなWebブラウザをサポートしなければならない | • Chrome 100+、Firefox 100+、Safari 15+、Edge 100+<br>• 各ブラウザでテスト<br>• 古いブラウザの優雅な劣化 |
| FM-COMPAT-002 | MEDIUM | システムは、タブレットデバイスをサポートしなければならない（iPad、Androidタブレット） | • タッチフレンドリーなコントロール（最小48pxタップターゲット）<br>• レスポンシブレイアウト（縦/横）<br>• iPad Air、Samsung Galaxy Tabでテスト |

---

## 5. インターフェース要件

### 5.1 TVM Server API統合

| 要件ID | 優先度 | 要件 | 受け入れ基準 |
|--------|----------|-------------|---------------------|
| FM-INT-API-001 | CRITICAL | システムは、TVM Server API経由で車両テレメトリを消費しなければならない | • TVM_API_SPECIFICATION.mdで定義されたRESTエンドポイント<br>• リアルタイム更新のためのWebSocket接続<br>• APIエラーを優雅に処理 |
| FM-INT-API-002 | CRITICAL | システムは、TVM Server API経由で車両コマンドを送信しなければならない | • コマンド: dispatch、cancel、emergency_stop、configure<br>• 仕様で定義されたWebSocketプロトコル<br>• 失敗したコマンドを再試行（最大3回） |
| FM-INT-API-003 | HIGH | システムは、全APIリクエスト/レスポンスをJSONスキーマに対して検証しなければならない | • TVM_DATA_MODELS.mdのスキーマを使用<br>• 送信前のクライアント側検証<br>• サーバーレスポンス検証 |

---

## 6. データ要件

### 6.1 データストレージ

| 要件ID | 優先度 | 要件 | 受け入れ基準 |
|--------|----------|-------------|---------------------|
| FM-DATA-STORE-001 | HIGH | システムは、ユーザーアカウント、予約、ミッション、車両をリレーショナルデータベースに保存しなければならない | • 推奨: PostgreSQL 14+<br>• マイグレーション付きスキーマバージョニング<br>• 外部キー制約を強制 |
| FM-DATA-STORE-002 | MEDIUM | システムは、リアルタイム車両状態をキャッシュに保存しなければならない（オプション） | • 高速読み取りアクセスのためのRedis/Memcached<br>• データベースと同期<br>• TTL 60秒 |

### 6.2 データ保持

| 要件ID | 優先度 | 要件 | 受け入れ基準 |
|--------|----------|-------------|---------------------|
| FM-DATA-RET-001 | MEDIUM | システムは、1年間のミッション履歴を保持しなければならない | • 1年以上前のミッションを自動アーカイブ<br>• アーカイブデータをエクスポート可能<br>• 設定可能な保持期間 |
| FM-DATA-RET-002 | MEDIUM | システムは、90日間の監査ログを保持しなければならない | • ログインイベント、権限変更、ミッション編集<br>• 30日後に圧縮<br>• SIEMシステムにエクスポート可能 |

---

## 7. 運用要件

### 7.1 デプロイメント

| 要件ID | 優先度 | 要件 | 受け入れ基準 |
|--------|----------|-------------|---------------------|
| FM-OPS-DEPLOY-001 | MEDIUM | システムは、コンテナ化されたデプロイメント（Docker）をサポートしなければならない | • Dockerfileを提供<br>• マルチコンテナセットアップ用のDocker Compose<br>• 設定用の環境変数 |
| FM-OPS-DEPLOY-002 | MEDIUM | システムは、インストールと設定ガイドを提供しなければならない | • ステップバイステップのセットアップ手順<br>• 設定ファイルの例<br>• トラブルシューティングセクション |

### 7.2 監視

| 要件ID | 優先度 | 要件 | 受け入れ基準 |
|--------|----------|-------------|---------------------|
| FM-OPS-MON-001 | MEDIUM | システムは、ヘルスチェックエンドポイントを公開しなければならない | • GET /healthが健全な場合200を返す<br>• 含む内容: データベース接続、API接続性、WebSocketステータス<br>• ロードバランサーで使用 |
| FM-OPS-MON-002 | LOW | システムは、アプリケーションエラーを集中ロギングシステムに記録しなければならない | • 構造化ログ（JSON形式）<br>• ログレベル: DEBUG、INFO、WARN、ERROR<br>• ELK/Splunkに転送 |

---

## 8. 受け入れ基準

### 8.1 テスト要件

| テストタイプ | カバレッジ | 受け入れ |
|-----------|----------|------------|
| ユニットテスト | ≥80%コードカバレッジ | 全テストが合格 |
| 統合テスト | APIエンドポイント、データベース操作 | 全クリティカルパスがテスト済み |
| UIテスト | ダッシュボード、予約フロー、ユーザー管理 | 主要ワークフローを自動化（Selenium/Cypress） |
| パフォーマンステスト | ロードテスト（50ユーザー、10車両） | パフォーマンス要件を満たす |
| セキュリティテスト | OWASP Top 10脆弱性 | クリティカル/高脆弱性なし |
| アクセシビリティテスト | WCAG 2.1 Level AA | 重大な違反なし |

### 8.2 ユーザー受け入れテスト

| シナリオ | ユーザー役割 | 合格基準 |
|----------|-----------|---------------|
| 歩行介助予約を作成 | 介護士 | 予約作成、時間通りに車両配車、ミッション完了 |
| 緊急薬品配送を作成 | 看護師 | 予約が優先され、即座に車両割り当て |
| フリートをリアルタイムで監視 | 管理者 | 全車両がマップに表示、ステータス更新 <2秒レイテンシ |
| 車両を緊急停止 | 管理者 | 車両が500ms以内に停止、ダッシュボードでステータス更新 |
| ミッション履歴を検索 | 管理者 | 検索フィルターが機能、結果が正確 |

---

## 9. トレーサビリティマトリックス

| 要件カテゴリー | 要件数 | 優先度分布 |
|---------------------|-------------------|----------------------|
| フリートダッシュボード | 21 | CRITICAL: 4、HIGH: 11、MEDIUM: 5、LOW: 1 |
| 予約システム | 19 | CRITICAL: 4、HIGH: 10、MEDIUM: 4、LOW: 1 |
| ユーザー役割管理 | 14 | CRITICAL: 3、HIGH: 6、MEDIUM: 5 |
| ミッション管理 | 14 | CRITICAL: 3、HIGH: 7、MEDIUM: 4 |
| 通信システム | 9 | CRITICAL: 1、HIGH: 4、MEDIUM: 3、LOW: 1 |
| レポートと分析 | 6 | MEDIUM: 3、LOW: 3 |
| 非機能（パフォーマンス） | 4 | HIGH: 2、MEDIUM: 2 |
| 非機能（信頼性） | 3 | HIGH: 2、MEDIUM: 1 |
| 非機能（セキュリティ） | 5 | CRITICAL: 2、HIGH: 2、MEDIUM: 1 |
| 非機能（ユーザビリティ） | 4 | HIGH: 1、MEDIUM: 2、LOW: 1 |
| 非機能（互換性） | 2 | HIGH: 1、MEDIUM: 1 |
| インターフェース要件 | 3 | CRITICAL: 2、HIGH: 1 |
| データ要件 | 3 | HIGH: 1、MEDIUM: 2 |
| 運用要件 | 3 | MEDIUM: 3、LOW: 1 |
| **合計** | **110** | **CRITICAL: 19、HIGH: 45、MEDIUM: 36、LOW: 10** |

---

## 10. 前提条件と依存関係

### 10.1 前提条件

1. 施設にダッシュボードアクセス用の信頼性の高いWi-Fiカバレッジがある
2. ユーザーが基本的なコンピューター/タブレットの習熟度を持つ
3. 施設マップがCAD/PNG形式で提供される
4. ウェイポイント名が施設全体で標準化されている

### 10.2 依存関係

1. TVMサーバーバックエンド実装（TVM_SERVER_REQUIREMENTS.md）
2. 車両側TVMクライアント実装（VEHICLE_TVM_CLIENT_REQUIREMENTS.md）
3. TVM API仕様が安定（TVM_API_SPECIFICATION.md）
4. データベースサーバー（PostgreSQL）が利用可能
5. HTTPS用のSSL証明書

---

## 11. 未解決の問題とリスク

### 11.1 未解決の問題

| ID | 問題 | 所有者 | 解決目標 |
|----|-------|-------|-------------------|
| FM-ISSUE-001 | マップデータ形式が未確定 | 施設運用 | 第3週 |
| FM-ISSUE-002 | VoIPプロバイダー選択が保留中 | Unno | 第4週 |
| FM-ISSUE-003 | メールサーバー設定がTBD | ITチーム | 第5週 |

### 11.2 リスク

| リスク | 確率 | 影響 | 緩和策 |
|------|------------|--------|------------|
| マップデータが利用不可 | LOW | HIGH | 汎用施設レイアウトを使用、カスタムウェイポイントを手動追加 |
| WebSocketスケーラビリティ問題 | MEDIUM | MEDIUM | 早期にロードテスト、メッセージキュー（Redis Pub/Sub）を検討 |
| ユーザー役割要件の変更 | MEDIUM | LOW | 柔軟なRBACシステムを設計、新しい役割の追加が容易 |

---

## 12. 改訂履歴

| バージョン | 日付 | 著者 | 変更内容 |
|---------|------|--------|---------|
| 1.0 | 2025-12-16 | Unno | 初期ドラフト - 第2週ドキュメンテーション |

---

**文書終了**

**総要件数:** 110
**文書ステータス:** レビュー用ドラフト
**次回レビュー:** 第3週（統合調整のためPankajと）

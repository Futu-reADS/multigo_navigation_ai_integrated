# TVMサーバーバックエンド要件

**文書管理:**
- **文書ID:** TVM-SRV-REQ-001
- **バージョン:** 1.0
- **日付:** 2025-12-16
- **ステータス:** ドラフト
- **オーナー:** 海野（フリート管理チーム）
- **レビュアー:** パンカジ（車両統合）、System Architect

---

## 1. はじめに

### 1.1 目的

この文書は、TVM_API_SPECIFICATION.mdで定義されたサーバー側APIコントラクトを実装するTVM（Total Vehicle Management）サーバーバックエンドの要件を規定します。TVMサーバーは、車両テレメトリ取り込み、コマンドディスパッチ、データ永続化を処理し、フリート管理フロントエンドアプリケーションにサービスを提供します。

### 1.2 範囲

**範囲内:**
- REST APIエンドポイント実装（TVM_API_SPECIFICATION.mdで定義された7エンドポイント）
- リアルタイム車両コマンド用WebSocketサーバー
- データベーススキーマ設計と管理
- JWT認証と認可
- JSONスキーマに対するメッセージ検証
- レート制限とオフライン運用サポート
- エラー処理とロギング
- 性能最適化とスケーラビリティ

**範囲外:**
- フリート管理フロントエンドUI（FLEET_MANAGEMENT_REQUIREMENTS.mdでカバー）
- 車両側TVMクライアント（VEHICLE_TVM_CLIENT_REQUIREMENTS.mdでカバー）
- ハードウェアインフラストラクチャ（サーバー、ロードバランサー）
- データベース管理（バックアップ、レプリケーション - 運用上の懸念）

### 1.3 定義と略語

| 用語 | 定義 |
|------|------------|
| TVMサーバー | TVM APIを実装するバックエンドサーバー |
| REST API | REpresentational State Transfer API（HTTPベース） |
| WebSocket | 双方向通信プロトコル |
| JWT | JSON Web Token（認証） |
| レート制限 | リクエスト頻度のスロットリング |
| バルクアップロード | オフライン車両データアップロード |
| テレメトリ | 車両センサーデータ（位置、バッテリーなど） |

### 1.4 参照

- TVM_API_SPECIFICATION.md - 完全なAPIコントラクト（7 RESTエンドポイント、5 WebSocketコマンド）
- TVM_DATA_MODELS.md - JSONスキーマと検証ルール
- FLEET_MANAGEMENT_REQUIREMENTS.md - フロントエンドアプリケーション要件
- VEHICLE_TVM_CLIENT_REQUIREMENTS.md - 車両側クライアント要件

---

## 2. システム概要

### 2.1 アーキテクチャ

TVMサーバーは以下を行うバックエンドアプリケーションです:
- REST API（POSTリクエスト）経由で車両テレメトリを受信
- 履歴分析のためにデータベースにテレメトリを保存
- WebSocket経由でフリート管理フロントエンドに車両状態変更をブロードキャスト
- フロントエンドからコマンドを受信し、WebSocket経由で車両にディスパッチ
- JSONスキーマに対して全メッセージを検証
- JWTベース認証を実装

### 2.2 技術スタック（推奨）

**バックエンドフレームワーク:**
- オプション1: Python FastAPI（非同期、高性能、自動生成OpenAPIドキュメント）
- オプション2: Node.js + Express + Socket.io（JavaScriptエコシステム）
- オプション3: Java Spring Boot（エンタープライズグレード、成熟したエコシステム）

**データベース:**
- PostgreSQL 14+（ACID準拠、JSONサポート、成熟）

**WebSocket:**
- FastAPI WebSockets / Socket.io / Spring WebSocket

**キャッシング（オプション）:**
- Redis（レート制限、セッションストレージ用）

---

## 3. 機能要件

### 3.1 REST API実装

#### 3.1.1 位置更新エンドポイント

| 要件ID | 優先度 | 要件 | 受け入れ基準 |
|--------|----------|-------------|---------------------|
| TVM-API-LOC-001 | 重要 | サーバーはPOST /api/v1/vehicle/{vehicle_id}/locationを実装しなければならない | • TVM_DATA_MODELS.mdに従ってJSONペイロードを受け入れる<br>• LocationUpdateスキーマに対して検証<br>• received_atタイムスタンプ付きで200を返す |
| TVM-API-LOC-002 | 高 | サーバーは位置更新に1 Hzレート制限を適用しなければならない | • 車両毎に1秒あたり最大1リクエスト<br>• 超過した場合429 Too Many Requestsを返す<br>• レート制限をRedis（またはインメモリ）で追跡 |
| TVM-API-LOC-003 | 高 | サーバーは位置更新をデータベースに保存しなければならない | • テーブル: vehicle_locations<br>• カラム: vehicle_id、timestamp、latitude、longitude、heading、speed、accuracy<br>• 高速クエリのため(vehicle_id、timestamp)にインデックス |
| TVM-API-LOC-004 | 高 | サーバーはWebSocket経由で接続されたフロントエンドクライアントに位置更新をブロードキャストしなければならない | • メッセージタイプ: "location_update"<br>• 受信後500ms以内にブロードキャスト<br>• その車両をサブスクライブしているクライアントのみに |
| TVM-API-LOC-005 | 中 | サーバーは無効なタイムスタンプを持つ位置更新を拒否しなければならない | • タイムスタンプはISO 8601 UTCでなければならない<br>• サーバー時刻の±5分以内<br>• エラー詳細付きで400 Bad Requestを返す |

#### 3.1.2 車両ステータスエンドポイント

| 要件ID | 優先度 | 要件 | 受け入れ基準 |
|--------|----------|-------------|---------------------|
| TVM-API-STATUS-001 | 重要 | サーバーはPOST /api/v1/vehicle/{vehicle_id}/statusを実装しなければならない | • VehicleStatusUpdateペイロードを受け入れる<br>• 状態遷移を検証（idle → navigating → docking → charging）<br>• 200 OKを返す |
| TVM-API-STATUS-002 | 高 | サーバーは車両ステータスをデータベースに保存しなければならない | • テーブル: vehicle_status<br>• カラム: vehicle_id、timestamp、state、mission_id、error_code、error_message<br>• 現在のステータスもRedisに高速アクセス用にキャッシュ |
| TVM-API-STATUS-003 | 高 | サーバーは車両がerrorまたはemergency_stop状態に入った場合、アラートをトリガーしなければならない | • メッセージキューにアラートメッセージを配信（Redis Pub/Sub）<br>• フリート管理フロントエンドがアラートをサブスクライブ<br>• アラートには: vehicle_id、state、error_code、severity |

#### 3.1.3 バッテリー更新エンドポイント

| 要件ID | 優先度 | 要件 | 受け入れ基準 |
|--------|----------|-------------|---------------------|
| TVM-API-BAT-001 | 高 | サーバーはPOST /api/v1/vehicle/{vehicle_id}/batteryを実装しなければならない | • BatteryUpdateペイロードを受け入れる<br>• 検証: soc（0-100）、voltage（>0）、current、temperature<br>• 200 OKを返す |
| TVM-API-BAT-002 | 高 | サーバーはバッテリー更新をデータベースに保存しなければならない | • テーブル: vehicle_battery<br>• レート制限: 車両毎に5秒あたり1リクエスト<br>• (vehicle_id、timestamp)にインデックス |
| TVM-API-BAT-003 | 中 | サーバーはバッテリー健康メトリクスを計算して保存しなければならない | • サイクルカウント（充放電サイクル）<br>• 時間経過による電圧劣化<br>• メンテナンスアラートに使用 |

#### 3.1.4 エラーレポートエンドポイント

| 要件ID | 優先度 | 要件 | 受け入れ基準 |
|--------|----------|-------------|---------------------|
| TVM-API-ERR-001 | 重要 | サーバーはPOST /api/v1/vehicle/{vehicle_id}/errorを実装しなければならない | • ErrorReportペイロードを受け入れる<br>• 既知のコード（TVM_DATA_MODELS.md）に対してerror_codeを検証<br>• 200 OKを返す |
| TVM-API-ERR-002 | 高 | サーバーはエラーレポートをデータベースに保存しなければならない | • テーブル: vehicle_errors<br>• カラム: vehicle_id、timestamp、code、severity、subsystem、location、description、resolved_at<br>• (vehicle_id、timestamp、severity)にインデックス |
| TVM-API-ERR-003 | 重要 | サーバーはCRITICAL重要度エラーに対して即座にアラートをトリガーしなければならない | • メッセージキューにアラートを配信<br>• 接続された全管理者にデスクトップ通知<br>• メールアラート（オプション、設定可能） |

#### 3.1.5 ドッキング更新エンドポイント

| 要件ID | 優先度 | 要件 | 受け入れ基準 |
|--------|----------|-------------|---------------------|
| TVM-API-DOCK-001 | 高 | サーバーはPOST /api/v1/vehicle/{vehicle_id}/dockingを実装しなければならない | • DockingUpdateペイロードを受け入れる<br>• フェーズ遷移を検証（approaching → aligning → docking → docked）<br>• 200 OKを返す |
| TVM-API-DOCK-002 | 中 | サーバーはドッキング更新をデータベースに保存しなければならない | • テーブル: vehicle_docking<br>• ドッキング成功率分析に使用<br>• mission_idにリンク |

#### 3.1.6 バルクアップロードエンドポイント

| 要件ID | 優先度 | 要件 | 受け入れ基準 |
|--------|----------|-------------|---------------------|
| TVM-API-BULK-001 | 高 | サーバーはPOST /api/v1/vehicle/{vehicle_id}/bulkを実装しなければならない | • 混合テレメトリメッセージ配列を受け入れる<br>• リクエスト毎に最大1000メッセージ<br>• 処理カウント付きで200 OKを返す |
| TVM-API-BULK-002 | 高 | サーバーはバルクアップロードをアトミックに処理しなければならない | • 全メッセージを単一データベーストランザクションで挿入<br>• メッセージ検証失敗時にロールバック<br>• 検証失敗時に最初のエラー付きで400を返す |
| TVM-API-BULK-003 | 中 | サーバーはタイムスタンプに基づいてバルクアップロードを重複排除しなければならない | • 同じvehicle_id + timestampのメッセージが既に存在するかチェック<br>• 重複メッセージをスキップ<br>• 挿入数対スキップ数を返す |

#### 3.1.7 認証エンドポイント

| 要件ID | 優先度 | 要件 | 受け入れ基準 |
|--------|----------|-------------|---------------------|
| TVM-API-AUTH-001 | 重要 | サーバーはPOST /api/v1/auth/tokenを実装しなければならない | • client_idとclient_secretを受け入れる<br>• データベースに対して認証情報を検証<br>• JWTトークン（24時間有効）＋リフレッシュトークンを返す |
| TVM-API-AUTH-002 | 重要 | サーバーはJWTトークン検証ミドルウェアを実装しなければならない | • AuthorizationヘッダーからJWTを抽出（Bearerスキーム）<br>• 署名と有効期限を検証<br>• 無効/期限切れトークンを401 Unauthorizedで拒否 |
| TVM-API-AUTH-003 | 高 | サーバーはトークンリフレッシュメカニズムを実装しなければならない | • POST /api/v1/auth/refreshエンドポイント<br>• リフレッシュトークンを受け入れる<br>• 新しいJWTトークン（24時間）を発行<br>• リフレッシュトークンは30日間有効 |

---

### 3.2 WebSocketサーバー実装

#### 3.2.1 接続管理

| 要件ID | 優先度 | 要件 | 受け入れ基準 |
|--------|----------|-------------|---------------------|
| TVM-WS-CONN-001 | 重要 | サーバーは/ws/vehicle/{vehicle_id}でWebSocketエンドポイントを実装しなければならない | • WebSocketアップグレードリクエストを受け入れる<br>• クエリパラメータまたはヘッダー内のJWTトークンを検証<br>• 双方向メッセージングのため接続を維持 |
| TVM-WS-CONN-002 | 高 | サーバーは車両毎に複数の同時WebSocket接続をサポートしなければならない | • 車両とフロントエンドの両方が同時に接続可能<br>• 車両接続: テレメトリ送信、コマンド受信<br>• フロントエンド接続: テレメトリ受信、コマンド送信 |
| TVM-WS-CONN-003 | 高 | サーバーは接続ハートビート/ping-pongを実装しなければならない | • サーバーは30秒毎にpingを送信<br>• 10秒以内にpongを期待<br>• pong未受信の場合、接続を閉じる |
| TVM-WS-CONN-004 | 中 | サーバーは接続切断を優雅に処理しなければならない | • 切断された車両用にメッセージをキュー（最大100メッセージ）<br>• 再接続時にキューされたメッセージを配信<br>• キュー満杯の場合、最古メッセージを破棄 |

#### 3.2.2 コマンドディスパッチ

| 要件ID | 優先度 | 要件 | 受け入れ基準 |
|--------|----------|-------------|---------------------|
| TVM-WS-CMD-001 | 重要 | サーバーは「dispatch」コマンド転送を実装しなければならない | • フロントエンドがdispatchコマンド送信 → サーバーが検証 → 車両WebSocketに転送<br>• コマンドには: mission_id、pickup、destination、priority<br>• タイムアウト5秒、車両が確認応答しない場合は再試行 |
| TVM-WS-CMD-002 | 重要 | サーバーは「cancel」コマンド転送を実装しなければならない | • dispatchと同じフロー<br>• 車両は現在のミッション状態で確認応答 |
| TVM-WS-CMD-003 | 重要 | サーバーは「emergency_stop」コマンド転送を実装しなければならない | • 最高優先度コマンド<br>• 検証遅延なし、車両への即座転送<br>• 監査証跡にログ |
| TVM-WS-CMD-004 | 高 | サーバーは「resume」コマンド転送を実装しなければならない | • emergency_stop後のみ有効<br>• 車両は再開が安全か検証 |
| TVM-WS-CMD-005 | 中 | サーバーは「configure」コマンド転送を実装しなければならない | • 車両設定を更新（speed_limit、operational_hours）<br>• 車両は更新された設定で確認応答 |

#### 3.2.3 メッセージブロードキャスティング

| 要件ID | 優先度 | 要件 | 受け入れ基準 |
|--------|----------|-------------|---------------------|
| TVM-WS-BCAST-001 | 高 | サーバーは車両テレメトリを全サブスクライブ済みフロントエンドクライアントにブロードキャストしなければならない | • REST経由で位置/ステータス更新受信時、WebSocket経由でブロードキャスト<br>• その車両または「全車両」をサブスクライブしているクライアントのみに<br>• 500ms以内にブロードキャスト |
| TVM-WS-BCAST-002 | 中 | サーバーはサブスクリプション管理を実装しなければならない | • クライアントはvehicle_idリスト付き「subscribe」メッセージを送信<br>• サーバーは接続毎にサブスクリプションを追跡<br>• 接続クローズ時にサブスクライブ解除 |

---

### 3.3 データベース管理

#### 3.3.1 スキーマ設計

| 要件ID | 優先度 | 要件 | 受け入れ基準 |
|--------|----------|-------------|---------------------|
| TVM-DB-SCHEMA-001 | 高 | サーバーは車両テレメトリ用のデータベーススキーマを実装しなければならない | • テーブル: vehicle_locations、vehicle_status、vehicle_battery、vehicle_errors、vehicle_docking<br>• 外部キー: vehicle_idがvehicles(id)を参照<br>• 全テーブルで(vehicle_id、timestamp)にインデックス |
| TVM-DB-SCHEMA-002 | 高 | サーバーはミッションと予約用のデータベーススキーマを実装しなければならない | • テーブル: missions、reservations<br>• ミッションをvehicle_idとreservation_idにリンク<br>• 保存: pickup、destination、start_time、end_time、status |
| TVM-DB-SCHEMA-003 | 高 | サーバーはユーザーと認証用のデータベーススキーマを実装しなければならない | • テーブル: users（id、username、email、password_hash、role）<br>• テーブル: refresh_tokens（token、user_id、expires_at）<br>• usernameとemailに一意制約 |

#### 3.3.2 データアクセスパターン

| 要件ID | 優先度 | 要件 | 受け入れ基準 |
|--------|----------|-------------|---------------------|
| TVM-DB-ACCESS-001 | 高 | サーバーは最新車両データのクエリを最適化しなければならない | • 車両毎の最新位置をクエリ（DISTINCT ONまたはウィンドウ関数を使用した1クエリ）<br>• 車両毎の最新ステータスをクエリ<br>• クエリ実行時間 <100ms |
| TVM-DB-ACCESS-002 | 中 | サーバーはデータベース接続プーリングを実装しなければならない | • 最小5、最大20接続<br>• 接続タイムアウト30秒<br>• 接続使用を監視 |
| TVM-DB-ACCESS-003 | 中 | サーバーはデータベースマイグレーションを実装しなければならない | • マイグレーションツールを使用（Python用Alembic、Java用Flyway、Node.js用Knex）<br>• バージョン管理されたマイグレーションファイル<br>• ロールバック機能 |

#### 3.3.3 データ保持

| 要件ID | 優先度 | 要件 | 受け入れ基準 |
|--------|----------|-------------|---------------------|
| TVM-DB-RET-001 | 中 | サーバーは古いテレメトリのデータアーカイブを実装しなければならない | • 30日超の古いvehicle_locationsを別テーブルにアーカイブ<br>• 90日超の古いvehicle_statusをアーカイブ<br>• スケジュールされたジョブが毎日02:00に実行 |
| TVM-DB-RET-002 | 中 | サーバーは監査ログ保持を実装しなければならない | • audit_logsを90日間保持<br>• 削除前にコールドストレージ（S3）にエクスポート<br>• 設定可能な保持期間 |

---

### 3.4 メッセージ検証

| 要件ID | 優先度 | 要件 | 受け入れ基準 |
|--------|----------|-------------|---------------------|
| TVM-VAL-001 | 重要 | サーバーはJSONスキーマに対して全受信メッセージを検証しなければならない | • TVM_DATA_MODELS.mdのスキーマを使用<br>• 検証ライブラリ（Python用jsonschema、Node.js用ajv）<br>• 検証失敗時に詳細エラー付きで400 Bad Requestを返す |
| TVM-VAL-002 | 高 | サーバーは処理前にvehicle_idが存在することを検証しなければならない | • データベースのvehiclesテーブルでvehicle_idをチェック<br>• 車両が存在しない場合、404 Not Foundを返す<br>• 高速ルックアップのためRedisに有効なvehicle_idをキャッシュ |
| TVM-VAL-003 | 高 | サーバーはタイムスタンプ形式と範囲を検証しなければならない | • ISO 8601 UTC形式<br>• サーバー時刻の±5分以内<br>• 将来のタイムスタンプを拒否 |
| TVM-VAL-004 | 中 | サーバーは列挙値を検証しなければならない | • VehicleState、ErrorSeverity、CommandPriority、DockingPhase<br>• 無効な場合、エラーメッセージ付きで400を返す |

---

### 3.5 エラー処理

| 要件ID | 優先度 | 要件 | 受け入れ基準 |
|--------|----------|-------------|---------------------|
| TVM-ERR-001 | 高 | サーバーは標準化されたエラー応答を返さなければならない | • 形式: {"error": {"code": "INVALID_TIMESTAMP", "message": "...", "details": {...}}}<br>• HTTPステータスコード: 400（検証）、401（認証）、403（権限）、404（未発見）、429（レート制限）、500（サーバーエラー） |
| TVM-ERR-002 | 高 | サーバーは全エラーをアプリケーションログに記録しなければならない | • 構造化ロギング（JSON形式）<br>• 含む: timestamp、level、message、vehicle_id、request_id、stack_trace<br>• ログローテーション（毎日、最大10ファイル） |
| TVM-ERR-003 | 中 | サーバーは優雅な劣化を実装しなければならない | • データベース利用不可の場合、503 Service Unavailableを返す<br>• Redis利用不可の場合、レート制限を無効化（全リクエスト許可）<br>• ヘルスチェックエンドポイントがコンポーネントステータスを反映 |

---

### 3.6 セキュリティ

| 要件ID | 優先度 | 要件 | 受け入れ基準 |
|--------|----------|-------------|---------------------|
| TVM-SEC-001 | 重要 | サーバーは全HTTP通信にHTTPSを使用しなければならない | • 強力な暗号を持つTLS 1.2+<br>• 有効なSSL証明書<br>• HTTPからHTTPSへリダイレクト |
| TVM-SEC-002 | 重要 | サーバーはWebSocket接続にWSS（WebSocket Secure）を使用しなければならない | • WebSocket用のTLS暗号化<br>• 暗号化されていないWebSocket接続を拒否 |
| TVM-SEC-003 | 重要 | サーバーは車両毎にレート制限を実装しなければならない | • 位置: 1 req/s、バッテリー: 1 req/5s、エラー: イベント駆動（制限なし）<br>• レートリミッター: トークンバケットまたはスライディングウィンドウ<br>• 分散レート制限のためRedisに保存 |
| TVM-SEC-004 | 高 | サーバーはSQLインジェクションを防ぐため全入力をサニタイズしなければならない | • パラメータ化クエリ（プリペアドステートメント）を使用<br>• ORM（SQLAlchemy、Sequelize、Hibernate）がSQLインジェクション防止を支援<br>• SQLクエリで文字列連結を使用しない |
| TVM-SEC-005 | 高 | サーバーはCORSポリシーを実装しなければならない | • 許可オリジン: フリート管理フロントエンドドメイン<br>• 許可メソッド: GET、POST、OPTIONS<br>• 許可ヘッダー: Authorization、Content-Type |
| TVM-SEC-006 | 中 | サーバーはリクエストIDトレースを実装しなければならない | • リクエスト毎にユニークなrequest_idを生成<br>• 応答ヘッダーに含む（X-Request-ID）<br>• デバッグのためrequest_id付きでログ |

---

## 4. 非機能要件

### 4.1 性能

| 要件ID | 優先度 | 要件 | 受け入れ基準 |
|--------|----------|-------------|---------------------|
| TVM-PERF-001 | 高 | サーバーは1 Hzでテレメトリを送信する10台の車両を処理しなければならない | • 持続的に10位置更新/秒<br>• API応答時間 <200ms（p95）<br>• CPU使用率 <70%、メモリ <2GB |
| TVM-PERF-002 | 高 | サーバーは50同時WebSocket接続をサポートしなければならない | • 10台の車両 + 40フロントエンドクライアント<br>• メッセージレイテンシー <500ms（p95）<br>• 接続切断なし |
| TVM-PERF-003 | 中 | サーバーは1000メッセージのバルクアップロードを5秒未満で処理しなければならない | • データベースバッチ挿入最適化<br>• トランザクションコミット時間 <5秒<br>• 応答時間 <5秒 |
| TVM-PERF-004 | 中 | サーバーデータベースクエリは100ms未満（p95）で実行しなければならない | • 頻繁にクエリされるカラムにインデックス<br>• クエリプラン最適化<br>• スロークエリログで監視 |

### 4.2 スケーラビリティ

| 要件ID | 優先度 | 要件 | 受け入れ基準 |
|--------|----------|-------------|---------------------|
| TVM-SCALE-001 | 中 | サーバーはロードバランサー背後で水平スケーリングをサポートしなければならない | • ステートレスサーバー設計（状態はデータベース/Redisに）<br>• WebSocketスティッキーセッション（ロードバランサー設定）<br>• 2以上のサーバーインスタンスでテスト |
| TVM-SCALE-002 | 中 | サーバーはデータベース読み取りレプリカをサポートしなければならない（オプション） | • プライマリに書き込み、履歴クエリはレプリカから読み取り<br>• レプリケーションラグ <1秒<br>• 自動フェイルオーバー |

### 4.3 信頼性

| 要件ID | 優先度 | 要件 | 受け入れ基準 |
|--------|----------|-------------|---------------------|
| TVM-REL-001 | 高 | サーバーはヘルスチェックエンドポイントを実装しなければならない | • GET /healthが健全な場合200を返す<br>• チェック: データベース接続、Redis接続（使用時）<br>• ロードバランサーがライブネスプローブに使用 |
| TVM-REL-002 | 高 | サーバーは優雅なシャットダウンを実装しなければならない | • SIGTERMで新規接続受け入れ停止<br>• アクティブリクエストの完了を待機（最大30秒）<br>• データベース接続をクリーンにクローズ |
| TVM-REL-003 | 中 | サーバーは一時的データベースエラーの自動再試行を実装しなければならない | • 接続タイムアウト、デッドロックで再試行<br>• 指数バックオフ（1秒、2秒、4秒）<br>• 最大3回再試行 |

### 4.4 可観測性

| 要件ID | 優先度 | 要件 | 受け入れ基準 |
|--------|----------|-------------|---------------------|
| TVM-OBS-001 | 中 | サーバーはメトリクスエンドポイントを公開しなければならない | • /metricsでPrometheus互換メトリクス<br>• メトリクス: request_count、request_duration、active_connections、db_pool_usage<br>• リアルタイムで更新 |
| TVM-OBS-002 | 中 | サーバーは構造化ロギングを実装しなければならない | • JSON形式ログ<br>• 含む: timestamp、level、message、request_id、vehicle_id、user_id<br>• 集中ロギング（ELK、Splunk）に転送 |
| TVM-OBS-003 | 低 | サーバーは分散トレーシングをサポートしなければならない（オプション） | • OpenTelemetry統合<br>• REST → DB → WebSocketを横断してリクエストをトレース<br>• トレースをJaeger/Zipkinに送信 |

---

## 5. インターフェース要件

### 5.1 API準拠

| 要件ID | 優先度 | 要件 | 受け入れ基準 |
|--------|----------|-------------|---------------------|
| TVM-INT-001 | 重要 | サーバーはTVM_API_SPECIFICATION.mdで規定された通りに正確にAPIを実装しなければならない | • 全7 RESTエンドポイント<br>• 全5 WebSocketコマンド<br>• 同じリクエスト/応答形式<br>• 同じエラーコード |
| TVM-INT-002 | 高 | サーバーはOpenAPI/Swaggerドキュメントを提供しなければならない | • コードから自動生成（FastAPI）または手動維持<br>• /docsまたは/api-docsでアクセス可能<br>• 全エンドポイントの例を含む |

### 5.2 データベースインターフェース

| 要件ID | 優先度 | 要件 | 受け入れ基準 |
|--------|----------|-------------|---------------------|
| TVM-INT-DB-001 | 高 | サーバーは環境変数からデータベース接続文字列を使用しなければならない | • 形式: postgresql://user:pass@host:port/dbname<br>• ハードコードされた認証情報なし<br>• 接続プーリングパラメータをサポート |

---

## 6. 運用要件

### 6.1 デプロイ

| 要件ID | 優先度 | 要件 | 受け入れ基準 |
|--------|----------|-------------|---------------------|
| TVM-OPS-001 | 中 | サーバーはコンテナ化デプロイ用のDockerfileを提供しなければならない | • 小さいイメージサイズのためのマルチステージビルド<br>• 非ルートユーザー<br>• ポート8000（HTTP）を公開 |
| TVM-OPS-002 | 中 | サーバーは環境変数から設定を読み取らなければならない | • 全設定（DB URL、JWTシークレット、レート制限）を環境変数から<br>• .env.exampleファイル提供<br>• 起動時の検証 |

### 6.2 ドキュメント

| 要件ID | 優先度 | 要件 | 受け入れ基準 |
|--------|----------|-------------|---------------------|
| TVM-OPS-DOC-001 | 高 | サーバーはデプロイガイドを提供しなければならない | • インストール手順<br>• データベースセットアップ（スキーマ作成）<br>• 環境変数リファレンス<br>• トラブルシューティングセクション |
| TVM-OPS-DOC-002 | 中 | サーバーは開発者セットアップガイドを提供しなければならない | • ローカル開発環境セットアップ<br>• テスト実行<br>• コードスタイルガイド |

---

## 7. テスト要件

| テストタイプ | カバレッジ | 受け入れ |
|-----------|----------|------------|
| ユニットテスト | ≥80%コードカバレッジ | 全テスト合格、クリティカルパス100%カバー |
| 統合テスト | 全APIエンドポイント | 実データベース（テストDB）でテスト |
| WebSocketテスト | 接続、コマンド、ブロードキャスティング | WebSocketクライアントでの自動テスト |
| 負荷テスト | 10台の車両、1時間1 Hz | エラーなし、応答時間 <200ms（p95） |
| セキュリティテスト | OWASP API Top 10 | クリティカル/高脆弱性なし |

---

## 8. トレーサビリティマトリクス

| 要件カテゴリ | 要件数 | 優先度分布 |
|---------------------|-------------------|----------------------|
| REST API実装 | 20 | 重要: 5、高: 12、中: 3 |
| WebSocket実装 | 11 | 重要: 4、高: 5、中: 2 |
| データベース管理 | 11 | 高: 6、中: 5 |
| メッセージ検証 | 4 | 重要: 1、高: 3 |
| エラー処理 | 3 | 高: 2、中: 1 |
| セキュリティ | 6 | 重要: 3、高: 2、中: 1 |
| 非機能（性能） | 4 | 高: 2、中: 2 |
| 非機能（スケーラビリティ） | 2 | 中: 2 |
| 非機能（信頼性） | 3 | 高: 2、中: 1 |
| 非機能（可観測性） | 3 | 中: 2、低: 1 |
| インターフェース要件 | 2 | 重要: 1、高: 1 |
| 運用要件 | 3 | 中: 2、高: 1 |
| **合計** | **72** | **重要: 14、高: 35、中: 21、低: 2** |

---

## 9. 前提と依存関係

### 9.1 前提

1. PostgreSQL 14+データベースサーバーが利用可能
2. データベースと同じネットワークにサーバーをデプロイ（低レイテンシー）
3. HTTPS用SSL証明書（Let's EncryptまたはCA発行）
4. ロードバランサーがTLS終端を処理（オプション、サーバーがTLS可能）

### 9.2 依存関係

1. TVM_API_SPECIFICATION.md完成（Week 1 ✅）
2. TVM_DATA_MODELS.md完成（Week 1 ✅）
3. 車両TVMクライアントがAPIを実装（VEHICLE_TVM_CLIENT_REQUIREMENTS.md）
4. フリート管理フロントエンドがAPIを消費（FLEET_MANAGEMENT_REQUIREMENTS.md）

---

## 10. オープン課題とリスク

### 10.1 オープン課題

| ID | 課題 | オーナー | 目標解決 |
|----|-------|-------|-------------------|
| TVM-SRV-ISSUE-001 | 技術スタック選択（Python/Node.js/Java） | Unno | Week 3 |
| TVM-SRV-ISSUE-002 | アラート用メッセージキュー（Redis Pub/Sub vs RabbitMQ） | Unno | Week 3 |

### 10.2 リスク

| リスク | 確率 | 影響 | 軽減策 |
|------|------------|--------|------------|
| 負荷下でのWebSocketスケーラビリティ | 中 | 高 | 早期負荷テスト（Week 7）、必要に応じてRedisをメッセージブロードキャスティングに使用 |
| 高テレメトリ量でのデータベース性能 | 中 | 中 | インデックス最適化、時系列データにTimescaleDB検討 |
| JWTシークレット侵害 | 低 | 高 | JWTシークレットを定期的にローテーション、セキュアボールトに保存（HashiCorp Vault） |

---

## 11. 改訂履歴

| バージョン | 日付 | 著者 | 変更内容 |
|---------|------|--------|---------|
| 1.0 | 2025-12-16 | Unno | 初期ドラフト - Week 2ドキュメンテーション |

---

**文書の終わり**

**合計要件:** 72
**文書ステータス:** レビュー用ドラフト
**次回レビュー:** Week 3（車両統合についてパンカジと）

# 予約システム要件

**文書管理:**
- **文書ID:** FM-RES-REQ-001
- **バージョン:** 1.0
- **日付:** 2025-12-16
- **ステータス:** ドラフト
- **所有者:** Unno（フリート管理チーム）
- **レビュアー:** Pankaj（統合）、施設運営チーム

---

## 1. はじめに

### 1.1 目的

本文書は、フリート管理システムのコアコンポーネントである予約システムの詳細要件を規定する。予約システムは、施設スタッフ（介護士と看護士）が入居者の車椅子輸送ミッション、歩行支援、薬剤配送サービスをスケジュールおよび管理できるようにする。

### 1.2 範囲

**対象範囲:**
- 予約作成ワークフロー（介護士と看護士インターフェース）
- 予約スケジューリングとタイムスロット管理
- 優先度キュー管理（通常、緊急、救急）
- 予約変更とキャンセル
- 繰り返し予約パターン
- 競合検出と解決
- 通知システム（確認、リマインダー、ステータス更新）
- 車両配車システムとの統合
- 予約履歴とレポート

**対象外:**
- リアルタイム車両追跡（FLEET_MANAGEMENT_REQUIREMENTS.mdで規定）
- TVMサーバーバックエンド実装（TVM_SERVER_REQUIREMENTS.mdで規定）
- ユーザー認証とロール管理（USER_ROLE_MANAGEMENT_REQUIREMENTS.mdで規定）

### 1.3 定義と略語

| 用語 | 定義 |
|------|------------|
| Reservation | 事前スケジュールされた輸送ミッション要求 |
| Caregiver | 介護士 - 歩行支援を要求するスタッフメンバー |
| Nurse | 看護士 - 薬剤配送を要求する医療スタッフ |
| Priority | 緊急度レベル（通常、緊急、救急） |
| Time Slot | 15分の予約枠 |
| Recurring Reservation | 繰り返しパターン（毎日、毎週） |
| Conflict | 同じ車両/時間に対する重複予約 |

### 1.4 参考文献

- FLEET_MANAGEMENT_REQUIREMENTS.md - 親文書
- TVM_SERVER_REQUIREMENTS.md - バックエンドAPI
- USER_ROLE_MANAGEMENT_REQUIREMENTS.md - ユーザーロールと権限
- Excelユースケース - 介護士と看護士のワークフロー

---

## 2. システム概要

### 2.1 ユースケース

**主要ユースケース:**
1. **歩行支援（介護士）:**
   - 入居者が部屋からロビーへの輸送を必要
   - 介護士が特定時間の車椅子ロボットを予約
   - ロボットが入居者をピックアップ、安全に輸送、戻る

2. **薬剤配送（看護士）:**
   - 薬局が201号室の患者用に薬を準備
   - 看護士が緊急配送のロボットを予約
   - ロボットが薬をピックアップ、患者の部屋に配送

3. **スケジュールされた活動:**
   - 毎日午前10:00のリハビリセッション
   - 平日毎日の繰り返し予約
   - スケジュール時間の5分前に自動配車

### 2.2 予約ライフサイクル

```
作成 → スケジュール → キュー → 配車 → 進行中 → 完了
   ↓         ↓         ↓         ↓
 変更   キャンセル   競合   失敗
```

---

## 3. 機能要件

### 3.1 予約作成

#### 3.1.1 歩行支援予約（介護士）

| 要件ID | 優先度 | 要件 | 受入基準 |
|--------|----------|-------------|---------------------|
| RES-CREATE-WALK-001 | CRITICAL | システムは歩行支援の予約フォームを提供しなければならない | • フォームフィールド: 乗客名、ピックアップウェイポイント、目的地ウェイポイント、スケジュール時間、メモ<br>• メモ以外のすべてのフィールドが必須<br>• 介護士ダッシュボードからアクセス可能 |
| RES-CREATE-WALK-002 | HIGH | システムは入居者データベースに対して乗客名を検証しなければならない | • 入居者リストからのオートコンプリート<br>• 入力ミスを防止<br>• 入居者の写真を表示（オプション） |
| RES-CREATE-WALK-003 | HIGH | システムはウェイポイント選択を検証しなければならない | • ピックアップ/目的地はドロップダウンから（施設ウェイポイント）<br>• 同じウェイポイントは不可<br>• ウェイポイント説明を表示（例: "201号室 - 2階東"） |
| RES-CREATE-WALK-004 | CRITICAL | システムは最小事前予約時間を強制しなければならない | • スケジュール時間 ≥ 現在時刻 + 10分<br>• 早すぎる場合はエラーメッセージ<br>• 例外: 救急優先度（即時予約） |
| RES-CREATE-WALK-005 | MEDIUM | システムは最適なタイムスロットを提案しなければならない | • 次の5つの利用可能なスロットを表示<br>• 車両可用性に基づく<br>• 緑（利用可能）、黄色（制限あり）、赤（満杯） |
| RES-CREATE-WALK-006 | MEDIUM | システムはメモ/特別指示を許可しなければならない | • 自由テキストフィールド（最大500文字）<br>• 例: "乗客は移動補助具あり"、"帰りの移動が必要"<br>• 車両オペレーター（存在する場合）に表示 |

#### 3.1.2 薬剤配送予約（看護士）

| 要件ID | 優先度 | 要件 | 受入基準 |
|--------|----------|-------------|---------------------|
| RES-CREATE-MED-001 | CRITICAL | システムは薬剤配送の予約フォームを提供しなければならない | • フォームフィールド: 品目説明、ピックアップ（薬局）、目的地（部屋）、スケジュール時間、優先度<br>• 優先度: 通常、緊急、救急<br>• 看護士ダッシュボードからアクセス可能 |
| RES-CREATE-MED-002 | HIGH | システムはピックアップを薬局ウェイポイントにデフォルト設定しなければならない | • ピックアップは "薬局 - 1階" で自動入力<br>• 変更可能（例: 異なる保管場所）<br>• 目的地は必須（患者の部屋） |
| RES-CREATE-MED-003 | CRITICAL | システムは薬剤配送の優先度レベルをサポートしなければならない | • 通常: 通常キュー（例: 毎日の服薬）<br>• 緊急: キュー優先（例: 痛み止め）<br>• 救急: 即座の配車（例: 重要薬剤）<br>• 優先度は色分けで表示 |
| RES-CREATE-MED-004 | HIGH | システムは優先度ベースの時間制約を強制しなければならない | • 通常: ≥ 30分事前<br>• 緊急: ≥ 10分事前<br>• 救急: 即座（0分）<br>• 制約違反の場合はエラー |
| RES-CREATE-MED-005 | MEDIUM | システムは救急優先度の確認を要求しなければならない | • 確認ダイアログ: "救急配送は現在のミッションを中断します。確認しますか？"<br>• 明示的な確認が必要<br>• 監査証跡にログ記録 |

#### 3.1.3 予約確認

| 要件ID | 優先度 | 要件 | 受入基準 |
|--------|----------|-------------|---------------------|
| RES-CONFIRM-001 | CRITICAL | システムは作成時に一意の予約IDを生成しなければならない | • フォーマット: RES-YYYYMMDD-NNNN（例: RES-20251216-0042）<br>• 日ごとの連番<br>• 確認で表示 |
| RES-CONFIRM-002 | HIGH | システムは作成後に予約サマリーを表示しなければならない | • サマリーに含む: 予約ID、乗客/品目、ウェイポイント、スケジュール時間、優先度<br>• 推定所要時間を表示<br>• 印刷/メールオプション |
| RES-CONFIRM-003 | HIGH | システムは要求者に確認通知を送信しなければならない | • アプリ内通知 + メール（設定されている場合）<br>• 予約詳細 + キャンセルリンクを含む<br>• 作成後5秒以内に送信 |
| RES-CONFIRM-004 | MEDIUM | システムは推定完了時間を計算しなければならない | • 基準: ピックアップ距離、輸送距離、ドッキング時間<br>• 表示: "スケジュール 10:00 AM、推定完了 10:12 AM"<br>• ルート変更時に更新 |

---

### 3.2 予約スケジューリング

#### 3.2.1 タイムスロット管理

| 要件ID | 優先度 | 要件 | 受入基準 |
|--------|----------|-------------|---------------------|
| RES-SCHED-SLOT-001 | HIGH | システムはスケジューリングに15分のタイムスロットを使用しなければならない | • スロット: 毎時00:00、00:15、00:30、00:45<br>• ユーザーは希望時間に最も近いスロットを選択<br>• 競合検出を簡素化 |
| RES-SCHED-SLOT-002 | HIGH | システムはタイムスロットの可用性をリアルタイムで表示しなければならない | • カレンダー/タイムラインビュー<br>• 利用可能（緑）、制限あり（黄色）、満杯（赤）<br>• 予約作成/キャンセル時に更新 |
| RES-SCHED-SLOT-003 | MEDIUM | システムは運用時間を強制しなければならない | • 設定可能な運用時間（例: 8:00-20:00）<br>• 運用時間外の予約を防止<br>• 例外: 救急優先度 |
| RES-SCHED-SLOT-004 | MEDIUM | システムは予約間のバッファ時間をサポートしなければならない | • 設定可能なバッファ（デフォルト5分）<br>• 連続ミッションを防止<br>• 車両が時間通りにピックアップ到着可能 |

#### 3.2.2 車両割り当て

| 要件ID | 優先度 | 要件 | 受入基準 |
|--------|----------|-------------|---------------------|
| RES-SCHED-VEHICLE-001 | CRITICAL | システムは配車時に予約に車両を自動割り当てしなければならない | • 割り当てアルゴリズム: 最寄りの利用可能な車両で十分なバッテリー<br>• 作成時は手動割り当てなし（配車時に自動）<br>• 予約ステータスに表示 |
| RES-SCHED-VEHICLE-002 | HIGH | システムは割り当てで車両バッテリーレベルを考慮しなければならない | • 割り当てに ≥30% バッテリーが必要<br>• >50% バッテリーの車両を優先<br>• すべての車両が <20% バッテリーの場合は拒否 |
| RES-SCHED-VEHICLE-003 | HIGH | システムは最初に割り当てた車両が故障した場合に再割り当てしなければならない | • 配車前に車両がエラー状態になった場合<br>• 次の利用可能な車両に自動再割り当て<br>• 要求者に通知送信 |
| RES-SCHED-VEHICLE-004 | MEDIUM | システムは複数予約の車両割り当てを最適化しなければならない | • 近接する予約を同じ車両にバッチ処理（ルート最適化）<br>• 総移動距離を最小化<br>• 予約優先度を考慮 |

---

### 3.3 予約変更

#### 3.3.1 時間/ウェイポイント変更

| 要件ID | 優先度 | 要件 | 受入基準 |
|--------|----------|-------------|---------------------|
| RES-MOD-CHANGE-001 | HIGH | システムは配車前の予約変更を許可しなければならない | • 予約詳細に編集ボタン<br>• 変更可能: 時間、ウェイポイント、メモ、優先度<br>• 車両配車後は変更不可 |
| RES-MOD-CHANGE-002 | HIGH | システムは変更を作成時と同じように検証しなければならない | • 同じ検証ルールを適用<br>• タイムスロットの可用性を確認<br>• 競合を防止 |
| RES-MOD-CHANGE-003 | MEDIUM | システムは要求者に変更成功を通知しなければならない | • 確認通知<br>• 新旧詳細を表示<br>• 更新された推定完了時間 |
| RES-MOD-CHANGE-004 | MEDIUM | システムはすべての変更を監査証跡にログ記録しなければならない | • タイムスタンプ、ユーザー、変更フィールド、旧値、新値<br>• 管理者が閲覧可能<br>• CSVにエクスポート可能 |

#### 3.3.2 優先度変更

| 要件ID | 優先度 | 要件 | 受入基準 |
|--------|----------|-------------|---------------------|
| RES-MOD-PRIORITY-001 | HIGH | システムは看護士が優先度をアップグレード（通常 → 緊急 → 救急）できるようにしなければならない | • 予約詳細にアップグレードボタン<br>• 救急には確認が必要<br>• 新しい優先度で予約を再キュー |
| RES-MOD-PRIORITY-002 | MEDIUM | システムは優先度ダウングレードを制限しなければならない | • 管理者のみが救急 → 緊急にダウングレード可能<br>• 介護士/看護士は自分の予約をダウングレード不可<br>• キューの悪用を防止 |

---

### 3.4 予約キャンセル

| 要件ID | 優先度 | 要件 | 受入基準 |
|--------|----------|-------------|---------------------|
| RES-CANCEL-001 | CRITICAL | システムは配車前の予約キャンセルを許可しなければならない | • 予約詳細にキャンセルボタン<br>• 確認ダイアログ: "予約 RES-... をキャンセルしますか？"<br>• 車両配車後はキャンセル不可（代わりにミッションキャンセルを使用） |
| RES-CANCEL-002 | HIGH | システムはキャンセル時にタイムスロットを解放しなければならない | • キャンセルされた予約をキューから削除<br>• タイムスロットは即座に利用可能<br>• キュー内の他の予約が繰り上がる可能性 |
| RES-CANCEL-003 | HIGH | システムは要求者にキャンセルを通知しなければならない | • 確認通知: "予約 RES-... がキャンセルされました"<br>• メール通知（設定されている場合）<br>• キャンセルタイムスタンプを記録 |
| RES-CANCEL-004 | MEDIUM | システムはキャンセル理由をログ記録しなければならない（オプション） | • オプションフィールド: "キャンセル理由"<br>• キャンセルパターンの分析に役立つ<br>• 管理者が閲覧可能 |
| RES-CANCEL-005 | MEDIUM | システムは一括キャンセルをサポートしなければならない（管理者のみ） | • 複数の予約を選択<br>• すべてキャンセルボタン<br>• カウント付き確認: "5件の予約をキャンセルしますか？" |

---

### 3.5 繰り返し予約

#### 3.5.1 繰り返しパターン

| 要件ID | 優先度 | 要件 | 受入基準 |
|--------|----------|-------------|---------------------|
| RES-RECUR-PATTERN-001 | MEDIUM | システムは毎日の繰り返し予約をサポートしなければならない | • 作成フォームに "毎日繰り返し" チェックボックス<br>• 終了日または発生回数（例: "30回繰り返し"）<br>• リンクされた予約のシリーズを作成 |
| RES-RECUR-PATTERN-002 | MEDIUM | システムは毎週の繰り返し予約をサポートしなければならない | • 曜日選択付き "毎週繰り返し"<br>• 例: "毎週月曜日、水曜日、金曜日"<br>• セラピースケジュールに柔軟対応 |
| RES-RECUR-PATTERN-003 | MEDIUM | システムはカスタム間隔をサポートしなければならない | • "N日ごとに繰り返し"（例: 3日ごと）<br>• 最大30日間隔<br>• 不規則なスケジュール用 |
| RES-RECUR-PATTERN-004 | LOW | システムは予約詳細に繰り返しパターンを表示しなければならない | • バッジ: "🔁 毎日"、"🔁 月/水/金"<br>• 繰り返し予約を識別しやすく<br>• クリックでシリーズを表示 |

#### 3.5.2 繰り返し予約管理

| 要件ID | 優先度 | 要件 | 受入基準 |
|--------|----------|-------------|---------------------|
| RES-RECUR-MGMT-001 | HIGH | システムは単一発生と全発生の編集を許可しなければならない | • 編集ダイアログ: "この発生のみ編集" または "今後のすべての発生を編集"<br>• 変更は選択した範囲に伝播<br>• 過去の発生は影響を受けない |
| RES-RECUR-MGMT-002 | HIGH | システムは単一発生と全発生のキャンセルを許可しなければならない | • キャンセルダイアログ: 編集と同じオプション<br>• "この発生をキャンセル" で1つのインスタンスを削除<br>• "すべてキャンセル" でシリーズ全体を削除 |
| RES-RECUR-MGMT-003 | MEDIUM | システムは祝日/施設閉鎖日を検出してスキップしなければならない | • 管理者が祝日カレンダーを設定<br>• 繰り返し予約はこれらの日を自動スキップ<br>• 要求者に通知 |
| RES-RECUR-MGMT-004 | MEDIUM | システムは繰り返し予約シリーズを3ヶ月に制限しなければならない | • 最大90日先まで<br>• 過度な長期予約を防止<br>• 2ヶ月後にシリーズ延長可能 |

---

### 3.6 競合検出と解決

#### 3.6.1 競合検出

| 要件ID | 優先度 | 要件 | 受入基準 |
|--------|----------|-------------|---------------------|
| RES-CONFLICT-DETECT-001 | HIGH | システムはタイムスロット競合を検出しなければならない | • 競合: 同じ15分スロットに >5予約<br>• 作成時に警告表示: "タイムスロットがほぼ満杯"<br>• 代替スロットを提案 |
| RES-CONFLICT-DETECT-002 | HIGH | システムはウェイポイント競合を検出しなければならない（同じピックアップ/目的地が同時） | • 5分以内に同じウェイポイントが複数予約で要求された場合に警告<br>• ピックアップ遅延の可能性<br>• ブロックはしない、警告のみ |
| RES-CONFLICT-DETECT-003 | MEDIUM | システムは車両容量競合を検出しなければならない | • フリートにN台の車両がある場合、同時予約をN台に制限<br>• N-1予約で警告<br>• N予約でブロック（救急を除く） |

#### 3.6.2 競合解決

| 要件ID | 優先度 | 要件 | 受入基準 |
|--------|----------|-------------|---------------------|
| RES-CONFLICT-RESOLVE-001 | HIGH | システムは救急予約を優先しなければならない | • 救急予約は常に受け入れ（競合があっても）<br>• 低優先度の予約を遅延させる可能性<br>• 遅延した予約の要求者に通知 |
| RES-CONFLICT-RESOLVE-002 | MEDIUM | システムは競合に対して代替タイムスロットを提案しなければならない | • "要求時間 10:00 は満杯。代替: 10:15、10:30、10:45"<br>• 最大5つの提案<br>• ワンクリックで再予約 |
| RES-CONFLICT-RESOLVE-003 | MEDIUM | システムは管理者が容量制限を上書きできるようにしなければならない | • 管理者は制限を超えて予約を強制追加可能<br>• 正当化メモが必要<br>• 監査証跡にログ記録 |

---

### 3.7 予約キュー管理

#### 3.7.1 キュー優先順位付け

| 要件ID | 優先度 | 要件 | 受入基準 |
|--------|----------|-------------|---------------------|
| RES-QUEUE-PRIORITY-001 | CRITICAL | システムは優先度と時間で順序付けされた優先キューを維持しなければならない | • 順序: 救急 > 緊急 > 通常 > スケジュール時間<br>• 同じ優先度内: FIFO（先入れ先出し）<br>• キューはリアルタイムで更新 |
| RES-QUEUE-PRIORITY-002 | HIGH | システムは要求者にキュー位置を表示しなければならない | • "あなたの予約はキューで #3 です"<br>• キュー変更時に更新<br>• 推定待ち時間を表示 |
| RES-QUEUE-PRIORITY-003 | HIGH | システムは管理者がキューを手動で並べ替えできるようにしなければならない | • ドラッグ&ドロップインターフェース<br>• 管理者ロールが必要<br>• 理由付きで監査証跡にログ記録 |

#### 3.7.2 キューステータス更新

| 要件ID | 優先度 | 要件 | 受入基準 |
|--------|----------|-------------|---------------------|
| RES-QUEUE-STATUS-001 | HIGH | システムは予約ステータスをリアルタイムで更新しなければならない | • 状態: pending、queued、dispatched、in_progress、completed、cancelled<br>• ステータスバッジは色分け<br>• 各状態遷移のタイムスタンプ |
| RES-QUEUE-STATUS-002 | MEDIUM | システムはステータス更新通知を送信しなければならない | • ステータスが "dispatched" に変わったときに通知<br>• 完了時に通知<br>• アプリ内 + メール（設定されている場合） |
| RES-QUEUE-STATUS-003 | MEDIUM | システムは推定配車時間を提供しなければならない | • "推定配車: 午前 10:05（3分後）"<br>• キュー位置と車両可用性に基づく<br>• 動的に更新 |

---

### 3.8 通知システム

#### 3.8.1 確認通知

| 要件ID | 優先度 | 要件 | 受入基準 |
|--------|----------|-------------|---------------------|
| RES-NOTIF-CONFIRM-001 | HIGH | システムは予約作成時に確認通知を送信しなければならない | • アプリ内通知（デスクトップポップアップ）<br>• メール通知（ユーザーが有効化している場合）<br>• 予約ID、時間、ウェイポイントを含む |
| RES-NOTIF-CONFIRM-002 | MEDIUM | システムは確認にキャンセルリンクを含めなければならない | • リンク形式: https://.../reservations/{id}/cancel?token=...<br>• ワンクリックキャンセル（確認付き）<br>• トークンは予約時間後に期限切れ |

#### 3.8.2 リマインダー通知

| 要件ID | 優先度 | 要件 | 受入基準 |
|--------|----------|-------------|---------------------|
| RES-NOTIF-REMIND-001 | MEDIUM | システムはスケジュール時間の10分前にリマインダー通知を送信しなければならない | • 設定可能なリマインダー時間（デフォルト10分）<br>• 通知: "リマインダー: あなたの予約 RES-... は10分後に始まります"<br>• ユーザーは設定でリマインダーを無効化可能 |
| RES-NOTIF-REMIND-002 | LOW | システムは乗客にリマインダーを送信しなければならない（連絡先情報が利用可能な場合） | • SMS または電話リマインダー（施設にシステムがある場合）<br>• "あなたの車椅子輸送は午前 10:00 に到着します"<br>• オプション機能 |

#### 3.8.3 ステータス変更通知

| 要件ID | 優先度 | 要件 | 受入基準 |
|--------|----------|-------------|---------------------|
| RES-NOTIF-STATUS-001 | HIGH | システムは車両が配車されたときに要求者に通知しなければならない | • 通知: "RES-... の車両が配車されました"<br>• 車両IDと推定到着時刻を含む<br>• 配車後5秒以内に送信 |
| RES-NOTIF-STATUS-002 | HIGH | システムはミッションが完了したときに要求者に通知しなければならない | • 通知: "予約 RES-... が正常に完了しました"<br>• 完了のタイムスタンプ<br>• フィードバック提供オプション |
| RES-NOTIF-STATUS-003 | CRITICAL | システムはミッションが失敗したときに要求者に通知しなければならない | • 通知: "予約 RES-... が失敗しました。理由: {error}"<br>• 再予約のオファー<br>• 管理者へのエスカレーション |

---

### 3.9 予約履歴とレポート

#### 3.9.1 予約履歴

| 要件ID | 優先度 | 要件 | 受入基準 |
|--------|----------|-------------|---------------------|
| RES-HISTORY-001 | MEDIUM | システムは完全な予約履歴を維持しなければならない | • すべての予約を保存（最低1年）<br>• フィールド: created_at、scheduled_time、actual_start、actual_end、status、requester、vehicle_id<br>• 検索とフィルタリング可能 |
| RES-HISTORY-002 | MEDIUM | システムは要求者が自分の予約履歴を閲覧できるようにしなければならない | • "自分の予約" ページ<br>• フィルター: 日付範囲、ステータス、優先度<br>• CSVにエクスポート |
| RES-HISTORY-003 | MEDIUM | システムは管理者がすべての予約履歴を閲覧できるようにしなければならない | • すべての予約へのフルアクセス<br>• 高度なフィルター: 要求者、ウェイポイント、車両<br>• 監査証跡が閲覧可能 |

#### 3.9.2 予約分析

| 要件ID | 優先度 | 要件 | 受入基準 |
|--------|----------|-------------|---------------------|
| RES-ANALYTICS-001 | MEDIUM | システムは予約使用レポートを生成しなければならない | • 日次/週次/月次の予約数<br>• タイプ別内訳（歩行支援 vs 薬剤配送）<br>• 優先度別内訳 |
| RES-ANALYTICS-002 | MEDIUM | システムは平均リードタイム（予約時間からスケジュール時間）を計算しなければならない | • メトリック: "平均リードタイム: 2時間15分"<br>• 車両容量計画に役立つ<br>• 傾向分析（改善/悪化） |
| RES-ANALYTICS-003 | LOW | システムはピーク予約時間を特定しなければならない | • ヒートマップ: 曜日 × 時間帯<br>• 車両配備の最適化に役立つ<br>• 例: "ピーク: 月-金 10:00-11:00" |
| RES-ANALYTICS-004 | LOW | システムはキャンセル率を計算しなければならない | • キャンセル率 %（キャンセル / 合計）<br>• 要求者別内訳<br>• 問題パターンを特定 |

---

## 4. 非機能要件

### 4.1 性能

| 要件ID | 優先度 | 要件 | 受入基準 |
|--------|----------|-------------|---------------------|
| RES-PERF-001 | HIGH | システムは2秒以内に予約を作成しなければならない | • フォーム送信から確認まで<br>• 検証とデータベース挿入を含む<br>• 95パーセンタイル <2秒 |
| RES-PERF-002 | MEDIUM | システムは予約変更後1秒以内にキュー位置を更新しなければならない | • WebSocket経由のリアルタイム更新<br>• フルページリロードなし<br>• スムーズなUI更新 |

### 4.2 使いやすさ

| 要件ID | 優先度 | 要件 | 受入基準 |
|--------|----------|-------------|---------------------|
| RES-UX-001 | HIGH | 予約フォームは60秒未満で完了可能でなければならない | • ユーザビリティテストで測定<br>• 最小限の必須フィールド<br>• オートコンプリートと提案 |
| RES-UX-002 | MEDIUM | システムは各フォームフィールドにコンテキストヘルプを提供しなければならない | • ホバー/タップ時のツールチップ<br>• 例: "ピックアップ: 乗客が現在いる場所"<br>• 日本語と英語 |

### 4.3 信頼性

| 要件ID | 優先度 | 要件 | 受入基準 |
|--------|----------|-------------|---------------------|
| RES-REL-001 | HIGH | システムは同じ予約の二重予約を防止しなければならない | • データベース制約: 一意の予約ID<br>• トランザクション分離レベル: SERIALIZABLE<br>• 競合時の再試行ロジック |
| RES-REL-002 | HIGH | システムはシステム再起動時に予約キューを永続化しなければならない | • キューはデータベースに保存（メモリのみではない）<br>• 起動時に復元<br>• 予約を失わない |

---

## 5. インターフェース要件

### 5.1 APIエンドポイント

| エンドポイント | メソッド | 目的 |
|----------|--------|---------|
| /api/v1/reservations | POST | 予約作成 |
| /api/v1/reservations/{id} | GET | 予約詳細取得 |
| /api/v1/reservations/{id} | PUT | 予約更新 |
| /api/v1/reservations/{id} | DELETE | 予約キャンセル |
| /api/v1/reservations | GET | 予約リスト（フィルター付き） |
| /api/v1/reservations/{id}/recurrence | POST | 繰り返し予約作成 |
| /api/v1/reservations/queue | GET | 現在のキューステータス取得 |

### 5.2 データベーススキーマ

**テーブル: reservations**
- id (UUID、主キー)
- reservation_id (VARCHAR、一意、例: RES-20251216-0042)
- type (ENUM: walking_assistance、medicine_delivery)
- requester_id (外部キー → users)
- passenger_name (VARCHAR) OR item_description (VARCHAR)
- pickup_waypoint_id (外部キー → waypoints)
- destination_waypoint_id (外部キー → waypoints)
- scheduled_time (TIMESTAMP)
- priority (ENUM: routine、urgent、emergency)
- status (ENUM: pending、queued、dispatched、in_progress、completed、cancelled)
- vehicle_id (外部キー → vehicles、nullable)
- created_at、updated_at (TIMESTAMP)
- notes (TEXT、nullable)
- recurrence_pattern_id (外部キー、nullable)

**テーブル: reservation_recurrence_patterns**
- id (UUID、主キー)
- type (ENUM: daily、weekly、custom)
- interval_days (INT) - customの場合
- weekdays (JSON) - 月/水/金の場合 [1,3,5]
- end_date (DATE) OR occurrence_count (INT)
- created_at (TIMESTAMP)

**テーブル: reservation_status_history**
- id (UUID、主キー)
- reservation_id (外部キー)
- status (ENUM)
- timestamp (TIMESTAMP)
- notes (TEXT、nullable)

---

## 6. テスト要件

| テストタイプ | カバレッジ | 受入 |
|-----------|----------|------------|
| ユニットテスト | ≥80% コードカバレッジ | 予約作成、検証、キューロジック |
| 統合テスト | APIエンドポイント、データベース操作 | すべてのCRUD操作をテスト |
| UIテスト | 予約フォーム、キュー表示、通知 | 主要ワークフローを自動化（Cypress） |
| 負荷テスト | 100件の同時予約作成 | エラーなし、応答時間 <2秒 |
| 競合テスト | 複数ユーザーが同じスロットを予約 | 正しい競合検出と解決 |

---

## 7. トレーサビリティマトリクス

| 要件カテゴリ | 要件数 | 優先度分布 |
|---------------------|-------------------|----------------------|
| 予約作成 | 17 | CRITICAL: 5、HIGH: 7、MEDIUM: 5 |
| 予約スケジューリング | 8 | CRITICAL: 1、HIGH: 5、MEDIUM: 2 |
| 予約変更 | 6 | HIGH: 3、MEDIUM: 3 |
| 予約キャンセル | 5 | CRITICAL: 1、HIGH: 2、MEDIUM: 2 |
| 繰り返し予約 | 8 | MEDIUM: 6、LOW: 2 |
| 競合検出/解決 | 6 | HIGH: 4、MEDIUM: 2 |
| キュー管理 | 6 | CRITICAL: 1、HIGH: 4、MEDIUM: 1 |
| 通知システム | 8 | CRITICAL: 1、HIGH: 4、MEDIUM: 2、LOW: 1 |
| 履歴とレポート | 7 | MEDIUM: 5、LOW: 2 |
| 非機能 | 6 | HIGH: 4、MEDIUM: 2 |
| **合計** | **77** | **CRITICAL: 9、HIGH: 33、MEDIUM: 30、LOW: 5** |

---

## 8. 前提条件と依存関係

### 8.1 前提条件

1. 施設に定義されたウェイポイント（部屋番号、共用エリア）がある
2. 名前と連絡先情報を含む入居者データベースが利用可能
3. スタッフが予約システムの使用方法についてトレーニングを受けている
4. 運用時間が設定されている（例: 8:00-20:00）

### 8.2 依存関係

1. FLEET_MANAGEMENT_REQUIREMENTS.md（親システム）
2. TVM_SERVER_REQUIREMENTS.md（バックエンドAPI実装）
3. USER_ROLE_MANAGEMENT_REQUIREMENTS.md（ユーザー認証とロール）
4. 車両配車システムが運用中

---

## 9. 未解決課題とリスク

### 9.1 未解決課題

| ID | 課題 | 所有者 | 目標解決 |
|----|-------|-------|-------------------|
| RES-ISSUE-001 | 繰り返し予約の祝日カレンダーデータソース | Unno | 第4週 |
| RES-ISSUE-002 | 通知配信方法（メール vs SMS） | 施設IT | 第4週 |

### 9.2 リスク

| リスク | 確率 | 影響 | 軽減策 |
|------|------------|--------|------------|
| 同時リクエストによるオーバーブッキング | MEDIUM | HIGH | データベースレベルのロック、トランザクション分離 |
| ユーザーが複数予約でキューをバイパス | LOW | MEDIUM | 制限: ユーザーあたり最大3件の保留予約 |
| 救急優先度の誤用 | LOW | MEDIUM | 監査証跡、管理者レビュー、使用レポート |

---

## 10. 改訂履歴

| バージョン | 日付 | 作成者 | 変更内容 |
|---------|------|--------|---------|
| 1.0 | 2025-12-16 | Unno | 初版ドラフト - 第3週文書化 |

---

**文書終了**

**要件合計:** 77件
**文書ステータス:** レビュー用ドラフト
**次回レビュー:** 第4週（キュー管理と配車との統合）

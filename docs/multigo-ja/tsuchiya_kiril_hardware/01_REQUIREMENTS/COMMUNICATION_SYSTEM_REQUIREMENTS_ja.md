# 通信システム要件

**プロジェクト:** 屋外車椅子輸送ロボット - マルチチームシステム
**ドキュメントタイプ:** ハードウェア要件仕様
**チーム責任:** Tsuchiya（ハードウェア）+ Pankaj（車両ソフトウェア統合）
**ステータス:** 第4週 - アクティブ開発
**日付:** 2025年12月16日
**バージョン:** 1.0

---

## ドキュメント管理

| バージョン | 日付 | 作成者 | 変更内容 |
|---------|------|--------|---------|
| 1.0 | 2025-12-16 | マルチチーム | 初版通信システム要件 |

**関連ドキュメント:**
- ELECTRICAL_REQUIREMENTS.md（通信モジュールの電源供給）
- TVM_API_SPECIFICATION.md（フリート通信プロトコル）
- HARDWARE_SOFTWARE_INTERFACES.md（ROS 2トピックマッピング）
- INTERFACE_REQUIREMENTS.md（車両レベルプロトコル）

---

## 1. 目的と範囲

本ドキュメントは、屋外車椅子輸送ロボットのすべての通信サブシステムの要件を規定します：
- **CANバス**（モーターコントローラー、BMS）
- **UART**（eHMI ESP32、センサー）
- **ROS 2 DDS**（内部ソフトウェア通信）
- **WiFi 802.11ac**（TVMフリート管理、更新）
- **4G LTE**（リモートテレオペレーション、バックアップ接続）

**設計原則:**
- 多層冗長性（WiFiプライマリ、4Gバックアップ）
- 安全クリティカルデータのリアルタイム確定的通信（CAN、UART）
- フリート管理用の安全な暗号化チャネル（TLS 1.3）
- リンク障害時のグレースフル劣化

---

## 2. CANバス通信要件

### 2.1 CANバスアーキテクチャ

| ID | 要件 | 優先度 | 受入基準 |
|----|-------------|----------|---------------------|
| COMM-CAN-001 | システムは2つのCANバスを実装する必要がある: CAN0（モーター）500 kbit/s、CAN1（BMS/センサー）250 kbit/s | クリティカル | オシロスコープでバス速度を検証 |
| COMM-CAN-002 | CAN0は8つのモーターコントローラー（ドライブ4 + ステア4）を10msサイクルタイムで接続する必要がある | クリティカル | すべての8コントローラーが10ms以内に応答 |
| COMM-CAN-003 | CAN1はBMS、IMU、補助センサーを100msサイクルタイムで接続する必要がある | 高 | センサーデータが≥10Hzで受信される |
| COMM-CAN-004 | システムはモーターコントローラーにCAN-FD（フレキシブルデータレート）を使用する必要がある | 高 | データペイロード>8バイトがサポートされる |
| COMM-CAN-005 | システムはCANバス終端（両端に120Ω抵抗）を実装する必要がある | クリティカル | バス信号品質を検証 |
| COMM-CAN-006 | システムはCANバスエラーを監視し診断にログする必要がある | 高 | エラーフレームがタイムスタンプとともにログされる |
| COMM-CAN-007 | システムはCANデバイスのホットプラグ検出をサポートする必要がある | 中 | デバイス接続/切断が<1秒で検出される |

**成功基準:** 100時間耐久テストでCANバスエラーゼロ

### 2.2 CANメッセージ定義

| ID | 要件 | 優先度 | 受入基準 |
|----|-------------|----------|---------------------|
| COMM-CAN-MSG-001 | モーターコマンドメッセージには以下を含める必要がある: motor_id、target_velocity、target_angle、torque_limit | クリティカル | メッセージフォーマットが検証される |
| COMM-CAN-MSG-002 | モーターステータスメッセージには以下を含める必要がある: motor_id、current_velocity、current_angle、current_draw、temperature、faults | クリティカル | すべてのフィールドが正しくデコードされる |
| COMM-CAN-MSG-003 | BMSステータスメッセージには以下を含める必要がある: voltage、current、SOC、SOH、cell_temps、faults | クリティカル | BMSデータが仕様と一致 |
| COMM-CAN-MSG-004 | 緊急停止メッセージはCAN ID 0x001（最高優先度）でブロードキャストする必要がある | クリティカル | 緊急停止が<10msで伝播 |
| COMM-CAN-MSG-005 | システムは将来の拡張性のために拡張CAN ID（29ビット）を使用する必要がある | 中 | 拡張IDフォーマットがサポートされる |

**成功基準:** 安全クリティカルメッセージの100%配信率

### 2.3 CANバスエラー処理

| ID | 要件 | 優先度 | 受入基準 |
|----|-------------|----------|---------------------|
| COMM-CAN-ERR-001 | システムはCANバスオフ状態を検出し自動回復を試みる必要がある | クリティカル | 1秒以内に回復を試行 |
| COMM-CAN-ERR-002 | 持続的なCAN障害時（5秒間>10エラー/秒）、システムはセーフモードに入る必要がある | クリティカル | 5秒以内にセーフモードを開始 |
| COMM-CAN-ERR-003 | システムはすべてのCANエラーフレームをタイムスタンプとエラータイプとともにログする必要がある | 高 | エラーログにフレームダンプが含まれる |
| COMM-CAN-ERR-004 | システムはCANバスステータスの診断LEDインジケーターを提供する必要がある（緑=OK、赤=エラー） | 中 | LEDステータスがバス状態と一致 |

---

## 3. UART通信要件

### 3.1 UART構成

| ID | 要件 | 優先度 | 受入基準 |
|----|-------------|----------|---------------------|
| COMM-UART-001 | システムは115200ボー、8N1（8データビット、パリティなし、1ストップビット）でUARTを実装する必要がある | クリティカル | UART構成を検証 |
| COMM-UART-002 | eHMI ESP32は115200ボーでUART0を介してJetsonと通信する必要がある | クリティカル | 双方向通信を検証 |
| COMM-UART-003 | システムはGPS（将来）、外部センサー用の追加UARTポートをサポートする必要がある | 中 | UART1/2が構成可能 |
| COMM-UART-004 | UARTメッセージはチェックサム検証（CRC-16）を使用する必要がある | 高 | 無効なチェックサムが拒否される |
| COMM-UART-005 | システムはUART接続にフロー制御（RTS/CTS）を実装する必要がある | 中 | 高負荷下でのデータ損失なし |

**成功基準:** 100万UARTメッセージ交換でデータ破損ゼロ

### 3.2 UARTメッセージプロトコル（eHMI）

| ID | 要件 | 優先度 | 受入基準 |
|----|-------------|----------|---------------------|
| COMM-UART-EHMI-001 | eHMIコマンドメッセージには以下を含める必要がある: command_type、led_pattern、buzzer_tone、display_text | クリティカル | コマンドが正しく実行される |
| COMM-UART-EHMI-002 | eHMIステータスメッセージには以下を含める必要がある: button_state、emergency_stop_pressed、battery_display | クリティカル | ステータス更新が10Hzで受信される |
| COMM-UART-EHMI-003 | 緊急停止ボタン押下は即座にメッセージを送信する必要がある（10ms以内） | クリティカル | 緊急停止レイテンシ<10ms |
| COMM-UART-EHMI-004 | システムはUARTブートローダーを介したESP32のファームウェア更新をサポートする必要がある | 中 | ファームウェア更新が成功 |

---

## 4. ROS 2 DDS通信要件

### 4.1 ROS 2構成

| ID | 要件 | 優先度 | 受入基準 |
|----|-------------|----------|---------------------|
| COMM-ROS2-001 | システムはデフォルトミドルウェアとしてCyclone DDSを使用したROS 2 Humbleを使用する必要がある | クリティカル | ROS 2ノードが確実に通信 |
| COMM-ROS2-002 | システムはDDS QoSプロファイルを構成する必要がある: コマンドにRELIABLE、センサーデータにBEST_EFFORT | クリティカル | QoSプロファイルが正しく適用される |
| COMM-ROS2-003 | システムは他のロボットから分離するためにROS 2ドメインID 42を使用する必要がある | 高 | 他システムとのクロストークなし |
| COMM-ROS2-004 | システムはDDS発見トラフィックをローカルサブネットに制限する必要がある（TTL=1） | 中 | 発見パケットがサブネットを離れない |
| COMM-ROS2-005 | システムは低レイテンシクリティカルパス（ドッキング、安全）にFastDDSを使用する必要がある | 高 | クリティカルトピックでDDSレイテンシ<5ms |

**成功基準:** RELIABLEトピックで99.99%メッセージ配信

### 4.2 ROS 2トピック設計

| ID | 要件 | 優先度 | 受入基準 |
|----|-------------|----------|---------------------|
| COMM-ROS2-TOPIC-001 | 安全クリティカルトピックは履歴深度≥10のRELIABLE QoSを使用する必要がある | クリティカル | 障害シナリオでのメッセージ損失なし |
| COMM-ROS2-TOPIC-002 | センサートピックは低レイテンシのためBEST_EFFORT QoSを使用する必要がある | 高 | センサーレイテンシ<20ms |
| COMM-ROS2-TOPIC-003 | コマンドトピックは遅延参加ノードのためにtransient_local耐久性を使用する必要がある | 中 | 遅延参加者が最後のコマンドを受信 |
| COMM-ROS2-TOPIC-004 | システムは1Hzで/diagnosticsトピックに診断を公開する必要がある | 高 | 診断がシステム全体で利用可能 |

---

## 5. WiFi通信要件

### 5.1 WiFiハードウェアと構成

| ID | 要件 | 優先度 | 受入基準 |
|----|-------------|----------|---------------------|
| COMM-WIFI-001 | システムはWiFi 802.11ac（5GHz）デュアルバンドアダプターを使用する必要がある | クリティカル | 5GHz接続を検証 |
| COMM-WIFI-002 | WiFiアダプターは866 Mbps最大スループットのために2×2 MIMOをサポートする必要がある | 高 | スループット≥400 Mbps達成 |
| COMM-WIFI-003 | システムはWiFi経由でTVMフリート管理サーバーに接続する必要がある（プライマリリンク） | クリティカル | TVM接続が<10秒で確立 |
| COMM-WIFI-004 | システムはWiFi切断時に指数バックオフで自動再接続する必要がある | クリティカル | 30秒以内に再接続 |
| COMM-WIFI-005 | システムはアクセスポイント間をシームレスにローミングする必要がある（802.11r高速ローミング） | 高 | ローミングハンドオフ<100ms |
| COMM-WIFI-006 | 5GHzが利用できない場合、システムは2.4GHz帯にフォールバックする必要がある | 中 | バンドフォールバックが自動 |

**成功基準:** 運用エリアでWiFi稼働率>99%

### 5.2 WiFiセキュリティ

| ID | 要件 | 優先度 | 受入基準 |
|----|-------------|----------|---------------------|
| COMM-WIFI-SEC-001 | WiFi接続は802.1X認証でWPA3-Enterpriseを使用する必要がある | クリティカル | WPA3暗号化を検証 |
| COMM-WIFI-SEC-002 | データ送信前にシステムはTVMサーバー証明書（TLS 1.3）を検証する必要がある | クリティカル | 無効な証明書が拒否される |
| COMM-WIFI-SEC-003 | システムはすべてのTVM通信をAES-256で暗号化する必要がある | クリティカル | パケットスニッフィングで暗号化を確認 |
| COMM-WIFI-SEC-004 | システムは車両ごとに個別のWiFi認証情報を使用する必要がある（共有パスワードなし） | 高 | 各車両が一意の認証情報を持つ |

### 5.3 WiFiデータ伝送

| ID | 要件 | 優先度 | 受入基準 |
|----|-------------|----------|---------------------|
| COMM-WIFI-DATA-001 | システムは5秒ごとにTVMサーバーにテレメトリーを送信する必要がある（位置、バッテリー、ステータス） | クリティカル | テレメトリーが0.2Hzで受信される |
| COMM-WIFI-DATA-002 | システムは60秒ごとにTVMサーバーにログを送信する必要がある（圧縮） | 中 | ログが正常にアップロードされる |
| COMM-WIFI-DATA-003 | システムはTVMサーバーからミッション更新を受信する必要がある（ゴール、予約） | クリティカル | ミッション更新が<1秒で処理される |
| COMM-WIFI-DATA-004 | システムはWiFi経由でリモート診断アクセスをサポートする必要がある（VPN経由SSH） | 中 | SSH接続が成功 |
| COMM-WIFI-DATA-005 | 輻輳を防ぐため、システムはWiFi帯域幅使用を平均10 Mbpsに制限する必要がある | 中 | 帯域幅キャップが強制される |

---

## 6. 4G LTE通信要件

### 6.1 LTEハードウェアと構成

| ID | 要件 | 優先度 | 受入基準 |
|----|-------------|----------|---------------------|
| COMM-LTE-001 | システムは4G LTEモデム（Cat 4、150 Mbpsダウン/50 Mbpsアップ）を含める必要がある | 高 | LTEモデムがシステムで検出される |
| COMM-LTE-002 | LTEモデムはマルチキャリアSIM（自動キャリア選択）をサポートする必要がある | 高 | SIMが利用可能なネットワークに接続 |
| COMM-LTE-003 | WiFi利用不可時、システムはLTEをバックアップリンクとして使用する必要がある | クリティカル | LTEへの自動フェイルオーバー<30秒 |
| COMM-LTE-004 | 利用可能時、システムはWiFiに再接続する必要がある（LTEよりWiFi優先） | 高 | WiFiへのフェイルバック60秒以内 |
| COMM-LTE-005 | システムはLTE信号強度（RSSI）を監視し、LTE <-100 dBmの場合WiFiに切り替える必要がある | 中 | 信号監視が機能的 |

**成功基準:** WiFi停止シナリオの100%でLTEフェイルオーバー成功

### 6.2 LTEデータ管理

| ID | 要件 | 優先度 | 受入基準 |
|----|-------------|----------|---------------------|
| COMM-LTE-DATA-001 | システムはLTEデータ使用を月1 GBに制限する必要がある（過度な料金を回避） | 高 | データ使用が追跡され上限設定される |
| COMM-LTE-DATA-002 | システムはLTE経由でクリティカルなテレメトリーのみを送信する必要がある（位置、緊急警告） | クリティカル | LTE上で非クリティカルデータが抑制される |
| COMM-LTE-DATA-003 | システムはLTE経由でリモート緊急停止をサポートする必要がある | クリティカル | 緊急停止コマンドが<2秒で受信される |
| COMM-LTE-DATA-004 | システムはLTE経由でリモートテレオペレーションをサポートする必要がある（低解像度ビデオ、1 fps） | 中 | LTE経由でテレオペレーションが機能的 |

### 6.3 LTEセキュリティ

| ID | 要件 | 優先度 | 受入基準 |
|----|-------------|----------|---------------------|
| COMM-LTE-SEC-001 | LTE接続はTVMサーバーへのVPNトンネル（WireGuard）を使用する必要がある | クリティカル | VPN暗号化を検証 |
| COMM-LTE-SEC-002 | LTE VPN確立前にシステムはTVMサーバーを認証する必要がある | クリティカル | 無効なサーバーが拒否される |
| COMM-LTE-SEC-003 | 不正なSIM使用を防ぐため、システムはSIM PINロックを使用する必要がある | 中 | PINロックが有効 |

---

## 7. ネットワークフェイルオーバーと冗長性

| ID | 要件 | 優先度 | 受入基準 |
|----|-------------|----------|---------------------|
| COMM-FAILOVER-001 | システムは10秒以内にWiFiリンク障害を自動検出する必要がある | クリティカル | 障害検出時間<10秒 |
| COMM-FAILOVER-002 | WiFi障害から30秒以内にシステムはWiFiからLTEに切り替える必要がある | クリティカル | フェイルオーバー時間<30秒 |
| COMM-FAILOVER-003 | ネットワーク停止中、システムはテレメトリーデータをバッファする必要がある（最大1時間） | 高 | バッファが720テレメトリーパケットを保持 |
| COMM-FAILOVER-004 | 接続回復時、システムはバッファされたデータをアップロードする必要がある | 高 | すべてのバッファされたデータがアップロードされる |
| COMM-FAILOVER-005 | ネットワーク停止中、システムは自律的に動作する必要がある（キャッシュされたマップ、ゴールを使用） | クリティカル | 車両がオフラインでミッションを完了 |
| COMM-FAILOVER-006 | システムはステータスフラグを介してTVMサーバーに接続問題を通知する必要がある | 中 | 接続ステータスが報告される |

**成功基準:** 一時的なネットワーク停止によるミッション失敗ゼロ

---

## 8. 車両間通信（V2V） - 将来

| ID | 要件 | 優先度 | 受入基準 |
|----|-------------|----------|---------------------|
| COMM-V2V-001 | システムは将来のV2V通信（802.11pまたはC-V2X）のためのハードウェアインターフェースを予約する必要がある | 低 | ハードウェアサポートが利用可能 |
| COMM-V2V-002 | システムは近くの車両への位置/速度のブロードキャストをサポートする必要がある（衝突回避） | 低 | V2Vメッセージが送信される |
| COMM-V2V-003 | V2V通信はDSRC 5.9 GHz帯を使用する必要がある（専用短距離） | 低 | DSRC周波数が構成される |

---

## 9. 通信性能要件

| ID | 要件 | 優先度 | 受入基準 |
|----|-------------|----------|---------------------|
| COMM-PERF-001 | モーターコマンドのCANバスレイテンシは<10msである必要がある | クリティカル | オシロスコープ測定<10ms |
| COMM-PERF-002 | eHMI緊急停止のUARTレイテンシは<10msである必要がある | クリティカル | 緊急停止レイテンシ<10ms |
| COMM-PERF-003 | センサーデータトピックのROS 2 DDSレイテンシは<20msである必要がある | 高 | DDSレイテンシが<20msで測定される |
| COMM-PERF-004 | TVMサーバーへのWiFi往復時間は<100msである必要がある | 高 | Ping RTT <100ms |
| COMM-PERF-005 | TVMサーバーへのLTE往復時間は<500msである必要がある | 中 | Ping RTT <500ms |
| COMM-PERF-006 | Jetson Orin NanoでのTotal通信スタックCPU使用率は<10%である必要がある | 中 | CPUプロファイリングで<10%を示す |

---

## 10. 通信診断と監視

| ID | 要件 | 優先度 | 受入基準 |
|----|-------------|----------|---------------------|
| COMM-DIAG-001 | システムはROS 2 /diagnosticsトピックに通信診断を公開する必要がある | 高 | 診断が利用可能 |
| COMM-DIAG-002 | 診断には以下を含める必要がある: CANエラー数、UARTエラー数、WiFi信号強度、LTE信号強度、パケットロス | 高 | すべてのメトリクスが報告される |
| COMM-DIAG-003 | システムは通信エラーを永続ストレージにログする必要がある | 中 | エラーログが保存される |
| COMM-DIAG-004 | システムはLEDインジケーターを提供する必要がある: WiFiステータス（青）、LTEステータス（緑）、エラー（赤） | 低 | LEDが通信ステータスと一致 |

---

## 11. 通信安全要件

| ID | 要件 | 優先度 | 受入基準 |
|----|-------------|----------|---------------------|
| COMM-SAFE-001 | 全通信障害時（WiFi + LTE停止）、システムは安全に動作する必要がある | クリティカル | 車両が安全に停止 |
| COMM-SAFE-002 | システムは受信したすべてのコマンドをチェックサム/CRCで検証する必要がある | クリティカル | 破損したコマンドが拒否される |
| COMM-SAFE-003 | システムは古いコマンドをタイムアウトする必要がある（例: >100ms古いモーターコマンド） | クリティカル | 古いコマンドが無視される |
| COMM-SAFE-004 | システムは通信スタックのウォッチドッグタイマーを実装する必要がある（ハング時にリセット） | 高 | ハング時にウォッチドッグがトリガー |

---

## 12. 通信テスト要件

| ID | 要件 | 優先度 | 受入基準 |
|----|-------------|----------|---------------------|
| COMM-TEST-001 | 負荷下ですべての8モーターコントローラーとのCANバス通信をテスト | クリティカル | 100%メッセージ配信 |
| COMM-TEST-002 | 100万メッセージ交換でUART通信をテスト（エラーなし） | クリティカル | 100万メッセージでゼロエラー |
| COMM-TEST-003 | <30秒でのWiFiからLTEへのフェイルオーバーをテスト | クリティカル | フェイルオーバー時間を検証 |
| COMM-TEST-004 | ネットワーク停止耐性をテスト（1時間オフライン動作） | 高 | 車両がオフラインで動作 |
| COMM-TEST-005 | EMI条件下で通信スタックをテスト（高電圧線の近く） | 中 | EMI下でエラーなし |

---

## 13. 要件サマリー

| カテゴリ | 数 | 優先度内訳 |
|----------|-------|-------------------|
| CANバス通信 | 12 | クリティカル: 8、高: 3、中: 1 |
| UART通信 | 9 | クリティカル: 6、高: 1、中: 2 |
| ROS 2 DDS通信 | 8 | クリティカル: 4、高: 3、中: 1 |
| WiFi通信 | 15 | クリティカル: 10、高: 3、中: 2 |
| 4G LTE通信 | 11 | クリティカル: 6、高: 4、中: 1 |
| ネットワークフェイルオーバー | 6 | クリティカル: 4、高: 2、中: 0 |
| V2V通信（将来） | 3 | 低: 3 |
| 性能 | 6 | クリティカル: 2、高: 3、中: 1 |
| 診断 | 4 | 高: 2、中: 1、低: 1 |
| 安全 | 4 | クリティカル: 3、高: 1 |
| テスト | 5 | クリティカル: 3、高: 1、中: 1 |
| **合計** | **83** | **クリティカル: 51、高: 23、中: 6、低: 3** |

---

## 14. トレーサビリティマトリクス

| 要件カテゴリ | 関連システムコンポーネント |
|---------------------|---------------------------|
| CANバス | スワーブドライブコントローラー、BMS、モーターコントローラー |
| UART | eHMI ESP32、将来のGPSモジュール |
| ROS 2 DDS | すべてのROS 2ノード（ナビゲーション、知覚、ドッキング、安全） |
| WiFi | TVMクライアント、フリート管理サーバー、リモート診断 |
| 4G LTE | TVMクライアント、リモートテレオペレーション、緊急接続 |

---

## 15. 改訂履歴

| バージョン | 日付 | 作成者 | 変更内容 |
|---------|------|--------|---------|
| 1.0 | 2025-12-16 | マルチチーム | 初版通信システム要件（83要件） |

---

**ドキュメント終了**

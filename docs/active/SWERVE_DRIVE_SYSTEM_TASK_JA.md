# スウェーブドライブシステム開発タスク

**プロジェクト:** 屋外優先・屋内互換性を持つ自律走行ロボット
**ハードウェアプラットフォーム:** スウェーブドライブシステム
**開発手法:** アジャイル開発
**ドキュメント作成日:** 2025年12月15日
**ステータス:** 計画・要件定義フェーズ

---

## 目次

1. [プロジェクト概要](#プロジェクト概要)
2. [ハードウェア仕様](#ハードウェア仕様)
3. [システム要件](#システム要件)
4. [ドキュメント構成](#ドキュメント構成)
5. [完全なシステムスコープ](#完全なシステムスコープ)
6. [技術スタック](#技術スタック)
7. [開発原則](#開発原則)

---

## プロジェクト概要

### 目的
**完全なエンドツーエンド自律走行ロボットシステム**の開発。スウェーブドライブ駆動方式を採用し、主に屋外での動作を想定しつつ、屋内での互換性も維持する。

### 主要機能
- ✅ 自律車椅子ドッキング(精度±2-5mm)
- ✅ 車椅子搬送(搭乗者あり、A→Bナビゲーション)
- ✅ 手動制御(ジョイスティック遠隔操作)
- ✅ 自律ナビゲーション(充電ステーション、シャトルサービス、巡回経路)
- ✅ 屋内/屋外動作、自動環境適応

### 開発手法
**アジャイル開発** - モジュール化された関心の分離アーキテクチャにより、並行サブシステム開発と段階的統合を実現。

---

## ハードウェア仕様

### 提案ハードウェア構成

**スウェーブドライブ研究(2025-12-10)** およびシステム要件に基づく:

| コンポーネント | 仕様 | 出典 |
|--------------|------|------|
| **駆動システム** | スウェーブドライブ(4独立モジュール) | 研究により確認 |
| **ホイール** | 6.5インチ(φ165mm)ホバーボードインホイールモーター | 研究仕様 |
| **駆動モーター** | 80W/ホイール、片持ち設計 | 研究計算値 |
| **操舵モーター** | デジタルサーボ(3.5Nm)または パワーウィンドウモーター(2.9Nm) | 研究オプション |
| **主要センサー** | LiDAR(360°、屋外対応グレード) | システム要件 |
| **ビジョン** | RGB カメラ×2(ArUco+物体検出) | システム要件 |
| **GPS** | RTK GPS(cm精度) | システム要件 |
| **IMU** | 9軸(傾き/姿勢) | システム要件 |
| **視覚マーカー** | ArUcoマーカー(ドッキング精度向上) | システム要件 |
| **ドッキングシステム** | ビジュアルサーボ+機械的結合 | システム要件 |
| **制御システム** | 組込みPC + GPU | システム要件 |
| **障害物センサー** | 近接センサー、崖検出 | システム要件 |
| **安全センサー** | 搭乗者検出、非常停止 | システム要件 |

### 設計パラメータ

| パラメータ | 仕様 | 出典 |
|-----------|------|------|
| **ロボット重量** | 60kg | スウェーブドライブ研究 |
| **搬送負荷** | 100kg(車椅子+搭乗者) | スウェーブドライブ研究 |
| **最大勾配** | 10°(17.6%勾配) | スウェーブドライブ研究 |
| **地上高** | 最小20mm | スウェーブドライブ研究 |
| **設計速度** | 1.0 m/s(3.6 km/h) | スウェーブドライブ研究 |
| **ドッキング精度** | ±2-5mm(屋外)、±1mm(屋内目標) | システム要件 |

---

## システム要件

### コア機能要件

1. **自律ドッキング**
   - ArUcoマーカーを使用した精密ビジュアルサーボ
   - 2段階アプローチ(粗ナビゲーション+精密位置合わせ)
   - 機械的結合機構
   - 成功率 >95%

2. **ROS 2 スウェーブドライブ統合**
   - スウェーブドライブ運動学用カスタムROS 2ノード
   - 4輪独立操舵の逆運動学
   - オドメトリ推定とセンサ融合
   - 経路計画のためのNav2統合

3. **ドッキング-駆動統合**
   - ナビゲーションモードとドッキングモード間のシームレス遷移
   - モード切替用ステートマシン(自由/ドッキング/結合)
   - サブシステム間の協調制御

4. **手動制御**
   - 安全オーバーライド付きジョイスティック遠隔操作
   - ティーチングモード(人間誘導ウェイポイント記録)
   - 非常停止統合

5. **自律動作**
   - **車椅子搬送:** 搭乗者あり、A→Bナビゲーション
   - **充電ステーションナビゲーション:** 低バッテリ時の自動帰還
   - **シャトルサービス:** スケジュール経路、マルチウェイポイント実行
   - **巡回経路:** セキュリティ、監視タスク
   - **配送タスク:** 機器/物品輸送

---

## ドキュメント構成

### 提案フォルダ構成

```
docs/active/outdoor_swerve_system/
├── 00_OVERVIEW/                          (概要)
│   ├── SYSTEM_OVERVIEW.md                (システム概要)
│   ├── GETTING_STARTED.md                (はじめに)
│   └── DOCUMENT_INDEX.md                 (ドキュメント索引)
│
├── 01_REQUIREMENTS/                      (要件)
│   ├── SYSTEM_REQUIREMENTS.md            (システム要件)
│   ├── HARDWARE_REQUIREMENTS.md          (ハードウェア要件)
│   ├── SOFTWARE_REQUIREMENTS.md          (ソフトウェア要件)
│   ├── SWERVE_DRIVE_REQUIREMENTS.md      (スウェーブドライブ要件)
│   ├── DOCKING_SYSTEM_REQUIREMENTS.md    (ドッキングシステム要件)
│   ├── NAVIGATION_REQUIREMENTS.md        (ナビゲーション要件)
│   ├── PERCEPTION_REQUIREMENTS.md        (知覚要件)
│   ├── SAFETY_REQUIREMENTS.md            (安全要件)
│   ├── PERFORMANCE_REQUIREMENTS.md       (性能要件)
│   ├── INTERFACE_REQUIREMENTS.md         (インターフェース要件)
│   └── REQUIREMENTS_TRACEABILITY_MATRIX.md (要件トレーサビリティマトリックス)
│
├── 02_ARCHITECTURE/                      (アーキテクチャ)
│   ├── OVERALL_SYSTEM_ARCHITECTURE.md    (全体システムアーキテクチャ)
│   ├── SWERVE_DRIVE_ARCHITECTURE.md      (スウェーブドライブアーキテクチャ)
│   ├── DOCKING_SUBSYSTEM_ARCHITECTURE.md (ドッキングサブシステムアーキテクチャ)
│   ├── NAVIGATION_SUBSYSTEM_ARCHITECTURE.md (ナビゲーションサブシステムアーキテクチャ)
│   ├── PERCEPTION_SUBSYSTEM_ARCHITECTURE.md (知覚サブシステムアーキテクチャ)
│   ├── CONTROL_SUBSYSTEM_ARCHITECTURE.md (制御サブシステムアーキテクチャ)
│   ├── SAFETY_SUBSYSTEM_ARCHITECTURE.md  (安全サブシステムアーキテクチャ)
│   └── INTEGRATION_ARCHITECTURE.md       (統合アーキテクチャ)
│
├── 03_DESIGN/                            (設計)
│   ├── SWERVE_DRIVE_DETAILED_DESIGN.md   (スウェーブドライブ詳細設計)
│   ├── DOCKING_MECHANISM_DESIGN.md       (ドッキング機構設計)
│   ├── SENSOR_FUSION_DESIGN.md           (センサ融合設計)
│   ├── LOCALIZATION_DESIGN.md            (自己位置推定設計)
│   └── STATE_MACHINE_DESIGN.md           (ステートマシン設計)
│
├── 04_INTERFACES/                        (インターフェース)
│   ├── INTERFACE_CONTROL_DOCUMENT.md     (インターフェース制御文書)
│   ├── ROS_TOPICS_AND_SERVICES.md        (ROSトピック・サービス)
│   ├── HARDWARE_INTERFACES.md            (ハードウェアインターフェース)
│   └── SUBSYSTEM_INTERFACES.md           (サブシステムインターフェース)
│
├── 05_DEVELOPMENT/                       (開発)
│   ├── AGILE_ROADMAP.md                  (アジャイルロードマップ)
│   ├── SPRINT_PLANNING.md                (スプリント計画)
│   ├── USER_STORIES.md                   (ユーザーストーリー)
│   └── BACKLOG.md                        (バックログ)
│
├── 06_TESTING/                           (テスト)
│   ├── TEST_STRATEGY.md                  (テスト戦略)
│   ├── TEST_PLAN.md                      (テスト計画)
│   └── ACCEPTANCE_CRITERIA.md            (受入基準)
│
└── 07_DEPLOYMENT/                        (デプロイ)
    ├── DEPLOYMENT_GUIDE.md               (デプロイガイド)
    ├── CONFIGURATION_MANAGEMENT.md       (構成管理)
    └── MAINTENANCE_GUIDE.md              (保守ガイド)
```

### ドキュメント優先順位

**優先度1: コア基盤**
1. SYSTEM_OVERVIEW.md
2. SYSTEM_REQUIREMENTS.md
3. OVERALL_SYSTEM_ARCHITECTURE.md
4. AGILE_ROADMAP.md

**優先度2: サブシステム要件(関心の分離)**
5. SWERVE_DRIVE_REQUIREMENTS.md
6. DOCKING_SYSTEM_REQUIREMENTS.md
7. NAVIGATION_REQUIREMENTS.md
8. PERCEPTION_REQUIREMENTS.md

**優先度3: サブシステムアーキテクチャ**
9. SWERVE_DRIVE_ARCHITECTURE.md
10. DOCKING_SUBSYSTEM_ARCHITECTURE.md
11. INTEGRATION_ARCHITECTURE.md

**優先度4: インターフェース・統合**
12. INTERFACE_CONTROL_DOCUMENT.md
13. ROS_TOPICS_AND_SERVICES.md

**優先度5: 開発・テスト**
14. USER_STORIES.md
15. TEST_STRATEGY.md

---

## 完全なシステムスコープ

### 1. 完全なナビゲーションスタック
- ✅ **ドッキングナビゲーション:** 車椅子への精密アプローチ(ビジュアルサーボ)
- ✅ **結合モードナビゲーション:** 搭乗者ありでのA→B車椅子搬送
- ✅ **自由ナビゲーション:** 巡回、充電ステーション、シャトルサービス
- ✅ **屋内ナビゲーション:** 平滑床面、管理された環境
- ✅ **屋外ナビゲーション:** 勾配(最大10°)、荒地、天候適応

### 2. 完全な知覚システム
- ✅ **LiDAR処理:** 障害物検出、地形マッピング、3D環境理解
- ✅ **カメラビジョン:** ArUcoマーカー検出、物体認識、車線検出
- ✅ **センサ融合:** LiDAR + カメラ + GPS + IMU + オドメトリ統合
- ✅ **環境理解:** 地形分類、障害物タイプ認識
- ✅ **動的物体追跡:** 歩行者、車両、車椅子(軌道予測)

### 3. 完全な計画システム
- ✅ **大域経路計画:** A* / Dijkstra / Hybrid A* による長距離経路
- ✅ **局所運動計画:** DWA / TEB / MPC (スウェーブドライブ運動学最適化)
- ✅ **軌道最適化:** 滑らか、安全、エネルギー効率的な経路
- ✅ **行動計画:** ステートマシン、タスクシーケンス、意思決定
- ✅ **再計画:** リアルタイム動的障害物対応

### 4. 完全な回避システム
- ✅ **静的障害物回避:** 壁、家具、縁石、固定障害物
- ✅ **動的障害物回避:** 人、車両、移動物体
- ✅ **予測回避:** 歩行者意図推定、軌道予測
- ✅ **ソーシャルナビゲーション:** パーソナルスペース尊重(1.5m バブル)、礼儀正しい行動
- ✅ **緊急回避:** 衝突切迫 → 即座のハードブレーキ

### 5. 完全な制御システム
- ✅ **スウェーブドライブコントローラ:** 逆運動学、4輪独立協調
- ✅ **ドッキングコントローラ:** ビジュアルサーボ、PID制御、精密位置合わせ
- ✅ **モーションコントローラ:** 速度/加速度制限、滑らかな運動プロファイル
- ✅ **手動制御:** ジョイスティック遠隔操作、安全オーバーライド機能
- ✅ **モード切替:** 単独/ドッキング/結合モード遷移

### 6. 完全な安全システム
- ✅ **非常停止:** ハードウェアe-stopボタン + ソフトウェア緊急ブレーキ
- ✅ **衝突防止:** 安全ゾーン、速度制限、近接アラート
- ✅ **安全監視:** センサヘルスチェック、システム診断、故障検出
- ✅ **ジオフェンシング:** 立入禁止ゾーン、動作境界の強制
- ✅ **フェイルセーフ動作:** センサ喪失 → 安全停止、グレースフルデグラデーション
- ✅ **冗長性:** 重要システム(ブレーキ、センサ)のバックアップ

### 7. 完全な自己位置推定システム
- ✅ **GPS自己位置推定:** 屋外グローバル測位、RTK でcmレベル精度
- ✅ **視覚自己位置推定:** ArUcoマーカー、特徴ベースマッチング
- ✅ **LiDAR自己位置推定:** スキャンマッチング、点群レジストレーション
- ✅ **オドメトリ:** ホイールエンコーダ、スウェーブドライブオドメトリ推定
- ✅ **センサ融合:** 拡張カルマンフィルタ(EKF) / パーティクルフィルタ
- ✅ **屋内/屋外遷移:** GPS利用可能性に基づく自動モード切替

### 8. 完全なSLAMシステム
- ✅ **マッピング:** 2D占有グリッド + 3D点群生成
- ✅ **同時自己位置推定:** マッピング中のオンライン姿勢推定
- ✅ **ループクロージャ:** ドリフト補正、姿勢グラフ最適化
- ✅ **マップ管理:** マルチマップサポート、マップ更新、バージョン管理
- ✅ **LiDAR SLAM:** SLAM Toolbox / Cartographer (屋外環境用)
- ✅ **Visual SLAM:** 屋内GPS拒否エリアのオプションフォールバック

### 9. 電源管理
- ✅ バッテリ状態監視(電圧、電流、温度)
- ✅ 充電ステーション自律ナビゲーション
- ✅ 低バッテリ時の自動帰還
- ✅ エネルギー効率的経路計画

### 10. 通信・監視
- ✅ 遠隔操作機能
- ✅ クラウドロギング・分析(ミッションデータ、診断)
- ✅ フリート管理(マルチロボット協調)
- ✅ オペレータダッシュボード(リアルタイム監視)

### 11. ユーザーインタラクション
- ✅ ジョイスティック手動制御(自律オーバーライド)
- ✅ 音声アナウンス(ステータス、警告)
- ✅ LED ステータスインジケータ(動作状態)
- ✅ モバイルアプリ(オペレータインターフェース、ミッション割当)

### 12. 環境適応
- ✅ 天候検出(雨、風センサ)
- ✅ 照明適応(昼/夜カメラ設定)
- ✅ 地形適応(平滑/荒地表面検出)
- ✅ 季節モード(夏/冬パラメータ)

---

## 技術スタック

### ハードウェアプラットフォーム
- **駆動システム:** スウェーブドライブ(4モジュール、6.5インチホバーボードインホイールモーター)
- **センサ:** LiDAR(360°)、RGBカメラ×2、GPS(RTK)、IMU(9軸)、ホイールエンコーダ
- **安全:** 崖検出センサ、近接センサ、非常停止ボタン
- **計算:** 組込みPC(x86_64)、ビジョン処理用GPU

### ソフトウェアスタック
| コンポーネント | 技術 | 目的 |
|--------------|------|------|
| **フレームワーク** | ROS 2 Humble | ロボットオペレーティングシステム |
| **ナビゲーション** | Nav2 | 経路計画、障害物回避 |
| **SLAM** | SLAM Toolbox / Cartographer | マッピング・自己位置推定 |
| **センサ融合** | robot_localization | マルチセンサ統合(EKF) |
| **ビジョン** | OpenCV 4.x | カメラ処理、ArUco検出 |
| **点群** | PCL (Point Cloud Library) | LiDARデータ処理 |
| **モーション計画** | MoveIt2 (オプション) | 高度な軌道計画 |
| **ビルドシステム** | colcon | ROS 2 パッケージビルドツール |
| **カスタムノード** | C++17 / Python 3.10 | スウェーブドライブ、ドッキング、制御 |

---

## 開発原則

### 1. 関心の分離
- ✅ 各サブシステム(スウェーブドライブ、ドッキング、ナビゲーション、知覚、安全)は **独立して文書化**
- ✅ サブシステム間の明確なインターフェース定義
- ✅ サブシステムを **並行して** 開発、テスト、検証可能
- ✅ モジュールアーキテクチャにより **段階的統合** が可能

### 2. 屋外優先設計
- ✅ すべての要件が **屋外動作を優先**(勾配、天候、荒地)
- ✅ 屋内互換性は **屋外機能のサブセット** として達成
- ✅ センサは **屋外堅牢性** を考慮して選定(防水、広温度範囲)
- ✅ 性能目標は **屋外最悪ケースシナリオ** に基づく

### 3. 屋内互換性
- ✅ システムは **屋内でシームレスに** 動作(平滑床面、管理環境)
- ✅ 自動 **環境検出**(GPS利用可能性、照明、地形タイプ)
- ✅ 屋内動作用 **精密モード**(高精度、高速)
- ✅ **フォールバック戦略**(GPS喪失 → Visual SLAM、マーカーベース自己位置推定)

### 4. アジャイル手法
- ✅ スプリント単位の **段階的開発**(2週間サイクル)
- ✅ エンドユーザー視点からの **ユーザーストーリー** 定義
- ✅ **継続的統合** とテスト
- ✅ テストフィードバックに基づく **反復改善**

### 5. 統合準備アーキテクチャ
- ✅ **明確に定義されたインターフェース**(ROS トピック、サービス、アクション文書化)
- ✅ **モジュール設計** により並行チーム開発が可能
- ✅ 各スプリント境界での **統合テスト**
- ✅ サブシステム統合後の **システムレベル検証**

### 6. 安全第一アプローチ
- ✅ すべてのサブシステムに **安全要件** を定義
- ✅ **複数の安全層**(非常停止、衝突回避、ジオフェンシング)
- ✅ **フェイルセーフデフォルト**(不明状態 → 安全停止)
- ✅ 重要システムの **冗長性**(センサ、ブレーキ)

### 7. 実証済みハードウェアに基づく
- ✅ **スウェーブドライブ研究(2025-12-10)** から導出された仕様
- ✅ **解析とシミュレーション** により検証されたハードウェア選定
- ✅ **実測要件** に基づく設計パラメータ(60kgロボット、100kg負荷、10°勾配)

---

## ユースケース

### 主要ユースケース
1. ✅ **自律車椅子ドッキング**(屋外精度±2-5mm、屋内目標±1mm)
2. ✅ **車椅子搬送**(搭乗者あり A→B ナビゲーション、スムーズな走行)
3. ✅ **充電ステーションナビゲーション**(低バッテリ時の自動帰還)
4. ✅ **シャトルサービス**(スケジュール経路、マルチウェイポイント実行)
5. ✅ **手動操作**(ジョイスティックオーバーライド、ウェイポイント記録用ティーチングモード)

### 副次的ユースケース
6. ✅ **巡回経路**(セキュリティ監視、スケジュール点検)
7. ✅ **配送タスク**(機器、物品の拠点間輸送)
8. ✅ **緊急帰還**(センサ故障 → 基地への安全ナビゲーション)
9. ✅ **ティーチングモード**(人間がロボット誘導、システムがウェイポイント記録)
10. ✅ **フリート協調**(複数ロボット、衝突回避、タスク割当)

---

## 次のステップ

### 即時アクション
1. ✅ 完全なドキュメント構造作成(フォルダとテンプレートファイル)
2. ✅ **SYSTEM_OVERVIEW.md** 開発(エグゼクティブサマリー)
3. ✅ **SYSTEM_REQUIREMENTS.md** 開発(機能要件・非機能要件)
4. ✅ **OVERALL_SYSTEM_ARCHITECTURE.md** 開発(高レベル設計)

### 短期目標
5. ✅ サブシステム要件定義(スウェーブドライブ、ドッキング、ナビゲーション、知覚、安全)
6. ✅ サブシステムアーキテクチャ設計(ROS ノード構造、インターフェース)
7. ✅ **AGILE_ROADMAP.md** 作成(スプリント計画、タイムライン)
8. ✅ **USER_STORIES.md** 定義(ユーザー視点からの機能記述)

### 中期目標
9. ✅ 詳細設計ドキュメント開発(運動学、制御アルゴリズム、ステートマシン)
10. ✅ インターフェース制御文書定義(ROS トピック、サービス、メッセージ定義)
11. ✅ テスト戦略と受入基準作成
12. ✅ スプリントベース開発開始

---

**ドキュメントバージョン:** 1.0
**最終更新日:** 2025年12月15日
**ステータス:** 計画フェーズ - ドキュメント構造作成準備完了
**次のマイルストーン:** 完全なドキュメント構造作成

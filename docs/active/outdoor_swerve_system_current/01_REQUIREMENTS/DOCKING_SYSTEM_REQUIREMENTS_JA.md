# ドッキングシステム要件

**文書ID:** REQ-DOCK-001
**バージョン:** 1.0
**日付:** 2025年12月15日
**ステータス:** ドラフト
**分類:** 内部

---

## 文書管理

| バージョン | 日付 | 作成者 | 変更内容 |
|---------|------|--------|---------|
| 1.0 | 2025-12-15 | システムアーキテクト | SYSTEM_REQUIREMENTS.md、question_answers.md、EHMI_SYSTEM_REFERENCE.mdに基づく初版仕様 |

---

## 1. はじめに

### 1.1 目的

本文書は、屋外優先車椅子輸送ロボットの**自律ドッキングサブシステム**の要件を規定します。ドッキングシステムは、ArUcoビジュアルマーカーとビジュアルサーボイング制御を使用して、車椅子ドッキングステーションへの精密接近と位置合わせを実現します。

### 1.2 スコープ

本仕様は以下をカバーします:
- デュアルRGBカメラを使用した**ArUcoマーカー検出**
- 精密位置合わせのための**ビジュアルサーボイング制御**
- **2段階ドッキングアプローチ**（粗ナビゲーション + 精密サーボイング）
- **ハードウェア要件**（カメラ、マーカー、照明）
- **ソフトウェアアーキテクチャ**（ROS 2ノード、コントローラ、状態機械）
- **安全性と信頼性**要件
- **環境動作条件**

**スコープ外:**
- Nav2グローバル経路計画（NAVIGATION_REQUIREMENTS.mdでカバー）
- 物理的ドッキング機構（機械的ラッチ、センサー）
- 車椅子検出センサー（PERCEPTION_REQUIREMENTS.mdでカバー）

### 1.3 関連文書

- **SYSTEM_REQUIREMENTS.md** - セクション1.1（DOCK-REQ-001～010）
- **OVERALL_SYSTEM_ARCHITECTURE.md** - セクション3.2（ドッキングサブシステム）
- **VISUAL_SERVOING_DESIGN.md** - 詳細設計
- **EHMI_SYSTEM_REFERENCE.md** - 状態21-28（ドッキング状態）
- **question_answers.md** - ドッキング戦略の明確化

### 1.4 システム概要

ドッキングシステムは**2段階アプローチ**を実装します:

**段階1: 粗ナビゲーション（Nav2）**
```
ロボット位置（任意）
    ↓
「ドッキング接近ゾーン」へナビゲート（Nav2ウェイポイント）
    ↓
接近ゾーンで停止（±10cm精度）
    ↓
ArUcoマーカーがカメラ範囲内（0.5-3m）
```

**段階2: 精密ビジュアルサーボイング**
```
ビジュアルサーボイングモードへ切替
    ↓
ArUcoマーカー検出（デュアルカメラ）
    ↓
姿勢誤差計算（X、Y、Yaw）
    ↓
PID制御 → 速度指令（vx、vy、ω）
    ↓
精密ドッキング（屋外±2-5mm、屋内±1mm）
```

---

## 2. 機能要件

### 2.1 ArUcoマーカー検出（DOCK-ARUCO）

| 要件ID | 要件 | 優先度 | 検証方法 |
|--------|------|--------|----------|
| DOCK-ARUCO-001 | システムはDICT_4X4_50辞書のArUcoマーカーを検出しなければならない | 必須 | 単体テスト |
| DOCK-ARUCO-002 | システムはドッキング中に最低10Hzでマーカーを検出しなければならない | 必須 | 性能テスト |
| DOCK-ARUCO-003 | システムは0.2m～5.0mの範囲でマーカーを検出しなければならない | 必須 | フィールドテスト |
| DOCK-ARUCO-004 | システムは水平±45°、垂直±30°の角度でマーカーを検出しなければならない | 高 | フィールドテスト |
| DOCK-ARUCO-005 | システムはマーカーから6自由度姿勢（X、Y、Z、roll、pitch、yaw）を計算しなければならない | 必須 | 単体テスト |
| DOCK-ARUCO-006 | システムは両カメラが同じマーカーを検出した場合、デュアルカメラフュージョンを使用しなければならない | 高 | 統合テスト |
| DOCK-ARUCO-007 | システムは複数マーカー検出時、最も近いマーカーを選択しなければならない | 高 | 統合テスト |
| DOCK-ARUCO-008 | システムは再投影誤差>2ピクセルの検出を拒否しなければならない | 中 | 単体テスト |
| DOCK-ARUCO-009 | システムはマーカー姿勢を`/aruco_detections`トピックに発行しなければならない | 必須 | 統合テスト |
| DOCK-ARUCO-010 | システムはTF2変換`marker_X -> camera_link`を発行しなければならない | 必須 | 統合テスト |
| DOCK-ARUCO-011 | システムは部分的マーカーオクルージョン（≥3コーナー可視）を処理しなければならない | 中 | フィールドテスト |
| DOCK-ARUCO-012 | システムは期待範囲外[0-49]のIDを持つマーカーを拒否しなければならない | 低 | 単体テスト |

**合計要件: 12**

---

### 2.2 ビジュアルサーボイング制御（DOCK-VS）

| 要件ID | 要件 | 優先度 | 検証方法 |
|--------|------|--------|----------|
| DOCK-VS-001 | システムはマーカー姿勢から姿勢誤差（ΔX、ΔY、Δθ）を計算しなければならない | 必須 | 単体テスト |
| DOCK-VS-002 | システムはX、Y、Yaw軸に対して独立したPID制御を使用しなければならない | 必須 | 単体テスト |
| DOCK-VS-003 | システムは最大ドッキング速度を0.3 m/s並進に制限しなければならない | 必須 | 安全テスト |
| DOCK-VS-004 | システムは最大ドッキング角速度を0.2 rad/sに制限しなければならない | 必須 | 安全テスト |
| DOCK-VS-005 | システムは屋外で±2-5mmの位置精度を達成しなければならない | 必須 | フィールドテスト |
| DOCK-VS-006 | システムは±0.5°の姿勢精度を達成しなければならない | 高 | フィールドテスト |
| DOCK-VS-007 | システムは誤差<5mmが2秒間継続した場合「ドッキング完了」を宣言しなければならない | 必須 | 統合テスト |
| DOCK-VS-008 | システムは`/cmd_vel`トピックへ速度指令を発行しなければならない | 必須 | 統合テスト |
| DOCK-VS-009 | システムはPID積分器のアンチワインドアップを実装しなければならない | 高 | 単体テスト |
| DOCK-VS-010 | システムは0.5sのランプアップ/ダウンで速度指令を平滑化しなければならない | 中 | 統合テスト |
| DOCK-VS-011 | システムはマーカーロスト時に停止して再検索しなければならない | 高 | 故障注入テスト |
| DOCK-VS-012 | システムはドッキング未達成の場合120秒後にタイムアウトしなければならない | 高 | 統合テスト |
| DOCK-VS-013 | システムは「接近のみ」モード（0.5mで停止）をサポートしなければならない | 中 | 統合テスト |

**合計要件: 13**

---

### 2.3 ドッキング状態機械（DOCK-SM）

| 要件ID | 要件 | 優先度 | 検証方法 |
|--------|------|--------|----------|
| DOCK-SM-001 | システムは状態機械を実装しなければならない: IDLE → APPROACH → SEARCH → SERVOING → DOCKED → UNDOCKING | 必須 | 統合テスト |
| DOCK-SM-002 | システムはドッキングゴール受信時にIDLE → APPROACHへ遷移しなければならない | 必須 | 統合テスト |
| DOCK-SM-003 | システムはAPPROACH状態でNav2を使用してドッキングゾーンへ到達しなければならない | 必須 | 統合テスト |
| DOCK-SM-004 | システムは接近ゾーン到達時にAPPROACH → SEARCHへ遷移しなければならない | 必須 | 統合テスト |
| DOCK-SM-005 | システムはマーカー未検出の場合SEARCH状態で360°回転しなければならない | 高 | 統合テスト |
| DOCK-SM-006 | システムはマーカー検出時にSEARCH → SERVOINGへ遷移しなければならない | 必須 | 統合テスト |
| DOCK-SM-007 | システムは成功基準満了時にSERVOING → DOCKEDへ遷移しなければならない | 必須 | 統合テスト |
| DOCK-SM-008 | システムはドッキング失敗（タイムアウト）時にIDLEへ遷移しなければならない | 高 | 故障注入テスト |
| DOCK-SM-009 | システムは後進動作のためのUNDOCKING状態をサポートしなければならない | 高 | 統合テスト |
| DOCK-SM-010 | システムは現在状態を`/docking/state`トピックへ発行しなければならない | 中 | 統合テスト |
| DOCK-SM-011 | システムはドッキング中にeHMIを状態21-28へ更新しなければならない | 高 | システムテスト |

**合計要件: 11**

---

### 2.4 デュアルカメラフュージョン（DOCK-CAM）

| 要件ID | 要件 | 優先度 | 検証方法 |
|--------|------|--------|----------|
| DOCK-CAM-001 | システムは2×RGBカメラ（前方左、前方右）を使用しなければならない | 必須 | ハードウェア検査 |
| DOCK-CAM-002 | システムは同じマーカーが両カメラで可視の場合、検出をフュージョンしなければならない | 高 | 統合テスト |
| DOCK-CAM-003 | システムは一つのカメラのみがマーカーを検出した場合、単眼を使用しなければならない | 高 | 統合テスト |
| DOCK-CAM-004 | システムは単眼よりステレオフュージョンを優先しなければならない（高精度） | 中 | 性能テスト |
| DOCK-CAM-005 | システムはデュアル検出フュージョン時に加重平均を計算しなければならない | 中 | 単体テスト |
| DOCK-CAM-006 | システムはカメラ内部パラメータ（K行列、歪み）を校正しなければならない | 必須 | 校正手順 |
| DOCK-CAM-007 | システムはカメラ外部パラメータ（camera → base_link TF）を校正しなければならない | 必須 | 校正手順 |
| DOCK-CAM-008 | システムはカメラ校正精度<1ピクセルRMSを維持しなければならない | 高 | 校正テスト |

**合計要件: 8**

---

### 2.5 マーカー管理（DOCK-MARKER）

| 要件ID | 要件 | 優先度 | 検証方法 |
|--------|------|--------|----------|
| DOCK-MARKER-001 | システムはドッキングステーションで4-8個のArUcoマーカーをサポートしなければならない | 必須 | 構成 |
| DOCK-MARKER-002 | システムはマーカーサイズ150mm × 150mm（0.15m）を使用しなければならない | 必須 | ハードウェア検査 |
| DOCK-MARKER-003 | システムはDICT_4X4_50辞書（50ユニークマーカー）を使用しなければならない | 必須 | 構成 |
| DOCK-MARKER-004 | システムはドッキングステーション毎にユニークIDを割り当てなければならない（例: 0-1、2-3、...） | 高 | 構成 |
| DOCK-MARKER-005 | システムはセンタリングのためステーション毎にデュアルマーカーを使用しなければならない（左+右） | 高 | フィールドテスト |
| DOCK-MARKER-006 | システムはデュアルマーカー間の中心点をターゲットとしなければならない | 高 | 統合テスト |
| DOCK-MARKER-007 | システムはマップフレーム内にマーカー姿勢を保存しなければならない（永続的） | 中 | 統合テスト |
| DOCK-MARKER-008 | システムはマーカー損傷/劣化を検出しなければならない（コーナー検出率低下） | 低 | 故障検出テスト |

**合計要件: 8**

---

## 3. 性能要件

### 3.1 ドッキング精度（DOCK-PERF-PREC）

| 要件ID | 要件 | 優先度 | 検証方法 |
|--------|------|--------|----------|
| DOCK-PERF-PREC-001 | システムは屋内で±2mmの位置精度を達成しなければならない | 高 | フィールドテスト（100試行） |
| DOCK-PERF-PREC-002 | システムは屋外で±5mmの位置精度を達成しなければならない | 必須 | フィールドテスト（100試行） |
| DOCK-PERF-PREC-003 | システムは±0.5°の姿勢精度を達成しなければならない | 高 | フィールドテスト |
| DOCK-PERF-PREC-004 | システムは屋外で95パーセンタイル精度±10mmを達成しなければならない | 高 | 統計解析 |
| DOCK-PERF-PREC-005 | システムは10-25 km/h風速で精度を維持しなければならない | 高 | 風洞試験 |
| DOCK-PERF-PREC-006 | システムは±5°傾斜で精度を維持しなければならない | 高 | 傾斜試験 |

**合計要件: 6**

---

### 3.2 ドッキング速度と成功率（DOCK-PERF-SPEED）

| 要件ID | 要件 | 優先度 | 検証方法 |
|--------|------|--------|----------|
| DOCK-PERF-SPEED-001 | システムは接近ゾーンから120秒以内にドッキング完了しなければならない | 高 | フィールドテスト |
| DOCK-PERF-SPEED-002 | システムは屋外で>95%のドッキング成功率を達成しなければならない | 必須 | フィールドテスト（1000試行） |
| DOCK-PERF-SPEED-003 | システムは屋内で>98%のドッキング成功率を達成しなければならない | 高 | フィールドテスト（500試行） |
| DOCK-PERF-SPEED-004 | システムは範囲内進入後5秒以内にマーカーを検出しなければならない | 高 | 性能テスト |
| DOCK-PERF-SPEED-005 | システムは60秒以内に±10mmへ収束しなければならない | 高 | 性能テスト |

**合計要件: 5**

---

### 3.3 検出性能（DOCK-PERF-DET）

| 要件ID | 要件 | 優先度 | 検証方法 |
|--------|------|--------|----------|
| DOCK-PERF-DET-001 | システムは最低10Hzでマーカーを検出しなければならない | 必須 | 性能テスト |
| DOCK-PERF-DET-002 | システムは<100ms検出遅延（カメラ → 姿勢）を達成しなければならない | 高 | 遅延テスト |
| DOCK-PERF-DET-003 | システムは0.5-3m範囲で>99%検出率を達成しなければならない | 必須 | フィールドテスト |
| DOCK-PERF-DET-004 | システムは3-5m範囲で>90%検出率を達成しなければならない | 高 | フィールドテスト |
| DOCK-PERF-DET-005 | システムは最低30 FPSカメラフレームレートを処理しなければならない | 必須 | ハードウェア仕様 |

**合計要件: 5**

---

## 4. ハードウェア要件

### 4.1 カメラハードウェア（DOCK-HW-CAM）

| 要件ID | 要件 | 優先度 | 検証方法 |
|--------|------|--------|----------|
| DOCK-HW-CAM-001 | システムは2×RGBカメラ（ステレオまたは独立）を使用しなければならない | 必須 | ハードウェアBOM |
| DOCK-HW-CAM-002 | カメラは最低1920×1080解像度を提供しなければならない | 必須 | データシート |
| DOCK-HW-CAM-003 | カメラは最低30 FPSフレームレートを提供しなければならない | 必須 | データシート |
| DOCK-HW-CAM-004 | カメラは最低90° HFOVを持たなければならない | 高 | データシート |
| DOCK-HW-CAM-005 | カメラはUSB 3.0またはGigEインターフェースをサポートしなければならない | 高 | データシート |
| DOCK-HW-CAM-006 | カメラはグローバルシャッター（推奨）または<10msローリングシャッターを持たなければならない | 中 | データシート |
| DOCK-HW-CAM-007 | カメラは地面から0.4-0.6m高さに取り付けなければならない | 高 | 機械設計 |
| DOCK-HW-CAM-008 | カメラは10-15°下向きに傾けなければならない | 中 | 機械設計 |
| DOCK-HW-CAM-009 | カメラはIP66+防水性またはハウジングを持たなければならない | 必須 | データシート |

**合計要件: 9**

---

### 4.2 ArUcoマーカーハードウェア（DOCK-HW-MARKER）

| 要件ID | 要件 | 優先度 | 検証方法 |
|--------|------|--------|----------|
| DOCK-HW-MARKER-001 | マーカーは150mm × 150mm（±2mm）でなければならない | 必須 | 製造仕様 |
| DOCK-HW-MARKER-002 | マーカーはDICT_4X4_50辞書を使用しなければならない | 必須 | 生成仕様 |
| DOCK-HW-MARKER-003 | マーカーは剛性基板（アルミ、アクリル）に印刷されなければならない | 高 | 材料仕様 |
| DOCK-HW-MARKER-004 | マーカーはマット仕上げ（非反射）を持たなければならない | 高 | 製造仕様 |
| DOCK-HW-MARKER-005 | マーカーは耐UV性（屋外耐久性）を持たなければならない | 高 | 材料仕様 |
| DOCK-HW-MARKER-006 | マーカーはIP66+防水性（ラミネートまたはコーティング）を持たなければならない | 必須 | 材料仕様 |
| DOCK-HW-MARKER-007 | マーカーは地面から0.3-0.5m高さに取り付けなければならない | 高 | 設置仕様 |
| DOCK-HW-MARKER-008 | マーカーは接近方向に対して垂直（±5°）に取り付けなければならない | 高 | 設置仕様 |

**合計要件: 8**

---

### 4.3 照明ハードウェア（DOCK-HW-LIGHT）

| 要件ID | 要件 | 優先度 | 検証方法 |
|--------|------|--------|----------|
| DOCK-HW-LIGHT-001 | システムは夜間ドッキング用のアクティブLED照明を持たなければならない | 高 | ハードウェアBOM |
| DOCK-HW-LIGHT-002 | LEDライトは2m距離で500-1000ルクスを提供しなければならない | 高 | フォトメータ試験 |
| DOCK-HW-LIGHT-003 | LEDライトはカメラと同位置に配置しなければならない（影を最小化） | 中 | 機械設計 |
| DOCK-HW-LIGHT-004 | LEDライトは低照度（<500ルクス周囲光）で自動起動しなければならない | 中 | 統合テスト |

**合計要件: 4**

---

## 5. ソフトウェア要件

### 5.1 ROS 2ノード（DOCK-SW-NODE）

| 要件ID | 要件 | 優先度 | 検証方法 |
|--------|------|--------|----------|
| DOCK-SW-NODE-001 | システムは`aruco_detector_node`（C++/Python）を実装しなければならない | 必須 | コード検査 |
| DOCK-SW-NODE-002 | システムは`visual_servoing_controller_node`（C++）を実装しなければならない | 必須 | コード検査 |
| DOCK-SW-NODE-003 | システムは`docking_state_machine_node`（Python）を実装しなければならない | 必須 | コード検査 |
| DOCK-SW-NODE-004 | ノードはROS 2 Humble上で実行しなければならない | 必須 | CI/CDテスト |
| DOCK-SW-NODE-005 | ノードはrclcpp/rclpyライフサイクル管理を使用しなければならない | 中 | コード検査 |
| DOCK-SW-NODE-006 | ノードは`/diagnostics`トピックへ診断を発行しなければならない | 中 | 統合テスト |

**合計要件: 6**

---

### 5.2 ROS 2トピックとサービス（DOCK-SW-COMM）

| 要件ID | 要件 | 優先度 | 検証方法 |
|--------|------|--------|----------|
| DOCK-SW-COMM-001 | システムは`/camera_front_left/image_raw`を購読しなければならない | 必須 | トピック検査 |
| DOCK-SW-COMM-002 | システムは`/camera_front_right/image_raw`を購読しなければならない | 必須 | トピック検査 |
| DOCK-SW-COMM-003 | システムは`/aruco_detections`（geometry_msgs/PoseArray）へ発行しなければならない | 必須 | トピック検査 |
| DOCK-SW-COMM-004 | システムはビジュアルサーボイング中に`/cmd_vel`へ発行しなければならない | 必須 | トピック検査 |
| DOCK-SW-COMM-005 | システムは`/docking/state`（std_msgs/String）へ発行しなければならない | 中 | トピック検査 |
| DOCK-SW-COMM-006 | システムは`/docking/start`サービス（std_srvs/Trigger）を提供しなければならない | 高 | サービス検査 |
| DOCK-SW-COMM-007 | システムは`/docking/cancel`サービス（std_srvs/Trigger）を提供しなければならない | 高 | サービス検査 |
| DOCK-SW-COMM-008 | システムは`/docking/dock`アクション（カスタムDockAction）を提供しなければならない | 高 | アクション検査 |

**合計要件: 8**

---

### 5.3 依存関係とライブラリ（DOCK-SW-LIB）

| 要件ID | 要件 | 優先度 | 検証方法 |
|--------|------|--------|----------|
| DOCK-SW-LIB-001 | システムはArUco検出にOpenCV 4.xを使用しなければならない | 必須 | ビルドシステム |
| DOCK-SW-LIB-002 | システムはROS 2 ↔ OpenCV変換にcv_bridgeを使用しなければならない | 必須 | ビルドシステム |
| DOCK-SW-LIB-003 | システムはカメライメージトピックにimage_transportを使用しなければならない | 高 | ビルドシステム |
| DOCK-SW-LIB-004 | システムは座標変換にtf2_rosを使用しなければならない | 必須 | ビルドシステム |
| DOCK-SW-LIB-005 | システムは校正にcamera_info_managerを使用しなければならない | 高 | ビルドシステム |

**合計要件: 5**

---

### 5.4 構成管理（DOCK-SW-CFG）

| 要件ID | 要件 | 優先度 | 検証方法 |
|--------|------|--------|----------|
| DOCK-SW-CFG-001 | システムはYAML構成ファイルからパラメータをロードしなければならない | 必須 | 統合テスト |
| DOCK-SW-CFG-002 | システムはPIDゲインの動的再構成をサポートしなければならない | 高 | ランタイムテスト |
| DOCK-SW-CFG-003 | システムは起動時にマーカー辞書を検証しなければならない | 高 | 単体テスト |
| DOCK-SW-CFG-004 | システムは起動時にカメラ校正ファイルを検証しなければならない | 必須 | 単体テスト |
| DOCK-SW-CFG-005 | システムは起動時に構成パラメータをログ出力しなければならない | 中 | ログ検査 |

**合計要件: 5**

---

## 6. 安全要件

### 6.1 衝突回避（DOCK-SAFE-COLL）

| 要件ID | 要件 | 優先度 | 検証方法 |
|--------|------|--------|----------|
| DOCK-SAFE-COLL-001 | システムはドッキング中にLiDARで障害物を監視しなければならない | 必須 | 安全テスト |
| DOCK-SAFE-COLL-002 | システムはドッキング中に<0.5mで障害物検出時に停止しなければならない | 必須 | 故障注入テスト |
| DOCK-SAFE-COLL-003 | システムは目標から<1mの場合ドッキング速度を0.1 m/sに制限しなければならない | 必須 | 安全テスト |
| DOCK-SAFE-COLL-004 | システムは経路内に予期しない障害物がある場合ドッキングを中止しなければならない | 高 | 故障注入テスト |

**合計要件: 4**

---

### 6.2 緊急停止（DOCK-SAFE-ESTOP）

| 要件ID | 要件 | 優先度 | 検証方法 |
|--------|------|--------|----------|
| DOCK-SAFE-ESTOP-001 | システムは緊急停止信号で即座に停止しなければならない | 必須 | 安全テスト |
| DOCK-SAFE-ESTOP-002 | システムは緊急停止時にビジュアルサーボイングを無効化しなければならない | 必須 | 統合テスト |
| DOCK-SAFE-ESTOP-003 | システムは緊急停止後に手動リセットを要求しなければならない | 高 | 統合テスト |

**合計要件: 3**

---

### 6.3 故障処理（DOCK-SAFE-FAULT）

| 要件ID | 要件 | 優先度 | 検証方法 |
|--------|------|--------|----------|
| DOCK-SAFE-FAULT-001 | システムはマーカーロスト>5秒の場合ドッキングを中止しなければならない | 高 | 故障注入テスト |
| DOCK-SAFE-FAULT-002 | システムはカメラ故障検出時にドッキングを中止しなければならない | 必須 | 故障注入テスト |
| DOCK-SAFE-FAULT-003 | システムはすべてのドッキング失敗を永続ストレージへログ出力しなければならない | 高 | ログ検査 |
| DOCK-SAFE-FAULT-004 | システムは`/docking/status`トピックへ失敗理由を発行しなければならない | 中 | 統合テスト |
| DOCK-SAFE-FAULT-005 | システムは失敗宣言前に再試行（最大3回）を試みなければならない | 中 | 統合テスト |

**合計要件: 5**

---

### 6.4 車椅子安全（DOCK-SAFE-WHEELCHAIR）

| 要件ID | 要件 | 優先度 | 検証方法 |
|--------|------|--------|----------|
| DOCK-SAFE-WHEELCHAIR-001 | システムはドッキング前に車椅子存在を検証しなければならない | 必須 | センサー統合テスト |
| DOCK-SAFE-WHEELCHAIR-002 | システムは車椅子ミスアライメント（>10cmオフセット）を検出しなければならない | 高 | 故障検出テスト |
| DOCK-SAFE-WHEELCHAIR-003 | システムはドッキング中に車椅子が動いた場合中止しなければならない | 高 | 故障注入テスト |

**合計要件: 3**

---

## 7. 環境要件

### 7.1 照明条件（DOCK-ENV-LIGHT）

| 要件ID | 要件 | 優先度 | 検証方法 |
|--------|------|--------|----------|
| DOCK-ENV-LIGHT-001 | システムは100-100,000ルクス（曇りから直射日光）で動作しなければならない | 必須 | フィールドテスト |
| DOCK-ENV-LIGHT-002 | システムはアクティブLED照明で夜間（<10ルクス）に動作しなければならない | 高 | 夜間テスト |
| DOCK-ENV-LIGHT-003 | システムは直射日光グレア（自動露出）を処理しなければならない | 高 | フィールドテスト |
| DOCK-ENV-LIGHT-004 | システムは逆光マーカー（背景より暗いマーカー）を処理しなければならない | 中 | フィールドテスト |

**合計要件: 4**

---

### 7.2 気象条件（DOCK-ENV-WEATHER）

| 要件ID | 要件 | 優先度 | 検証方法 |
|--------|------|--------|----------|
| DOCK-ENV-WEATHER-001 | システムは小雨（<2.5mm/hr）で動作しなければならない | 高 | 降雨室試験 |
| DOCK-ENV-WEATHER-002 | システムは表面に水滴があるマーカーを検出しなければならない | 高 | 降雨シミュレーション |
| DOCK-ENV-WEATHER-003 | システムはカメラレンズ上の結露を処理しなければならない（加熱/曇り止め） | 中 | 恒温室 |
| DOCK-ENV-WEATHER-004 | システムは豪雨（>7.5mm/hr）での動作を拒否しなければならない | 中 | 雨センサー |

**合計要件: 4**

---

### 7.3 温度と耐久性（DOCK-ENV-TEMP）

| 要件ID | 要件 | 優先度 | 検証方法 |
|--------|------|--------|----------|
| DOCK-ENV-TEMP-001 | システムは-10°C～+45°C周囲温度で動作しなければならない | 高 | 恒温室 |
| DOCK-ENV-TEMP-002 | カメラは温度範囲全体で校正精度を維持しなければならない | 高 | 熱校正テスト |
| DOCK-ENV-TEMP-003 | マーカーは1000時間UV露光後に反射率を維持しなければならない | 中 | UV老化試験 |
| DOCK-ENV-TEMP-004 | マーカーは100凍結融解サイクル後に接着を維持しなければならない | 中 | 熱サイクル試験 |

**合計要件: 4**

---

## 8. 統合要件

### 8.1 Nav2統合（DOCK-INT-NAV）

| 要件ID | 要件 | 優先度 | 検証方法 |
|--------|------|--------|----------|
| DOCK-INT-NAV-001 | システムはNav2から接近ゾーンウェイポイントを受信しなければならない | 必須 | 統合テスト |
| DOCK-INT-NAV-002 | システムはNav2からビジュアルサーボイングへ制御を引き継がなければならない | 必須 | 統合テスト |
| DOCK-INT-NAV-003 | システムはドッキング完了後にNav2制御を復元しなければならない | 高 | 統合テスト |
| DOCK-INT-NAV-004 | システムはマップ内に「ドッキング接近ゾーン」を定義しなければならない | 高 | マップ構成 |

**合計要件: 4**

---

### 8.2 eHMI統合（DOCK-INT-EHMI）

| 要件ID | 要件 | 優先度 | 検証方法 |
|--------|------|--------|----------|
| DOCK-INT-EHMI-001 | システムはeHMI状態を21（車椅子へ接近中）へ更新しなければならない | 高 | 統合テスト |
| DOCK-INT-EHMI-002 | システムはeHMI状態を22（ドッキング進行中）へ更新しなければならない | 高 | 統合テスト |
| DOCK-INT-EHMI-003 | システムはeHMI状態を23（ドッキング完了）へ更新しなければならない | 高 | 統合テスト |
| DOCK-INT-EHMI-004 | システムはeHMI状態を28（ドッキング失敗）へ更新しなければならない | 中 | 統合テスト |

**合計要件: 4**

---

### 8.3 安全システム統合（DOCK-INT-SAFE）

| 要件ID | 要件 | 優先度 | 検証方法 |
|--------|------|--------|----------|
| DOCK-INT-SAFE-001 | システムはドッキング中に安全システム速度制限を尊重しなければならない | 必須 | 安全テスト |
| DOCK-INT-SAFE-002 | システムは安全モニターへドッキング状態を報告しなければならない | 高 | 統合テスト |
| DOCK-INT-SAFE-003 | システムは安全システム要求でドッキングを中止しなければならない | 必須 | 故障注入テスト |

**合計要件: 3**

---

## 9. テストと検証要件

### 9.1 単体テスト（DOCK-TEST-UNIT）

| 要件ID | 要件 | 優先度 | 検証方法 |
|--------|------|--------|----------|
| DOCK-TEST-UNIT-001 | ArUco検出は>90%単体テストカバレッジを持たなければならない | 高 | コードカバレッジ |
| DOCK-TEST-UNIT-002 | ビジュアルサーボイングコントローラは>85%単体テストカバレッジを持たなければならない | 高 | コードカバレッジ |
| DOCK-TEST-UNIT-003 | PIDコントローラはエッジケース専用テストを持たなければならない | 高 | テスト計画 |

**合計要件: 3**

---

### 9.2 フィールドテスト（DOCK-TEST-FIELD）

| 要件ID | 要件 | 優先度 | 検証方法 |
|--------|------|--------|----------|
| DOCK-TEST-FIELD-001 | システムは100回の成功した屋外ドッキングテストを完了しなければならない | 必須 | テストレポート |
| DOCK-TEST-FIELD-002 | システムは50回の成功した夜間ドッキングテストを完了しなければならない | 高 | テストレポート |
| DOCK-TEST-FIELD-003 | システムは50回の成功した雨天ドッキングテストを完了しなければならない | 高 | テストレポート |
| DOCK-TEST-FIELD-004 | システムは精度統計（平均、標準偏差、95パーセンタイル）をログ出力しなければならない | 高 | テストレポート |

**合計要件: 4**

---

### 9.3 受入基準（DOCK-TEST-ACCEPT）

| 基準 | 目標 | MVP目標 | 検証 |
|-----|------|---------|------|
| ドッキング成功率（屋外） | >95% | >90% | 100試行 |
| ドッキング成功率（屋内） | >98% | >95% | 50試行 |
| 位置精度（屋外） | ±5mm | ±10mm | 統計解析 |
| 位置精度（屋内） | ±2mm | ±5mm | 統計解析 |
| 姿勢精度 | ±0.5° | ±1° | 統計解析 |
| ドッキング時間 | <120s | <180s | 50試行平均 |
| 検出範囲 | 0.2-5m | 0.5-3m | フィールドテスト |
| 夜間動作成功 | >90% | >80% | 50夜間試行 |

---

## 10. 要件サマリー

### カテゴリ別要件数

| カテゴリ | 合計要件 | 必須 | 高 | 中 | 低 |
|---------|---------|------|-----|-----|-----|
| **機能** | **52** | 32 | 17 | 3 | 0 |
| - ArUco検出 | 12 | 7 | 3 | 2 | 1 |
| - ビジュアルサーボイング | 13 | 8 | 4 | 1 | 0 |
| - 状態機械 | 11 | 7 | 4 | 0 | 0 |
| - デュアルカメラ | 8 | 5 | 3 | 0 | 0 |
| - マーカー管理 | 8 | 3 | 4 | 1 | 0 |
| **性能** | **16** | 8 | 8 | 0 | 0 |
| - 精度 | 6 | 3 | 3 | 0 | 0 |
| - 速度と成功率 | 5 | 3 | 2 | 0 | 0 |
| - 検出 | 5 | 2 | 3 | 0 | 0 |
| **ハードウェア** | **21** | 10 | 9 | 2 | 0 |
| - カメラ | 9 | 5 | 3 | 1 | 0 |
| - マーカー | 8 | 4 | 4 | 0 | 0 |
| - 照明 | 4 | 1 | 2 | 1 | 0 |
| **ソフトウェア** | **24** | 13 | 7 | 4 | 0 |
| - ROS 2ノード | 6 | 4 | 0 | 2 | 0 |
| - 通信 | 8 | 4 | 3 | 1 | 0 |
| - ライブラリ | 5 | 3 | 2 | 0 | 0 |
| - 構成 | 5 | 2 | 2 | 1 | 0 |
| **安全** | **15** | 10 | 5 | 0 | 0 |
| - 衝突回避 | 4 | 3 | 1 | 0 | 0 |
| - 緊急停止 | 3 | 3 | 0 | 0 | 0 |
| - 故障処理 | 5 | 2 | 2 | 1 | 0 |
| - 車椅子安全 | 3 | 2 | 1 | 0 | 0 |
| **環境** | **12** | 2 | 7 | 3 | 0 |
| - 照明 | 4 | 1 | 2 | 1 | 0 |
| - 気象 | 4 | 0 | 2 | 2 | 0 |
| - 温度 | 4 | 1 | 2 | 1 | 0 |
| **統合** | **11** | 6 | 5 | 0 | 0 |
| - Nav2 | 4 | 3 | 1 | 0 | 0 |
| - eHMI | 4 | 0 | 3 | 1 | 0 |
| - 安全システム | 3 | 3 | 0 | 0 | 0 |
| **テスト** | **10** | 1 | 7 | 0 | 0 |
| - 単体テスト | 3 | 0 | 3 | 0 | 0 |
| - フィールドテスト | 4 | 1 | 3 | 0 | 0 |
| - 受入 | 3 | 0 | 1 | 0 | 0 |
| **合計** | **161** | **82 (51%)** | **65 (40%)** | **12 (7%)** | **0 (0%)** |

**優先度分布:**
- **必須（82要件、51%）**: 安全クリティカル、これなしでシステムは機能しない
- **高（65要件、40%）**: 信頼性とユーザー体験に重要
- **中（12要件、7%）**: あると良い機能、品質改善
- **低（0要件、0%）**: 将来の拡張

---

## 11. 受入基準

### 11.1 最小実行可能製品（MVP）

**MVP定義:** 屋外で90%成功率、±10mm精度の機能的ドッキングシステム。

**MVP要件:**
- ✅ すべての必須要件（82合計）を満たさなければならない
- ✅ 10 Hz、0.5-3m範囲でArUco検出動作
- ✅ ±10mm精度を達成するビジュアルサーボイング
- ✅ APPROACH → SEARCH → SERVOING → DOCKED状態機械
- ✅ デュアルカメラフュージョン機能
- ✅ 障害物検出時の安全停止
- ✅ 100屋外試行で90%成功率

**MVP除外:**
- 夜間動作（日中を要求可能）
- 雨天動作（乾燥条件を要求可能）
- 高度なPIDチューニング（基本チューニング許容）

---

### 11.2 製品準備完了

**製品定義:** すべての必須+高要件を満たす堅牢で耐候性のあるシステム。

**製品要件:**
- ✅ すべての必須（82）+すべての高（65）要件満足 = 147合計
- ✅ 1000試行で屋外95%成功率
- ✅ 屋外±5mm位置精度、屋内±2mm
- ✅ アクティブLED照明での夜間動作
- ✅ 小雨動作（<2.5mm/hr）
- ✅ 100回の成功した夜間テスト
- ✅ 50回の成功した雨天テスト
- ✅ すべてのハードウェアでIP66+防水性
- ✅ マーカーで1000時間UV耐久性テスト

---

## 12. トレーサビリティ

### 12.1 親要件トレーサビリティ

本文書はSYSTEM_REQUIREMENTS.md（DOCK-REQ）から要件を派生:

| システム要件 | 派生ドッキング要件 | ステータス |
|-------------|------------------|-----------|
| DOCK-REQ-001（ArUco検出10 Hz） | DOCK-ARUCO-002、DOCK-PERF-DET-001 | トレース済み |
| DOCK-REQ-002（屋外ナビゲーション） | DOCK-INT-NAV-001～004 | トレース済み |
| DOCK-REQ-003（屋外±2-5mm精度） | DOCK-PERF-PREC-002、DOCK-VS-005 | トレース済み |
| DOCK-REQ-004（屋内±1mm目標） | DOCK-PERF-PREC-001 | トレース済み |
| DOCK-REQ-005（4-8 ArUcoマーカー） | DOCK-MARKER-001 | トレース済み |
| DOCK-REQ-006（OpenCV ArUcoライブラリ） | DOCK-SW-LIB-001 | トレース済み |
| DOCK-REQ-007（デュアルRGBカメラ） | DOCK-CAM-001、DOCK-HW-CAM-001 | トレース済み |
| DOCK-REQ-008（小雨でのドッキング） | DOCK-ENV-WEATHER-001～002 | トレース済み |
| DOCK-REQ-009（>95%成功率） | DOCK-PERF-SPEED-002 | トレース済み |
| DOCK-REQ-010（2段階ドッキング） | DOCK-SM-001～003 | トレース済み |

**すべてのシステムレベルドッキング要件がサブシステム要件にトレース済み。** ✅

---

## 13. 変更履歴

| バージョン | 日付 | 作成者 | 変更内容 |
|---------|------|--------|---------|
| 1.0 | 2025-12-15 | システムアーキテクト | SYSTEM_REQUIREMENTS.md、question_answers.md、EHMI_SYSTEM_REFERENCE.mdに基づく初版要件仕様 |

---

## 付録A: リファレンスアーキテクチャ

### ドッキングシステムブロック図

```
┌─────────────────────────────────────────────────────────────────┐
│                     ドッキングサブシステム                        │
│                                                                 │
│  ┌──────────────┐          ┌──────────────────┐               │
│  │  カメラ L    │──────────│  ArUco検出器     │               │
│  │  (1920×1080) │          │  ノード (OpenCV)  │               │
│  └──────────────┘          │                  │               │
│                             │  - 検出 10Hz     │               │
│  ┌──────────────┐          │  - 姿勢 6自由度  │               │
│  │  カメラ R    │──────────│  - TF2発行       │               │
│  │  (1920×1080) │          └────────┬─────────┘               │
│  └──────────────┘                   │                          │
│                                      │ /aruco_detections        │
│                                      ↓                          │
│  ┌──────────────┐          ┌──────────────────┐               │
│  │  Nav2        │────────→ │  ドッキング状態  │               │
│  │  (接近)      │ウェイポイント│  機械            │               │
│  └──────────────┘          │                  │               │
│                             │  IDLE            │               │
│                             │  APPROACH        │               │
│                             │  SEARCH          │               │
│                             │  SERVOING ◄──────┼───┐          │
│                             │  DOCKED          │   │          │
│                             │  UNDOCKING       │   │          │
│                             └────────┬─────────┘   │          │
│                                      │             │          │
│                                      │ 状態        │          │
│                                      ↓             │          │
│  ┌──────────────┐          ┌──────────────────┐   │          │
│  │  /cmd_vel    │◄─────────│  ビジュアル      │◄──┘          │
│  │  (スワーブ)  │          │  サーボイング    │   /aruco_detections
│  └──────────────┘          │  コントローラ    │               │
│                             │                  │               │
│                             │  - PID (X,Y,θ)   │               │
│                             │  - アンチワインドアップ│            │
│                             │  - 速度制限      │               │
│                             └──────────────────┘               │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

**文書ステータス:** ドラフト
**次回レビュー:** 設計フェーズ完了後
**承認必要:** システムアーキテクト、安全エンジニア、ナビゲーションリード

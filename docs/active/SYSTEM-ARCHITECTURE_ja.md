# ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ - ç¾åœ¨ã¨ææ¡ˆ

**æœ€çµ‚æ›´æ–°æ—¥:** 2025-12-02
**ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒãƒ¼ã‚¸ãƒ§ãƒ³:** 1.0
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:** ç¾åœ¨ (61% å®Œäº†) â†’ ææ¡ˆ (4ãƒ•ã‚§ãƒ¼ã‚ºã§100%ã¸)

---

## ç›®æ¬¡

### ãƒ‘ãƒ¼ãƒˆ1: ç¾åœ¨ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ (æ—¢å­˜ã®ã‚‚ã®)
1. [ã‚·ã‚¹ãƒ†ãƒ æ¦‚è¦](#1-ã‚·ã‚¹ãƒ†ãƒ æ¦‚è¦)
2. [ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£](#2-ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£)
3. [é€šä¿¡ãƒ‘ã‚¿ãƒ¼ãƒ³](#3-é€šä¿¡ãƒ‘ã‚¿ãƒ¼ãƒ³)
4. [ä¸»è¦ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ](#4-ä¸»è¦ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ )
5. [ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼](#5-ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼)

### ãƒ‘ãƒ¼ãƒˆ2: ææ¡ˆã•ã‚ŒãŸã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ (ãƒ•ã‚§ãƒ¼ã‚º1-4)
6. [ã‚»ãƒ¼ãƒ•ãƒ†ã‚£ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£](#6-ææ¡ˆã•ã‚ŒãŸã‚»ãƒ¼ãƒ•ãƒ†ã‚£ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ãƒ•ã‚§ãƒ¼ã‚º-1)
7. [çŠ¶æ…‹ç®¡ç†](#7-ææ¡ˆã•ã‚ŒãŸçŠ¶æ…‹ç®¡ç†ãƒ•ã‚§ãƒ¼ã‚º-1)
8. [ROS 2ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹](#8-ææ¡ˆã•ã‚ŒãŸros-2æ”¹å–„ãƒ•ã‚§ãƒ¼ã‚º-3)
9. [ãƒ†ã‚¹ãƒˆã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£](#9-ææ¡ˆã•ã‚ŒãŸãƒ†ã‚¹ãƒˆã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ãƒ•ã‚§ãƒ¼ã‚º-2)
10. [ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£](#10-ææ¡ˆã•ã‚ŒãŸãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ãƒ•ã‚§ãƒ¼ã‚º-4)

---

# ãƒ‘ãƒ¼ãƒˆ1: ç¾åœ¨ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

## 1. ã‚·ã‚¹ãƒ†ãƒ æ¦‚è¦

### 1.1 ãƒã‚¤ãƒ¬ãƒ™ãƒ«ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  MultiGo Navigation System                  â”‚
â”‚              (ROS 2 Humble on Ubuntu 22.04)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                  â”‚                  â”‚
   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
   â”‚ Master  â”‚       â”‚  Nav &  â”‚       â”‚Hardware â”‚
   â”‚ Control â”‚       â”‚ Docking â”‚       â”‚ Drivers â”‚
   â”‚multigo_ â”‚       â”‚multigo_ â”‚       â”‚multigo_ â”‚
   â”‚ master  â”‚       â”‚navigationâ”‚      â”‚ launch  â”‚
   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
        â”‚                 â”‚                  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Calibration  â”‚
                    â”‚MultiGoAruco  â”‚
                    â”‚     Test     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

| ãƒ¬ã‚¤ãƒ¤ãƒ¼ | æŠ€è¡“ |
|-------|-----------|
| **ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯** | ROS 2 Humble (LTS) |
| **OS** | Ubuntu 22.04 LTS |
| **è¨€èª** | C++17, Python 3.10 |
| **ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³** | Nav2 (æ¥­ç•Œæ¨™æº–) |
| **SLAM** | RTAB-Map (ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«SLAM) |
| **ãƒ“ã‚¸ãƒ§ãƒ³** | OpenCV 4.x (ArUcoãƒãƒ¼ã‚«ãƒ¼) |
| **ãƒ“ãƒ«ãƒ‰** | colcon |
| **ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢** | Phidget22 (ãƒ¢ãƒ¼ã‚¿ãƒ¼åˆ¶å¾¡) |

### 1.3 åˆ¶å¾¡éšå±¤ (5ãƒ¬ã‚¤ãƒ¤ãƒ¼)

```
ãƒ¬ã‚¤ãƒ¤ãƒ¼1: ãƒŸãƒƒã‚·ãƒ§ãƒ³åˆ¶å¾¡ (multigo_master)
         â”œâ”€â†’ nav_master_node: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹
         â”œâ”€â†’ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
         â””â”€â†’ ã‚»ãƒ¼ãƒ•ãƒ†ã‚£ç¢ºèª

ãƒ¬ã‚¤ãƒ¤ãƒ¼2: ã‚¿ã‚¹ã‚¯å®Ÿè¡Œ (multigo_navigation)
         â”œâ”€â†’ nav_goal_node: ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚µãƒ¼ãƒãƒ¼
         â”œâ”€â†’ nav_docking_node: ãƒ‰ãƒƒã‚­ãƒ³ã‚°ã‚µãƒ¼ãƒãƒ¼
         â””â”€â†’ çŠ¶æ…‹ç®¡ç† (åŸºæœ¬)

ãƒ¬ã‚¤ãƒ¤ãƒ¼3: ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³ãƒ‹ãƒ³ã‚° (Nav2 + nav_control)
         â”œâ”€â†’ Nav2 ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼ (NavFn)
         â”œâ”€â†’ Nav2 ãƒ­ãƒ¼ã‚«ãƒ«ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼ (DWB)
         â”œâ”€â†’ nav_control: ã‚­ãƒãƒãƒ†ã‚£ã‚¯ã‚¹
         â””â”€â†’ ã‚³ã‚¹ãƒˆãƒãƒƒãƒ—ç®¡ç†

ãƒ¬ã‚¤ãƒ¤ãƒ¼4: ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ (mecanum_wheels)
         â”œâ”€â†’ é€†é‹å‹•å­¦
         â”œâ”€â†’ ãƒ›ã‚¤ãƒ¼ãƒ«æ¯ã®PID
         â””â”€â†’ Phidget22ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹

ãƒ¬ã‚¤ãƒ¤ãƒ¼5: ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢
         â””â”€â†’ 4Ã— BLDCãƒ¢ãƒ¼ã‚¿ãƒ¼ã€ãƒ¡ã‚«ãƒŠãƒ ãƒ›ã‚¤ãƒ¼ãƒ«ã€ã‚¨ãƒ³ã‚³ãƒ¼ãƒ€ãƒ¼
```

---

## 2. ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### 2.1 ãƒã‚¹ã‚¿ãƒ¼åˆ¶å¾¡ (`multigo_master`)

**ç›®çš„:** ãƒã‚¤ãƒ¬ãƒ™ãƒ«ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³

**ä¸»è¦ãƒãƒ¼ãƒ‰:** `nav_master_node`

**è²¬ä»»:**
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ç¢ºèªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ (ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ â†’ ãƒ‰ãƒƒã‚­ãƒ³ã‚°)
- ãƒã‚¤ãƒ¬ãƒ™ãƒ«ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

**ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ:**
1. `/approach` - ãƒ‰ãƒƒã‚­ãƒ³ã‚°ã‚¾ãƒ¼ãƒ³ã¸ã®ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒˆãƒªã‚¬ãƒ¼
2. `/dock` - ç²¾å¯†ãƒ‰ãƒƒã‚­ãƒ³ã‚°ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ã‚’ãƒˆãƒªã‚¬ãƒ¼

**ç¾åœ¨ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼:**
```cpp
// ç°¡ç•¥åŒ–ã•ã‚ŒãŸãƒ•ãƒ­ãƒ¼
1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’ãƒˆãƒªã‚¬ãƒ¼
2. nav_master: "ãƒ‰ãƒƒã‚­ãƒ³ã‚°ã‚¹ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã«ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã—ã¾ã™ã‹? (y/n)"
3. ãƒ¦ãƒ¼ã‚¶ãƒ¼ç¢ºèª â†’ /approach ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å‘¼ã³å‡ºã—
4. ã‚¢ãƒ—ãƒ­ãƒ¼ãƒå®Œäº†ã‚’å¾…ã¤
5. nav_master: "ãƒ‰ãƒƒã‚­ãƒ³ã‚°ã‚’é–‹å§‹ã—ã¾ã™ã‹? (y/n)"
6. ãƒ¦ãƒ¼ã‚¶ãƒ¼ç¢ºèª â†’ /dock ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å‘¼ã³å‡ºã—
7. ãƒ‰ãƒƒã‚­ãƒ³ã‚°å®Œäº†ã‚’å¾…ã¤
8. æˆåŠŸ/å¤±æ•—ã‚’å ±å‘Š
```

**å•é¡Œç‚¹:**
- âŒ æ˜ç¤ºçš„ãªçŠ¶æ…‹ãƒã‚·ãƒ³ãŒãªã„ (ãƒ­ãƒœãƒƒãƒˆçŠ¶æ…‹ã®è¿½è·¡ãŒå›°é›£)
- âŒ ã‚·ãƒ¼ã‚±ãƒ³ã‚·ãƒ£ãƒ«ã®ã¿ (è¤‡é›‘ãªãƒ•ãƒ­ãƒ¼ã‚’å‡¦ç†ã§ããªã„)
- âŒ ã‚­ãƒ£ãƒ³ã‚»ãƒ«ä»¥å¤–ã®ã‚¨ãƒ©ãƒ¼ãƒªã‚«ãƒãƒªãƒ¼ãŒãªã„

---

### 2.2 ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ (`multigo_navigation`)

#### 2.2.1 ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚´ãƒ¼ãƒ«è¨ˆç®— (`nav_goal`)

**ãƒãƒ¼ãƒ‰:** `nav_goal_node`

**ç›®çš„:** ãƒãƒ¼ã‚«ãƒ¼ã‚’æ¤œå‡ºã—ã€ã‚¢ãƒ—ãƒ­ãƒ¼ãƒä½ç½®ã‚’è¨ˆç®—ã—ã€Nav2ã«ã‚´ãƒ¼ãƒ«ã‚’é€ä¿¡

**ãƒ•ã‚¡ã‚¤ãƒ«:** `src/nav_goal/nav_goal.cpp`

**ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ :**
```cpp
1. /aruco_detect/markers_left ã‚’ã‚µãƒ–ã‚¹ã‚¯ãƒ©ã‚¤ãƒ–
2. ç›®çš„ã®ãƒãƒ¼ã‚«ãƒ¼ (ID 20) ã‚’æ¤œå‡º
3. ã‚«ãƒ¡ãƒ©ãƒ•ãƒ¬ãƒ¼ãƒ ã§ã®ãƒãƒ¼ã‚«ãƒ¼å§¿å‹¢ã‚’å–å¾—
4. TF2ã‚’ä½¿ç”¨ã—ã¦ãƒãƒƒãƒ—ãƒ•ãƒ¬ãƒ¼ãƒ ã«å¤‰æ›
5. ã‚ªãƒ•ã‚»ãƒƒãƒˆã‚´ãƒ¼ãƒ«ã‚’è¨ˆç®— (marker_pos + offset * marker_direction)
   - offset = 0.305m (aruco_distance_offsetã§è¨­å®šå¯èƒ½)
6. /goal_pose (PoseStamped) ã‚’ãƒ‘ãƒ–ãƒªãƒƒã‚·ãƒ¥
7. Nav2ãŒã‚´ãƒ¼ãƒ«ã«ãƒŠãƒ“ã‚²ãƒ¼ãƒˆ
8. Nav2å®Œäº†æ™‚ã«æˆåŠŸã‚’å ±å‘Š
```

**ç²¾åº¦:** Â±5cm (Nav2ã®ç²—ã„ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã«ã¯ååˆ†)

**ãƒˆãƒ”ãƒƒã‚¯:**
- **ã‚µãƒ–ã‚¹ã‚¯ãƒ©ã‚¤ãƒ–:** `/aruco_detect/markers_left` (PoseArray)
- **ãƒ‘ãƒ–ãƒªãƒƒã‚·ãƒ¥:** `/goal_pose` (PoseStamped)

**ã‚¢ã‚¯ã‚·ãƒ§ãƒ³:**
- **ã‚µãƒ¼ãƒãƒ¼:** `/approach` (nav_interface::action::Approach)
- **ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ:** `/navigate_to_pose` (nav2_msgs::action::NavigateToPose)

---

#### 2.2.2 ç²¾å¯†ãƒ‰ãƒƒã‚­ãƒ³ã‚° (`nav_docking`)

**ãƒãƒ¼ãƒ‰:** `nav_docking_node`

**ç›®çš„:** PIDåˆ¶å¾¡ã‚’ä½¿ç”¨ã—ãŸÂ±1mmç²¾åº¦ã®ç²¾å¯†ãƒ‰ãƒƒã‚­ãƒ³ã‚°ã®ãŸã‚ã®ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ã‚µãƒ¼ãƒœã‚¤ãƒ³ã‚°

**ãƒ•ã‚¡ã‚¤ãƒ«:** `src/nav_docking/nav_docking.cpp`

**2æ®µéšãƒ‰ãƒƒã‚­ãƒ³ã‚°:**

**ã‚¹ãƒ†ãƒ¼ã‚¸1: å˜ä¸€å‰æ–¹ãƒãƒ¼ã‚«ãƒ¼ (è·é›¢ > 0.7m)**
```cpp
void frontMarkerCmdVelPublisher() {
    // å·¦ãƒãƒ¼ã‚«ãƒ¼ (ID 20) ã®ã¿ä½¿ç”¨
    double error_dist = current_distance - target_distance;
    double error_y = marker_y_position;  // ã‚»ãƒ³ã‚¿ãƒªãƒ³ã‚°
    double error_yaw = marker_yaw;

    // å„è»¸ã®PIDåˆ¶å¾¡
    integral_dist_ += error_dist * dt;  // ç©ç®— (ãƒ•ã‚§ãƒ¼ã‚º1ã§ãƒã‚°ä¿®æ­£æ¸ˆã¿)
    double derivative = (error_dist - prev_error_dist_) / dt;

    double vel_x = Kp_dist * error_dist
                 + Ki_dist * integral_dist_
                 + Kd_dist * derivative;

    // Yã¨Yawã«ã¤ã„ã¦ã‚‚åŒæ§˜
    publishVelocity(vel_x, vel_y, vel_yaw);
}
```

**ã‚¹ãƒ†ãƒ¼ã‚¸2: ãƒ‡ãƒ¥ã‚¢ãƒ«ãƒãƒ¼ã‚«ãƒ¼ (è·é›¢ < 0.7m)**
```cpp
void dualMarkerCmdVelPublisher() {
    // æœ€å¤§ç²¾åº¦ã®ãŸã‚ã«ä¸¡æ–¹ã®ãƒãƒ¼ã‚«ãƒ¼ã‚’ä½¿ç”¨
    double center_x = (left_marker_x + right_marker_x) / 2;
    double center_y = (left_marker_y + right_marker_y) / 2;

    // ä¸­å¿ƒã‹ã‚‰ã®èª¤å·®ã‚’è¨ˆç®—
    double error_dist = center_x - target_distance_dual;
    double error_y = center_y;
    double error_yaw = calculateYawFromTwoMarkers();

    // åŒã˜PIDåˆ¶å¾¡ã€ã‚ˆã‚Šé«˜ç²¾åº¦
    // ...
}
```

**ã‚¹ãƒ†ãƒ¼ã‚¸é·ç§»:** `distance < dual_aruco_distance_th (0.7m)` ã‹ã¤ ä¸¡ãƒãƒ¼ã‚«ãƒ¼ãŒè¦‹ãˆã‚‹æ™‚

**ãƒ‰ãƒƒã‚­ãƒ³ã‚°ç¢ºèª (2æ®µéšæ¤œè¨¼):**
```cpp
void checkDockingCompletion() {
    if (distance < aruco_close_th && position_stable) {
        if (!first_confirmation_received_) {
            first_confirmation_received_ = true;
            wait(3.0);  // å®‰å®šæ€§ãƒã‚§ãƒƒã‚¯
        } else if (!second_confirmation_received_) {
            if (still_within_threshold) {
                second_confirmation_received_ = true;
                reportSuccess();
            }
        }
    }
}
```

**PIDãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿:**
```yaml
# è·é›¢åˆ¶å¾¡
Kp_dist: 0.5
Ki_dist: 0.1
Kd_dist: 0.05

# Yè»¸ã‚»ãƒ³ã‚¿ãƒªãƒ³ã‚°
Kp_y: 0.8
Ki_y: 0.05
Kd_y: 0.1

# å›è»¢åˆ¶å¾¡
Kp_yaw: 0.6
Ki_yaw: 0.08
Kd_yaw: 0.12
```

**é–¾å€¤:**
```yaml
aruco_distance_offset: 0.305          # ã‚¹ãƒ†ãƒ¼ã‚¸1ã®ç›®æ¨™è·é›¢
dual_aruco_distance_th: 0.700         # ã‚¹ãƒ†ãƒ¼ã‚¸2ã¸ã®åˆ‡ã‚Šæ›¿ãˆ
aruco_distance_offset_dual: 0.430     # ã‚¹ãƒ†ãƒ¼ã‚¸2ã®ç›®æ¨™è·é›¢
aruco_close_th: 0.42                  # æœ€çµ‚ã‚¢ãƒ—ãƒ­ãƒ¼ãƒé–¾å€¤
```

**ãƒˆãƒ”ãƒƒã‚¯:**
- **ã‚µãƒ–ã‚¹ã‚¯ãƒ©ã‚¤ãƒ–:**
  - `/aruco_detect/markers_left` (PoseArray)
  - `/aruco_detect/markers_right` (PoseArray)
- **ãƒ‘ãƒ–ãƒªãƒƒã‚·ãƒ¥:** `/cmd_vel_final` (Twist)

**ã‚¢ã‚¯ã‚·ãƒ§ãƒ³:**
- **ã‚µãƒ¼ãƒãƒ¼:** `/dock` (nav_interface::action::Dock)

**æ—¢çŸ¥ã®å•é¡Œ (ãƒ•ã‚§ãƒ¼ã‚º1ã§ä¿®æ­£æ¸ˆã¿):**
- âš ï¸ **CRIT-01:** PIDç©åˆ†ãŒç´¯ç©ã•ã‚Œãªã„ (197è¡Œç›®)
- âš ï¸ **CRIT-02:** ãƒ‡ãƒ¥ã‚¢ãƒ«ãƒãƒ¼ã‚«ãƒ¼è·é›¢è¨ˆç®—ã®ãƒã‚° (387, 503è¡Œç›®)
- âš ï¸ **HIGH-01:** åˆæœŸåŒ–ã•ã‚Œã¦ã„ãªã„å¤‰æ•°

---

#### 2.2.3 é€Ÿåº¦åˆ¶å¾¡ (`nav_control`)

**ãƒãƒ¼ãƒ‰:** `nav_control_node`

**ç›®çš„:** å‹•ä½œãƒ¢ãƒ¼ãƒ‰ (å›è»¢ä¸­å¿ƒ) ã«åŸºã¥ã„ã¦é€Ÿåº¦ã‚³ãƒãƒ³ãƒ‰ã‚’èª¿æ•´

**ãƒ•ã‚¡ã‚¤ãƒ«:** `src/nav_control/nav_control.cpp`

**ãƒ¢ãƒ¼ãƒ‰:**
1. **SOLO** - ä¸­å¿ƒå›è»¢ (é€šå¸¸ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³)
2. **DOCKING** - å‰æ–¹å›è»¢ (ç²¾å¯†ãƒ‰ãƒƒã‚­ãƒ³ã‚°)
3. **COMBINE_CHAIR** - é æ–¹å‰æ–¹å›è»¢ (è»Šæ¤…å­æ¥ç¶šæ™‚)

**ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ :**
```cpp
void adjustVelocityForMode(Twist& cmd_vel, NavigationMode mode) {
    double rotation_center_offset;

    switch(mode) {
        case SOLO:
            rotation_center_offset = 0.0;   // ä¸­å¿ƒå‘¨ã‚Šã®å›è»¢
            break;
        case DOCKING:
            rotation_center_offset = 0.25;  // 25cmå‰æ–¹
            break;
        case COMBINE_CHAIR:
            rotation_center_offset = 0.50;  // 50cmå‰æ–¹
            break;
    }

    // å¸Œæœ›ã™ã‚‹å›è»¢ä¸­å¿ƒã‚’é”æˆã™ã‚‹ãŸã‚ã«ä¸¦é€²é€Ÿåº¦ã‚’èª¿æ•´
    cmd_vel.linear.x += cmd_vel.angular.z * rotation_center_offset;
}
```

**ãƒˆãƒ”ãƒƒã‚¯:**
- **ã‚µãƒ–ã‚¹ã‚¯ãƒ©ã‚¤ãƒ–:**
  - `/cmd_vel` (Nav2ã‹ã‚‰)
  - `/cmd_vel_final` (nav_dockingã‹ã‚‰)
  - `/navigation_mode` (ãƒ¢ãƒ¼ãƒ‰é¸æŠ)
- **ãƒ‘ãƒ–ãƒªãƒƒã‚·ãƒ¥:** `/cmd_vel_adjusted` (Twist)

---

#### 2.2.4 ArUcoãƒãƒ¼ã‚«ãƒ¼æ¤œå‡º (`aruco_detect`)

**ãƒãƒ¼ãƒ‰:** `aruco_detect_node`

**ç›®çš„:** ArUcoãƒãƒ¼ã‚«ãƒ¼ã‚’æ¤œå‡ºã—6DOFå§¿å‹¢ã‚’æ¨å®š

**ãƒ•ã‚¡ã‚¤ãƒ«:** `src/aruco_detect/aruco_detect.cpp`

**ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ :**
```cpp
void detectMarkers() {
    // 1. ã‚«ãƒ¡ãƒ©ã‹ã‚‰ç”»åƒã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£
    cv::Mat image = camera_image_;

    // 2. ãƒãƒ¼ã‚«ãƒ¼ã‚’æ¤œå‡º (OpenCV ArUco)
    std::vector<int> marker_ids;
    std::vector<std::vector<cv::Point2f>> marker_corners;
    cv::aruco::detectMarkers(
        image,
        dictionary,  // DICT_6X6_250
        marker_corners,
        marker_ids
    );

    // 3. å„ãƒãƒ¼ã‚«ãƒ¼ã®å§¿å‹¢ã‚’æ¨å®š
    for (size_t i = 0; i < marker_ids.size(); i++) {
        cv::Vec3d rvec, tvec;
        cv::aruco::estimatePoseSingleMarkers(
            marker_corners[i],
            marker_size,      // 0.15m (ç‰©ç†ã‚µã‚¤ã‚º)
            camera_matrix,    // ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‹ã‚‰
            dist_coeffs,      // ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‹ã‚‰
            rvec, tvec
        );

        // 4. OpenCVãƒ•ãƒ¬ãƒ¼ãƒ ã‚’ROSãƒ•ãƒ¬ãƒ¼ãƒ ã«å¤‰æ›
        // OpenCV: X-å³, Y-ä¸‹, Z-å‰
        // ROS:    X-å‰, Y-å·¦, Z-ä¸Š
        geometry_msgs::msg::Pose marker_pose = convertToROSFrame(rvec, tvec);

        // 5. å§¿å‹¢ã‚’ãƒ‘ãƒ–ãƒªãƒƒã‚·ãƒ¥
        publishMarkerPose(marker_ids[i], marker_pose);
    }
}
```

**ãƒãƒ¼ã‚«ãƒ¼è¨­å®š:**
- **å·¦ãƒãƒ¼ã‚«ãƒ¼:** ID 20 (å‰æ–¹ã€ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã«ä½¿ç”¨)
- **å³ãƒãƒ¼ã‚«ãƒ¼:** ID 21 (ãƒ‡ãƒ¥ã‚¢ãƒ«ãƒãƒ¼ã‚«ãƒ¼ç²¾åº¦ã«ä½¿ç”¨)
- **ãƒãƒ¼ã‚«ãƒ¼ã‚µã‚¤ã‚º:** 0.15m (15cm)
- **è¾æ›¸:** DICT_6X6_250

**ãƒˆãƒ”ãƒƒã‚¯:**
- **ã‚µãƒ–ã‚¹ã‚¯ãƒ©ã‚¤ãƒ–:**
  - `/camera/color/image_raw_left` (Image)
  - `/camera/color/image_raw_right` (Image)
- **ãƒ‘ãƒ–ãƒªãƒƒã‚·ãƒ¥:**
  - `/aruco_detect/markers_left` (PoseArray)
  - `/aruco_detect/markers_right` (PoseArray)
  - TFå¤‰æ›: `camera â†’ aruco_marker_20`, `aruco_marker_21`

---

### 2.3 ã‚µãƒ¼ãƒ‰ãƒ‘ãƒ¼ãƒ†ã‚£çµ±åˆ

#### 2.3.1 Nav2 (Navigation2 Stack)

**ç›®çš„:** æ¥­ç•Œæ¨™æº–ã®è‡ªå¾‹ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯

**Nav2ãŒæä¾›ã™ã‚‹ã‚‚ã®:**
- ã‚°ãƒ­ãƒ¼ãƒãƒ«çµŒè·¯è¨ˆç”» (NavFnãƒ—ãƒ©ãƒ³ãƒŠãƒ¼)
- ãƒ­ãƒ¼ã‚«ãƒ«è»Œé“è¨ˆç”» (DWBãƒ­ãƒ¼ã‚«ãƒ«ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼)
- ã‚³ã‚¹ãƒˆãƒãƒƒãƒ—ç®¡ç† (é™çš„ã€éšœå®³ç‰©ã€è†¨å¼µãƒ¬ã‚¤ãƒ¤ãƒ¼)
- ãƒªã‚«ãƒãƒªãƒ¼å‹•ä½œ (ã‚¹ãƒ”ãƒ³ã€ãƒãƒƒã‚¯ã€å¾…æ©Ÿ)
- ãƒ“ãƒ˜ã‚¤ãƒ“ã‚¢ãƒ„ãƒªãƒ¼å®Ÿè¡Œ

**çµ±åˆãƒã‚¤ãƒ³ãƒˆ:**
```
MultiGo â†’ Nav2:
- å…¥åŠ›: /goal_pose (PoseStamped)
- å…¥åŠ›: /map (RTAB-Mapã‹ã‚‰ã®OccupancyGrid)
- å…¥åŠ›: /scan (LiDARã‹ã‚‰ã®LaserScan)
- å…¥åŠ›: /tf (å¤‰æ›)

Nav2 â†’ MultiGo:
- å‡ºåŠ›: /cmd_vel (Twist) â†’ nav_control
- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³: /navigate_to_pose
```

**ä¸»è¦è¨­å®š (`nav2_params.yaml` - 357è¡Œ):**

```yaml
controller_server:
  FollowPath:
    plugin: "dwb_core::DWBLocalPlanner"
    max_vel_x: 0.26        # m/s (ã‚†ã£ãã‚Šæ­©ãé€Ÿåº¦)
    max_vel_theta: 1.0     # rad/s
    max_vel_y: 0.0         # âš ï¸ ç„¡åŠ¹ (ãƒ›ãƒ­ãƒãƒŸãƒƒã‚¯ã«ã¯0.15ã§ã‚ã‚‹ã¹ã)
    acc_lim_x: 2.5         # m/sÂ²
    acc_lim_theta: 3.2     # rad/sÂ²

planner_server:
  GridBased:
    plugin: "nav2_navfn_planner::NavfnPlanner"
    tolerance: 0.5         # ã‚´ãƒ¼ãƒ«è¨±å®¹èª¤å·® (ãƒ¡ãƒ¼ãƒˆãƒ«)
    use_astar: false       # ãƒ€ã‚¤ã‚¯ã‚¹ãƒˆãƒ©ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ 
    allow_unknown: true    # æœªæ¢ç´¢ã‚¨ãƒªã‚¢ã‚’é€šã£ã¦è¨ˆç”»å¯èƒ½

global_costmap:
  robot_radius: 0.28       # ãƒ¡ãƒ¼ãƒˆãƒ«
  resolution: 0.05         # 5cmã‚°ãƒªãƒƒãƒ‰ã‚»ãƒ«
  inflation_radius: 0.55   # ã‚»ãƒ¼ãƒ•ãƒ†ã‚£ãƒãƒ¼ã‚¸ãƒ³
  plugins:
    - "static_layer"       # ãƒãƒƒãƒ—ã‹ã‚‰
    - "obstacle_layer"     # LiDARã‹ã‚‰
    - "inflation_layer"    # ã‚»ãƒ¼ãƒ•ãƒ†ã‚£ãƒãƒƒãƒ•ã‚¡

local_costmap:
  width: 3.0               # 3m Ã— 3m ãƒ—ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°ãƒ›ãƒ©ã‚¤ã‚ºãƒ³
  height: 3.0
  update_frequency: 5.0    # Hz
```

**é‡å¤§ãªå•é¡Œ:**
- âš ï¸ **CRIT-09:** ãƒ›ãƒ­ãƒãƒŸãƒƒã‚¯å‹•ä½œãŒç„¡åŠ¹ (`max_vel_y = 0`)
- **å½±éŸ¿:** ãƒ¡ã‚«ãƒŠãƒ ãƒ›ã‚¤ãƒ¼ãƒ«ãŒååˆ†ã«æ´»ç”¨ã•ã‚Œãšã€ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ä¸­ã«æ¨ªç§»å‹•ã§ããªã„
- **ä¿®æ­£ (ãƒ•ã‚§ãƒ¼ã‚º3):** ãƒ›ãƒ­ãƒãƒŸãƒƒã‚¯å‹•ä½œç”¨ã«DWBã‚’è¨­å®š

---

#### 2.3.2 RTAB-Map (Visual SLAM)

**ç›®çš„:** ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚¢ãƒ”ã‚¢ãƒ©ãƒ³ã‚¹ãƒ™ãƒ¼ã‚¹ãƒãƒƒãƒ”ãƒ³ã‚°ã¨è‡ªå·±ä½ç½®æ¨å®š

**RTAB-MapãŒæä¾›ã™ã‚‹ã‚‚ã®:**
- ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«SLAM (ã‚«ãƒ¡ãƒ©ãƒ™ãƒ¼ã‚¹)
- ãƒ«ãƒ¼ãƒ—ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ£æ¤œå‡º (ãƒ‰ãƒªãƒ•ãƒˆè£œæ­£)
- 3Dãƒã‚¤ãƒ³ãƒˆã‚¯ãƒ©ã‚¦ãƒ‰ãƒãƒƒãƒ”ãƒ³ã‚°
- é•·æœŸãƒ¡ãƒ¢ãƒª (ã‚»ãƒƒã‚·ãƒ§ãƒ³é–“ã§ç’°å¢ƒã‚’è¨˜æ†¶)
- Nav2ç”¨ã®2Då æœ‰ã‚°ãƒªãƒƒãƒ‰

**å…¥åŠ›:**
- RGBã‚«ãƒ¡ãƒ©ç”»åƒ (å·¦ + å³)
- LiDARã‚¹ã‚­ãƒ£ãƒ³ (`/scan`)
- ãƒ›ã‚¤ãƒ¼ãƒ«ã‚ªãƒ‰ãƒ¡ãƒˆãƒª (`/odom`)

**å‡ºåŠ›:**
- `/map` (OccupancyGrid) â†’ Nav2
- `/tf` å¤‰æ› `map â†’ odom` (è£œæ­£ã•ã‚ŒãŸè‡ªå·±ä½ç½®æ¨å®š)
- 3Dãƒã‚¤ãƒ³ãƒˆã‚¯ãƒ©ã‚¦ãƒ‰ãƒãƒƒãƒ— (ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³)

**è‡ªå·±ä½ç½®æ¨å®šæˆ¦ç•¥:**
```
è·é›¢ > 5m    : RTAB-Mapã®ã¿ (ãƒãƒ¼ã‚«ãƒ¼ãŒè¦‹ãˆãªã„)
1m < è·é›¢ < 5m : RTAB-Mapä¸»ã€ArUcoåˆ©ç”¨å¯èƒ½
è·é›¢ < 1m    : ArUcoãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ã‚µãƒ¼ãƒœã‚¤ãƒ³ã‚°ã«åˆ‡ã‚Šæ›¿ãˆ
```

**ãªãœãƒ‡ãƒ¥ã‚¢ãƒ«è‡ªå·±ä½ç½®æ¨å®š?**
- **RTAB-Map:** ã‚°ãƒ­ãƒ¼ãƒãƒ«ä¸€è²«æ€§ã€Â±5-10cmç²¾åº¦ã€ç„¡åˆ¶é™ç¯„å›²
- **ArUco:** ãƒ­ãƒ¼ã‚«ãƒ«ç²¾åº¦ã€Â±1mmç²¾åº¦ã€é™å®šç¯„å›² (0.5-5m)
- **ä¸¡æ–¹ã®é•·æ‰€ã‚’æ´»ç”¨**

---

### 2.4 ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³åˆ¶å¾¡

#### 2.4.1 ãƒ¡ã‚«ãƒŠãƒ ãƒ›ã‚¤ãƒ¼ãƒ« (`mecanum_wheels`)

**ãƒãƒ¼ãƒ‰:** `mecanum_wheels_node`

**ç›®çš„:** Twistã‚³ãƒãƒ³ãƒ‰ã‚’ãƒ›ã‚¤ãƒ¼ãƒ«é€Ÿåº¦ã«å¤‰æ›ã—ã€ãƒ¢ãƒ¼ã‚¿ãƒ¼ã‚’åˆ¶å¾¡

**ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ :**
```cpp
// ãƒ¡ã‚«ãƒŠãƒ ãƒ›ã‚¤ãƒ¼ãƒ«ã®é€†é‹å‹•å­¦
void twistToWheelVelocities(Twist cmd_vel) {
    double vx = cmd_vel.linear.x;
    double vy = cmd_vel.linear.y;
    double omega = cmd_vel.angular.z;

    // ãƒ¡ã‚«ãƒŠãƒ ãƒ›ã‚¤ãƒ¼ãƒ«ã®ã‚­ãƒãƒãƒ†ã‚£ã‚¯ã‚¹
    double wheel_fl = (1/r) * (vx - vy - (lx + ly) * omega);
    double wheel_fr = (1/r) * (vx + vy + (lx + ly) * omega);
    double wheel_rl = (1/r) * (vx + vy - (lx + ly) * omega);
    double wheel_rr = (1/r) * (vx - vy + (lx + ly) * omega);

    // ãƒ›ã‚¤ãƒ¼ãƒ«æ¯ã®PIDåˆ¶å¾¡
    for (int i = 0; i < 4; i++) {
        motor_command[i] = wheelPID(target[i], current[i]);
    }

    // Phidgetãƒ¢ãƒ¼ã‚¿ãƒ¼ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã«é€ä¿¡
    sendMotorCommands(motor_command);
}
```

**ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿:**
```yaml
WHEEL_BASE_LENGTH: 0.40m   # å‰å¾Œè·é›¢
WHEEL_BASE_WIDTH: 0.30m    # å·¦å³è·é›¢
WHEEL_DIAMETER: 0.0762m    # 3ã‚¤ãƒ³ãƒ
```

**ãƒˆãƒ”ãƒƒã‚¯:**
- **ã‚µãƒ–ã‚¹ã‚¯ãƒ©ã‚¤ãƒ–:** `/cmd_vel_adjusted` (Twist)
- **ãƒ‘ãƒ–ãƒªãƒƒã‚·ãƒ¥:** `/odom` (Odometry)

---

## 3. é€šä¿¡ãƒ‘ã‚¿ãƒ¼ãƒ³

### 3.1 ãƒˆãƒ”ãƒƒã‚¯ãƒãƒƒãƒ—

| ãƒˆãƒ”ãƒƒã‚¯ | ã‚¿ã‚¤ãƒ— | ãƒ‘ãƒ–ãƒªãƒƒã‚·ãƒ£ãƒ¼ | ã‚µãƒ–ã‚¹ã‚¯ãƒ©ã‚¤ãƒãƒ¼ | ç›®çš„ |
|-------|------|-----------|---------------|---------|
| `/camera/color/image_raw_left` | Image | camera_driver | aruco_detect | å·¦ã‚«ãƒ¡ãƒ©ãƒ•ã‚£ãƒ¼ãƒ‰ |
| `/camera/color/image_raw_right` | Image | camera_driver | aruco_detect | å³ã‚«ãƒ¡ãƒ©ãƒ•ã‚£ãƒ¼ãƒ‰ |
| `/scan` | LaserScan | lidar_driver | Nav2, RTAB-Map | LiDARãƒ‡ãƒ¼ã‚¿ |
| `/aruco_detect/markers_left` | PoseArray | aruco_detect | nav_goal, nav_docking | æ¤œå‡ºã•ã‚ŒãŸãƒãƒ¼ã‚«ãƒ¼ |
| `/aruco_detect/markers_right` | PoseArray | aruco_detect | nav_docking | æ¤œå‡ºã•ã‚ŒãŸãƒãƒ¼ã‚«ãƒ¼ |
| `/goal_pose` | PoseStamped | nav_goal | Nav2 | ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚´ãƒ¼ãƒ« |
| `/cmd_vel` | Twist | Nav2 | nav_control | ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒãƒ³ãƒ‰ |
| `/cmd_vel_final` | Twist | nav_docking | nav_control | ãƒ‰ãƒƒã‚­ãƒ³ã‚°ã‚³ãƒãƒ³ãƒ‰ |
| `/cmd_vel_adjusted` | Twist | nav_control | mecanum_wheels | æœ€çµ‚ã‚³ãƒãƒ³ãƒ‰ |
| `/odom` | Odometry | mecanum_wheels | Nav2, RTAB-Map | ãƒ›ã‚¤ãƒ¼ãƒ«ã‚ªãƒ‰ãƒ¡ãƒˆãƒª |
| `/map` | OccupancyGrid | RTAB-Map | Nav2 | 2Dã‚°ãƒªãƒƒãƒ‰ãƒãƒƒãƒ— |

### 3.2 ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒãƒƒãƒ—

| ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ | ã‚¿ã‚¤ãƒ— | ã‚µãƒ¼ãƒãƒ¼ | ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ | ç›®çš„ |
|--------|------|--------|--------|---------|
| `/approach` | Approach | nav_goal | nav_master | ãƒ‰ãƒƒã‚­ãƒ³ã‚°ã‚¾ãƒ¼ãƒ³ã¸ãƒŠãƒ“ã‚²ãƒ¼ãƒˆ |
| `/dock` | Dock | nav_docking | nav_master | ç²¾å¯†ãƒ‰ãƒƒã‚­ãƒ³ã‚° |
| `/navigate_to_pose` | NavigateToPose | Nav2 bt_navigator | nav_goal | Nav2ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ |

### 3.3 TFãƒ„ãƒªãƒ¼

```
map (RTAB-Map)
 â””â”€â†’ odom (ãƒ›ã‚¤ãƒ¼ãƒ«ã‚ªãƒ‰ãƒ¡ãƒˆãƒª)
      â””â”€â†’ base_link (ãƒ­ãƒœãƒƒãƒˆä¸­å¿ƒ)
           â”œâ”€â†’ base_footprint (åœ°é¢æŠ•å½±)
           â”œâ”€â†’ camera_left_link
           â”‚    â””â”€â†’ aruco_marker_20
           â”œâ”€â†’ camera_right_link
           â”‚    â””â”€â†’ aruco_marker_21
           â””â”€â†’ laser_link (LiDAR)
```

---

## 4. ä¸»è¦ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ 

### 4.1 PIDåˆ¶å¾¡ (ãƒ‰ãƒƒã‚­ãƒ³ã‚°)

**ç›®çš„:** ç›®æ¨™ä½ç½®ã¸ã®æ»‘ã‚‰ã‹ã§å®‰å®šã—ãŸã‚¢ãƒ—ãƒ­ãƒ¼ãƒ

**ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ :**
```cpp
double pidControl(double error, double Kp, double Ki, double Kd, double dt) {
    // æ¯”ä¾‹: ç¾åœ¨ã®èª¤å·®ã«åå¿œ
    double P = Kp * error;

    // ç©åˆ†: å®šå¸¸åå·®ã‚’æ’é™¤
    integral_ += error * dt;  // âš ï¸ ç´¯ç©å¿…é ˆ! (CRIT-01)
    double I = Ki * integral_;

    // å¾®åˆ†: æŒ¯å‹•ã‚’æ¸›è¡°
    double derivative = (error - prev_error_) / dt;
    double D = Kd * derivative;

    prev_error_ = error;

    return P + I + D;
}
```

**ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°:**
- **Kp** (æ¯”ä¾‹): é«˜ã„ = é€Ÿã„å¿œç­”ã€ã‚ªãƒ¼ãƒãƒ¼ã‚·ãƒ¥ãƒ¼ãƒˆã®ãƒªã‚¹ã‚¯
- **Ki** (ç©åˆ†): å®šå¸¸åå·®ã‚’æ’é™¤ã€ãƒ¯ã‚¤ãƒ³ãƒ‰ã‚¢ãƒƒãƒ—ã®ãƒªã‚¹ã‚¯
- **Kd** (å¾®åˆ†): æŒ¯å‹•ã‚’æ¸›è¡°ã€ãƒã‚¤ã‚ºã«æ•æ„Ÿ

**ç¾åœ¨ã®ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚° (è‰¯å¥½ã«å‹•ä½œ):**
- è·é›¢: Kp=0.5, Ki=0.1, Kd=0.05
- ã‚»ãƒ³ã‚¿ãƒªãƒ³ã‚°: Kp=0.8, Ki=0.05, Kd=0.1
- å›è»¢: Kp=0.6, Ki=0.08, Kd=0.12

---

### 4.2 ãƒ‡ãƒ¥ã‚¢ãƒ«ãƒãƒ¼ã‚«ãƒ¼ã‚»ãƒ³ã‚¿ãƒªãƒ³ã‚°

**ç›®çš„:** 2ã¤ã®ãƒãƒ¼ã‚«ãƒ¼é–“ã®ä¸­å¿ƒç·šã«å¯¾ã™ã‚‹ãƒ­ãƒœãƒƒãƒˆä½ç½®ã‚’è¨ˆç®—

**ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ :**
```cpp
void calculateCenterPosition() {
    // ä¸¡æ–¹ã®ãƒãƒ¼ã‚«ãƒ¼ä½ç½®ã‚’å–å¾—
    double left_x = left_marker.pose.position.x;
    double right_x = right_marker.pose.position.x;

    // ä¸­å¿ƒã‚’è¨ˆç®— (å¹³å‡)
    double center_x = (left_x + right_x) / 2;  // âš ï¸ æ‹¬å¼§ãŒé‡è¦! (CRIT-02)

    // Yã¨Yawã«ã¤ã„ã¦ã‚‚åŒæ§˜
    double center_y = (left_y + right_y) / 2;
    double center_yaw = (left_yaw + right_yaw) / 2;

    // èª¤å·®ã‚’è¨ˆç®—
    double error_dist = center_x - target_distance;
    double error_y = center_y;  // 0ã§ã‚ã‚‹ã¹ã (ã‚»ãƒ³ã‚¿ãƒªãƒ³ã‚°)
    double error_yaw = center_yaw;  // 0ã§ã‚ã‚‹ã¹ã (æ•´åˆ—)
}
```

**é‡å¤§ãªãƒã‚° (CRIT-02):**
```cpp
// èª¤ã‚Š (æ¼”ç®—å­ã®å„ªå…ˆé †ä½ã®å•é¡Œ):
double center = (left_x) + (right_x) / 2;  // = left + (right/2)

// æ­£è§£:
double center = (left_x + right_x) / 2;    // = (left + right) / 2
```

**å½±éŸ¿:** ä¿®æ­£ãªã—ã§ã¯ã€ãƒ­ãƒœãƒƒãƒˆã¯ç´„5-10cmä¸­å¿ƒã‹ã‚‰ãšã‚Œã¦ãƒ‰ãƒƒã‚­ãƒ³ã‚°ã™ã‚‹

---

## 5. ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼

### 5.1 å®Œå…¨ãªãƒ‰ãƒƒã‚­ãƒ³ã‚°ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼

```
[ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚³ãƒãƒ³ãƒ‰]
    â”‚
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ nav_master: "ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ? (y/n)"         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚ (ãƒ¦ãƒ¼ã‚¶ãƒ¼ç¢ºèª: y)
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ã‚¹ãƒ†ãƒ¼ã‚¸1: ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ (nav_goal)        â”‚
â”‚                                       â”‚
â”‚ 1. ArUcoãƒãƒ¼ã‚«ãƒ¼ (ID 20) ã‚’æ¤œå‡º        â”‚
â”‚ 2. ãƒãƒƒãƒ—ãƒ•ãƒ¬ãƒ¼ãƒ ã«å¤‰æ›                â”‚
â”‚ 3. ã‚ªãƒ•ã‚»ãƒƒãƒˆã‚´ãƒ¼ãƒ«ã‚’è¨ˆç®— (0.305m)     â”‚
â”‚ 4. /goal_pose ã‚’ãƒ‘ãƒ–ãƒªãƒƒã‚·ãƒ¥           â”‚
â”‚ 5. Nav2ãŒãƒŠãƒ“ã‚²ãƒ¼ãƒˆ (~30s)            â”‚
â”‚ 6. ãƒ­ãƒœãƒƒãƒˆãŒãƒãƒ¼ã‚«ãƒ¼ã‹ã‚‰~30cmåœæ­¢     â”‚
â”‚                                       â”‚
â”‚ ç²¾åº¦: Â±5cm                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚ (ã‚¢ãƒ—ãƒ­ãƒ¼ãƒå®Œäº†)
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ nav_master: "ãƒ‰ãƒƒã‚­ãƒ³ã‚°é–‹å§‹? (y/n)"     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚ (ãƒ¦ãƒ¼ã‚¶ãƒ¼ç¢ºèª: y)
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ã‚¹ãƒ†ãƒ¼ã‚¸2: ã‚¢ãƒ©ã‚¤ãƒ¡ãƒ³ãƒˆ (nav_docking)   â”‚
â”‚ å˜ä¸€ãƒãƒ¼ã‚«ãƒ¼ãƒ•ã‚§ãƒ¼ã‚º                   â”‚
â”‚                                       â”‚
â”‚ 1. å‰æ–¹ãƒãƒ¼ã‚«ãƒ¼ (ID 20) ã‚’æ¤œå‡º         â”‚
â”‚ 2. PIDåˆ¶å¾¡: X, Y, Yaw                 â”‚
â”‚ 3. è·é›¢ < 0.7m ã¾ã§ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ          â”‚
â”‚ 4. ä¸¡ãƒãƒ¼ã‚«ãƒ¼ãŒè¦‹ãˆã‚‹                  â”‚
â”‚                                       â”‚
â”‚ ç²¾åº¦: Â±1cm                            â”‚
â”‚ æ‰€è¦æ™‚é–“: ~15s                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚ (ä¸¡ãƒãƒ¼ã‚«ãƒ¼ãŒè¦‹ãˆã‚‹)
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ã‚¹ãƒ†ãƒ¼ã‚¸3: ç²¾å¯† (nav_docking)          â”‚
â”‚ ãƒ‡ãƒ¥ã‚¢ãƒ«ãƒãƒ¼ã‚«ãƒ¼ãƒ•ã‚§ãƒ¼ã‚º               â”‚
â”‚                                       â”‚
â”‚ 1. ä¸¡ãƒãƒ¼ã‚«ãƒ¼ (ID 20, 21) ã‚’æ¤œå‡º       â”‚
â”‚ 2. ä¸­å¿ƒä½ç½®ã‚’è¨ˆç®—                      â”‚
â”‚ 3. ã‚»ãƒ³ã‚¿ãƒªãƒ³ã‚°ã®ãŸã‚ã®PIDåˆ¶å¾¡         â”‚
â”‚ 4. è·é›¢ < 0.42m ã¾ã§ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ         â”‚
â”‚                                       â”‚
â”‚ ç²¾åº¦: Â±1mm (ç›®æ¨™)                     â”‚
â”‚ æ‰€è¦æ™‚é–“: ~10s                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚ (è·é›¢ < 0.42m)
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ã‚¹ãƒ†ãƒ¼ã‚¸4: æ¤œè¨¼                        â”‚
â”‚                                       â”‚
â”‚ 1. ä½ç½®ãŒå®‰å®šã—ã¦ã„ã‚‹ã‹ç¢ºèª (3ç§’)      â”‚
â”‚ 2. æœ€åˆã®ç¢ºèªãƒã‚§ãƒƒã‚¯                  â”‚
â”‚ 3. ã•ã‚‰ã«3ç§’å¾…æ©Ÿ                       â”‚
â”‚ 4. 2å›ç›®ã®ç¢ºèªãƒã‚§ãƒƒã‚¯                 â”‚
â”‚ 5. æˆåŠŸã‚’å ±å‘Š                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â†“
[ãƒ‰ãƒƒã‚­ãƒ³ã‚°å®Œäº†!]
```

**ç·æ‰€è¦æ™‚é–“:** ~60-70ç§’ (30sã‚¢ãƒ—ãƒ­ãƒ¼ãƒ + 15sã‚¢ãƒ©ã‚¤ãƒ¡ãƒ³ãƒˆ + 15sç²¾å¯† + 6sæ¤œè¨¼)

---

# ãƒ‘ãƒ¼ãƒˆ2: ææ¡ˆã•ã‚ŒãŸã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ (ãƒ•ã‚§ãƒ¼ã‚º1-4)

## 6. ææ¡ˆã•ã‚ŒãŸã‚»ãƒ¼ãƒ•ãƒ†ã‚£ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£(ãƒ•ã‚§ãƒ¼ã‚º 1)

### 6.1 å•é¡Œã®èª¬æ˜

**ç¾åœ¨ã®å•é¡Œ:**
- âŒ ãƒ‰ãƒƒã‚­ãƒ³ã‚°ä¸­ã®LiDARç›£è¦–ãªã— (éšœå®³ç‰©ã«å¯¾ã—ã¦ç›²ç›®)
- âŒ ç·Šæ€¥åœæ­¢ãƒ¡ã‚«ãƒ‹ã‚ºãƒ ãªã—
- âŒ ä¸Šæ›¸ãæ¨©é™ã‚’æŒã¤ã‚»ãƒ¼ãƒ•ãƒ†ã‚£ãƒ¬ã‚¤ãƒ¤ãƒ¼ãªã—
- âŒ ã‚»ãƒ¼ãƒ•ãƒ†ã‚£ãƒ­ã‚¸ãƒƒã‚¯ãŒãƒãƒ¼ãƒ‰é–“ã«æ•£åœ¨

**çµæœ:** ã‚·ã‚¹ãƒ†ãƒ ã¯æœ¬ç•ªå±•é–‹ã«**å®‰å…¨ã§ã¯ãªã„**

### 6.2 ææ¡ˆã•ã‚ŒãŸã‚»ãƒ¼ãƒ•ãƒ†ã‚£ãƒ¬ã‚¤ãƒ¤ãƒ¼

**è¨­è¨ˆåŸå‰‡:** ã™ã¹ã¦ã®å‹•ä½œã«å¯¾ã™ã‚‹ä¸Šæ›¸ãæ¨©é™ã‚’æŒã¤ç›´äº¤ã‚»ãƒ¼ãƒ•ãƒ†ã‚£ãƒ¬ã‚¤ãƒ¤ãƒ¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           SAFETY SUPERVISOR (ä¸Šæ›¸ãæ¨©é™)                â”‚
â”‚                                                         â”‚
â”‚  çŠ¶æ…‹:                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ SAFE â”‚â†’â”‚CAUTION â”‚â†’â”‚ UNSAFE â”‚â†’â”‚ EMERGENCY_STOP   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                         â”‚
â”‚  ç›£è¦–:                                                  â”‚
â”‚  â€¢ LiDARã‚¹ã‚­ãƒ£ãƒ³ (éšœå®³ç‰©è·é›¢)                           â”‚
â”‚  â€¢ ArUcoãƒãƒ¼ã‚«ãƒ¼ (å¯è¦–æ€§)                               â”‚
â”‚  â€¢ ãƒ­ãƒœãƒƒãƒˆçŠ¶æ…‹ (ä½ç½®ã€é€Ÿåº¦)                            â”‚
â”‚  â€¢ ã‚·ã‚¹ãƒ†ãƒ ãƒ˜ãƒ«ã‚¹ (ãƒãƒ¼ãƒ‰ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹)                     â”‚
â”‚  â€¢ æ‰‹å‹•éå¸¸åœæ­¢ãƒœã‚¿ãƒ³                                   â”‚
â”‚                                                         â”‚
â”‚  å®Ÿè¡Œ:                                                  â”‚
â”‚  â€¢ /multigo/safety/emergency_stop (Bool)                â”‚
â”‚  â€¢ /multigo/safety/speed_limit (Float32)                â”‚
â”‚  â€¢ /multigo/safety/state (String)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â†“                â†“                â†“
  [nav_docking]    [nav_control]   [mecanum_wheels]
     (ãƒã‚§ãƒƒã‚¯)       (ãƒã‚§ãƒƒã‚¯)       (ãƒã‚§ãƒƒã‚¯)
```

**å®Ÿè£…:**

```cpp
class SafetySupervisor : public rclcpp::Node {
public:
    enum class SafetyState {
        SAFE,           // ã™ã¹ã¦ã‚¯ãƒªã‚¢
        CAUTION,        // è­¦å‘Šã€é€Ÿåº¦ä½æ¸›
        UNSAFE,         // å±é™ºã€å‹•ä½œåœæ­¢
        EMERGENCY_STOP  // æ‰‹å‹•éå¸¸åœæ­¢æœ‰åŠ¹
    };

private:
    SafetyState current_state_ = SafetyState::SAFE;

    // ãƒ¢ãƒ‹ã‚¿ãƒ¼
    rclcpp::Subscription<LaserScan>::SharedPtr scan_sub_;
    rclcpp::Subscription<Bool>::SharedPtr estop_button_sub_;
    rclcpp::Subscription<PoseArray>::SharedPtr markers_sub_;

    // å®Ÿè¡Œè€…
    rclcpp::Publisher<Bool>::SharedPtr safety_stop_pub_;
    rclcpp::Publisher<Float32>::SharedPtr speed_limit_pub_;
    rclcpp::Publisher<String>::SharedPtr state_pub_;

public:
    void scanCallback(LaserScan::SharedPtr msg) {
        double min_dist = *std::min_element(msg->ranges.begin(), msg->ranges.end());

        if (min_dist < 0.15) {  // 15cm = å±é™º
            transitionTo(SafetyState::EMERGENCY_STOP);
        } else if (min_dist < 0.30) {  // 30cm = æ³¨æ„
            transitionTo(SafetyState::CAUTION);
        } else if (min_dist < 0.50) {  // 50cm = å®‰å…¨ã ãŒç›£è¦–
            transitionTo(SafetyState::SAFE);
        }
    }

    void transitionTo(SafetyState new_state) {
        if (new_state == current_state_) return;

        RCLCPP_INFO(get_logger(), "Safety: %s -> %s",
                    stateToString(current_state_),
                    stateToString(new_state));

        current_state_ = new_state;

        switch (new_state) {
            case SafetyState::SAFE:
                publishSpeedLimit(1.0);      // 100% é€Ÿåº¦
                publishSafetyStop(false);
                break;

            case SafetyState::CAUTION:
                publishSpeedLimit(0.5);      // 50% é€Ÿåº¦
                RCLCPP_WARN(get_logger(), "CAUTION: éšœå®³ç‰©ã‚’æ¤œå‡ºã€é€Ÿåº¦ã‚’ä½æ¸›");
                break;

            case SafetyState::UNSAFE:
                publishSpeedLimit(0.2);      // 20% é€Ÿåº¦ (å¾è¡Œ)
                RCLCPP_WARN(get_logger(), "UNSAFE: éšœå®³ç‰©ãŒéå¸¸ã«è¿‘ã„");
                break;

            case SafetyState::EMERGENCY_STOP:
                publishSpeedLimit(0.0);      // åœæ­¢
                publishSafetyStop(true);
                RCLCPP_ERROR(get_logger(), "ç·Šæ€¥åœæ­¢ãŒæœ‰åŠ¹åŒ–ã•ã‚Œã¾ã—ãŸ!");
                break;
        }

        publishState(stateToString(new_state));
    }
};
```

**ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ãƒ‰ã¨ã®çµ±åˆ:**

```cpp
// nav_dockingã€nav_controlã€mecanum_wheelsã§:
class NavDockingNode : public rclcpp::Node {
private:
    rclcpp::Subscription<Bool>::SharedPtr estop_sub_;
    rclcpp::Subscription<Float32>::SharedPtr speed_limit_sub_;

    bool emergency_stop_active_ = false;
    double speed_limit_multiplier_ = 1.0;

public:
    void estopCallback(Bool::SharedPtr msg) {
        emergency_stop_active_ = msg->data;
        if (emergency_stop_active_) {
            RCLCPP_ERROR(get_logger(), "éå¸¸åœæ­¢! ã™ã¹ã¦ã®å‹•ä½œã‚’åœæ­¢");
            publishZeroVelocity();
            cancelCurrentAction();
        }
    }

    void speedLimitCallback(Float32::SharedPtr msg) {
        speed_limit_multiplier_ = msg->data;
    }

    void publishVelocity(Twist cmd) {
        // ã‚»ãƒ¼ãƒ•ãƒ†ã‚£ãƒã‚§ãƒƒã‚¯1: éå¸¸åœæ­¢ãŒæœ‰åŠ¹ã‹?
        if (emergency_stop_active_) {
            RCLCPP_WARN(get_logger(), "éå¸¸åœæ­¢ã«ã‚ˆã‚Šå‹•ä½œãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ");
            return;  // ãƒ‘ãƒ–ãƒªãƒƒã‚·ãƒ¥ã—ãªã„
        }

        // ã‚»ãƒ¼ãƒ•ãƒ†ã‚£ãƒã‚§ãƒƒã‚¯2: é€Ÿåº¦åˆ¶é™ã‚’é©ç”¨
        cmd.linear.x *= speed_limit_multiplier_;
        cmd.linear.y *= speed_limit_multiplier_;
        cmd.angular.z *= speed_limit_multiplier_;

        cmd_vel_pub_->publish(cmd);
    }
};
```

**ã‚»ãƒ¼ãƒ•ãƒ†ã‚£ãƒˆãƒ”ãƒƒã‚¯:**
- `/multigo/safety/emergency_stop` (Bool) - RELIABLE, TRANSIENT_LOCAL, KEEP_ALL
- `/multigo/safety/speed_limit` (Float32) - RELIABLE
- `/multigo/safety/state` (String) - ç›£è¦–ç”¨

**ãƒ†ã‚¹ãƒˆ:**
```bash
# éå¸¸åœæ­¢ã‚’ãƒ†ã‚¹ãƒˆ
ros2 topic pub /multigo/safety/emergency_stop std_msgs/Bool "data: true"
# ç¢ºèª: ãƒ­ãƒœãƒƒãƒˆãŒå³åº§ã«åœæ­¢ (<100ms)

# é€Ÿåº¦åˆ¶é™ã‚’ãƒ†ã‚¹ãƒˆ
ros2 topic pub /multigo/safety/speed_limit std_msgs/Float32 "data: 0.3"
# ç¢ºèª: ãƒ­ãƒœãƒƒãƒˆãŒ30%é€Ÿåº¦ã«æ¸›é€Ÿ

# éšœå®³ç‰©æ¤œå‡ºã‚’ãƒ†ã‚¹ãƒˆ
# ãƒ‰ãƒƒã‚­ãƒ³ã‚°ä¸­ã«ãƒ­ãƒœãƒƒãƒˆã‹ã‚‰20cmã®å ´æ‰€ã«éšœå®³ç‰©ã‚’é…ç½®
# ç¢ºèª: ãƒ­ãƒœãƒƒãƒˆãŒEMERGENCY_STOPã«é·ç§»ã—ã¦åœæ­¢
```

**å·¥æ•°:** 40æ™‚é–“ (è¨­è¨ˆ 8h + å®Ÿè£… 24h + ãƒ†ã‚¹ãƒˆ 8h)

**å„ªå…ˆåº¦:** ğŸ”´ **é‡è¦** - ã“ã‚Œãªã—ã§ã¯å±•é–‹ã§ããªã„

---

### 6.3 ã‚¸ã‚ªãƒ•ã‚§ãƒ³ã‚·ãƒ³ã‚° (ç«‹å…¥ç¦æ­¢ã‚¾ãƒ¼ãƒ³)

**ç›®çš„:** ãƒ­ãƒœãƒƒãƒˆãŒè¶Šãˆã‚‰ã‚Œãªã„ä»®æƒ³å¢ƒç•Œã‚’å®šç¾©

**è¨­å®š:** `config/safety_zones.yaml`

```yaml
keep_out_zones:
  - id: "elevator_shaft"
    polygon: [[5.0, 10.0], [6.0, 10.0], [6.0, 11.0], [5.0, 11.0]]
    reason: "å±é™º: ã‚¨ãƒ¬ãƒ™ãƒ¼ã‚¿ãƒ¼ã‚·ãƒ£ãƒ•ãƒˆ"

  - id: "stairs_north"
    polygon: [[2.0, 8.0], [3.0, 8.0], [3.0, 9.0], [2.0, 9.0]]
    reason: "å´–ã®å±é™º: éšæ®µ"

allowed_zones:
  - id: "hospital_floor_2"
    polygon: [[0, 0], [50, 0], [50, 30], [0, 30]]
    reason: "æ‰¿èªã•ã‚ŒãŸç¨¼åƒã‚¨ãƒªã‚¢"
```

**å®Ÿè£…:**

```cpp
class SafetyZoneManager : public rclcpp::Node {
private:
    std::vector<Polygon> keep_out_zones_;
    std::vector<Polygon> allowed_zones_;

public:
    void loadZones(std::string yaml_file) {
        // YAMLã‚’è§£æã—ã¦ãƒãƒªã‚´ãƒ³ã‚’èª­ã¿è¾¼ã¿
        YAML::Node config = YAML::LoadFile(yaml_file);
        for (auto zone : config["keep_out_zones"]) {
            keep_out_zones_.push_back(parsePolygon(zone));
        }
    }

    bool isPositionSafe(double x, double y) {
        // ãƒã‚§ãƒƒã‚¯1: ç«‹å…¥ç¦æ­¢ã‚¾ãƒ¼ãƒ³å†…ã«ãªã„ã‹
        for (auto& zone : keep_out_zones_) {
            if (pointInPolygon(x, y, zone)) {
                RCLCPP_ERROR(get_logger(), "ä½ç½® (%.2f, %.2f) ã¯ç«‹å…¥ç¦æ­¢ã‚¾ãƒ¼ãƒ³å†…: %s",
                            x, y, zone.reason.c_str());
                return false;
            }
        }

        // ãƒã‚§ãƒƒã‚¯2: å°‘ãªãã¨ã‚‚1ã¤ã®è¨±å¯ã‚¾ãƒ¼ãƒ³å†…ã«ã„ã‚‹ã‹
        bool in_allowed = false;
        for (auto& zone : allowed_zones_) {
            if (pointInPolygon(x, y, zone)) {
                in_allowed = true;
                break;
            }
        }

        if (!in_allowed) {
            RCLCPP_ERROR(get_logger(), "ä½ç½® (%.2f, %.2f) ãŒè¨±å¯ã‚¾ãƒ¼ãƒ³ã®å¤–", x, y);
        }

        return in_allowed;
    }

private:
    bool pointInPolygon(double x, double y, const Polygon& poly) {
        // ç‚¹ãŒãƒãƒªã‚´ãƒ³å†…ã«ã‚ã‚‹ã‹ã®ãƒ¬ã‚¤ã‚­ãƒ£ã‚¹ãƒ†ã‚£ãƒ³ã‚°ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ 
        // æ¨™æº–çš„ãªè¨ˆç®—å¹¾ä½•å­¦ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ 
        // ...
    }
};
```

**çµ±åˆ:**
- ã‚»ãƒ¼ãƒ•ãƒ†ã‚£ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒã‚¤ã‚¶ãƒ¼ãŒ100msã”ã¨ã«ãƒ­ãƒœãƒƒãƒˆä½ç½®ã‚’ãƒã‚§ãƒƒã‚¯
- é•åãŒæ¤œå‡ºã•ã‚ŒãŸå ´åˆ â†’ EMERGENCY_STOPã«é·ç§»
- ç«‹å…¥ç¦æ­¢ã‚¾ãƒ¼ãƒ³å†…ã®ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚´ãƒ¼ãƒ«ã¯æ‹’å¦
- çµŒè·¯è¨ˆç”»ã¯è¨±å¯ã‚¾ãƒ¼ãƒ³ã«åˆ¶ç´„

**å·¥æ•°:** 16æ™‚é–“ (åŸºæœ¬)ã€40æ™‚é–“ (ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³ä»˜ãå®Œå…¨ç‰ˆ)

---

## 7. ææ¡ˆã•ã‚ŒãŸçŠ¶æ…‹ç®¡ç†(ãƒ•ã‚§ãƒ¼ã‚º 1)

### 7.1 å•é¡Œã®èª¬æ˜

**ç¾åœ¨ã®å•é¡Œ:**
- âŒ æ˜ç¤ºçš„ãªçŠ¶æ…‹è¿½è·¡ãŒãªã„ ("ãƒ­ãƒœãƒƒãƒˆã¯ã©ã®çŠ¶æ…‹ã«ã‚ã‚‹ã‹?")
- âŒ ãƒ‡ãƒãƒƒã‚°ãŒå›°é›£ ("ã©ã“ã§å¤±æ•—ã—ãŸã‹?")
- âŒ æ‹¡å¼µãŒå›°é›£ (æ–°ã—ã„ã‚¹ãƒ†ãƒƒãƒ—ã®è¿½åŠ ã«ã¯ã‚³ãƒ¼ãƒ‰å¤‰æ›´ãŒå¿…è¦)
- âŒ å‹•ä½œã®ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³ãŒãªã„

### 7.2 ææ¡ˆã•ã‚ŒãŸçŠ¶æ…‹ãƒã‚·ãƒ³

**å®Ÿè£…:**

```cpp
enum class MissionState {
    IDLE,
    WAITING_APPROACH_CONFIRMATION,
    NAVIGATING_TO_GOAL,
    WAITING_DOCK_CONFIRMATION,
    DOCKING,
    DOCKED,
    UNDOCKING,          // å°†æ¥
    TRANSPORTING,       // å°†æ¥
    ERROR
};

class MissionStateMachine : public rclcpp::Node {
private:
    MissionState current_state_ = MissionState::IDLE;

    // çŠ¶æ…‹å¤‰æ›´ãƒ‘ãƒ–ãƒªãƒƒã‚·ãƒ£ãƒ¼
    rclcpp::Publisher<std_msgs::msg::String>::SharedPtr state_pub_;

    // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
    rclcpp_action::Client<Approach>::SharedPtr approach_client_;
    rclcpp_action::Client<Dock>::SharedPtr dock_client_;

public:
    MissionStateMachine() : Node("mission_state_machine") {
        // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        approach_client_ = rclcpp_action::create_client<Approach>(this, "approach");
        dock_client_ = rclcpp_action::create_client<Dock>(this, "dock");

        // çŠ¶æ…‹ãƒ‘ãƒ–ãƒªãƒƒã‚·ãƒ£ãƒ¼ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        state_pub_ = create_publisher<std_msgs::msg::String>("/multigo/mission/state", 10);

        // ãƒ¡ã‚¤ãƒ³çŠ¶æ…‹ãƒã‚·ãƒ³ãƒ«ãƒ¼ãƒ— (10 Hz)
        timer_ = create_wall_timer(
            std::chrono::milliseconds(100),
            std::bind(&MissionStateMachine::update, this)
        );
    }

    void update() {
        switch (current_state_) {
            case MissionState::IDLE:
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚’è¦æ±‚ã™ã‚‹ã®ã‚’å¾…ã¤
                if (approach_requested_) {
                    transitionTo(MissionState::WAITING_APPROACH_CONFIRMATION);
                }
                break;

            case MissionState::WAITING_APPROACH_CONFIRMATION:
                // ç¢ºèªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¡¨ç¤º
                displayPrompt("ãƒ‰ãƒƒã‚­ãƒ³ã‚°ã‚¹ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã«ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã—ã¾ã™ã‹? (y/n)");

                if (user_confirmed_) {
                    transitionTo(MissionState::NAVIGATING_TO_GOAL);
                    sendApproachGoal();
                } else if (user_cancelled_) {
                    transitionTo(MissionState::IDLE);
                }
                break;

            case MissionState::NAVIGATING_TO_GOAL:
                // ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ãƒã‚§ãƒƒã‚¯
                if (approach_succeeded_) {
                    transitionTo(MissionState::WAITING_DOCK_CONFIRMATION);
                } else if (approach_failed_) {
                    transitionTo(MissionState::ERROR);
                    logError("ã‚¢ãƒ—ãƒ­ãƒ¼ãƒå¤±æ•—: " + approach_error_message_);
                } else if (user_cancelled_) {
                    cancelApproachGoal();
                    transitionTo(MissionState::IDLE);
                }
                break;

            case MissionState::WAITING_DOCK_CONFIRMATION:
                displayPrompt("ç²¾å¯†ãƒ‰ãƒƒã‚­ãƒ³ã‚°ã‚’é–‹å§‹ã—ã¾ã™ã‹? (y/n)");

                if (user_confirmed_) {
                    transitionTo(MissionState::DOCKING);
                    sendDockGoal();
                } else if (user_cancelled_) {
                    transitionTo(MissionState::IDLE);
                }
                break;

            case MissionState::DOCKING:
                // ãƒ‰ãƒƒã‚­ãƒ³ã‚°ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ãƒã‚§ãƒƒã‚¯
                if (dock_succeeded_) {
                    transitionTo(MissionState::DOCKED);
                    displaySuccess("ãƒ‰ãƒƒã‚­ãƒ³ã‚°å®Œäº†!");
                } else if (dock_failed_) {
                    transitionTo(MissionState::ERROR);
                    logError("ãƒ‰ãƒƒã‚­ãƒ³ã‚°å¤±æ•—: " + dock_error_message_);
                } else if (user_cancelled_) {
                    cancelDockGoal();
                    transitionTo(MissionState::IDLE);
                }
                break;

            case MissionState::DOCKED:
                // æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å¾…ã¤ (ã‚¢ãƒ³ãƒ‰ãƒƒã‚¯ã€è¼¸é€ãªã©)
                if (undock_requested_) {
                    transitionTo(MissionState::UNDOCKING);  // å°†æ¥
                }
                break;

            case MissionState::ERROR:
                // ã‚¨ãƒ©ãƒ¼ã‚’è¡¨ç¤ºã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç¢ºèªã‚’å¾…ã¤
                if (user_acknowledged_error_) {
                    transitionTo(MissionState::IDLE);
                }
                break;
        }
    }

    void transitionTo(MissionState new_state) {
        if (new_state == current_state_) return;

        RCLCPP_INFO(get_logger(), "çŠ¶æ…‹é·ç§»: %s -> %s",
                    stateToString(current_state_),
                    stateToString(new_state));

        // æ—§çŠ¶æ…‹ã®çµ‚äº†ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
        onStateExit(current_state_);

        // çŠ¶æ…‹ã‚’æ›´æ–°
        current_state_ = new_state;

        // æ–°çŠ¶æ…‹ã®é–‹å§‹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
        onStateEntry(new_state);

        // ç›£è¦–ç”¨ã«ãƒ‘ãƒ–ãƒªãƒƒã‚·ãƒ¥
        std_msgs::msg::String state_msg;
        state_msg.data = stateToString(new_state);
        state_pub_->publish(state_msg);
    }

    void onStateEntry(MissionState state) {
        // çŠ¶æ…‹ã«å…¥ã‚‹éš›ã®é–‹å§‹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
        switch (state) {
            case MissionState::NAVIGATING_TO_GOAL:
                RCLCPP_INFO(get_logger(), "ã‚´ãƒ¼ãƒ«ã¸ã®ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é–‹å§‹...");
                break;
            case MissionState::DOCKING:
                RCLCPP_INFO(get_logger(), "ç²¾å¯†ãƒ‰ãƒƒã‚­ãƒ³ã‚°ã‚’é–‹å§‹...");
                break;
            case MissionState::DOCKED:
                RCLCPP_INFO(get_logger(), "ãƒ‰ãƒƒã‚­ãƒ³ã‚°å®Œäº†ã€ãƒ­ãƒœãƒƒãƒˆã¯ãƒ‰ãƒƒã‚­ãƒ³ã‚°æ¸ˆã¿");
                break;
            case MissionState::ERROR:
                RCLCPP_ERROR(get_logger(), "ERRORçŠ¶æ…‹ã«å…¥ã‚Šã¾ã—ãŸ");
                break;
            default:
                break;
        }
    }

    void onStateExit(MissionState state) {
        // çŠ¶æ…‹ã‚’é›¢ã‚Œã‚‹éš›ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
        switch (state) {
            case MissionState::NAVIGATING_TO_GOAL:
                RCLCPP_INFO(get_logger(), "ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†");
                break;
            case MissionState::DOCKING:
                RCLCPP_INFO(get_logger(), "ãƒ‰ãƒƒã‚­ãƒ³ã‚°ã‚·ãƒ¼ã‚±ãƒ³ã‚¹å®Œäº†");
                break;
            default:
                break;
        }
    }

private:
    std::string stateToString(MissionState state) {
        switch (state) {
            case MissionState::IDLE: return "IDLE";
            case MissionState::WAITING_APPROACH_CONFIRMATION: return "WAITING_APPROACH_CONFIRMATION";
            case MissionState::NAVIGATING_TO_GOAL: return "NAVIGATING_TO_GOAL";
            case MissionState::WAITING_DOCK_CONFIRMATION: return "WAITING_DOCK_CONFIRMATION";
            case MissionState::DOCKING: return "DOCKING";
            case MissionState::DOCKED: return "DOCKED";
            case MissionState::UNDOCKING: return "UNDOCKING";
            case MissionState::TRANSPORTING: return "TRANSPORTING";
            case MissionState::ERROR: return "ERROR";
            default: return "UNKNOWN";
        }
    }
};
```

**ãƒ¡ãƒªãƒƒãƒˆ:**
- âœ… ãƒ­ãƒœãƒƒãƒˆçŠ¶æ…‹ã‚’å¸¸ã«æŠŠæ¡: `ros2 topic echo /multigo/mission/state`
- âœ… ãƒ‡ãƒãƒƒã‚°ãŒå®¹æ˜“: "ãƒ­ãƒœãƒƒãƒˆãŒDOCKINGçŠ¶æ…‹ã§ã‚¹ã‚¿ãƒƒã‚¯"
- âœ… ã‚ˆã‚Šè‰¯ã„ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°: æ˜ç¢ºãªã‚¨ãƒ©ãƒ¼çŠ¶æ…‹ + ãƒªã‚«ãƒãƒªãƒ¼
- âœ… æ‹¡å¼µå¯èƒ½: æ–°ã—ã„çŠ¶æ…‹ã‚’è¿½åŠ  (UNDOCKINGã€CHARGING ãªã©)
- âœ… ãƒ†ã‚¹ãƒˆå¯èƒ½: çŠ¶æ…‹é·ç§»ã®ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ

**ç›£è¦–:**
```bash
# çŠ¶æ…‹å¤‰åŒ–ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ç›£è¦–
ros2 topic echo /multigo/mission/state

# ãƒ†ã‚¹ãƒˆç”¨ã«çŠ¶æ…‹é·ç§»ã‚’ãƒˆãƒªã‚¬ãƒ¼
ros2 service call /mission/trigger_approach std_srvs/Trigger
```

**å·¥æ•°:** 24æ™‚é–“ (å®Ÿè£… + çµ±åˆ + ãƒ†ã‚¹ãƒˆ)

**å„ªå…ˆåº¦:** ğŸ”´ **é«˜** - ãƒ‡ãƒãƒƒã‚°æ€§ã®å¤§å¹…ãªæ”¹å–„

---

## 8. ææ¡ˆã•ã‚ŒãŸROS 2æ”¹å–„(ãƒ•ã‚§ãƒ¼ã‚º 3)

### 8.1 ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ãƒãƒ¼ãƒ‰

**ç¾åœ¨ã®å•é¡Œ:** ãƒãƒ¼ãƒ‰ãŒå³åº§ã«èµ·å‹•ã€ã‚¯ãƒªãƒ¼ãƒ³ãªèµ·å‹•/ã‚·ãƒ£ãƒƒãƒˆãƒ€ã‚¦ãƒ³ãŒãªã„

**ææ¡ˆ:** é‡è¦ãªãƒãƒ¼ãƒ‰ã‚’ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ãƒãƒ¼ãƒ‰ã«å¤‰æ›

**ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«çŠ¶æ…‹:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Unconfigured â”‚  (åˆæœŸçŠ¶æ…‹)
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ configure()
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Inactive    â”‚  (è¨­å®šèª­ã¿è¾¼ã¿æ¸ˆã¿ã€ãƒ‘ãƒ–ãƒªãƒƒã‚·ãƒ¥ã—ã¦ã„ãªã„)
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ activate()
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Active     â”‚  (å®Œå…¨ã«å‹•ä½œä¸­)
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ deactivate()
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Inactive    â”‚  (ç´ æ—©ãå†æœ‰åŠ¹åŒ–å¯èƒ½)
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ cleanup()
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Unconfigured â”‚  (ã‚¯ãƒªãƒ¼ãƒ³ãªã‚·ãƒ£ãƒƒãƒˆãƒ€ã‚¦ãƒ³)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å®Ÿè£…ä¾‹ (ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ãƒãƒ¼ãƒ‰ã¨ã—ã¦ã®nav_docking):**

```cpp
#include <rclcpp_lifecycle/lifecycle_node.hpp>

class NavDockingLifecycle : public rclcpp_lifecycle::LifecycleNode {
public:
    NavDockingLifecycle() : LifecycleNode("nav_docking_node") {
        RCLCPP_INFO(get_logger(), "NavDocking ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ãƒãƒ¼ãƒ‰ãŒä½œæˆã•ã‚Œã¾ã—ãŸ");
    }

    // CONFIGURE: ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã€è¨­å®šæ¤œè¨¼
    CallbackReturn on_configure(const State&) override {
        RCLCPP_INFO(get_logger(), "NavDockingãƒãƒ¼ãƒ‰ã‚’è¨­å®šä¸­...");

        // ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§æ¤œè¨¼
        declare_parameter<double>("Kp_dist", 0.5);
        declare_parameter<double>("Ki_dist", 0.1);
        declare_parameter<double>("Kd_dist", 0.05);

        Kp_dist_ = get_parameter("Kp_dist").as_double();
        Ki_dist_ = get_parameter("Ki_dist").as_double();
        Kd_dist_ = get_parameter("Kd_dist").as_double();

        // æ¤œè¨¼
        if (Kp_dist_ <= 0 || Ki_dist_ < 0 || Kd_dist_ < 0) {
            RCLCPP_ERROR(get_logger(), "ç„¡åŠ¹ãªPIDãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿!");
            return CallbackReturn::FAILURE;
        }

        // ãƒ‘ãƒ–ãƒªãƒƒã‚·ãƒ£ãƒ¼/ã‚µãƒ–ã‚¹ã‚¯ãƒ©ã‚¤ãƒãƒ¼ã‚’ä½œæˆ (ã¾ã æœ‰åŠ¹åŒ–ã—ãªã„)
        cmd_vel_pub_ = create_publisher<Twist>("/cmd_vel_final", 10);
        markers_sub_ = create_subscription<PoseArray>(
            "/aruco_detect/markers_left", 10,
            std::bind(&NavDockingLifecycle::markersCallback, this, std::placeholders::_1)
        );

        // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚µãƒ¼ãƒãƒ¼ã‚’ä½œæˆ (ã¾ã æœ‰åŠ¹åŒ–ã—ãªã„)
        dock_action_server_ = rclcpp_action::create_server<Dock>(
            this, "dock",
            std::bind(&NavDockingLifecycle::handleGoal, this, std::placeholders::_1, std::placeholders::_2),
            std::bind(&NavDockingLifecycle::handleCancel, this, std::placeholders::_1),
            std::bind(&NavDockingLifecycle::handleAccepted, this, std::placeholders::_1)
        );

        RCLCPP_INFO(get_logger(), "NavDockingãŒæ­£å¸¸ã«è¨­å®šã•ã‚Œã¾ã—ãŸ");
        return CallbackReturn::SUCCESS;
    }

    // ACTIVATE: ãƒ‘ãƒ–ãƒªãƒƒã‚·ãƒ¥é–‹å§‹ã€ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚µãƒ¼ãƒãƒ¼æœ‰åŠ¹åŒ–
    CallbackReturn on_activate(const State&) override {
        RCLCPP_INFO(get_logger(), "NavDockingãƒãƒ¼ãƒ‰ã‚’æœ‰åŠ¹åŒ–ä¸­...");

        // ãƒ‘ãƒ–ãƒªãƒƒã‚·ãƒ£ãƒ¼ã‚’æœ‰åŠ¹åŒ– (ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ãƒ‘ãƒ–ãƒªãƒƒã‚·ãƒ£ãƒ¼ã¯æœ‰åŠ¹æ™‚ã®ã¿ãƒ‘ãƒ–ãƒªãƒƒã‚·ãƒ¥)
        cmd_vel_pub_->on_activate();

        // åˆ¶å¾¡ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹
        control_timer_ = create_wall_timer(
            std::chrono::milliseconds(100),
            std::bind(&NavDockingLifecycle::controlLoop, this)
        );

        RCLCPP_INFO(get_logger(), "NavDockingãŒæœ‰åŠ¹ã€ãƒ‰ãƒƒã‚­ãƒ³ã‚°æº–å‚™å®Œäº†");
        return CallbackReturn::SUCCESS;
    }

    // DEACTIVATE: ãƒ‘ãƒ–ãƒªãƒƒã‚·ãƒ¥åœæ­¢ã€ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚µãƒ¼ãƒãƒ¼ç„¡åŠ¹åŒ–
    CallbackReturn on_deactivate(const State&) override {
        RCLCPP_INFO(get_logger(), "NavDockingãƒãƒ¼ãƒ‰ã‚’ç„¡åŠ¹åŒ–ä¸­...");

        // åˆ¶å¾¡ãƒ«ãƒ¼ãƒ—åœæ­¢
        control_timer_->cancel();

        // ã‚³ãƒãƒ³ãƒ‰ã®ãƒ‘ãƒ–ãƒªãƒƒã‚·ãƒ¥ã‚’åœæ­¢ (å®‰å…¨!)
        cmd_vel_pub_->on_deactivate();
        publishZeroVelocity();

        // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒ‰ãƒƒã‚­ãƒ³ã‚°ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        if (current_goal_handle_) {
            current_goal_handle_->abort();
        }

        RCLCPP_INFO(get_logger(), "NavDockingãŒç„¡åŠ¹åŒ–ã•ã‚Œã¾ã—ãŸ");
        return CallbackReturn::SUCCESS;
    }

    // CLEANUP: ãƒªã‚½ãƒ¼ã‚¹ã‚’è§£æ”¾
    CallbackReturn on_cleanup(const State&) override {
        RCLCPP_INFO(get_logger(), "NavDockingãƒãƒ¼ãƒ‰ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ä¸­...");

        // çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
        integral_dist_ = 0.0;
        integral_y_ = 0.0;
        integral_yaw_ = 0.0;

        // ãƒ‘ãƒ–ãƒªãƒƒã‚·ãƒ£ãƒ¼/ã‚µãƒ–ã‚¹ã‚¯ãƒ©ã‚¤ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢
        cmd_vel_pub_.reset();
        markers_sub_.reset();
        dock_action_server_.reset();

        RCLCPP_INFO(get_logger(), "NavDockingãŒã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã•ã‚Œã¾ã—ãŸ");
        return CallbackReturn::SUCCESS;
    }

    // SHUTDOWN: çµ‚äº†å‰ã®æœ€çµ‚ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    CallbackReturn on_shutdown(const State&) override {
        RCLCPP_INFO(get_logger(), "NavDockingãƒãƒ¼ãƒ‰ã‚’ã‚·ãƒ£ãƒƒãƒˆãƒ€ã‚¦ãƒ³ä¸­...");

        // ãƒ­ãƒœãƒƒãƒˆãŒåœæ­¢ã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
        publishZeroVelocity();

        return CallbackReturn::SUCCESS;
    }
};
```

**ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ç®¡ç†:**

```bash
# CLIã§ãƒãƒ¼ãƒ‰ã®ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ã‚’ç®¡ç†
ros2 lifecycle set /nav_docking_node configure
ros2 lifecycle set /nav_docking_node activate
ros2 lifecycle set /nav_docking_node deactivate
ros2 lifecycle set /nav_docking_node cleanup
```

**è‡ªå‹•ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ç®¡ç†:**

```yaml
# lifecycle_manager è¨­å®š
lifecycle_manager:
  ros__parameters:
    node_names:
      - nav_docking_node
      - nav_goal_node
      - nav_control_node
    autostart: true
    bond_timeout: 4.0
```

**å¤‰æ›ã™ã‚‹ãƒãƒ¼ãƒ‰:**
1. nav_docking (12æ™‚é–“)
2. nav_control (12æ™‚é–“)
3. mecanum_wheels (12æ™‚é–“)
4. aruco_detect (12æ™‚é–“)

**ç·å·¥æ•°:** 48æ™‚é–“

**ãƒ¡ãƒªãƒƒãƒˆ:**
- âœ… ã‚¯ãƒªãƒ¼ãƒ³ãªèµ·å‹•ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ (è¨­å®š â†’ æœ‰åŠ¹åŒ–)
- âœ… å®‰å…¨ãªã‚·ãƒ£ãƒƒãƒˆãƒ€ã‚¦ãƒ³ (ç„¡åŠ¹åŒ– â†’ ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—)
- âœ… ã‚·ã‚¹ãƒ†ãƒ ã‚’å†èµ·å‹•ã›ãšã«ãƒãƒ¼ãƒ‰ã‚’å†èµ·å‹•å¯èƒ½
- âœ… æ¨™æº–åŒ–ã•ã‚ŒãŸãƒãƒ¼ãƒ‰ç®¡ç†
- âœ… ãƒ†ã‚¹ãƒˆã«é©ã—ã¦ã„ã‚‹ (ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆç”¨ã«ç„¡åŠ¹åŒ–å¯èƒ½)

---

### 8.2 QoSãƒãƒªã‚·ãƒ¼ (Quality of Service)

**ç¾åœ¨ã®å•é¡Œ:** ã™ã¹ã¦ã®ãƒˆãƒ”ãƒƒã‚¯ãŒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆQoSã‚’ä½¿ç”¨ (ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æå¤±ã®å¯èƒ½æ€§)

**ææ¡ˆ:** ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é‡è¦åº¦ã«åŸºã¥ãæ˜ç¤ºçš„ãªQoSãƒãƒªã‚·ãƒ¼

**QoSè¨­å®š:**

```cpp
// CRITICAL: ç·Šæ€¥åœæ­¢ã€ã‚»ãƒ¼ãƒ•ãƒ†ã‚£ä¿¡å·
// ã“ã‚Œã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ±ºã—ã¦å¤±ã£ã¦ã¯ãªã‚‰ãªã„
auto qos_critical = rclcpp::QoS(10)
    .reliability(RMW_QOS_POLICY_RELIABILITY_RELIABLE)       // é…ä¿¡ä¿è¨¼
    .durability(RMW_QOS_POLICY_DURABILITY_TRANSIENT_LOCAL)  // é…ã‚Œã¦å‚åŠ ã—ãŸè€…ãŒæœ€å¾Œã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—
    .history(RMW_QOS_POLICY_HISTORY_KEEP_ALL);              // ã™ã¹ã¦ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä¿æŒ

// CONTROL: é€Ÿåº¦ã‚³ãƒãƒ³ãƒ‰ã€ãƒ‰ãƒƒã‚­ãƒ³ã‚°åˆ¶å¾¡
// æœ€æ–°å€¤ãŒå¿…è¦ã€å¤ã„ã‚³ãƒãƒ³ãƒ‰ã¯é™³è…åŒ–
auto qos_control = rclcpp::QoS(10)
    .reliability(RMW_QOS_POLICY_RELIABILITY_RELIABLE)       // é…ä¿¡ä¿è¨¼
    .history(RMW_QOS_POLICY_HISTORY_KEEP_LAST, 1);          // æœ€æ–°ã®ã¿ãŒé‡è¦

// SENSOR: ã‚«ãƒ¡ãƒ©ç”»åƒã€LiDARã‚¹ã‚­ãƒ£ãƒ³
// é«˜é »åº¦ã€å¤ã„ãƒ‡ãƒ¼ã‚¿ã®ãƒ‰ãƒ­ãƒƒãƒ—ã¯è¨±å®¹
auto qos_sensor = rclcpp::QoS(10)
    .reliability(RMW_QOS_POLICY_RELIABILITY_BEST_EFFORT)    // ä¿è¨¼ãªã— (é«˜é€Ÿ!)
    .history(RMW_QOS_POLICY_HISTORY_KEEP_LAST, 1);          // æœ€æ–°ã®ã¿ãŒé‡è¦

// STATUS: è¨ºæ–­ã€ç›£è¦–
// é…ã‚Œã¦å‚åŠ ã—ãŸè€…ã®ãŸã‚ã«å±¥æ­´ãŒå¿…è¦
auto qos_status = rclcpp::QoS(10)
    .reliability(RMW_QOS_POLICY_RELIABILITY_RELIABLE)
    .durability(RMW_QOS_POLICY_DURABILITY_TRANSIENT_LOCAL)
    .history(RMW_QOS_POLICY_HISTORY_KEEP_LAST, 10);
```

**é©ç”¨:**

```cpp
// ç·Šæ€¥åœæ­¢ãƒ‘ãƒ–ãƒªãƒƒã‚·ãƒ£ãƒ¼ (CRITICAL QoS)
auto qos_critical = rclcpp::QoS(10)
    .reliability(RMW_QOS_POLICY_RELIABILITY_RELIABLE)
    .durability(RMW_QOS_POLICY_DURABILITY_TRANSIENT_LOCAL)
    .history(RMW_QOS_POLICY_HISTORY_KEEP_ALL);

estop_pub_ = create_publisher<std_msgs::msg::Bool>(
    "/multigo/safety/emergency_stop",
    qos_critical  // â† æ˜ç¤ºçš„ãªQoS
);

// ã‚«ãƒ¡ãƒ©ã‚µãƒ–ã‚¹ã‚¯ãƒ©ã‚¤ãƒãƒ¼ (SENSOR QoS)
auto qos_sensor = rclcpp::QoS(10)
    .reliability(RMW_QOS_POLICY_RELIABILITY_BEST_EFFORT);

camera_sub_ = create_subscription<sensor_msgs::msg::Image>(
    "/camera/color/image_raw_left",
    qos_sensor,  // â† æ˜ç¤ºçš„ãªQoS
    callback
);
```

**ãƒˆãƒ”ãƒƒã‚¯QoSæ¨å¥¨äº‹é …:**

| ãƒˆãƒ”ãƒƒã‚¯ | QoSã‚¿ã‚¤ãƒ— | ç†ç”± |
|-------|----------|-----------|
| `/multigo/safety/emergency_stop` | CRITICAL | éå¸¸åœæ­¢ä¿¡å·ã‚’æ±ºã—ã¦å¤±ã£ã¦ã¯ãªã‚‰ãªã„ |
| `/multigo/safety/speed_limit` | CRITICAL | ã‚»ãƒ¼ãƒ•ãƒ†ã‚£ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ« |
| `/cmd_vel*` | CONTROL | æœ€æ–°ã‚³ãƒãƒ³ãƒ‰ãŒå¿…è¦ã€å¤ã„ã‚‚ã®ã¯é™³è…åŒ– |
| `/camera/color/*` | SENSOR | é«˜é »åº¦ã€ãƒ™ã‚¹ãƒˆã‚¨ãƒ•ã‚©ãƒ¼ãƒˆã§OK |
| `/scan` | SENSOR | é«˜é »åº¦ã€ãƒ™ã‚¹ãƒˆã‚¨ãƒ•ã‚©ãƒ¼ãƒˆã§OK |
| `/aruco_detect/markers_*` | CONTROL | ä¿¡é ¼æ€§ã®ã‚ã‚‹ãƒãƒ¼ã‚«ãƒ¼æ¤œå‡ºãŒå¿…è¦ |
| `/goal_pose` | CONTROL | ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚´ãƒ¼ãƒ«ã¯åˆ°ç€å¿…é ˆ |
| `/multigo/mission/state` | STATUS | ç›£è¦–ç”¨ã«å±¥æ­´ãŒå¿…è¦ |

**å·¥æ•°:** 8æ™‚é–“ (ã™ã¹ã¦ã®ãƒˆãƒ”ãƒƒã‚¯ã«QoSã‚’é©ç”¨ + ãƒ†ã‚¹ãƒˆ)

**ãƒ¡ãƒªãƒƒãƒˆ:**
- âœ… éå¸¸åœæ­¢ä¿¡å·ã®æå¤±ãªã—
- âœ… ã‚ˆã‚Šè‰¯ã„ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ (ã‚»ãƒ³ã‚µãƒ¼ç”¨BEST_EFFORT)
- âœ… é…ã‚Œã¦å‚åŠ ã—ãŸè€…ãŒé‡è¦ãªçŠ¶æ…‹ã‚’å–å¾— (TRANSIENT_LOCAL)
- âœ… æ˜ç¤ºçš„ãªé€šä¿¡è¦ä»¶

---

### 8.3 å¼·åŒ–ã•ã‚ŒãŸã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®šç¾©

**ç¾åœ¨ã®å•é¡Œ:** ã‚¢ã‚¯ã‚·ãƒ§ãƒ³çµæœã« `success: bool` ã®ã¿

**ææ¡ˆ:** ãƒªãƒƒãƒãªãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã¨è©³ç´°ãªçµæœ

**å¼·åŒ–ã•ã‚ŒãŸDock.action:**

```
# Goal
geometry_msgs/PoseStamped target_pose  # ãƒ‰ãƒƒã‚­ãƒ³ã‚°å…ˆ
float32 tolerance                      # ä½ç½®è¨±å®¹èª¤å·® (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ 0.002m)
---
# Result
bool success                           # å…¨ä½“çš„ãªæˆåŠŸ
string error_code                      # å¤±æ•—ã®å ´åˆ: "MARKERS_LOST", "TIMEOUT", "OBSTACLE" ãªã©
string detailed_message                # äººé–“ãŒèª­ã‚ã‚‹ã‚¨ãƒ©ãƒ¼èª¬æ˜

# æœ€çµ‚çŠ¶æ…‹
geometry_msgs/Pose final_pose          # å®Ÿéš›ã®æœ€çµ‚ä½ç½®
float32 final_distance_error_x         # Xã®èª¤å·® (ãƒ¡ãƒ¼ãƒˆãƒ«)
float32 final_distance_error_y         # Yã®èª¤å·® (ãƒ¡ãƒ¼ãƒˆãƒ«)
float32 final_yaw_error                # Yawã®èª¤å·® (ãƒ©ã‚¸ã‚¢ãƒ³)

# ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ¡ãƒˆãƒªã‚¯ã‚¹
float32 duration_seconds               # ãƒ‰ãƒƒã‚­ãƒ³ã‚°ã«ã‹ã‹ã£ãŸæ™‚é–“
int32 attempts                         # å†è©¦è¡Œå›æ•°
---
# Feedback (å®Ÿè¡Œä¸­ã«ãƒ‘ãƒ–ãƒªãƒƒã‚·ãƒ¥)
string current_phase                   # "APPROACH", "ALIGN_SINGLE", "ALIGN_DUAL", "VERIFY"
float32 distance_to_target             # ç¾åœ¨ã®è·é›¢ (ãƒ¡ãƒ¼ãƒˆãƒ«)
float32 centering_error                # æ¨ªæ–¹å‘èª¤å·® (ãƒ¡ãƒ¼ãƒˆãƒ«)
float32 yaw_error                      # å‘ãèª¤å·® (ãƒ©ã‚¸ã‚¢ãƒ³)
bool markers_visible                   # ãƒãƒ¼ã‚«ãƒ¼ãŒæ¤œå‡ºã•ã‚Œã¦ã„ã‚‹ã‹?
int32 marker_count                     # è¦‹ãˆã‚‹ãƒãƒ¼ã‚«ãƒ¼æ•° (1 ã¾ãŸã¯ 2)
float32 progress_percentage            # 0-100%
```

**ä½¿ç”¨æ³•:**

```cpp
// ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ (nav_master)
void dockingFeedbackCallback(const Dock::Feedback::ConstSharedPtr feedback) {
    RCLCPP_INFO(get_logger(), "ãƒ‰ãƒƒã‚­ãƒ³ã‚°é€²æ—: %d%% | ãƒ•ã‚§ãƒ¼ã‚º: %s | è·é›¢: %.3fm",
                (int)feedback->progress_percentage,
                feedback->current_phase.c_str(),
                feedback->distance_to_target);

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«è¡¨ç¤º
    displayProgress(feedback->progress_percentage, feedback->current_phase);
}

void dockingResultCallback(const Dock::Result::ConstSharedPtr result) {
    if (result->success) {
        RCLCPP_INFO(get_logger(),
                    "ãƒ‰ãƒƒã‚­ãƒ³ã‚°æˆåŠŸ!\n"
                    "  æœ€çµ‚èª¤å·®: X=%.1fmm, Y=%.1fmm, Yaw=%.1fÂ°\n"
                    "  æ‰€è¦æ™‚é–“: %.1fs, è©¦è¡Œå›æ•°: %d",
                    result->final_distance_error_x * 1000,
                    result->final_distance_error_y * 1000,
                    result->final_yaw_error * 180 / M_PI,
                    result->duration_seconds,
                    result->attempts);
    } else {
        RCLCPP_ERROR(get_logger(),
                     "ãƒ‰ãƒƒã‚­ãƒ³ã‚°å¤±æ•—: %s\n"
                     "  ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰: %s\n"
                     "  å¤±æ•—ã¾ã§ã®æ™‚é–“: %.1fs",
                     result->detailed_message.c_str(),
                     result->error_code.c_str(),
                     result->duration_seconds);

        // ç‰¹å®šã®ã‚¨ãƒ©ãƒ¼ã‚’å‡¦ç†
        if (result->error_code == "MARKERS_LOST") {
            // ãƒãƒ¼ã‚«ãƒ¼é…ç½®ã®ãƒã‚§ãƒƒã‚¯ã‚’ææ¡ˆ
        } else if (result->error_code == "TIMEOUT") {
            // PIDã‚²ã‚¤ãƒ³ã®ä½æ¸›ã¾ãŸã¯ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã®å¢—åŠ ã‚’ææ¡ˆ
        }
    }
}
```

**ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰:**
```cpp
enum class DockingErrorCode {
    SUCCESS = 0,
    MARKERS_LOST,           // ãƒ‰ãƒƒã‚­ãƒ³ã‚°ä¸­ã«ãƒãƒ¼ã‚«ãƒ¼ãŒæ¶ˆãˆãŸ
    TIMEOUT,                // æ™‚é–“ãŒã‹ã‹ã‚Šã™ããŸ (>120s)
    OBSTACLE_DETECTED,      // ã‚»ãƒ¼ãƒ•ãƒ†ã‚£ã‚·ã‚¹ãƒ†ãƒ ãŒãƒ‰ãƒƒã‚­ãƒ³ã‚°ã‚’åœæ­¢
    POSITION_UNSTABLE,      // å®‰å®šã—ãŸä½ç½®ã‚’é”æˆã§ããªã‹ã£ãŸ
    TOLERANCE_NOT_MET,      // æœ€çµ‚ä½ç½®ãŒè¨±å®¹èª¤å·®å¤–
    ACTION_CANCELLED,       // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«
    INTERNAL_ERROR          // äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼
};
```

**å·¥æ•°:** 12æ™‚é–“ (ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å†è¨­è¨ˆ + å®Ÿè£… + ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæ›´æ–°)

**ãƒ¡ãƒªãƒƒãƒˆ:**
- âœ… ã‚ˆã‚Šè‰¯ã„ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ ("ãƒãƒ¼ã‚«ãƒ¼æ¶ˆå¤±" vs "å¤±æ•—")
- âœ… é€²æ—ã®ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³ (0-100%)
- âœ… ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ¡ãƒˆãƒªã‚¯ã‚¹ (æ‰€è¦æ™‚é–“ã€ç²¾åº¦)
- âœ… ãƒ‡ãƒãƒƒã‚°ãŒå®¹æ˜“ (æ­£ç¢ºãªå¤±æ•—ãƒ¢ãƒ¼ãƒ‰ãŒã‚ã‹ã‚‹)
- âœ… ã‚ˆã‚Šè‰¯ã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¨ã‚¯ã‚¹ãƒšãƒªã‚¨ãƒ³ã‚¹

---

### 8.4 ãƒˆãƒ”ãƒƒã‚¯å‘½åã®æ¨™æº–åŒ–

**ç¾åœ¨ã®å•é¡Œ:** ä¸€è²«æ€§ã®ãªã„å‘½å (`/cmd_vel`, `/cmd_vel_final`, `/aruco_detect/markers_left`)

**ææ¡ˆ:** REP-144æ¨™æº–å‘½åè¦å‰‡

**å‘½åè¦å‰‡:**
```
/[robot_namespace]/[functionality]/[topic_name]

ä¾‹:
/multigo/navigation/cmd_vel
/multigo/docking/cmd_vel
/multigo/perception/markers/left
/multigo/perception/markers/right
/multigo/motion/cmd_vel_final
/multigo/safety/emergency_stop
/multigo/mission/state
```

**ç§»è¡Œãƒãƒƒãƒ—:**

| æ—§åç§° | æ–°åç§° | å‚™è€ƒ |
|----------|----------|-------|
| `/cmd_vel` | `/multigo/navigation/cmd_vel` | Nav2å‡ºåŠ› |
| `/cmd_vel_final` | `/multigo/docking/cmd_vel` | ãƒ‰ãƒƒã‚­ãƒ³ã‚°å‡ºåŠ› |
| `/cmd_vel_adjusted` | `/multigo/motion/cmd_vel` | ãƒ¢ãƒ¼ã‚¿ãƒ¼ã¸ã®æœ€çµ‚ |
| `/aruco_detect/markers_left` | `/multigo/perception/markers/left` | |
| `/aruco_detect/markers_right` | `/multigo/perception/markers/right` | |
| `/goal_pose` | `/multigo/navigation/goal_pose` | |
| `/scan` | `/multigo/sensors/scan` | LiDAR |
| `/camera/color/image_raw_left` | `/multigo/sensors/camera/left/image_raw` | |
| `/camera/color/image_raw_right` | `/multigo/sensors/camera/right/image_raw` | |

**ãƒ¡ãƒªãƒƒãƒˆ:**
- âœ… æ˜ç¢ºãªåå‰ç©ºé–“ã®æ•´ç†
- âœ… ãƒãƒ«ãƒãƒ­ãƒœãƒƒãƒˆå¯¾å¿œ (robot_idãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’è¿½åŠ )
- âœ… ãƒˆãƒ”ãƒƒã‚¯ç™ºè¦‹ãŒå®¹æ˜“ (`ros2 topic list | grep multigo/safety`)
- âœ… æ¥­ç•Œæ¨™æº– (REP-144)

**å·¥æ•°:** 16æ™‚é–“ (ã™ã¹ã¦ã®ãƒãƒ¼ãƒ‰ + ãƒ­ãƒ¼ãƒ³ãƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›´æ–° + ãƒ†ã‚¹ãƒˆ)

---

## 9. ææ¡ˆã•ã‚ŒãŸãƒ†ã‚¹ãƒˆã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£(ãƒ•ã‚§ãƒ¼ã‚º 2)

**ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:** 0% ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ âŒ

**ææ¡ˆã•ã‚ŒãŸã‚´ãƒ¼ãƒ«:** 80%+ ã‚«ãƒãƒ¬ãƒƒã‚¸ âœ…

### 9.1 ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ

**ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯:** gtest (C++)ã€pytest (Python)

**ç›®æ¨™:** 40-50ã®ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ

**ãƒ†ã‚¹ãƒˆä¾‹:**

```cpp
// test/test_pid_control.cpp
#include <gtest/gtest.h>
#include "nav_docking/pid_controller.hpp"

TEST(PIDControlTest, IntegralAccumulates) {
    PIDController pid(0.5, 0.1, 0.05);  // Kp, Ki, Kd

    double error = 1.0;
    double dt = 0.1;

    // 5å›ã®åå¾©ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
    double output = 0;
    for (int i = 0; i < 5; i++) {
        output = pid.compute(error, dt);
    }

    // ç©åˆ†ã¯ error * dt * iterations = 1.0 * 0.1 * 5 = 0.5 ã§ã‚ã‚‹ã¹ã
    EXPECT_NEAR(pid.getIntegral(), 0.5, 0.001);

    // å‡ºåŠ›ã«ã¯ç©åˆ†é …ãŒå«ã¾ã‚Œã‚‹ã¹ã: 0.1 * 0.5 = 0.05
    EXPECT_GT(output, 0.05);  // å°‘ãªãã¨ã‚‚ç©åˆ†ã®å¯„ä¸
}

TEST(PIDControlTest, DerivativeReducesOscillation) {
    PIDController pid(0.5, 0.0, 0.5);  // é«˜ã„Kd

    double dt = 0.1;

    // å¤§ããªåˆæœŸèª¤å·®
    double output1 = pid.compute(1.0, dt);

    // æ€¥é€Ÿã«æ¸›å°‘ã™ã‚‹èª¤å·® (ç›®æ¨™ã«è¿‘ã¥ã)
    double output2 = pid.compute(0.5, dt);

    // å¾®åˆ†é …ãŒå‡ºåŠ›ã‚’æ¸›å°‘ã•ã›ã‚‹ã¹ã (æ¸›è¡°)
    EXPECT_LT(output2, output1);
}

TEST(DualMarkerTest, CenterCalculation) {
    double left_x = 1.0, right_x = 0.8;
    double center_x = (left_x + right_x) / 2;

    EXPECT_NEAR(center_x, 0.9, 0.001);  // 0.9ã§ã‚ã‚‹ã¹ãã€1.4ã§ã¯ãªã„!
}

TEST(DualMarkerTest, OperatorPrecedenceBug) {
    double left_x = 1.0, right_x = 0.8;

    // èª¤ã‚Š (æ¼”ç®—å­ã®å„ªå…ˆé †ä½):
    double wrong_center = (left_x) + (right_x) / 2;  // = 1.0 + 0.4 = 1.4
    EXPECT_NEAR(wrong_center, 1.4, 0.001);

    // æ­£è§£:
    double correct_center = (left_x + right_x) / 2;  // = 1.8 / 2 = 0.9
    EXPECT_NEAR(correct_center, 0.9, 0.001);

    // ç•°ãªã‚‹ã“ã¨ã‚’ç¢ºèª!
    EXPECT_NE(wrong_center, correct_center);
}

TEST(ArucoDetectTest, OpenCVToROSConversion) {
    cv::Vec3d opencv_tvec(1.0, 0.0, 2.0);  // OpenCVãƒ•ãƒ¬ãƒ¼ãƒ 

    // ROSãƒ•ãƒ¬ãƒ¼ãƒ ã«å¤‰æ›
    geometry_msgs::msg::Pose ros_pose = convertOpenCVToROS(opencv_tvec);

    // OpenCV X -> ROS -Y, OpenCV Y -> ROS -Z, OpenCV Z -> ROS X
    EXPECT_NEAR(ros_pose.position.x, 2.0, 0.001);   // Z -> X
    EXPECT_NEAR(ros_pose.position.y, -1.0, 0.001);  // X -> -Y
    EXPECT_NEAR(ros_pose.position.z, 0.0, 0.001);   // Y -> -Z
}

TEST(StateMachineTest, StateTransitions) {
    MissionStateMachine sm;

    EXPECT_EQ(sm.getState(), MissionState::IDLE);

    // ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’ãƒˆãƒªã‚¬ãƒ¼
    sm.handleEvent(Event::APPROACH_REQUESTED);
    EXPECT_EQ(sm.getState(), MissionState::WAITING_APPROACH_CONFIRMATION);

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ç¢ºèª
    sm.handleEvent(Event::USER_CONFIRMED);
    EXPECT_EQ(sm.getState(), MissionState::NAVIGATING_TO_GOAL);

    // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³æˆåŠŸ
    sm.handleEvent(Event::APPROACH_SUCCEEDED);
    EXPECT_EQ(sm.getState(), MissionState::WAITING_DOCK_CONFIRMATION);
}

TEST(SafetySupervisorTest, EmergencyStopTriggered) {
    SafetySupervisor supervisor;

    EXPECT_EQ(supervisor.getState(), SafetyState::SAFE);

    // éå¸¸ã«è¿‘ã„éšœå®³ç‰©ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ (10cm)
    auto scan = createLaserScan({0.10, 0.10, 0.10});  // ã™ã¹ã¦ã®ç¯„å›²ãŒ10cm
    supervisor.scanCallback(std::make_shared<LaserScan>(scan));

    EXPECT_EQ(supervisor.getState(), SafetyState::EMERGENCY_STOP);
}

TEST(SafetyZoneTest, KeepOutZoneDetection) {
    SafetyZoneManager zone_manager;

    // ç«‹å…¥ç¦æ­¢ã‚¾ãƒ¼ãƒ³ã‚’å®šç¾© (ã‚¨ãƒ¬ãƒ™ãƒ¼ã‚¿ãƒ¼ã‚·ãƒ£ãƒ•ãƒˆ)
    Polygon elevator = {{5.0, 10.0}, {6.0, 10.0}, {6.0, 11.0}, {5.0, 11.0}};
    zone_manager.addKeepOutZone("elevator", elevator);

    // ã‚¾ãƒ¼ãƒ³å†…ã‚’ãƒ†ã‚¹ãƒˆ (å®‰å…¨ã§ãªã„)
    EXPECT_FALSE(zone_manager.isPositionSafe(5.5, 10.5));

    // ã‚¾ãƒ¼ãƒ³å¤–ã‚’ãƒ†ã‚¹ãƒˆ (å®‰å…¨)
    EXPECT_TRUE(zone_manager.isPositionSafe(7.0, 10.5));
}
```

**ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ:**
```bash
# ãƒ†ã‚¹ãƒˆä»˜ãã§ãƒ“ãƒ«ãƒ‰
colcon build --symlink-install

# ã™ã¹ã¦ã®ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
colcon test --packages-select nav_docking

# ç‰¹å®šã®ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
colcon test --packages-select nav_docking --ctest-args -R test_pid_control

# çµæœã‚’è¡¨ç¤º
colcon test-result --verbose
```

**å·¥æ•°:** 60æ™‚é–“ (48hé–‹ç™º + 12hãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£/ãƒ¢ãƒƒã‚¯)

---

### 9.2 çµ±åˆãƒ†ã‚¹ãƒˆ

**ç›®æ¨™:** 10-15ã®çµ±åˆãƒ†ã‚¹ãƒˆ

**ãƒ†ã‚¹ãƒˆç’°å¢ƒ:** ãƒ•ã‚§ã‚¤ã‚¯ã‚»ãƒ³ã‚µãƒ¼ä»˜ãã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ (Gazebo)

**ãƒ†ã‚¹ãƒˆä¾‹:**

```python
# test/integration/test_approach_workflow.py
import pytest
import rclpy
from nav_interface.action import Approach

def test_approach_success(ros_node):
    """å®Œå…¨ãªã‚¢ãƒ—ãƒ­ãƒ¼ãƒãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ãƒ†ã‚¹ãƒˆ"""

    # ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—: ãƒ­ãƒœãƒƒãƒˆãŒåŸç‚¹ã€ãƒãƒ¼ã‚«ãƒ¼ãŒ (5, 0)
    publish_marker_pose(x=5.0, y=0.0, yaw=3.14159)

    # å®Ÿè¡Œ: ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚´ãƒ¼ãƒ«ã‚’é€ä¿¡
    result = send_approach_goal(timeout_sec=60.0)

    # æ¤œè¨¼: ã‚¢ãƒ—ãƒ­ãƒ¼ãƒæˆåŠŸ
    assert result.success == True

    # æ¤œè¨¼: ãƒ­ãƒœãƒƒãƒˆãŒã‚´ãƒ¼ãƒ«ã«åˆ°é” (5cmä»¥å†…)
    final_pose = get_robot_pose()
    assert abs(final_pose.x - 4.695) < 0.05  # 5.0 - 0.305
    assert abs(final_pose.y - 0.0) < 0.05

def test_docking_precision(ros_node):
    """ç²¾å¯†ãƒ‰ãƒƒã‚­ãƒ³ã‚°ã®ç²¾åº¦ã‚’ãƒ†ã‚¹ãƒˆ"""

    # ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—: ãƒ­ãƒœãƒƒãƒˆã‚’ã‚¢ãƒ—ãƒ­ãƒ¼ãƒä½ç½®ã«é…ç½®
    position_robot_at_approach_pose()

    # å®Ÿè¡Œ: ãƒ‰ãƒƒã‚­ãƒ³ã‚°ã‚´ãƒ¼ãƒ«ã‚’é€ä¿¡
    result = send_dock_goal(timeout_sec=60.0)

    # æ¤œè¨¼: ãƒ‰ãƒƒã‚­ãƒ³ã‚°æˆåŠŸ
    assert result.success == True

    # æ¤œè¨¼: é«˜ç²¾åº¦ (<2mm)
    assert result.final_distance_error_x < 0.002  # 2mm
    assert result.final_distance_error_y < 0.002  # 2mm

    # æ¤œè¨¼: æ‰€è¦æ™‚é–“ãŒå¦¥å½“ (15-30s)
    assert 15.0 < result.duration_seconds < 30.0

def test_obstacle_stops_docking(ros_node):
    """å®‰å…¨æ€§: éšœå®³ç‰©æ¤œå‡ºãŒãƒ‰ãƒƒã‚­ãƒ³ã‚°ã‚’åœæ­¢"""

    # ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—: ãƒ‰ãƒƒã‚­ãƒ³ã‚°é–‹å§‹
    dock_goal_handle = send_dock_goal_async()
    time.sleep(2.0)  # ãƒ‰ãƒƒã‚­ãƒ³ã‚°é–‹å§‹ã‚’å¾…ã¤

    # ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ: çµŒè·¯ã«éšœå®³ç‰©ãŒå‡ºç¾
    spawn_obstacle_in_path(distance=0.2)  # ãƒ­ãƒœãƒƒãƒˆã‹ã‚‰20cm

    # æ¤œè¨¼: ãƒ­ãƒœãƒƒãƒˆãŒ1ç§’ä»¥å†…ã«åœæ­¢
    time.sleep(1.0)
    velocity = get_robot_velocity()
    assert velocity.linear.x < 0.01  # ã»ã¼åœæ­¢

    # æ¤œè¨¼: ãƒ‰ãƒƒã‚­ãƒ³ã‚°ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒå¤±æ•—ã¾ãŸã¯ä¸€æ™‚åœæ­¢ã‚’å ±å‘Š
    # (å®Ÿè£…ã«ä¾å­˜: abortã€pauseã€ã¾ãŸã¯ wait)

def test_marker_loss_recovery(ros_node):
    """ãƒ‰ãƒƒã‚­ãƒ³ã‚°ãŒãƒãƒ¼ã‚«ãƒ¼æ¶ˆå¤±ã‚’å‡¦ç†ã™ã‚‹ã“ã¨ã‚’ãƒ†ã‚¹ãƒˆ"""

    # ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—: ãƒ‰ãƒƒã‚­ãƒ³ã‚°é–‹å§‹
    dock_goal_handle = send_dock_goal_async()
    time.sleep(2.0)

    # ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ: ãƒãƒ¼ã‚«ãƒ¼ãŒæ¶ˆãˆã‚‹ (éšœå®³ç‰©ã§ãƒ–ãƒ­ãƒƒã‚¯)
    hide_markers(duration_sec=3.0)

    # æ¤œè¨¼: ãƒ­ãƒœãƒƒãƒˆãŒåœæ­¢ã¾ãŸã¯æ¸›é€Ÿ
    time.sleep(0.5)
    velocity = get_robot_velocity()
    assert velocity.linear.x < 0.05

    # ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ: ãƒãƒ¼ã‚«ãƒ¼ãŒå†å‡ºç¾
    show_markers()

    # æ¤œè¨¼: ãƒ‰ãƒƒã‚­ãƒ³ã‚°ãŒå†é–‹ã—ã¦å®Œäº†
    result = wait_for_dock_result(timeout_sec=30.0)
    assert result.success == True

def test_full_workflow_approach_dock(ros_node):
    """å®Œå…¨ãªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ãƒ†ã‚¹ãƒˆ: idle â†’ approach â†’ dock â†’ docked"""

    # åˆæœŸçŠ¶æ…‹ã‚’æ¤œè¨¼
    assert get_mission_state() == "IDLE"

    # ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
    trigger_approach()
    time.sleep(1.0)
    assert get_mission_state() == "WAITING_APPROACH_CONFIRMATION"

    # ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’ç¢ºèª
    confirm_approach()
    assert get_mission_state() == "NAVIGATING_TO_GOAL"

    # ã‚¢ãƒ—ãƒ­ãƒ¼ãƒå®Œäº†ã‚’å¾…ã¤
    wait_for_state("WAITING_DOCK_CONFIRMATION", timeout_sec=60.0)

    # ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ‰ãƒƒã‚­ãƒ³ã‚°ã‚’ç¢ºèª
    confirm_dock()
    assert get_mission_state() == "DOCKING"

    # ãƒ‰ãƒƒã‚­ãƒ³ã‚°å®Œäº†ã‚’å¾…ã¤
    wait_for_state("DOCKED", timeout_sec=60.0)

    # æœ€çµ‚çŠ¶æ…‹ã¨ä½ç½®ã‚’æ¤œè¨¼
    assert get_mission_state() == "DOCKED"
    final_pose = get_robot_pose()
    target_pose = get_target_pose()
    assert pose_distance(final_pose, target_pose) < 0.002  # <2mm
```

**ãƒ†ã‚¹ãƒˆãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£:**

```python
@pytest.fixture
def ros_node():
    """ãƒ†ã‚¹ãƒˆç”¨ã®ROS 2ãƒãƒ¼ãƒ‰ã‚’ä½œæˆ"""
    rclpy.init()
    node = rclpy.create_node('test_node')
    yield node
    node.destroy_node()
    rclpy.shutdown()

@pytest.fixture
def simulation():
    """Gazeboã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’èµ·å‹•"""
    sim_process = launch_simulation("test_world.sdf")
    time.sleep(10.0)  # ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®å®‰å®šåŒ–ã‚’å¾…ã¤
    yield sim_process
    sim_process.terminate()
    sim_process.wait()
```

**çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ:**
```bash
# ãƒ†ã‚¹ãƒˆã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’èµ·å‹•
ros2 launch multigo_testing test_simulation.launch.py

# çµ±åˆãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
pytest test/integration/ -v

# ç‰¹å®šã®ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
pytest test/integration/test_approach_workflow.py::test_full_workflow_approach_dock -v -s
```

**å·¥æ•°:** 30æ™‚é–“ (20hãƒ†ã‚¹ãƒˆ + 10hãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£/ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³)

---

### 9.3 CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³

**ãƒ„ãƒ¼ãƒ«:** GitHub Actions

**è¨­å®š:** `.github/workflows/ci.yml`

```yaml
name: MultiGo CI Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  build-and-test:
    runs-on: ubuntu-22.04
    container:
      image: ros:humble

    steps:
      - name: ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v3

      - name: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          apt update
          apt install -y python3-pip
          rosdep update
          rosdep install --from-paths src --ignore-src -r -y

      - name: ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’ãƒ“ãƒ«ãƒ‰
        run: |
          source /opt/ros/humble/setup.bash
          colcon build --symlink-install --cmake-args -DCMAKE_BUILD_TYPE=Release

      - name: ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
        run: |
          source install/setup.bash
          colcon test --packages-select nav_docking nav_goal nav_control aruco_detect
          colcon test-result --verbose

      - name: çµ±åˆãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
        run: |
          source install/setup.bash
          pytest test/integration/ -v

      - name: ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ
        run: |
          pip install coverage
          coverage report --fail-under=80

      - name: ã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’Codecovã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.xml
          flags: unittests
          name: codecov-umbrella

      - name: ã‚³ãƒ¼ãƒ‰ã‚’ãƒªãƒ³ãƒˆ (C++)
        run: |
          apt install -y clang-format
          find src -name '*.cpp' -o -name '*.hpp' | xargs clang-format --dry-run --Werror

      - name: ã‚³ãƒ¼ãƒ‰ã‚’ãƒªãƒ³ãƒˆ (Python)
        run: |
          pip install flake8
          flake8 src --count --select=E9,F63,F7,F82 --show-source --statistics
```

**ã‚«ãƒãƒ¬ãƒƒã‚¸è¦ä»¶:**
- æœ€ä½80%ã®ãƒ©ã‚¤ãƒ³ã‚«ãƒãƒ¬ãƒƒã‚¸
- æœ€ä½70%ã®ãƒ–ãƒ©ãƒ³ãƒã‚«ãƒãƒ¬ãƒƒã‚¸
- ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒåˆæ ¼ã™ã‚‹å¿…è¦ãŒã‚ã‚‹

**å·¥æ•°:** 16æ™‚é–“ (CIã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— + è¨­å®š + ãƒ†ã‚¹ãƒˆ)

---

## 10. ææ¡ˆã•ã‚ŒãŸãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£(ãƒ•ã‚§ãƒ¼ã‚º 4)

### 10.1 Dockerãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆ

**ç›®çš„:** ç°¡å˜ãªè¤‡è£½ã®ãŸã‚ã®ã‚³ãƒ³ãƒ†ãƒŠåŒ–ã•ã‚ŒãŸãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆ

**Docker Composeè¨­å®š:**

```yaml
# docker-compose.yml
version: '3.8'

services:
  # ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ (ãƒ‡ãƒã‚¤ã‚¹ã‚¢ã‚¯ã‚»ã‚¹ãŒå¿…è¦)
  hardware:
    image: multigo/hardware:${VERSION:-latest}
    container_name: multigo_hardware
    privileged: true  # ãƒ‡ãƒã‚¤ã‚¹ã‚¢ã‚¯ã‚»ã‚¹ã®ãŸã‚
    devices:
      - /dev/video0:/dev/video0        # å·¦ã‚«ãƒ¡ãƒ©
      - /dev/video1:/dev/video1        # å³ã‚«ãƒ¡ãƒ©
      - /dev/ttyUSB0:/dev/ttyUSB0      # LiDAR
      - /dev/phidget:/dev/phidget      # ãƒ¢ãƒ¼ã‚¿ãƒ¼ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼
    environment:
      - ROS_DOMAIN_ID=42
    command: ros2 launch boot boot.launch.py
    networks:
      - ros_network

  # ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã¨ãƒ‰ãƒƒã‚­ãƒ³ã‚°
  navigation:
    image: multigo/navigation:${VERSION:-latest}
    container_name: multigo_navigation
    depends_on:
      - hardware
    environment:
      - ROS_DOMAIN_ID=42
      - ROS_LOCALHOST_ONLY=0
    command: ros2 launch boot run.launch.py
    networks:
      - ros_network

  # ã‚»ãƒ¼ãƒ•ãƒ†ã‚£ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒã‚¤ã‚¶ãƒ¼ (é‡è¦ã€å¸¸ã«å†èµ·å‹•)
  safety:
    image: multigo/safety:${VERSION:-latest}
    container_name: multigo_safety
    depends_on:
      - hardware
      - navigation
    environment:
      - ROS_DOMAIN_ID=42
    command: ros2 run safety_supervisor safety_supervisor_node
    restart: always  # ã‚»ãƒ¼ãƒ•ãƒ†ã‚£ã¯é‡è¦!
    networks:
      - ros_network

  # Web UI (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)
  web_ui:
    image: multigo/web_ui:${VERSION:-latest}
    container_name: multigo_web_ui
    ports:
      - "8080:8080"
    environment:
      - ROS_DOMAIN_ID=42
    command: python3 -m multigo_web_ui
    networks:
      - ros_network

networks:
  ros_network:
    driver: bridge
```

**Dockerfiles:**

```dockerfile
# Dockerfile.hardware
FROM ros:humble-ros-base

# ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN apt-get update && apt-get install -y \
    ros-humble-camera-info-manager \
    ros-humble-cv-bridge \
    python3-pip \
    libphidget22 \
    && rm -rf /var/lib/apt/lists/*

# ã‚½ãƒ¼ã‚¹ã‚’ã‚³ãƒ”ãƒ¼
COPY src/camera_publisher /workspace/src/camera_publisher
COPY src/mecanum_wheels /workspace/src/mecanum_wheels

# ãƒ“ãƒ«ãƒ‰
WORKDIR /workspace
RUN source /opt/ros/humble/setup.bash && \
    colcon build --symlink-install

# ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ
COPY docker/entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh
ENTRYPOINT ["/entrypoint.sh"]
```

**ãƒ“ãƒ«ãƒ‰ã¨ãƒ‡ãƒ—ãƒ­ã‚¤:**

```bash
# ã™ã¹ã¦ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰
docker-compose build

# ãƒ‡ãƒ—ãƒ­ã‚¤
docker-compose up -d

# ãƒ­ã‚°ã‚’è¡¨ç¤º
docker-compose logs -f

# åœæ­¢
docker-compose down
```

**å·¥æ•°:** 40æ™‚é–“ (Dockerfilesä½œæˆ + ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ†ã‚¹ãƒˆ + ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ)

---

### 10.2 è¨­å®šç®¡ç†

**å•é¡Œ:** ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤šã™ãã‚‹ã€å„ªå…ˆé †ä½ãŒä¸æ˜ç¢º

**ææ¡ˆ:** éšå±¤çš„è¨­å®šã‚·ã‚¹ãƒ†ãƒ 

**æ§‹é€ :**

```
config/
â”œâ”€â”€ defaults/
â”‚   â”œâ”€â”€ navigation.yaml       # ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã®ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
â”‚   â”œâ”€â”€ docking.yaml          # ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã®ãƒ‰ãƒƒã‚­ãƒ³ã‚°ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
â”‚   â””â”€â”€ safety.yaml           # ã‚»ãƒ¼ãƒ•ãƒ†ã‚£ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
â”‚
â”œâ”€â”€ robots/
â”‚   â”œâ”€â”€ multigo_001.yaml      # ãƒ­ãƒœãƒƒãƒˆå›ºæœ‰ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰
â”‚   â”œâ”€â”€ multigo_002.yaml
â”‚   â””â”€â”€ multigo_test.yaml     # ãƒ†ã‚¹ãƒˆãƒ­ãƒœãƒƒãƒˆ
â”‚
â”œâ”€â”€ environments/
â”‚   â”œâ”€â”€ hospital_floor2.yaml  # ç’°å¢ƒå›ºæœ‰ (ãƒãƒƒãƒ—ã€ã‚¾ãƒ¼ãƒ³)
â”‚   â”œâ”€â”€ hospital_floor3.yaml
â”‚   â””â”€â”€ simulation.yaml       # ãƒ†ã‚¹ãƒˆç”¨
â”‚
â””â”€â”€ missions/
    â”œâ”€â”€ wheelchair_dock.yaml  # ãƒŸãƒƒã‚·ãƒ§ãƒ³å›ºæœ‰ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
    â”œâ”€â”€ bed_dock.yaml
    â””â”€â”€ transport.yaml
```

**èª­ã¿è¾¼ã¿å„ªå…ˆé †ä½ (é«˜ã‹ã‚‰ä½):**
1. ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³å¼•æ•° (`--params-file`)
2. ãƒŸãƒƒã‚·ãƒ§ãƒ³è¨­å®š (`wheelchair_dock.yaml`)
3. ç’°å¢ƒè¨­å®š (`hospital_floor2.yaml`)
4. ãƒ­ãƒœãƒƒãƒˆè¨­å®š (`multigo_001.yaml`)
5. ã‚·ã‚¹ãƒ†ãƒ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ (`navigation.yaml`, `docking.yaml`)

**è¨­å®šãƒ­ãƒ¼ãƒ€ãƒ¼:**

```python
# config_loader.py
class HierarchicalConfigLoader:
    def __init__(self, config_dir: str):
        self.config_dir = Path(config_dir)

    def load_config(self,
                   robot_id: str,
                   environment: str,
                   mission: str) -> Dict:
        """è¨­å®šéšå±¤ã‚’èª­ã¿è¾¼ã‚“ã§ãƒãƒ¼ã‚¸"""

        # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‹ã‚‰é–‹å§‹
        config = self.load_yaml(self.config_dir / "defaults" / "navigation.yaml")
        config.update(self.load_yaml(self.config_dir / "defaults" / "docking.yaml"))
        config.update(self.load_yaml(self.config_dir / "defaults" / "safety.yaml"))

        # ãƒ­ãƒœãƒƒãƒˆå›ºæœ‰ã§ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰
        robot_config = self.config_dir / "robots" / f"{robot_id}.yaml"
        if robot_config.exists():
            config.update(self.load_yaml(robot_config))

        # ç’°å¢ƒå›ºæœ‰ã§ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰
        env_config = self.config_dir / "environments" / f"{environment}.yaml"
        if env_config.exists():
            config.update(self.load_yaml(env_config))

        # ãƒŸãƒƒã‚·ãƒ§ãƒ³å›ºæœ‰ã§ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰
        mission_config = self.config_dir / "missions" / f"{mission}.yaml"
        if mission_config.exists():
            config.update(self.load_yaml(mission_config))

        return config
```

**ä½¿ç”¨æ³•:**

```bash
# éšå±¤çš„è¨­å®šã§èµ·å‹•
ros2 launch multigo_launch run.launch.py \
    robot_id:=multigo_001 \
    environment:=hospital_floor2 \
    mission:=wheelchair_dock
```

**å·¥æ•°:** 24æ™‚é–“ (ãƒ­ãƒ¼ãƒ€ãƒ¼å®Ÿè£… + è¨­å®šç§»è¡Œ + ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ)

---

### 10.3 ãƒ†ã‚£ãƒ¼ãƒãƒ³ã‚°ãƒ¢ãƒ¼ãƒ‰ (ã‚¦ã‚§ã‚¤ãƒã‚¤ãƒ³ãƒˆã‚·ã‚¹ãƒ†ãƒ )

**ç›®çš„:** æŠ€è¡“è€…ã§ãªã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ­ãƒœãƒƒãƒˆã«æ–°ã—ã„ãƒ«ãƒ¼ãƒˆã¨ãƒ‰ãƒƒã‚­ãƒ³ã‚°ä½ç½®ã‚’æ•™ãˆã‚‰ã‚Œã‚‹

**å®Ÿè£…:**

**1. ã‚¦ã‚§ã‚¤ãƒã‚¤ãƒ³ãƒˆãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼:**

```cpp
class WaypointManager : public rclcpp::Node {
private:
    std::map<std::string, geometry_msgs::msg::Pose> waypoints_;
    std::string waypoints_file_;

public:
    WaypointManager() : Node("waypoint_manager") {
        // ã‚µãƒ¼ãƒ“ã‚¹
        save_service_ = create_service<multigo_msgs::srv::SaveWaypoint>(
            "/waypoint/save",
            std::bind(&WaypointManager::handleSave, this, _1, _2)
        );

        get_service_ = create_service<multigo_msgs::srv::GetWaypoint>(
            "/waypoint/get",
            std::bind(&WaypointManager::handleGet, this, _1, _2)
        );

        list_service_ = create_service<multigo_msgs::srv::ListWaypoints>(
            "/waypoint/list",
            std::bind(&WaypointManager::handleList, this, _1, _2)
        );

        // æ—¢å­˜ã®ã‚¦ã‚§ã‚¤ãƒã‚¤ãƒ³ãƒˆã‚’èª­ã¿è¾¼ã¿
        loadWaypoints();
    }

    void handleSave(
        const std::shared_ptr<SaveWaypoint::Request> request,
        std::shared_ptr<SaveWaypoint::Response> response
    ) {
        // ç¾åœ¨ã®ãƒ­ãƒœãƒƒãƒˆå§¿å‹¢ã‚’å–å¾—
        geometry_msgs::msg::PoseStamped current_pose;
        if (!getCurrentPose(current_pose)) {
            response->success = false;
            response->message = "ç¾åœ¨ã®å§¿å‹¢ã®å–å¾—ã«å¤±æ•—";
            return;
        }

        // ã‚¦ã‚§ã‚¤ãƒã‚¤ãƒ³ãƒˆã‚’ä¿å­˜
        waypoints_[request->waypoint_id] = current_pose.pose;

        // ãƒ‡ã‚£ã‚¹ã‚¯ã«æ°¸ç¶šåŒ–
        saveWaypoints();

        response->success = true;
        response->message = "ã‚¦ã‚§ã‚¤ãƒã‚¤ãƒ³ãƒˆä¿å­˜: " + request->waypoint_id;

        RCLCPP_INFO(get_logger(), "ã‚¦ã‚§ã‚¤ãƒã‚¤ãƒ³ãƒˆ '%s' ã‚’ (%.2f, %.2f) ã«ä¿å­˜",
                    request->waypoint_id.c_str(),
                    current_pose.pose.position.x,
                    current_pose.pose.position.y);
    }

    void saveWaypoints() {
        YAML::Emitter out;
        out << YAML::BeginMap;
        out << YAML::Key << "waypoints";
        out << YAML::Value << YAML::BeginSeq;

        for (const auto& [id, pose] : waypoints_) {
            out << YAML::BeginMap;
            out << YAML::Key << "id" << YAML::Value << id;
            out << YAML::Key << "pose";
            out << YAML::Value << YAML::BeginMap;
            out << YAML::Key << "x" << YAML::Value << pose.position.x;
            out << YAML::Key << "y" << YAML::Value << pose.position.y;
            out << YAML::Key << "yaw" << YAML::Value << getYawFromQuaternion(pose.orientation);
            out << YAML::EndMap;
            out << YAML::EndMap;
        }

        out << YAML::EndSeq;
        out << YAML::EndMap;

        std::ofstream fout(waypoints_file_);
        fout << out.c_str();
        fout.close();
    }
};
```

**2. ãƒ†ã‚£ãƒ¼ãƒãƒ³ã‚°ãƒ¢ãƒ¼ãƒ‰èµ·å‹•:**

```python
# teaching_mode.launch.py
def generate_launch_description():
    return LaunchDescription([
        # ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ã‚’èµ·å‹•
        IncludeLaunchDescription(
            PythonLaunchDescriptionSource('boot.launch.py')
        ),

        # RTAB-Mapã‚’ãƒãƒƒãƒ”ãƒ³ã‚°ãƒ¢ãƒ¼ãƒ‰ã§èµ·å‹•
        Node(
            package='rtabmap_ros',
            executable='rtabmap',
            parameters=[{
                'Mem/IncrementalMemory': 'true',  # ãƒãƒƒãƒ”ãƒ³ã‚°ãƒ¢ãƒ¼ãƒ‰
                'Mem/InitWMWithAllNodes': 'false'
            }]
        ),

        # ã‚¦ã‚§ã‚¤ãƒã‚¤ãƒ³ãƒˆãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã‚’èµ·å‹•
        Node(
            package='multigo_waypoints',
            executable='waypoint_manager',
            parameters=[{
                'waypoints_file': '/config/waypoints/hospital_floor2.yaml'
            }]
        ),

        # æ‰‹å‹•åˆ¶å¾¡ç”¨ã®ãƒ†ãƒ¬ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’èµ·å‹•
        Node(
            package='teleop_twist_keyboard',
            executable='teleop_twist_keyboard',
            prefix='xterm -e',  # åˆ¥ã®ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§å®Ÿè¡Œ
            remappings=[
                ('/cmd_vel', '/multigo/teleop/cmd_vel')
            ]
        ),

        # ã‚¦ã‚§ã‚¤ãƒã‚¤ãƒ³ãƒˆãƒ†ã‚£ãƒ¼ãƒãƒ³ã‚°GUI
        Node(
            package='multigo_teaching',
            executable='teaching_gui',
            output='screen'
        )
    ])
```

**3. ãƒ†ã‚£ãƒ¼ãƒãƒ³ã‚°ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼:**

```bash
# ã‚¹ãƒ†ãƒƒãƒ—1: ãƒ†ã‚£ãƒ¼ãƒãƒ³ã‚°ãƒ¢ãƒ¼ãƒ‰ã§èµ·å‹•
ros2 launch multigo_teaching teaching_mode.launch.py

# ã‚¹ãƒ†ãƒƒãƒ—2: ãƒ­ãƒœãƒƒãƒˆã‚’æ‰‹å‹•ã§å ´æ‰€ã¾ã§é‹è»¢ (ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰/ã‚¸ãƒ§ã‚¤ã‚¹ãƒ†ã‚£ãƒƒã‚¯ä½¿ç”¨)
# çŸ¢å°ã‚­ãƒ¼ã§ç§»å‹•ã€ãƒ­ãƒœãƒƒãƒˆã¯ç§»å‹•ã—ãªãŒã‚‰ãƒãƒƒãƒ—ã‚’æ§‹ç¯‰

# ã‚¹ãƒ†ãƒƒãƒ—3: å„é‡è¦ãªå ´æ‰€ã§ã‚¦ã‚§ã‚¤ãƒã‚¤ãƒ³ãƒˆã‚’ä¿å­˜
ros2 service call /waypoint/save multigo_msgs/srv/SaveWaypoint "{waypoint_id: 'room_205_door'}"
ros2 service call /waypoint/save multigo_msgs/srv/SaveWaypoint "{waypoint_id: 'room_205_bed'}"

# ã‚¹ãƒ†ãƒƒãƒ—4: ãƒãƒƒãƒ—ã‚’ä¿å­˜
ros2 service call /rtabmap/save_map std_srvs/srv/Empty

# ã‚¹ãƒ†ãƒƒãƒ—5: ã™ã¹ã¦ã®ä¿å­˜ã•ã‚ŒãŸã‚¦ã‚§ã‚¤ãƒã‚¤ãƒ³ãƒˆã‚’ãƒªã‚¹ãƒˆ
ros2 service call /waypoint/list multigo_msgs/srv/ListWaypoints

# ã‚¹ãƒ†ãƒƒãƒ—6: ä¿å­˜ã•ã‚ŒãŸãƒãƒƒãƒ—ã§è‡ªå¾‹ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ
ros2 launch multigo_launch run.launch.py map:=hospital_floor2.db
```

**ãƒ†ã‚£ãƒ¼ãƒãƒ³ã‚°GUI (RVizãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã¾ãŸã¯Webã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹):**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       ãƒ†ã‚£ãƒ¼ãƒãƒ³ã‚°ãƒ¢ãƒ¼ãƒ‰ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç¾åœ¨ä½ç½®: (12.5, 8.3)                   â”‚
â”‚ ãƒãƒƒãƒ—ã‚«ãƒãƒ¬ãƒƒã‚¸: 85%                   â”‚
â”‚                                         â”‚
â”‚ ä¿å­˜ã•ã‚ŒãŸã‚¦ã‚§ã‚¤ãƒã‚¤ãƒ³ãƒˆ:                â”‚
â”‚  â˜‘ room_205_door     (10.2, 7.1)       â”‚
â”‚  â˜‘ room_205_bed      (12.5, 8.3)       â”‚
â”‚  â˜‘ charging_station  (5.0, 2.0)        â”‚
â”‚                                         â”‚
â”‚ [ç¾åœ¨ä½ç½®ã‚’ä¿å­˜]                         â”‚
â”‚ ã‚¦ã‚§ã‚¤ãƒã‚¤ãƒ³ãƒˆå: _______________        â”‚
â”‚                                         â”‚
â”‚ [ãƒãƒƒãƒ—ã‚’ä¿å­˜ã—ã¦ãƒ†ã‚£ãƒ¼ãƒãƒ³ã‚°ãƒ¢ãƒ¼ãƒ‰ã‚’çµ‚äº†] â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å·¥æ•°:** 40æ™‚é–“ (ã‚¦ã‚§ã‚¤ãƒã‚¤ãƒ³ãƒˆãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ 20h + GUI 20h)

**ãƒ¡ãƒªãƒƒãƒˆ:**
- âœ… æŠ€è¡“è€…ã§ãªã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ«ãƒ¼ãƒˆã‚’æ•™ãˆã‚‰ã‚Œã‚‹
- âœ… ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ä¸è¦
- âœ… ç’°å¢ƒãŒå¤‰ã‚ã£ãŸæ™‚ã«ç°¡å˜ã«æ›´æ–°å¯èƒ½
- âœ… ã™ã¹ã¦ã®ä¿å­˜ã•ã‚ŒãŸã‚¦ã‚§ã‚¤ãƒã‚¤ãƒ³ãƒˆã‚’è¦–è¦šåŒ–

---

## ã¾ã¨ã‚: å®Ÿè£…ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—

### ãƒ•ã‚§ãƒ¼ã‚º1: é‡å¤§ãªãƒã‚°ã¨ã‚»ãƒ¼ãƒ•ãƒ†ã‚£ (4é€±é–“) - 144æ™‚é–“
**å„ªå…ˆåº¦:** ğŸ”´ é‡è¦

**æˆæœç‰©:**
- âœ… 3ã¤ã®é‡å¤§ãªãƒã‚°ã‚’ä¿®æ­£ (CRIT-01ã€CRIT-02ã€HIGH-01)
- âœ… ã‚»ãƒ¼ãƒ•ãƒ†ã‚£ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒã‚¤ã‚¶ãƒ¼ãƒ¬ã‚¤ãƒ¤ãƒ¼
- âœ… ç·Šæ€¥åœæ­¢ãƒ¡ã‚«ãƒ‹ã‚ºãƒ 
- âœ… nav_masterã®çŠ¶æ…‹ãƒã‚·ãƒ³
- âœ… ãƒ‰ãƒƒã‚­ãƒ³ã‚°ä¸­ã®LiDARç›£è¦–
- âœ… åŸºæœ¬çš„ãªã‚¸ã‚ªãƒ•ã‚§ãƒ³ã‚·ãƒ³ã‚°

**çµæœ:** ãƒ†ã‚¹ãƒˆæº–å‚™ãŒæ•´ã£ãŸå®‰å…¨ãªã‚·ã‚¹ãƒ†ãƒ 

---

### ãƒ•ã‚§ãƒ¼ã‚º2: ãƒ†ã‚¹ãƒˆã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£ (4é€±é–“) - 96æ™‚é–“
**å„ªå…ˆåº¦:** ğŸ”´ é‡è¦

**æˆæœç‰©:**
- âœ… 40-50ã®ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ (80%ã‚«ãƒãƒ¬ãƒƒã‚¸)
- âœ… 10-15ã®çµ±åˆãƒ†ã‚¹ãƒˆ
- âœ… CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ (GitHub Actions)
- âœ… è‡ªå‹•å›å¸°ãƒ†ã‚¹ãƒˆ

**çµæœ:** ãƒªã‚°ãƒ¬ãƒƒã‚·ãƒ§ãƒ³ä¿è­·ä»˜ãã§ãƒ†ã‚¹ãƒˆãƒ»æ¤œè¨¼ã•ã‚ŒãŸã‚·ã‚¹ãƒ†ãƒ 

---

### ãƒ•ã‚§ãƒ¼ã‚º3: ROS 2ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ (4é€±é–“) - 104æ™‚é–“
**å„ªå…ˆåº¦:** ğŸŸ¡ é«˜

**æˆæœç‰©:**
- âœ… 4ã¤ã®ãƒãƒ¼ãƒ‰ã‚’ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ã«å¤‰æ›
- âœ… æ˜ç¤ºçš„ãªQoSãƒãƒªã‚·ãƒ¼
- âœ… å¼·åŒ–ã•ã‚ŒãŸã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®šç¾©
- âœ… æ¨™æº–åŒ–ã•ã‚ŒãŸãƒˆãƒ”ãƒƒã‚¯å‘½å
- âœ… ã‚³ãƒãƒ³ãƒ‰èª¿åœ
- âœ… ãƒ›ãƒ­ãƒãƒŸãƒƒã‚¯ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³æœ‰åŠ¹åŒ–

**çµæœ:** æœ¬ç•ªå“è³ªã®ROS 2ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

---

### ãƒ•ã‚§ãƒ¼ã‚º4: ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã¨é‹ç”¨ (4é€±é–“) - 104æ™‚é–“
**å„ªå…ˆåº¦:** ğŸŸ¡ é«˜

**æˆæœç‰©:**
- âœ… ãƒ†ã‚£ãƒ¼ãƒãƒ³ã‚°ãƒ¢ãƒ¼ãƒ‰ + ã‚¦ã‚§ã‚¤ãƒã‚¤ãƒ³ãƒˆã‚·ã‚¹ãƒ†ãƒ 
- âœ… Dockerãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆ
- âœ… éšå±¤çš„è¨­å®š
- âœ… è¨ºæ–­ã‚·ã‚¹ãƒ†ãƒ 
- âœ… ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

**çµæœ:** ãƒ‡ãƒ—ãƒ­ã‚¤å¯èƒ½ã€é‹ç”¨å¯èƒ½ãªã‚·ã‚¹ãƒ†ãƒ 

---

## ç·å·¥æ•°: 616æ™‚é–“ (2äººã®é–‹ç™ºè€…ã§16é€±é–“)

---

**æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:**
1. ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ãƒãƒ¼ãƒ ã§ãƒ¬ãƒ“ãƒ¥ãƒ¼
2. ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å¤‰æ›´ã‚’æ‰¿èª
3. [IMPLEMENTATION-GUIDE.md](./IMPLEMENTATION-GUIDE.md) ãƒ•ã‚§ãƒ¼ã‚º1ã‚’é–‹å§‹
4. é€±æ¬¡ã§é€²æ—ã‚’è¿½è·¡

**è³ªå•ãŒã‚ã‚Šã¾ã™ã‹?** ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ˜ãƒ«ãƒ—ã«ã¤ã„ã¦ã¯ [START-HERE.md](./START-HERE.md) ã‚’å‚ç…§

---

**æœ€çµ‚æ›´æ–°æ—¥:** 2025-12-02
**ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒãƒ¼ã‚¸ãƒ§ãƒ³:** 1.0

# 要件比較: Confluence vs docs/active/

**日付:** 2025年12月5日
**目的:** ConfluenceとDocs/active/ドキュメント間の要件捕捉を比較
**範囲:** 機能要件のみ(実装状況は含まない)

---

## 概要

| 側面 | Confluence | docs/active/ | 整合性 |
|------|------------|--------------|--------|
| **ハードウェア仕様** | ✅ 詳細 | 🟡 部分的 | 60% |
| **ソフトウェア/ナビゲーション** | 🟡 高レベル | ✅ 詳細 | 40% |
| **ドッキング機構** | ✅ 機械的焦点 | ✅ ソフトウェア焦点 | 50% |
| **センサー** | ✅ 詳細モデル | ✅ 機能要件 | 70% |
| **安全性** | 🟡 基本的 | ✅ 包括的 | 40% |
| **運用要件** | ✅ 環境仕様 | ✅ 性能仕様 | 80% |

**全体的な整合性:** 約60% (焦点が異なり、相補的)

---

## 要件比較マトリックス

### 1. ハードウェア要件

| 要件 | Confluence | docs/active/ | 状態 |
|------|------------|--------------|------|
| **物理寸法** | ✅ 550×550×1300mm | ❌ 未指定 | ➡️ docs/active/に追加 |
| **前面幅** | ✅ 380mm (車椅子フィット) | ❌ 未指定 | ➡️ docs/active/に追加 |
| **ロボット重量** | ✅ ≥50kg (牽引能力) | ❌ 未指定 | ➡️ docs/active/に追加 |
| **ロボット半径** | ❌ 未指定 | ✅ 0.28m (ナビゲーション) | ➡️ Confluenceに追加 |
| **インフレーション半径** | ❌ 未指定 | ✅ 0.55m (安全マージン) | ➡️ Confluenceに追加 |
| **最低地上高** | ✅ ≥5cm | ❌ 未指定 | ➡️ docs/active/に追加 |
| **サスペンション** | ✅ ±20mmストローク希望 | ❌ 未指定 | ➡️ docs/active/に追加 |
| **重心** | ✅ 低い(安定性要件) | ❌ 未指定 | ➡️ docs/active/に追加 |
| **ホイールベース** | ✅ 安定性のため広い | ❌ 未指定 | ➡️ docs/active/に追加 |

**ギャップ:** Confluenceは物理設計仕様を持ち、docs/active/はナビゲーション関連仕様を持つ

---

### 2. 駆動系要件

| 要件 | Confluence | docs/active/ | 状態 |
|------|------------|--------------|------|
| **車輪タイプ** | ✅ メカナム、直径≥150mm | ✅ メカナム(現在) | ✅ 整合 |
| **駆動モーター** | ❌ 未指定 | ✅ 4× Phidget BLDC | ➡️ Confluenceに追加 |
| **モーター制御** | ❌ 未指定 | ✅ 車輪ごとのPID | ➡️ Confluenceに追加 |
| **全方向移動** | ✅ 暗示的(メカナム) | ✅ 文書化(部分的) | ✅ 整合 |
| **旋回能力** | ✅ 車椅子軸周り | ✅ その場回転(0m半径) | ✅ 整合(docs/active/がより良い) |
| **逆運動学** | ❌ 未指定 | ✅ 実装済み | ➡️ Confluenceに追加 |
| **オドメトリ** | ❌ 未指定 | ✅ ホイールエンコーダー+融合 | ➡️ Confluenceに追加 |

**ギャップ:** Confluenceは機械的に焦点、docs/active/は制御アルゴリズムを含む

---

### 3. 性能要件

| 要件 | Confluence | docs/active/ | 状態 |
|------|------------|--------------|------|
| **輸送能力** | ✅ 約100kg (車椅子+人) | ❌ 未テスト/未文書化 | ➡️ docs/active/に追加 |
| **最大速度** | ✅ 約4 km/h (目標) | ✅ 0.26 m/s (約0.9 km/h) 実際 | ⚠️ 不一致(目標vs実際) |
| **最大角速度** | ❌ 未指定 | ✅ 1.0 rad/s | ➡️ Confluenceに追加 |
| **加速度制限** | ❌ 未指定 | ✅ 2.5 m/s² 直線、3.2 rad/s² 角度 | ➡️ Confluenceに追加 |
| **坂道能力** | ✅ 約10° (目標) | ✅ 約1° (メカナム限界を文書化) | ⚠️ 不一致(目標vs実際) |
| **段差乗り越え** | ✅ 約2cm (目標) | ❌ 未テスト/未文書化 | ➡️ docs/active/に追加 |

**ギャップ:** Confluenceは目標を列挙、docs/active/は実際の設定限界を文書化

---

### 4. 動作環境要件

| 要件 | Confluence | docs/active/ | 状態 |
|------|------------|--------------|------|
| **主要環境** | ✅ 屋内(介護施設) | ✅ 屋内(病院/介護) | ✅ 整合 |
| **温度範囲** | ✅ 10–35°C | ❌ 未指定 | ➡️ docs/active/に追加 |
| **湿度範囲** | ✅ 40–80% | ❌ 未指定 | ➡️ docs/active/に追加 |
| **表面条件** | ✅ 平滑な屋内床 | ✅ 平滑な床(暗黙的) | ✅ 整合 |
| **屋外能力** | ❌ 未言及 | ✅ 分析済み(メカナムでは問題) | ➡️ Confluenceに追加 |
| **防水性** | ❌ 未指定 | ✅ 防水なし(屋内のみ) | ➡️ Confluenceに追加 |

**ギャップ:** Confluenceは環境限界を指定、docs/active/は制限を分析

---

### 5. ナビゲーション・位置推定要件

| 要件 | Confluence | docs/active/ | 状態 |
|------|------------|--------------|------|
| **ナビゲーションスタック** | ❌ 未指定 | ✅ Nav2 (ROS 2標準) | ➡️ Confluenceに追加 |
| **SLAMシステム** | ❌ 未指定 | ✅ RTAB-Map (ビジュアルSLAM) | ➡️ Confluenceに追加 |
| **グローバルプランナー** | ❌ 未指定 | ✅ NavFn (Dijkstra/A*) | ➡️ Confluenceに追加 |
| **ローカルプランナー** | ❌ 未指定 | ✅ DWB (Dynamic Window) | ➡️ Confluenceに追加 |
| **コストマップレイヤー** | ❌ 未指定 | ✅ 静的、障害物、膨張 | ➡️ Confluenceに追加 |
| **障害物回避** | ✅ 暗示的(安全要件) | ✅ LiDARベース、5Hz更新 | ✅ 整合 |
| **リカバリー動作** | ❌ 未指定 | ✅ 回転、後退、待機 | ➡️ Confluenceに追加 |
| **経路計画許容誤差** | ❌ 未指定 | ✅ ±0.5m 目標許容誤差 | ➡️ Confluenceに追加 |

**ギャップ:** Confluenceはソフトウェアアーキテクチャを指定せず、docs/active/は完全な詳細を持つ

---

### 6. センサー要件

| 要件 | Confluence | docs/active/ | 状態 |
|------|------------|--------------|------|
| **3D LiDAR** | ✅ 1× (Hesai XT16相当) | ✅ 1× Hesai (モデル不明) | 🟡 部分的に整合 |
| **2D LiDAR** | ✅ 3× (前1、後2、YDLidar Tmini Pro) | ❌ 未言及 | ➡️ 設置済みか確認 |
| **RGBカメラ** | ❌ 未指定 | ✅ 2× (左/右、ArUco用) | ➡️ Confluenceに追加 |
| **深度カメラ** | ✅ 1× Intel RealSense D455 | ❌ 未言及 | ➡️ 設置済みか確認 |
| **距離センサー** | ✅ 固定機構用 | ❌ ドッキングコードにない | ⚠️ 実装済みか確認 |
| **ホイールエンコーダー** | ❌ 未指定 | ✅ 4× (車輪ごと) | ➡️ Confluenceに追加 |
| **IMU** | ❌ 未指定 | ❌ 未言及(推奨されているが) | 両方に欠落 |
| **GPS** | ❌ 未指定 | ❌ 未言及(屋外アップグレード) | 両方に欠落 |

**重要なギャップ:** 異なるセンサー構成が文書化されている - 明確化が必要

---

### 7. ドッキング・固定要件

#### 7.1 機械的固定

| 要件 | Confluence | docs/active/ | 状態 |
|------|------------|--------------|------|
| **固定機構** | ✅ 機械的(ピン+スロット) | ❌ コードに未言及 | ⚠️ **重要 - 確認必要** |
| **拘束軸** | ✅ X/Y/Yawロック、Z/Pitch/Roll自由 | ❌ 未指定 | ➡️ docs/active/に追加 |
| **ロック動作** | ✅ 左右リニア | ❌ コードにない | ⚠️ 実装済みか確認 |
| **強度要件** | ✅ 200N耐える(上り坂) | ❌ 未指定 | ➡️ docs/active/に追加 |
| **取付方法** | ✅ 車椅子に専用ピン | ❌ 未指定 | ➡️ docs/active/に追加 |
| **スロット設計** | ✅ 縦長(高さ差を吸収) | ❌ 未指定 | ➡️ docs/active/に追加 |

#### 7.2 ビジュアルドッキング(ソフトウェア)

| 要件 | Confluence | docs/active/ | 状態 |
|------|------------|--------------|------|
| **マーカータイプ** | ✅ 位置認識用2Dコード | ✅ ArUcoマーカー (ID 20, 21) | ✅ 整合 |
| **ドッキング精度** | ❌ 未指定 | ✅ ±1mm (目標) | ➡️ Confluenceに追加 |
| **ドッキングフェーズ** | ❌ 未指定 | ✅ 2段階 (接近+精密) | ➡️ Confluenceに追加 |
| **接近距離** | ❌ 未指定 | ✅ 0.305m オフセット | ➡️ Confluenceに追加 |
| **デュアルマーカー遷移** | ❌ 未指定 | ✅ <0.7m 距離閾値 | ➡️ Confluenceに追加 |
| **制御アルゴリズム** | ❌ 未指定 | ✅ PID制御 (3軸) | ➡️ Confluenceに追加 |
| **検証** | ❌ 未指定 | ✅ 2段階 (3秒安定性) | ➡️ Confluenceに追加 |
| **PIDパラメーター** | ❌ 未指定 | ✅ 設定可能なKp/Ki/Kd | ➡️ Confluenceに追加 |

**重要なギャップ:** Confluenceは機械的ロックを説明、docs/active/はビジュアルサーボを説明 - **両方とも実装済み?**

---

### 8. 安全要件

| 要件 | Confluence | docs/active/ | 状態 |
|------|------------|--------------|------|
| **非常停止** | ❌ 未指定 | ✅ 必要(未実装) | ➡️ Confluenceに追加 |
| **障害物回避(ナビ)** | ✅ 暗示的 | ✅ LiDARベース、コストマップ | ✅ 整合 |
| **障害物回避(ドッキング)** | ❌ 未指定 | ✅ 必要(未実装) | ➡️ Confluenceに追加 |
| **速度制限** | ✅ 最大4 km/h | ✅ 0.26 m/s (0.9 km/h) 設定済み | ✅ 整合(保守的) |
| **安全ゾーン** | ❌ 未指定 | ✅ 膨張半径 0.55m | ➡️ Confluenceに追加 |
| **ジオフェンシング** | ❌ 未指定 | ✅ 立入禁止区域(計画中) | ➡️ Confluenceに追加 |
| **マーカータイムアウト** | ❌ 未指定 | ✅ 1-2秒(紛失時停止) | ➡️ Confluenceに追加 |
| **衝突検出** | ❌ 未指定 | ✅ ドッキング中必要 | ➡️ Confluenceに追加 |
| **転倒防止** | ✅ 低重心、広いホイールベース | ❌ 定量化されていない | ➡️ docs/active/に追加 |

**ギャップ:** Confluenceは機械的安全に焦点、docs/active/はソフトウェア安全機能に焦点

---

### 9. ユーザーインタラクション要件

| 要件 | Confluence | docs/active/ | 状態 |
|------|------------|--------------|------|
| **ユーザー確認** | ❌ 未指定 | ✅ 接近前+ドッキング前プロンプト | ➡️ Confluenceに追加 |
| **ステータス報告** | ❌ 未指定 | ✅ コンソールメッセージ、フィードバック | ➡️ Confluenceに追加 |
| **アクション調整** | ❌ 未指定 | ✅ 接近→ドッキングシーケンス | ➡️ Confluenceに追加 |
| **エラー報告** | ❌ 未指定 | ✅ 成功/失敗メッセージ | ➡️ Confluenceに追加 |
| **教示モード** | ❌ 未指定 | ✅ ウェイポイント保存/読込(計画中) | ➡️ Confluenceに追加 |
| **手動制御** | ❌ 未指定 | ✅ 教示中のテレオペレーション | ➡️ Confluenceに追加 |

**ギャップ:** Confluenceはユーザーインタラクションワークフローをカバーしていない

---

### 10. 設計・製造要件

| 要件 | Confluence | docs/active/ | 状態 |
|------|------------|--------------|------|
| **工業デザイン** | ✅ 準拠必須(別仕様) | ❌ 未指定 | ➡️ docs/active/に追加 |
| **組立方法** | ✅ 強度、組立やすさ | ❌ 未指定 | ➡️ docs/active/に追加 |
| **試作製造** | ✅ 3Dプリント | ❌ 未指定 | ➡️ docs/active/に追加 |
| **量産** | ✅ 射出成形 | ❌ 未指定 | ➡️ docs/active/に追加 |
| **保守性** | ✅ 分解考慮 | ❌ 未指定 | ➡️ docs/active/に追加 |
| **目標価格** | ✅ 1台200-300万円 | ❌ 未指定 | ➡️ docs/active/に追加 |

**ギャップ:** Confluenceは製造をカバー、docs/active/はソフトウェアに焦点

---

### 11. ソフトウェアアーキテクチャ要件

| 要件 | Confluence | docs/active/ | 状態 |
|------|------------|--------------|------|
| **ROSバージョン** | ❌ 未指定 | ✅ ROS 2 Humble | ➡️ Confluenceに追加 |
| **オペレーティングシステム** | ❌ 未指定 | ✅ Ubuntu 22.04 LTS | ➡️ Confluenceに追加 |
| **プログラミング言語** | ❌ 未指定 | ✅ C++17, Python 3.10 | ➡️ Confluenceに追加 |
| **ビルドシステム** | ❌ 未指定 | ✅ colcon | ➡️ Confluenceに追加 |
| **パッケージ構造** | ❌ 未指定 | ✅ 13パッケージ文書化 | ➡️ Confluenceに追加 |
| **アクション定義** | ❌ 未指定 | ✅ Approach、Dockアクション | ➡️ Confluenceに追加 |
| **トピック命名** | ❌ 未指定 | ✅ ノードごとに文書化 | ➡️ Confluenceに追加 |
| **構成管理** | ❌ 未指定 | ✅ YAMLベース (nav2_params.yaml) | ➡️ Confluenceに追加 |

**ギャップ:** Confluenceはソフトウェアスタックを全く指定していない

---

## ギャップ分析サマリー

### Confluenceにあり、docs/active/にない → **docs/active/に追加**

#### ハードウェア仕様:
- ✅ 物理寸法 (550×550×1300mm)
- ✅ 前面幅 (380mm)
- ✅ ロボット重量 (≥50kg)
- ✅ 最低地上高 (≥5cm)
- ✅ サスペンション仕様 (±20mmストローク)
- ✅ 重心要件
- ✅ ホイールベース設計

#### 機械的固定:
- ✅ ロック機構設計 (ピン、スロット)
- ✅ 拘束軸 (X/Y/Yawロック、Z/Pitch/Roll自由)
- ✅ リニアモーション (左右)
- ✅ 強度要件 (200N)
- ✅ 取付方法

#### 環境仕様:
- ✅ 温度範囲 (10–35°C)
- ✅ 湿度範囲 (40–80%)

#### 性能目標:
- ✅ 輸送能力 (100kg)
- ✅ 段差乗り越え (2cm)

#### 設計要件:
- ✅ 工業デザイン準拠
- ✅ 製造方法 (3Dプリント→射出成形)
- ✅ 目標価格 (200-300万円)

#### センサーモデル:
- ✅ 具体的な型番 (Hesai XT16、YDLidar Tmini Pro、RealSense D455)
- ✅ 3× 2D LiDAR構成 (前1、後2)

**合計:** Confluenceに約25の要件がdocs/active/にない

---

### docs/active/にあり、Confluenceにない → **Confluenceに追加**

#### ソフトウェアアーキテクチャ:
- ✅ ROS 2 Humble on Ubuntu 22.04
- ✅ Nav2ナビゲーションスタック
- ✅ RTAB-Mapビジュアルスラム
- ✅ NavFnグローバルプランナー
- ✅ DWBローカルプランナー
- ✅ 13パッケージ構造
- ✅ アクション定義 (Approach、Dock)

#### ナビゲーション詳細:
- ✅ ロボット半径 (0.28m)
- ✅ 膨張半径 (0.55m)
- ✅ コストマップ構成 (3レイヤー)
- ✅ 目標許容誤差 (±0.5m)
- ✅ 更新頻度 (5 Hz)
- ✅ リカバリー動作

#### ドッキング精度:
- ✅ ±1mm 精度目標
- ✅ 2段階ドッキング (接近+精密)
- ✅ デュアルマーカー戦略 (ID 20, 21)
- ✅ PID制御 (3軸: X, Y, Yaw)
- ✅ 距離閾値 (0.305m, 0.7m, 0.42m)
- ✅ 2段階検証 (3秒安定性)

#### 制御仕様:
- ✅ 4× Phidget BLDCモーター
- ✅ 車輪ごとのPID制御
- ✅ 逆運動学
- ✅ ホイールエンコーダーオドメトリ
- ✅ 最大角速度 (1.0 rad/s)
- ✅ 加速度制限 (2.5 m/s², 3.2 rad/s²)

#### 安全機能:
- ✅ 非常停止要件
- ✅ マーカータイムアウト (1-2秒)
- ✅ ジオフェンシング/立入禁止区域
- ✅ ドッキング中の衝突検出
- ✅ LiDAR安全監視

#### ユーザーインタラクション:
- ✅ 確認プロンプト (接近前、ドッキング前)
- ✅ ステータス報告
- ✅ アクション調整
- ✅ 教示モード (ウェイポイント管理)
- ✅ テレオペレーションサポート

#### 屋外分析:
- ✅ メカナムの屋外での限界
- ✅ スワーブドライブ代替案
- ✅ 屋外用GPS/IMU要件
- ✅ 防水性の考慮事項

**合計:** docs/active/に約40の要件がConfluenceにない

---

### 整合している要件(両方にある)

#### 中核機能:
- ✅ 自律車椅子輸送
- ✅ 屋内動作 (介護施設)
- ✅ メカナムホイール駆動系
- ✅ 障害物回避 (暗示的/詳細)
- ✅ ArUco/2Dコードマーカー (ドッキング用)
- ✅ 全方向移動能力
- ✅ その場回転

#### 性能:
- ✅ 速度制限 (Confluence: 4 km/h目標、docs/active/: 0.9 km/h実際)
- ✅ 坂道能力 (Confluence: 10°目標、docs/active/: 1°実際)

#### センサー:
- ✅ LiDAR (Hesai)
- ✅ カメラ (マーカー用)

**合計:** 約10の中核要件が整合 (目標vs実際の不一致あり)

---

## 重要な明確化が必要な点

### 1. **機械的ロック機構** 🔴
**質問:** 機械的ロック(ピン、スロット、リニアガイド)は実際に実装済み?
- **Confluence:** 詳細な機械設計
- **docs/active/:** ビジュアルサーボコードのみ(nav_docking.cppに機械ロックなし)

**アクション:** ハードウェアチームにロック機構の存在を確認

---

### 2. **センサー構成** 🔴
**質問:** 実際に設置されているセンサーは?
- **Confluence:** 3D LiDAR + 3× 2D LiDAR + RealSense D455
- **docs/active/:** 2× RGBカメラ + 1× Hesai LiDAR

**アクション:** 統一されたセンサーインベントリ文書を作成

---

### 3. **目標vs実際の能力** ⚠️
**不一致:**
- 速度: 4 km/h (目標) vs 0.9 km/h (実際)
- 坂道: 10° (目標) vs 1° (実際)
- 段差: 2cm (目標) vs 未テスト (実際)

**アクション:** 両文書で目標と現在の能力を明確化

---

## 私の推奨事項

### 1. **統一要件文書を作成** 🏆
**両方の視点を統合:**
```
新規: UNIFIED_REQUIREMENTS.md
├── セクション1: 物理仕様 (Confluenceから)
├── セクション2: ソフトウェアアーキテクチャ (docs/active/から)
├── セクション3: ナビゲーション・ドッキング (両方を統合)
├── セクション4: センサー (統一インベントリ)
├── セクション5: 安全性 (両方を統合)
├── セクション6: 製造 (Confluenceから)
└── セクション7: 目標vs現状 (明確化)
```

### 2. **両文書を更新**

**Confluenceに追加:**
- ソフトウェアスタック (ROS 2, Nav2, RTAB-Map)
- ドッキング精度 (±1mm)
- 2段階ドッキング戦略
- 安全機能 (非常停止、ジオフェンシング)
- ユーザーインタラクションワークフロー
- 目標vs現状の区別

**docs/active/に追加:**
- 物理寸法
- 重量、最低地上高、サスペンション
- 機械的ロック機構 (存在する場合)
- 環境限界 (温度、湿度)
- 目標価格
- 製造要件

### 3. **3つの重要なギャップを明確化**
1. 機械的ロック: 実装済みか計画中か?
2. センサー構成: 実際に設置されているセンサーは?
3. 性能仕様: 目標vs現状の実態

### 4. **相補的な文書を維持**
**Confluence = ビジネス/ハードウェア焦点:**
- 物理設計
- 製造
- コスト
- 高レベルの能力

**docs/active/ = ソフトウェア/技術焦点:**
- ソフトウェアアーキテクチャ
- アルゴリズム
- 構成
- 詳細なワークフロー

**両方が明確なリンクで相互参照**

---

## 統計サマリー

| カテゴリ | Confluence | docs/active/ | 両方 | 合計 |
|----------|------------|--------------|------|------|
| **ハードウェア仕様** | 25 | 5 | 3 | 33 |
| **ソフトウェア/ナビ** | 0 | 40 | 0 | 40 |
| **ドッキング/固定** | 10 | 8 | 2 | 20 |
| **センサー** | 6 | 6 | 2 | 14 |
| **安全性** | 2 | 8 | 2 | 12 |
| **運用** | 4 | 3 | 3 | 10 |
| **設計/製造** | 6 | 0 | 0 | 6 |
| **ユーザーUI** | 0 | 6 | 0 | 6 |
| **合計** | **53** | **76** | **12** | **141** |

**捕捉された一意の要件総数:** 141 (53+76+12)
- Confluenceの貢献: 53の一意の要件
- docs/active/の貢献: 76の一意の要件
- 両方が整合: 12の要件

**重複:** わずか8.5% (12/141) - **文書は高度に相補的**

---

## 結論

**主要な発見:**
1. ✅ **ConfluenceとDocs/active/は相補的** (冗長ではない)
2. ⚠️ **重複はわずか8.5%** - 焦点領域が異なる
3. 🔴 **3つの重要なギャップに明確化が必要** (機械ロック、センサー、目標vs実際)
4. ✅ **両文書とも価値がある** - 完全な全体像のために統合すべき

**推奨事項:**
以下を組み合わせた**統一要件文書**を作成:
- ハードウェア/製造仕様 (Confluenceから)
- ソフトウェア/技術詳細 (docs/active/から)
- 目標と現在の能力の明確な区別

**次のステップ:**
1. 機械的ロック機構の状態を明確化
2. 統一されたセンサーインベントリを作成
3. 欠落している要件で両文書を更新
4. 両文書を相互参照

---

**文書バージョン:** 1.0
**日付:** 2025年12月5日
**ページ数:** 10

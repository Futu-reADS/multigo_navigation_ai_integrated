# システム概要 - 屋外優先車椅子搬送ロボット

**プロジェクト名:** スワーブドライブ搭載車椅子搬送ロボット
**対象環境:** 屋外優先・屋内対応
**開発アプローチ:** モジュラーアーキテクチャによるアジャイル手法
**参照アーキテクチャ:** 実績のあるParcelPalアプローチに着想（コード0%、パターン60%、Autowareは使用しない）
**文書日付:** 2025年12月15日
**バージョン:** 1.0

---

## エグゼクティブサマリー

本文書は、**屋外運用**を主目的とし、完全な屋内互換性を持つ自律型車椅子搬送ロボットの包括的概要を提供します。システムは、優れた屋外性能を実現する**スワーブドライブプラットフォーム**、ArUcoビジュアルマーカーを使用した**精密ドッキング**（±2-5mm）、GPS依存なしの実績ある**ROS 2 + Nav2ナビゲーション**（ParcelPal着想）を使用します。

**主要イノベーション:** 屋外優先設計は、手動SLAMマッピング + NDTスキャンマッチャーローカリゼーション（実績のあるParcelPalアプローチ）を使用し、高価なRTK GPSなしで500m-1kmの信頼性のある運用を可能にします。

---

## 1. プロジェクト概要

### 1.1 目的

以下が可能な完全自律型車椅子搬送ロボットの開発:
- ✅ **自律車椅子ドッキング**: 精密な接続
- ✅ **安全な乗客搬送**: ピックアップから目的地まで
- ✅ **屋外ナビゲーション**: 最大10°の坂、小雨、荒れた地形
- ✅ **屋内互換性**: 平滑な床面、制御された環境
- ✅ **マルチストップシャトルサービス**: 500m-1kmの運用範囲
- ✅ **手動制御フォールバック**: ジョイスティック遠隔操作

### 1.2 主要ユースケース

| ユースケース | 説明 | 優先度 |
|-------------|------|--------|
| **車椅子ドッキング** | 自律アプローチと精密ドッキング（±2-5mm） | Critical |
| **乗客搬送** | 人を乗せたA→Bナビゲーション、スムーズな走行 | Critical |
| **マルチストップシャトル** | シーケンシャルウェイポイントナビゲーション、スケジュールサービス | High |
| **充電ステーション帰還** | 低バッテリー（<30%）時の自動帰還 | High |
| **手動オーバーライド** | ジョイスティック遠隔操作、ティーチングモード | Medium |
| **緊急帰還** | センサー故障時の安全なベース帰還 | Medium |

### 1.3 運用環境

**主要:** 屋外環境
- キャンパス通路、歩道、駐車場
- 天候: 小雨運用（IP54+防水防塵）
- 地形: 最大10°の坂（17.6%勾配）、荒れた表面
- 範囲: マルチストップルーティングで500m-1km

**副次:** 屋内環境
- 病院廊下、ショッピングモールフロア
- 平滑表面、制御温度
- より高精度達成可能（±1mmドッキング目標）

---

## 2. システムアーキテクチャ

### 2.1 ハイレベルアーキテクチャ

```
┌─────────────────────────────────────────────────────────────────┐
│              車椅子搬送ロボットシステム                            │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │         車椅子マスター（メインオーケストレーション）         │  │
│  │         • ステートマシン調整                              │  │
│  │         • ミッション計画                                  │  │
│  │         • 安全監視                                        │  │
│  └─────────────┬────────────────────────────────────────────┘  │
│                │                                                │
│    ┌───────────┼───────────┬──────────────┬──────────────┐    │
│    ▼           ▼           ▼              ▼              ▼     │
│ ┌──────┐  ┌────────┐  ┌─────────┐  ┌──────────┐  ┌────────┐  │
│ │  UI  │  │Autoware│  │ Swerve  │  │ Docking  │  │  eHMI  │  │
│ │(タッチ│  │  Nav   │  │  Drive  │  │ Subsystem│  │(ESP32) │  │
│ │スクリ│  │ Stack  │  │Controller│  │(ArUco)   │  │        │  │
│ │ーン）│  └────────┘  └─────────┘  └──────────┘  └────────┘  │
│ └──────┘       │                                                │
│                ▼                                                │
│         ┌─────────────┐                                        │
│         │  センサー    │                                        │
│         │LiDAR+カメラ  │                                        │
│         │  +IMU       │                                        │
│         └─────────────┘                                        │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 コアサブシステム

#### **1. スワーブドライブシステム**（新規）
- 4つの独立ホイールモジュール（6.5インチホバーボードインホイールモーター）
- 全方向移動のための逆運動学
- メカナムホイールより優れた屋外性能
- Nav2統合のためのROS 2コントローラープラグイン

#### **2. 車椅子ドッキングサブシステム**（新規）
- ArUcoマーカー検出（OpenCV）
- 2フェーズドッキング: 粗いナビゲーション + 精密ビジュアルサーボイング
- 精度: 屋外±2-5mm、屋内±1mm目標
- 確認センサー付き機械的カップリング

#### **3. ナビゲーションスタック**（新規コード、ParcelPal着想アーキテクチャ）
- 手動SLAMマッピング1回（オフライン、ループクロージャ付き）
- NDTスキャンマッチャーローカリゼーション（標準ROS 2、Autowareではない）
- Nav2パスプランニングと障害物回避
- 範囲: GPSなしで500m-1km
- **注:** ParcelPalからコード0%、アーキテクチャパターン70%

#### **4. 知覚システム**（新規コード、ParcelPal着想アーキテクチャ）
- 3D LiDAR（屋外グレード、IP65+、モデルTBD）
- デュアルRGBカメラ（ArUco検出 + 障害物認識）
- 9軸IMU（向き、傾き補償）
- バイナリ障害物検出（PCLベース、ディープラーニングなし）
- **注:** ParcelPalからコード0%、アーキテクチャパターン60%

#### **5. 安全システム**（拡張 - ParcelPal + 車椅子）
- 乗客安全監視（乗員検出）
- 緊急停止（ハードウェアボタン + ソフトウェア）
- 5°を超える坂でのピックアップ/ドロップオフ禁止
- 乗客乗車時の速度制限
- ジオフェンシングと立入禁止ゾーン

#### **6. ユーザーインターフェース**（適応 - ParcelPal）
- タッチスクリーン（React + Next.js、車椅子予約）
- eHMI（ESP32-S3: LEDストリップ + LEDマトリックス + オーディオ）
- 多言語サポート（EN、JP、ZH）
- オペレーターダッシュボード（ミッション監視）

---

## 3. 主要技術仕様

### 3.1 ハードウェアプラットフォーム

| コンポーネント | 仕様 | 根拠 |
|--------------|------|------|
| **ドライブシステム** | スワーブドライブ（4モジュール） | 最高の屋外性能、全方向移動 |
| **ホイール** | 6.5インチφ165mmホバーボードインホイールモーター | 実績あり、入手可能、1輪あたり80W |
| **コンピュート** | GMKtec Nucbox K6（Ryzen 7 7840HS、32GB、Radeon 780M） | CPUベース処理に十分、ディープラーニングGPU不要 |
| **3D LiDAR** | 屋外グレード、IP65+（モデルTBD） | ナビゲーションと障害物検出の主要センサー |
| **カメラ** | 2×RGBカメラ（解像度TBD） | ArUcoマーカー検出、視覚的認識 |
| **IMU** | 9軸（MPU-9250または類似） | 傾き補償、向き |
| **GPS** | ❌ 含まれない | コスト削減、NDTローカリゼーションが<1km範囲で十分 |
| **ArUcoマーカー** | ドッキングステーションに4-8マーカー | 精密ドッキング、OpenCVベース検出 |
| **防水防塵** | IP54+エンクロージャー | 小雨運用 |

### 3.2 性能目標

| パラメータ | 屋外 | 屋内 | 備考 |
|-----------|------|------|------|
| **ドッキング精度** | ±2-5mm | ±1mm（目標） | ArUcoビジュアルサーボイング |
| **ナビゲーション範囲** | 500m-1km | 無制限 | バッテリーで制限、ローカリゼーションではない |
| **最大坂** | 10°（17.6%） | 15°（可能） | 100kg負荷での設計限界 |
| **最大速度** | 1.0 m/s | 1.5 m/s | 乗客快適性限界 |
| **ローカリゼーション精度** | ±10cm位置 | ±5cm位置 | NDTスキャンマッチャー |
| **障害物検出範囲** | 0.1-30m | 0.1-15m | LiDAR + カメラ |
| **バッテリー寿命** | 4-6時間 | 6-8時間 | 地形、負荷に依存 |

### 3.3 ソフトウェアスタック

| レイヤー | 技術 | 目的 |
|---------|------|------|
| **フレームワーク** | ROS 2 Humble（Ubuntu 22.04） | ロボットオペレーティングシステム |
| **ナビゲーション** | Autoware + Nav2 | 実績ある屋外ナビゲーションスタック |
| **ローカリゼーション** | NDTスキャンマッチャー（SLAM Toolbox） | 保存マップでのドリフトなしローカリゼーション |
| **SLAM** | 1回の手動マッピング（オフライン） | ループクロージャ、運用のための保存マップ |
| **知覚** | PCL（Point Cloud Library） | LiDAR処理、CPUベース |
| **ビジョン** | OpenCV 4.x | ArUco検出、カメラ処理 |
| **ドッキング** | カスタムROS 2ノード（ビジュアルサーボイング） | 精密ドッキングコントローラー |
| **スワーブドライブ** | カスタムROS 2コントローラープラグイン | 逆運動学、Nav2統合 |
| **UI** | React + Next.js | タッチスクリーンインターフェース |
| **eHMI** | Arduino（ESP32-S3）+ Dezyne | LED/オーディオ外部HMI |

---

## 4. 運用ワークフロー

### 4.1 車椅子ドッキングシーケンス

```
1. IDLE → 乗客がUI/アプリで呼び出し
   └─> ロボットがピックアップ場所を受信

2. APPROACHING_WHEELCHAIR → アプローチゾーンへナビゲート
   └─> 保存マップ + NDTローカリゼーション使用

3. SEARCHING_ARUCO → 車椅子上のArUcoマーカー検出
   └─> ナビゲーションからビジュアルサーボイングへ切替

4. DOCKING → 精密アプローチ（±2-5mm）
   └─> ビジュアルサーボイングコントローラー + 機械的カップリング

5. WHEELCHAIR_ATTACHED → 接続確認
   └─> 乗員検出センサーアクティブ
   └─> オーディオ: "車椅子が正常に接続されました"
```

### 4.2 乗客搬送シーケンス

```
6. TRANSPORTING → 目的地へナビゲート
   └─> 乗客乗車中、速度低減、快適性優先
   └─> eHMI: "乗客乗車中、距離を保ってください"

7. ARRIVED_DESTINATION → ドロップオフ場所に到着
   └─> オーディオ: "目的地に到着しました"
   └─> ドッキング解除の確認を待機

8. UNDOCKING → 機械的カップリング解放
   └─> ドッキング手順を逆実行

9. WHEELCHAIR_DETACHED → 解放確認
   └─> オーディオ: "車椅子が切り離されました、準備完了"
   └─> IDLEまたは次のミッションへ戻る
```

### 4.3 マルチストップシャトルサービス

```
ミッション: [ピックアップA] → [ドロップオフA] → [ピックアップB] → [ドロップオフB] → [充電ステーション]

• シーケンシャルウェイポイントナビゲーション
• キュー管理（複数乗客）
• バッテリー監視（<30%で充電帰還）
• スケジュールルート（例: 毎時シャトル）
```

---

## 5. 設計原則

### 5.1 屋外優先哲学

**すべての要件が屋外運用を優先:**
- ハードウェア: 防水防塵、屋外グレードセンサー
- ソフトウェア: GPS喪失、照明変化、地形変動に対するロバスト性
- 性能: 坂、荒れた表面、気象条件での検証
- **屋内がより簡単に:** より良いローカリゼーション、より速い速度、より厳しい公差

### 5.2 関心事の分離（アジャイル対応）

**各サブシステムは独立して:**
- 文書化（要件、アーキテクチャ、設計）
- 開発可能（並行チーム開発）
- テスト可能（単体 + 統合 + システムテスト）
- 統合可能（明確なROS 2インターフェース）

**サブシステム:**
1. スワーブドライブコントローラー
2. 車椅子ドッキングサブシステム
3. Autowareナビゲーションスタック
4. 知覚サブシステム
5. 安全サブシステム
6. ユーザーインターフェース + eHMI

### 5.3 実績あるアーキテクチャに基づく（ParcelPal）

**ParcelPal配送ロボットの60-70%を再利用:**
- ✅ Autowareナビゲーションスタック（100%再利用）
- ✅ NDTローカリゼーションアプローチ（100%再利用）
- ✅ UIフレームワークパターン（70%再利用）
- ✅ eHMIコントローラーパターン（90%再利用）
- ✅ メインオーケストレーションパターン（80%再利用）

**新規開発フォーカス:**
- スワーブドライブコントローラー（0% - 新規）
- 車椅子ドッキングサブシステム（0% - 新規）
- 乗客安全監視（0% - 新規）

---

## 6. 開発ロードマップ（ハイレベル）

### フェーズ1: 基盤（スプリント1-4）
- Autoware + NDTローカリゼーションセットアップ
- テスト環境の手動SLAMマッピング
- 基本スワーブドライブコントローラー
- システム統合スケルトン

### フェーズ2: ドッキングシステム（スプリント5-8）
- ArUcoマーカー検出
- ビジュアルサーボイングコントローラー
- 機械的カップリング設計
- ドッキング精度テスト

### フェーズ3: 安全性と搬送（スプリント9-12）
- 乗客安全監視
- 強化された安全機能
- 搬送モードテスト
- マルチストップルーティング

### フェーズ4: UI/UXと仕上げ（スプリント13-16）
- タッチスクリーンUI
- eHMI実装
- 多言語サポート
- ユーザー受入テスト

### フェーズ5: フィールドテスト（スプリント17-20）
- 屋外テスト（様々な天候、地形）
- 屋内互換性検証
- 性能最適化
- 生産準備

---

## 7. 既存システムとの主要差別化要因

| 機能 | 本システム | 典型的な屋内車椅子ロボット | 優位性 |
|------|-----------|-------------------------|--------|
| **環境** | 屋外優先 + 屋内 | 屋内のみ | 実世界展開の柔軟性 |
| **ローカリゼーション** | 手動SLAM + NDT（GPSなし） | GPSまたはビーコンベース | コスト削減、<1km信頼性 |
| **ドライブシステム** | スワーブドライブ | メカナムまたは差動 | 優れた屋外性能 |
| **ドッキング精度** | 屋外±2-5mm | 典型的±10cm | すべての条件で信頼性のある接続 |
| **参照アーキテクチャ** | 実績あるParcelPalベース | ゼロからカスタム | 低リスク、高速開発 |
| **コンピュート** | GMKtec Nucbox K6（統合GPU） | 高価な組込GPU | コスト効率、十分な性能 |

---

## 8. リスク軽減

### 8.1 技術的リスク

| リスク | 軽減策 | ステータス |
|--------|--------|-----------|
| **屋外ローカリゼーションドリフト** | 手動SLAM + NDT（ParcelPal実績） | ✅ 検証済み |
| **屋外ドッキング精度** | ArUco + ビジュアルサーボイング | ⚠️ テスト要 |
| **スワーブドライブ制御複雑性** | 段階的開発、ROS 2プラグイン | ⚠️ 新規開発 |
| **センサーへの気象影響** | IP65+ LiDAR、カメラレンズ加熱 | ⚠️ テスト要 |
| **坂でのバッテリー寿命** | 保守的な電力予算、4時間目標 | ⚠️ 検証要 |

### 8.2 安全性リスク

| リスク | 軽減策 | ステータス |
|--------|--------|-----------|
| **搬送中の乗客転落** | 乗員検出、緊急停止、速度制限 | 🔄 設計フェーズ |
| **歩行者との衝突** | LiDAR障害物検出、eHMI警告 | ✅ ParcelPal実績 |
| **負荷時の坂安定性** | 10°設計限界、傾きセンサーカットオフ | 🔄 テスト要 |
| **坂でのドッキング** | 5°を超える坂でのドッキング禁止 | ✅ 強制 |

---

## 9. 成功基準

### 9.1 技術的成功

- ✅ ドッキング成功率 >95%（屋外条件）
- ✅ ローカリゼーション精度 500mで±10cm（GPSなし）
- ✅ 障害物回避: テストで衝突ゼロ
- ✅ バッテリー寿命: 乗客搬送で4時間以上
- ✅ 稼働時間: >98%（保守除く）

### 9.2 運用的成功

- ✅ 乗客満足度: >4.5/5評価（快適性、信頼性）
- ✅ スタッフ満足度: オペレーターダッシュボード使いやすさ >4/5
- ✅ 展開: 90%屋外、10%屋内（屋外優先を検証）
- ✅ 保守: 平均週2時間未満

---

## 10. 関連文書

**参照資料:**
- `reference/PARCELPAL_EXPLORATION_SUMMARY.md` - ParcelPalアーキテクチャ分析
- `reference/EHMI_SYSTEM_REFERENCE.md` - eHMI実装詳細
- `reference/SWERVE_DRIVE_SYSTEM_TASK.md` - 元のタスク仕様
- `reference/question_answers.md` - シニアレビューQ&A

**要件:**
- `01_REQUIREMENTS/SYSTEM_REQUIREMENTS.md` - 完全システム要件
- `01_REQUIREMENTS/SWERVE_DRIVE_REQUIREMENTS.md` - ドライブシステム仕様
- `01_REQUIREMENTS/DOCKING_SYSTEM_REQUIREMENTS.md` - ドッキング精度仕様

**アーキテクチャ:**
- `02_ARCHITECTURE/OVERALL_SYSTEM_ARCHITECTURE.md` - 詳細アーキテクチャ
- `02_ARCHITECTURE/SWERVE_DRIVE_ARCHITECTURE.md` - ドライブシステム設計
- `02_ARCHITECTURE/DOCKING_SUBSYSTEM_ARCHITECTURE.md` - ドッキング設計

**開発:**
- `05_DEVELOPMENT/AGILE_ROADMAP.md` - スプリント計画とタイムライン
- `05_DEVELOPMENT/USER_STORIES.md` - ユーザー視点の機能説明

---

## 11. 用語集

| 用語 | 定義 |
|------|------|
| **Autoware** | オープンソース自動運転ソフトウェア（tier4_autoware） |
| **ArUco** | 視覚的位置決めのためのOpenCVベース基準マーカーシステム |
| **eHMI** | 外部ヒューマンマシンインターフェース（歩行者向けLED/オーディオ） |
| **GMKtec Nucbox K6** | ミニPC（Ryzen 7 7840HS、32GB RAM、Radeon 780M GPU） |
| **NDT** | 正規分布変換（スキャンマッチングアルゴリズム） |
| **Nav2** | ROS 2ナビゲーションフレームワーク |
| **ParcelPal** | Autowareを使用する参照配送ロボット（FutureADSプロジェクト） |
| **SLAM** | 同時位置推定とマッピング |
| **スワーブドライブ** | 4輪独立操舵・駆動システム |
| **TVM** | Total Vehicle Management（ログアップロードサービス、ロボットとは別） |
| **ビジュアルサーボイング** | リアルタイム視覚フィードバックを使用した制御 |

---

**文書ステータス:** 完了
**次回レビュー:** フェーズ1スプリント1完了後
**保守担当:** システムアーキテクト
**バージョン履歴:**
- v1.0（2025-12-15）: 初版システム概要文書

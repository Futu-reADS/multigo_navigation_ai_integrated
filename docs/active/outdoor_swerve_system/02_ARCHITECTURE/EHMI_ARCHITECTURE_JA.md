# eHMIアーキテクチャ（外部ヒューマンマシンインターフェース）

**文書ID:** ARCH-EHMI-001
**バージョン:** 1.0
**日付:** 2025年12月15日
**ステータス:** ドラフト

---

## 1. 概要

**eHMI（External Human-Machine Interface）サブシステム**は、視覚および音声信号を通じて歩行者と傍観者にロボットの意図と状態を伝達します。自律ロボットの安全性と社会的受容性を向上させます。

**主要機能:**
- アンビエントロボット状態表示用LEDストリップ（360°視認性）
- 方向意図表示用LEDマトリックス（矢印、アイコン、テキスト）
- 主要イベント用音声アナウンス（ドッキング、到着、警告）
- 多言語音声サポート（EN、JP、ZH）
- 決定論的動作のための形式的ステートマシン（Dezyneモデリング）
- ROS 2とのシリアル通信（ESP32-S3マイクロコントローラー）

**設計哲学:**
- **明確な通信:** 明瞭な視覚/音声信号
- **予測可能な動作:** 形式的ステートマシン（Dezyne）
- **屋外動作:** 高輝度LED、防水スピーカー
- **社会的受容性:** フレンドリーで威圧的でない外観

---

## 2. システムアーキテクチャ

### 2.1 コンポーネント図

```
┌──────────────────────────────────────────────────────────────────┐
│                    eHMIサブシステム                               │
│                                                                  │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │                  ROS 2 eHMIマネージャーノード              │ │
│  │                  (PythonまたはC++)                         │ │
│  │                                                            │ │
│  │  - ロボット状態トピック購読                                 │ │
│  │  - 状態をeHMI状態にマッピング（0-28）                      │ │
│  │  - シリアル経由でESP32にコマンド送信                       │ │
│  └──────────────────────┬─────────────────────────────────────┘ │
│                         │                                        │
│                         │ シリアル（115200ボー）                 │
│                         ↓                                        │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │                  ESP32-S3マイクロコントローラー            │ │
│  │                  (Arduino/PlatformIO)                      │ │
│  │                                                            │ │
│  │  ┌──────────────────┐      ┌──────────────────┐          │ │
│  │  │  Dezyneステート  │      │  LEDコントローラー│          │ │
│  │  │  マシン          │─────▶│                  │          │ │
│  │  │  (eHMI状態       │      │  - WS2812Bストリップ│         │ │
│  │  │   0-28)          │      │  - HUB75マトリックス│        │ │
│  │  └──────────────────┘      └──────────────────┘          │ │
│  │                                                            │ │
│  │  ┌──────────────────┐      ┌──────────────────┐          │ │
│  │  │  音声プレーヤー  │      │  シリアル        │          │ │
│  │  │                  │      │  インターフェース│          │ │
│  │  │  - I2S DAC       │      │  (ROSコマンド)   │          │ │
│  │  │  - MP3ファイル   │      │                  │          │ │
│  │  └──────────────────┘      └──────────────────┘          │ │
│  └────────────────────────────────────────────────────────────┘ │
│                                                                  │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │                  ハードウェア                              │ │
│  │                                                            │ │
│  │  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐│ │
│  │  │ WS2812B LED   │  │ HUB75 LED     │  │ I2Sスピーカー ││ │
│  │  │ ストリップ    │  │ マトリックス  │  │ (MAX98357A)   ││ │
│  │  │ (≥60 LED)     │  │ (64×32ピクセル)│  │               ││ │
│  │  │               │  │               │  │               ││ │
│  │  │ - 360°ビュー  │  │ - 方向矢印    │  │ - アナウンス  ││ │
│  │  │ - アンビエント│  │ - アイコン、テキスト│ │ - 多言語      ││ │
│  │  │   ステータス  │  │               │  │               ││ │
│  │  └───────────────┘  └───────────────┘  └───────────────┘│ │
│  └────────────────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────────────┘
```

---

## 3. ハードウェアアーキテクチャ

### 3.1 ESP32-S3マイクロコントローラー

**仕様:**
- **CPU:** デュアルコアXtensa LX7、240 MHz
- **メモリ:** 512 KB SRAM、384 KB ROM
- **フラッシュ:** 8 MB（ファームウェア+音声ファイル用）
- **GPIO:** 45個のプログラマブルピン
- **周辺機器:** I2S、SPI、UART、I2C
- **電源:** 3.3V、約500mA（LEDは別途5V供給必要）

**ピン配置:**
```
ESP32-S3ピン配置:
- GPIO2  → WS2812B LEDストリップデータ
- GPIO4-11 → HUB75 LEDマトリックス（R1、G1、B1、R2、G2、B2、A、B、C、D、CLK、LAT、OE）
- GPIO12 → I2S BCLK（ビットクロック）
- GPIO13 → I2S LRCLK（左/右クロック）
- GPIO14 → I2S DIN（データ入力）
- GPIO43 → UART TX（ROS 2へ）
- GPIO44 → UART RX（ROS 2から）
```

---

### 3.2 LEDストリップ（WS2812B）

**仕様:**
- **タイプ:** WS2812B個別アドレス可能RGB LED
- **数:** ≥60 LED（300mmストリップ、5mm間隔）
- **電圧:** 5V DC
- **電流:** LED当たり約60mA（最大輝度）、60 LEDで合計約3.6A
- **プロトコル:** 単線制御（800 kHzデータレート）

**取り付け:**
- ロボットベースまたは上部の360°リング
- 防水シリコンコーティング（IP65+）
- よりソフトな光のためのディフューザー

**状態:**
- **待機:** ゆっくりした青パルス
- **ナビゲート中:** 緑チェイスパターン
- **ドッキング:** 黄色回転パターン
- **乗客搭乗:** シアンソリッド
- **エラー:** 赤フラッシュ
- **緊急停止:** 赤ソリッド

---

### 3.3 LEDマトリックス（HUB75）

**仕様:**
- **解像度:** 64×32ピクセル
- **カラー:** RGB（フルカラー）
- **プロトコル:** HUB75（パラレルデータ+制御）
- **リフレッシュレート:** 最小60 Hz
- **視野角:** 水平120°、垂直60°
- **輝度:** 調整可能（0-255）

**コンテンツ:**
- **矢印:** 左、右、前進、後退、回転
- **アイコン:** 車椅子、警告、チェックマーク、X
- **テキスト:** 短いメッセージ（4-8文字、例: "停止"、"待機"）

**表示例:**
- 車椅子接近中: "→"（右矢印）
- ドッキング中: 車椅子アイコン+回転アニメーション
- 目的地到達: チェックマークアイコン
- エラー: "X" + エラーコード

---

### 3.4 音声（I2Sスピーカー）

**仕様:**
- **DAC:** MAX98357A I2Sアンプ（3Wモノラル）
- **スピーカー:** 4Ω 3W防水スピーカー
- **フォーマット:** MP3音声ファイル（ESP32フラッシュに保存）
- **音量:** 0-10（ROS経由で調整可能）
- **サンプルレート:** 44.1 kHz

**音声ファイル（多言語）:**
```
audio/
├── en/
│   ├── approaching.mp3           # "Approaching wheelchair"
│   ├── docking.mp3                # "Docking in progress"
│   ├── docked.mp3                 # "Docking complete"
│   ├── passenger_onboard.mp3      # "Passenger onboard"
│   ├── destination_reached.mp3    # "Destination reached"
│   ├── emergency_stop.mp3         # "Emergency stop activated"
│   └── error.mp3                  # "Error detected"
├── ja/
│   ├── approaching.mp3            # "車椅子に接近中"
│   ├── docking.mp3                # "ドッキング中"
│   ├── docked.mp3                 # "ドッキング完了"
│   └── ...
└── zh/
    ├── approaching.mp3            # "接近轮椅"
    └── ...
```

---

## 4. ステートマシン（Dezyne形式的モデリング）

### 4.1 状態定義

**標準ロボット状態（0-20）:**
- 0: オフ
- 1: 待機
- 2: ナビゲート中
- 3: 一時停止
- 4: 充電中
- 5: エラー
- 6: 緊急停止
- 7: 手動制御
- 8: ローカライゼーション消失
- 9: 低バッテリー
- 10: 障害物検出
- 11-20: 予約済み

**車椅子固有状態（21-28）:**
- 21: 車椅子接近中
- 22: ドッキング中
- 23: ドッキング完了
- 24: 乗客搭乗
- 25: 搬送中
- 26: 目的地到達
- 27: 乗客降車
- 28: ドッキング失敗

---

### 4.2 Dezyneステートマシンモデル

**eHMI.dzn:**
```dzn
interface IeHMI {
  in void setState(int state);
  in void setLanguage(string lang);
  in void setVolume(int volume);
  
  behavior {
    enum State {
      OFF, IDLE, NAVIGATING, PAUSED, CHARGING, ERROR, EMERGENCY_STOP,
      MANUAL, LOC_LOST, LOW_BATTERY, OBSTACLE,
      APPROACHING_WHEELCHAIR, DOCKING, DOCKED, PASSENGER_ONBOARD,
      TRANSPORT, DESTINATION_REACHED, DISEMBARK, DOCKING_FAILED
    };
    
    State current_state = State.OFF;
    
    on setState(int s): {
      current_state = toState(s);
      updateLEDs(current_state);
      updateMatrix(current_state);
      playAudio(current_state);
    }
  }
}

component eHMI {
  provides IeHMI api;
  requires ILEDStrip led_strip;
  requires ILEDMatrix led_matrix;
  requires IAudio audio;
  
  behavior {
    on api.setState(state): {
      // 状態遷移ロジック
      if (isValidTransition(current_state, state)) {
        current_state = state;
        
        // 視覚出力更新
        led_strip.setPattern(getPattern(state));
        led_matrix.setContent(getContent(state));
        
        // 音声アナウンス再生
        if (hasAudio(state)) {
          audio.play(getAudioFile(state, current_language));
        }
      } else {
        // 無効な遷移、エラーログ
        logError("無効な状態遷移");
      }
    }
  }
}
```

---

### 4.3 状態遷移

**許可される遷移:**
```
待機 → ナビゲート中                    （ナビゲーション開始）
ナビゲート中 → 車椅子接近中            （ドッキングステーション近く）
車椅子接近中 → ドッキング中            （ビジュアルサーボ開始）
ドッキング中 → ドッキング完了          （ドッキング完了）
ドッキング完了 → 乗客搭乗              （乗客アタッチメント確認）
乗客搭乗 → 搬送中                      （搬送ミッション開始）
搬送中 → 目的地到達                    （目的地到着）
目的地到達 → 降車中                    （乗客降車中）
降車中 → 待機                          （ミッション完了）

* → 緊急停止                           （任意の状態→E-Stop）
* → エラー                             （任意の状態→エラー）
ドッキング中 → ドッキング失敗          （ドッキングタイムアウトまたは失敗）
```

**無効な遷移:**
- 待機 → 乗客搭乗（ドッキングスキップ不可）
- ドッキング中 → 搬送中（検証スキップ不可）

---

## 5. ROS 2統合

### 5.1 eHMIマネージャーノード

**ノード名:** `ehmi_manager`
**言語:** PythonまたはC++
**ライフサイクル:** 標準ノード

**購読トピック:**
- `/robot_state` (std_msgs/UInt8): 全体ロボット状態（0-20）
- `/docking/state` (std_msgs/String): ドッキングサブシステム状態
- `/route_status` (custom_msgs/RouteStatus): ミッション進捗
- `/passenger_attached` (std_msgs/Bool): 乗客搭乗ステータス
- `/emergency_stop` (std_msgs/Bool): E-Stopステータス

**配信トピック:**
- `/ehmi_state` (std_msgs/UInt8): 現在のeHMI状態（0-28）

**サービス:**
- `/ehmi/set_language` (custom_srvs/SetLanguage): 音声言語変更
- `/ehmi/set_volume` (custom_srvs/SetVolume): 音量調整（0-10）
- `/ehmi/set_brightness` (custom_srvs/SetBrightness): LED輝度調整（0-255）

**シリアルインターフェース:**
- **ポート:** /dev/ttyUSB0（またはESP32の場合/dev/ttyACM0）
- **ボーレート:** 115200
- **プロトコル:** シンプルなテキストベースコマンド

**シリアルコマンド:**
```
STATE <state_num>           # eHMI状態設定（0-28）
LANG <language>             # 言語設定（en、ja、zh）
VOL <volume>                # 音量設定（0-10）
BRIGHT <brightness>         # 輝度設定（0-255）
TEST                        # テストパターン実行（全LED+音声）
```

---

## 6. テスト戦略

### 6.1 ユニットテスト
- ステートマシン遷移（Dezyne検証）
- LEDパターン正確性
- 音声ファイル再生
- シリアルコマンド解析

### 6.2 統合テスト
- ROS 2 → ESP32通信
- 状態同期
- 多言語音声切り替え
- 輝度/音量調整

### 6.3 フィールドテスト（社会的受容性）
- eHMI信号への歩行者反応
- 日光下の視認性（LED輝度）
- 音声可聴性（屋外ノイズ）
- 文化的適切性（多言語）

---

## 7. 性能目標

| メトリック | 目標 | 検証 |
|--------|--------|------------|
| LED更新レート | 50 Hz | タイムスタンプ解析 |
| 状態変更遅延 | <200ms | 統合テスト |
| LED輝度（日光下） | 10mで視認可能 | フィールドテスト |
| 音声音量（屋外） | 5mで可聴 | フィールドテスト |
| シリアル通信レート | 115200ボー | ハードウェア仕様 |

---

## 8. 実装フェーズ

### フェーズ1: 基本eHMI（スプリント1-2）
- ✅ ESP32ファームウェアセットアップ
- ✅ LEDストリップ制御（WS2812B）
- ✅ ROSとのシリアル通信
- ✅ 基本状態（0-10）

### フェーズ2: 高度なeHMI（スプリント3-4）
- ✅ LEDマトリックス統合（HUB75）
- ✅ 音声再生（I2S）
- ✅ 車椅子状態（21-28）
- ✅ 多言語サポート

### フェーズ3: ステートマシン（スプリント5-6）
- ✅ Dezyne形式的モデル
- ✅ 状態遷移検証
- ✅ ROS 2 eHMIマネージャーノード
- ✅ 状態マッピングアルゴリズム

### フェーズ4: フィールド検証（スプリント7-8）
- ✅ 屋外視認性テスト
- ✅ 社会的受容性テスト
- ✅ 多言語音声録音
- ✅ 本番ハードウェア組み立て

---

**文書ステータス:** ドラフト
**実装ステータス:** 未開始
**承認必要:** eHMIエンジニア、UXデザイナー、システムアーキテクト
